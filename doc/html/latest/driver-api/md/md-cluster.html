

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>MD Cluster &mdash; The Linux Kernel  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="RAID 4/5/6 cache" href="raid5-cache.html" />
    <link rel="prev" title="RAID" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.6.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kbuild/index.html">Kernel Build System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../livepatch/index.html">Kernel Livepatching</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">The Linux driver implementer’s API guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../driver-model/index.html">Driver Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics.html">Driver Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../infrastructure.html">Device drivers infrastructure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../early-userspace/index.html">Early Userspace</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pm/index.html">CPU and Device Power Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../clk.html">The Common Clk Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="../device-io.html">Bus-Independent Device Accesses</a></li>
<li class="toctree-l2"><a class="reference internal" href="../device_connection.html">Device connections</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dma-buf.html">Buffer Sharing and Synchronization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../device_link.html">Device links</a></li>
<li class="toctree-l2"><a class="reference internal" href="../component.html">Component Helper for Aggregate Drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../message-based.html">Message-based devices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../infiniband.html">InfiniBand and Remote DMA (RDMA) Interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sound.html">Sound Devices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../frame-buffer.html">Frame Buffer Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../regulator.html">Voltage and current regulator API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l2"><a class="reference internal" href="../input.html">Input Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usb/index.html">Linux USB API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../firewire.html">Firewire (IEEE 1394) driver Interface Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pci/index.html">The Linux PCI driver implementer’s API guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../spi.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../i2c.html">I<sup>2</sup>C and SMBus Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ipmb.html">IPMB Driver for a Satellite MC</a></li>
<li class="toctree-l2"><a class="reference internal" href="../i3c/index.html">I3C subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../interconnect.html">Generic System Interconnect Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../devfreq.html">Device Frequency Scaling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hsi.html">High Speed Synchronous Serial Interface (HSI)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edac.html">Error Detection And Correction (EDAC) Devices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../scsi.html">SCSI Interfaces Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libata.html">libATA Developer’s Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../target.html">target and iSCSI Interfaces Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mtdnand.html">MTD NAND Driver Programming Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../miscellaneous.html">Parallel Port Devices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../miscellaneous.html#x50-uart-driver">16x50 UART Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../miscellaneous.html#pulse-width-modulation-pwm">Pulse-Width Modulation (PWM)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mei/index.html">Intel(R) Management Engine Interface (Intel(R) MEI)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mtd/index.html">Memory Technology Device (MTD)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mmc/index.html">MMC/SD/SDIO card support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../nvdimm/index.html">Non-Volatile Memory Device (NVDIMM)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../w1.html">W1: Dallas’ 1-wire bus</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rapidio/index.html">The Linux RapidIO Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../s390-drivers.html">Writing s390 channel device drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../vme.html">VME Device Drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../80211/index.html">Linux 802.11 Driver Developer’s Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../uio-howto.html">The Userspace I/O HOWTO</a></li>
<li class="toctree-l2"><a class="reference internal" href="../firmware/index.html">Linux Firmware API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pinctl.html">PINCTRL (PIN CONTROL) subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gpio/index.html">General Purpose Input/Output (GPIO)</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">RAID</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">MD Cluster</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#on-disk-format">1. On-disk format</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dlm-locks-for-management">2. DLM Locks for management</a></li>
<li class="toctree-l4"><a class="reference internal" href="#communication">3. Communication</a></li>
<li class="toctree-l4"><a class="reference internal" href="#handling-failures">4. Handling Failures</a></li>
<li class="toctree-l4"><a class="reference internal" href="#device-failure">4.2 Device Failure</a></li>
<li class="toctree-l4"><a class="reference internal" href="#module-interface">6. Module interface</a></li>
<li class="toctree-l4"><a class="reference internal" href="#unsupported-features">7. Unsupported features</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="raid5-cache.html">RAID 4/5/6 cache</a></li>
<li class="toctree-l3"><a class="reference internal" href="raid5-ppl.html">Partial Parity Log</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../misc_devices.html">Miscellaneous Devices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../nfc/index.html">Near Field Communication</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dmaengine/index.html">DMAEngine documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../slimbus.html">Linux kernel SLIMbus support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../soundwire/index.html">SoundWire Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../thermal/index.html">Thermal</a></li>
<li class="toctree-l2"><a class="reference internal" href="../fpga/index.html">FPGA Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../acpi/index.html">ACPI Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../backlight/lp855x-driver.html">Kernel driver lp855x</a></li>
<li class="toctree-l2"><a class="reference internal" href="../connector.html">Kernel Connector</a></li>
<li class="toctree-l2"><a class="reference internal" href="../console.html">Console Drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dcdbas.html">Dell Systems Management Base Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edid.html">EDID</a></li>
<li class="toctree-l2"><a class="reference internal" href="../eisa.html">EISA bus support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ipmb.html">IPMB Driver for a Satellite MC</a></li>
<li class="toctree-l2"><a class="reference internal" href="../isa.html">ISA Drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../isapnp.html">ISA Plug &amp; Play support by Jaroslav Kysela &lt;perex&#64;suse.cz&gt;</a></li>
<li class="toctree-l2"><a class="reference internal" href="../generic-counter.html">Generic Counter Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lightnvm-pblk.html">pblk: Physical Block Device Target</a></li>
<li class="toctree-l2"><a class="reference internal" href="../memory-devices/index.html">Memory Controller drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../men-chameleon-bus.html">MEN Chameleon Bus</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ntb.html">NTB Drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../nvmem.html">NVMEM Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../parport-lowlevel.html">PARPORT interface documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pps.html">PPS - Pulse Per Second</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ptp.html">PTP hardware clock infrastructure for Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../phy/index.html">Generic PHY Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pti_intel_mid.html">Intel MID PTI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pwm.html">Pulse Width Modulation (PWM) interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rfkill.html">rfkill - RF kill switch support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../serial/index.html">Support for Serial devices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sm501.html">SM501 Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../smsc_ece1099.html">Msc Keyboard Scan Expansion/GPIO Expansion device</a></li>
<li class="toctree-l2"><a class="reference internal" href="../switchtec.html">Linux Switchtec Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sync_file.html">Sync File API Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../vfio-mediated-device.html">VFIO Mediated devices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../vfio.html">VFIO - “Virtual Function I/O” </a></li>
<li class="toctree-l2"><a class="reference internal" href="../xilinx/index.html">Xilinx FPGA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../xillybus.html">Xillybus driver for generic FPGA interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../zorro.html">Writing Device Drivers for Zorro Devices</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../locking/index.html">locking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../accounting/index.html">Accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../block/index.html">Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cdrom/index.html">cdrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ide/index.html">Integrated Drive Electronics (IDE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fpga/index.html">fpga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../isdn/index.html">ISDN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../leds/index.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../media/index.html">Linux Media Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../power/index.html">Power Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../timers/index.html">timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../virt/index.html">Linux Virtualization Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usb/index.html">USB support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mic/index.html">Intel Many Integrated Core (MIC) architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scheduler/index.html">Linux Scheduler</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../asm-annotations.html">Assembler Annotations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../arm/index.html">ARM Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../arm64/index.html">ARM64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ia64/index.html">IA-64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../m68k/index.html">m68k Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mips/index.html">MIPS-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nios2/nios2.html">Linux on the Nios II architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../openrisc/index.html">OpenRISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../parisc/index.html">PA-RISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../powerpc/index.html">powerpc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../riscv/index.html">RISC-V architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../s390/index.html">s390 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sh/index.html">SuperH Interfaces Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sparc/index.html">Sparc Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../x86/index.html">x86-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../xtensa/index.html">Xtensa Architecture</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../filesystems/ext4/index.html">ext4 Data Structures and Algorithms</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">The Linux driver implementer’s API guide</a> &raquo;</li>
        
          <li><a href="index.html">RAID</a> &raquo;</li>
        
      <li>MD Cluster</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/driver-api/md/md-cluster.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="md-cluster">
<h1>MD Cluster<a class="headerlink" href="#md-cluster" title="Permalink to this headline">¶</a></h1>
<p>The cluster MD is a shared-device RAID for a cluster, it supports
two levels: raid1 and raid10 (limited support).</p>
<div class="section" id="on-disk-format">
<h2>1. On-disk format<a class="headerlink" href="#on-disk-format" title="Permalink to this headline">¶</a></h2>
<p>Separate write-intent-bitmaps are used for each cluster node.
The bitmaps record all writes that may have been started on that node,
and may not yet have finished. The on-disk layout is:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>0                    4k                     8k                    12k
-------------------------------------------------------------------
| idle                | md super            | bm super [0] + bits |
| bm bits[0, contd]   | bm super[1] + bits  | bm bits[1, contd]   |
| bm super[2] + bits  | bm bits [2, contd]  | bm super[3] + bits  |
| bm bits [3, contd]  |                     |                     |
</pre></div>
</div>
<p>During “normal” functioning we assume the filesystem ensures that only
one node writes to any given block at a time, so a write request will</p>
<blockquote>
<div><ul class="simple">
<li>set the appropriate bit (if not already set)</li>
<li>commit the write to all mirrors</li>
<li>schedule the bit to be cleared after a timeout.</li>
</ul>
</div></blockquote>
<p>Reads are just handled normally. It is up to the filesystem to ensure
one node doesn’t read from a location where another node (or the same
node) is writing.</p>
</div>
<div class="section" id="dlm-locks-for-management">
<h2>2. DLM Locks for management<a class="headerlink" href="#dlm-locks-for-management" title="Permalink to this headline">¶</a></h2>
<p>There are three groups of locks for managing the device:</p>
<div class="section" id="bitmap-lock-resource-bm-lockres">
<h3>2.1 Bitmap lock resource (bm_lockres)<a class="headerlink" href="#bitmap-lock-resource-bm-lockres" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>The bm_lockres protects individual node bitmaps. They are named in
the form bitmap000 for node 1, bitmap001 for node 2 and so on. When a
node joins the cluster, it acquires the lock in PW mode and it stays
so during the lifetime the node is part of the cluster. The lock
resource number is based on the slot number returned by the DLM
subsystem. Since DLM starts node count from one and bitmap slots
start from zero, one is subtracted from the DLM slot number to arrive
at the bitmap slot number.</p>
<p>The LVB of the bitmap lock for a particular node records the range
of sectors that are being re-synced by that node.  No other
node may write to those sectors.  This is used when a new nodes
joins the cluster.</p>
</div></blockquote>
</div>
<div class="section" id="message-passing-locks">
<h3>2.2 Message passing locks<a class="headerlink" href="#message-passing-locks" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div>Each node has to communicate with other nodes when starting or ending
resync, and for metadata superblock updates.  This communication is
managed through three locks: “token”, “message”, and “ack”, together
with the Lock Value Block (LVB) of one of the “message” lock.</div></blockquote>
</div>
<div class="section" id="new-device-management">
<h3>2.3 new-device management<a class="headerlink" href="#new-device-management" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div>A single lock: “no-new-dev” is used to co-ordinate the addition of
new devices - this must be synchronized across the array.
Normally all nodes hold a concurrent-read lock on this device.</div></blockquote>
</div>
</div>
<div class="section" id="communication">
<h2>3. Communication<a class="headerlink" href="#communication" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div>Messages can be broadcast to all nodes, and the sender waits for all
other nodes to acknowledge the message before proceeding.  Only one
message can be processed at a time.</div></blockquote>
<div class="section" id="message-types">
<h3>3.1 Message Types<a class="headerlink" href="#message-types" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div>There are six types of messages which are passed:</div></blockquote>
<div class="section" id="metadata-updated">
<h4>3.1.1 METADATA_UPDATED<a class="headerlink" href="#metadata-updated" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div>informs other nodes that the metadata has
been updated, and the node must re-read the md superblock. This is
performed synchronously. It is primarily used to signal device
failure.</div></blockquote>
</div>
<div class="section" id="resyncing">
<h4>3.1.2 RESYNCING<a class="headerlink" href="#resyncing" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div>informs other nodes that a resync is initiated or
ended so that each node may suspend or resume the region.  Each
RESYNCING message identifies a range of the devices that the
sending node is about to resync. This overrides any previous
notification from that node: only one ranged can be resynced at a
time per-node.</div></blockquote>
</div>
<div class="section" id="newdisk">
<h4>3.1.3 NEWDISK<a class="headerlink" href="#newdisk" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div>informs other nodes that a device is being added to
the array. Message contains an identifier for that device.  See
below for further details.</div></blockquote>
</div>
<div class="section" id="remove">
<h4>3.1.4 REMOVE<a class="headerlink" href="#remove" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><blockquote>
<div>A failed or spare device is being removed from the
array. The slot-number of the device is included in the message.</div></blockquote>
<p>3.1.5 RE_ADD:</p>
<blockquote>
<div>A failed device is being re-activated - the assumption
is that it has been determined to be working again.</div></blockquote>
<p>3.1.6 BITMAP_NEEDS_SYNC:</p>
<blockquote>
<div>If a node is stopped locally but the bitmap
isn’t clean, then another node is informed to take the ownership of
resync.</div></blockquote>
</div></blockquote>
</div>
</div>
<div class="section" id="communication-mechanism">
<h3>3.2 Communication mechanism<a class="headerlink" href="#communication-mechanism" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div>The DLM LVB is used to communicate within nodes of the cluster. There
are three resources used for the purpose:</div></blockquote>
<div class="section" id="token">
<h4>3.2.1 token<a class="headerlink" href="#token" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div>The resource which protects the entire communication
system. The node having the token resource is allowed to
communicate.</div></blockquote>
</div>
<div class="section" id="message">
<h4>3.2.2 message<a class="headerlink" href="#message" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div>The lock resource which carries the data to communicate.</div></blockquote>
</div>
<div class="section" id="ack">
<h4>3.2.3 ack<a class="headerlink" href="#ack" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div>The resource, acquiring which means the message has been
acknowledged by all nodes in the cluster. The BAST of the resource
is used to inform the receiving node that a node wants to
communicate.</div></blockquote>
<p>The algorithm is:</p>
<blockquote>
<div><ol class="arabic">
<li><p class="first">receive status - all nodes have concurrent-reader lock on “ack”:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>sender                         receiver                 receiver
&quot;ack&quot;:CR                       &quot;ack&quot;:CR                 &quot;ack&quot;:CR
</pre></div>
</div>
</li>
<li><p class="first">sender get EX on “token”,
sender get EX on “message”:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>sender                        receiver                 receiver
&quot;token&quot;:EX                    &quot;ack&quot;:CR                 &quot;ack&quot;:CR
&quot;message&quot;:EX
&quot;ack&quot;:CR
</pre></div>
</div>
<p>Sender checks that it still needs to send a message. Messages
received or other events that happened while waiting for the
“token” may have made this message inappropriate or redundant.</p>
</li>
<li><p class="first">sender writes LVB</p>
<p>sender down-convert “message” from EX to CW</p>
<p>sender try to get EX of “ack”</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span> [ wait until all receivers have *processed* the &quot;message&quot; ]

                                  [ triggered by bast of &quot;ack&quot; ]
                                  receiver get CR on &quot;message&quot;
                                  receiver read LVB
                                  receiver processes the message
                                  [ wait finish ]
                                  receiver releases &quot;ack&quot;
                                  receiver tries to get PR on &quot;message&quot;

sender                         receiver                  receiver
&quot;token&quot;:EX                     &quot;message&quot;:CR              &quot;message&quot;:CR
&quot;message&quot;:CW
&quot;ack&quot;:EX
</pre></div>
</div>
</li>
<li><p class="first">triggered by grant of EX on “ack” (indicating all receivers
have processed message)</p>
<p>sender down-converts “ack” from EX to CR</p>
<p>sender releases “message”</p>
<p>sender releases “token”</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>                            receiver upconvert to PR on &quot;message&quot;
                            receiver get CR of &quot;ack&quot;
                            receiver release &quot;message&quot;

sender                      receiver                   receiver
&quot;ack&quot;:CR                    &quot;ack&quot;:CR                   &quot;ack&quot;:CR
</pre></div>
</div>
</li>
</ol>
</div></blockquote>
</div>
</div>
</div>
<div class="section" id="handling-failures">
<h2>4. Handling Failures<a class="headerlink" href="#handling-failures" title="Permalink to this headline">¶</a></h2>
<div class="section" id="node-failure">
<h3>4.1 Node Failure<a class="headerlink" href="#node-failure" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>When a node fails, the DLM informs the cluster with the slot
number. The node starts a cluster recovery thread. The cluster
recovery thread:</p>
<blockquote>
<div><ul class="simple">
<li>acquires the bitmap&lt;number&gt; lock of the failed node</li>
<li>opens the bitmap</li>
<li>reads the bitmap of the failed node</li>
<li>copies the set bitmap to local node</li>
<li>cleans the bitmap of the failed node</li>
<li>releases bitmap&lt;number&gt; lock of the failed node</li>
<li>initiates resync of the bitmap on the current node
md_check_recovery is invoked within recover_bitmaps,
then md_check_recovery -&gt; metadata_update_start/finish,
it will lock the communication by lock_comm.
Which means when one node is resyncing it blocks all
other nodes from writing anywhere on the array.</li>
</ul>
</div></blockquote>
<p>The resync process is the regular md resync. However, in a clustered
environment when a resync is performed, it needs to tell other nodes
of the areas which are suspended. Before a resync starts, the node
send out RESYNCING with the (lo,hi) range of the area which needs to
be suspended. Each node maintains a suspend_list, which contains the
list of ranges which are currently suspended. On receiving RESYNCING,
the node adds the range to the suspend_list. Similarly, when the node
performing resync finishes, it sends RESYNCING with an empty range to
other nodes and other nodes remove the corresponding entry from the
suspend_list.</p>
<p>A helper function, -&gt;area_resyncing() can be used to check if a
particular I/O range should be suspended or not.</p>
</div></blockquote>
</div>
</div>
<div class="section" id="device-failure">
<h2>4.2 Device Failure<a class="headerlink" href="#device-failure" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div>Device failures are handled and communicated with the metadata update
routine.  When a node detects a device failure it does not allow
any further writes to that device until the failure has been
acknowledged by all other nodes.</div></blockquote>
<div class="section" id="adding-a-new-device">
<h3>5. Adding a new Device<a class="headerlink" href="#adding-a-new-device" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>For adding a new device, it is necessary that all nodes “see” the new
device to be added. For this, the following algorithm is used:</p>
<blockquote>
<div><ol class="arabic simple">
<li>Node 1 issues mdadm –manage /dev/mdX –add /dev/sdYY which issues
ioctl(ADD_NEW_DISK with disc.state set to MD_DISK_CLUSTER_ADD)</li>
<li>Node 1 sends a NEWDISK message with uuid and slot number</li>
<li>Other nodes issue kobject_uevent_env with uuid and slot number
(Steps 4,5 could be a udev rule)</li>
<li>In userspace, the node searches for the disk, perhaps
using blkid -t SUB_UUID=””</li>
<li>Other nodes issue either of the following depending on whether
the disk was found:
ioctl(ADD_NEW_DISK with disc.state set to MD_DISK_CANDIDATE and
disc.number set to slot number)
ioctl(CLUSTERED_DISK_NACK)</li>
<li>Other nodes drop lock on “no-new-devs” (CR) if device is found</li>
<li>Node 1 attempts EX lock on “no-new-dev”</li>
<li>If node 1 gets the lock, it sends METADATA_UPDATED after
unmarking the disk as SpareLocal</li>
<li>If not (get “no-new-dev” lock), it fails the operation and sends
METADATA_UPDATED.</li>
<li>Other nodes get the information whether a disk is added or not
by the following METADATA_UPDATED.</li>
</ol>
</div></blockquote>
</div></blockquote>
</div>
</div>
<div class="section" id="module-interface">
<h2>6. Module interface<a class="headerlink" href="#module-interface" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div>There are 17 call-backs which the md core can make to the cluster
module.  Understanding these can give a good overview of the whole
process.</div></blockquote>
<div class="section" id="join-nodes-and-leave">
<h3>6.1 join(nodes) and leave()<a class="headerlink" href="#join-nodes-and-leave" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div>These are called when an array is started with a clustered bitmap,
and when the array is stopped.  join() ensures the cluster is
available and initializes the various resources.
Only the first ‘nodes’ nodes in the cluster can use the array.</div></blockquote>
</div>
<div class="section" id="slot-number">
<h3>6.2 slot_number()<a class="headerlink" href="#slot-number" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div>Reports the slot number advised by the cluster infrastructure.
Range is from 0 to nodes-1.</div></blockquote>
</div>
<div class="section" id="resync-info-update">
<h3>6.3 resync_info_update()<a class="headerlink" href="#resync-info-update" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div>This updates the resync range that is stored in the bitmap lock.
The starting point is updated as the resync progresses.  The
end point is always the end of the array.
It does <em>not</em> send a RESYNCING message.</div></blockquote>
</div>
<div class="section" id="resync-start-resync-finish">
<h3>6.4 resync_start(), resync_finish()<a class="headerlink" href="#resync-start-resync-finish" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>These are called when resync/recovery/reshape starts or stops.
They update the resyncing range in the bitmap lock and also
send a RESYNCING message.  resync_start reports the whole
array as resyncing, resync_finish reports none of it.</p>
<p>resync_finish() also sends a BITMAP_NEEDS_SYNC message which
allows some other node to take over.</p>
</div></blockquote>
</div>
<div class="section" id="metadata-update-start-metadata-update-finish-metadata-update-cancel">
<h3>6.5 metadata_update_start(), metadata_update_finish(), metadata_update_cancel()<a class="headerlink" href="#metadata-update-start-metadata-update-finish-metadata-update-cancel" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div>metadata_update_start is used to get exclusive access to
the metadata.  If a change is still needed once that access is
gained, metadata_update_finish() will send a METADATA_UPDATE
message to all other nodes, otherwise metadata_update_cancel()
can be used to release the lock.</div></blockquote>
</div>
<div class="section" id="area-resyncing">
<h3>6.6 area_resyncing()<a class="headerlink" href="#area-resyncing" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>This combines two elements of functionality.</p>
<p>Firstly, it will check if any node is currently resyncing
anything in a given range of sectors.  If any resync is found,
then the caller will avoid writing or read-balancing in that
range.</p>
<p>Secondly, while node recovery is happening it reports that
all areas are resyncing for READ requests.  This avoids races
between the cluster-filesystem and the cluster-RAID handling
a node failure.</p>
</div></blockquote>
</div>
<div class="section" id="add-new-disk-start-add-new-disk-finish-new-disk-ack">
<h3>6.7 add_new_disk_start(), add_new_disk_finish(), new_disk_ack()<a class="headerlink" href="#add-new-disk-start-add-new-disk-finish-new-disk-ack" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>These are used to manage the new-disk protocol described above.
When a new device is added, add_new_disk_start() is called before
it is bound to the array and, if that succeeds, add_new_disk_finish()
is called the device is fully added.</p>
<p>When a device is added in acknowledgement to a previous
request, or when the device is declared “unavailable”,
new_disk_ack() is called.</p>
</div></blockquote>
</div>
<div class="section" id="remove-disk">
<h3>6.8 remove_disk()<a class="headerlink" href="#remove-disk" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div>This is called when a spare or failed device is removed from
the array.  It causes a REMOVE message to be send to other nodes.</div></blockquote>
</div>
<div class="section" id="gather-bitmaps">
<h3>6.9 gather_bitmaps()<a class="headerlink" href="#gather-bitmaps" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div>This sends a RE_ADD message to all other nodes and then
gathers bitmap information from all bitmaps.  This combined
bitmap is then used to recovery the re-added device.</div></blockquote>
</div>
<div class="section" id="lock-all-bitmaps-and-unlock-all-bitmaps">
<h3>6.10 lock_all_bitmaps() and unlock_all_bitmaps()<a class="headerlink" href="#lock-all-bitmaps-and-unlock-all-bitmaps" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div>These are called when change bitmap to none. If a node plans
to clear the cluster raid’s bitmap, it need to make sure no other
nodes are using the raid which is achieved by lock all bitmap
locks within the cluster, and also those locks are unlocked
accordingly.</div></blockquote>
</div>
</div>
<div class="section" id="unsupported-features">
<h2>7. Unsupported features<a class="headerlink" href="#unsupported-features" title="Permalink to this headline">¶</a></h2>
<p>There are somethings which are not supported by cluster MD yet.</p>
<ul class="simple">
<li>change array_sectors.</li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="raid5-cache.html" class="btn btn-neutral float-right" title="RAID 4/5/6 cache" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral float-left" title="RAID" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>