

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Protected Execution Facility &mdash; The Linux Kernel  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.7.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/mm/damon/index.html">Monitoring Data Accesses</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../vm/damon/index.html">DAMON: Data Access MONitor</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Protected Execution Facility</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/powerpc/ultravisor.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="protected-execution-facility">
<span id="ultravisor"></span><h1><a class="toc-backref" href="#id65">Protected Execution Facility</a><a class="headerlink" href="#protected-execution-facility" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#protected-execution-facility" id="id65">Protected Execution Facility</a><ul>
<li><a class="reference internal" href="#introduction" id="id66">Introduction</a><ul>
<li><a class="reference internal" href="#hardware" id="id67">Hardware</a></li>
<li><a class="reference internal" href="#software-microcode" id="id68">Software/Microcode</a></li>
<li><a class="reference internal" href="#terminology" id="id69">Terminology</a></li>
</ul>
</li>
<li><a class="reference internal" href="#ultravisor-calls-api" id="id70">Ultravisor calls API</a><ul>
<li><a class="reference internal" href="#ultracalls-used-by-hypervisor" id="id71">Ultracalls used by Hypervisor</a></li>
<li><a class="reference internal" href="#ultracalls-used-by-svm" id="id72">Ultracalls used by SVM</a></li>
</ul>
</li>
<li><a class="reference internal" href="#hypervisor-calls-api" id="id73">Hypervisor Calls API</a><ul>
<li><a class="reference internal" href="#hypervisor-calls-to-support-ultravisor" id="id74">Hypervisor calls to support Ultravisor</a></li>
</ul>
</li>
<li><a class="reference internal" href="#references" id="id75">References</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id66">Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Protected Execution Facility (PEF) is an architectural change for
POWER 9 that enables Secure Virtual Machines (SVMs). DD2.3 chips
(PVR=0x004e1203) or greater will be PEF-capable. A new ISA release
will include the PEF RFC02487 changes.</p>
<p>When enabled, PEF adds a new higher privileged mode, called Ultravisor
mode, to POWER architecture. Along with the new mode there is new
firmware called the Protected Execution Ultravisor (or Ultravisor
for short). Ultravisor mode is the highest privileged mode in POWER
architecture.</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="100%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Privilege States</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Problem</td>
</tr>
<tr class="row-odd"><td>Supervisor</td>
</tr>
<tr class="row-even"><td>Hypervisor</td>
</tr>
<tr class="row-odd"><td>Ultravisor</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>PEF protects SVMs from the hypervisor, privileged users, and other
VMs in the system. SVMs are protected while at rest and can only be
executed by an authorized machine. All virtual machines utilize
hypervisor services. The Ultravisor filters calls between the SVMs
and the hypervisor to assure that information does not accidentally
leak. All hypercalls except H_RANDOM are reflected to the hypervisor.
H_RANDOM is not reflected to prevent the hypervisor from influencing
random values in the SVM.</p>
<p>To support this there is a refactoring of the ownership of resources
in the CPU. Some of the resources which were previously hypervisor
privileged are now ultravisor privileged.</p>
</div></blockquote>
<div class="section" id="hardware">
<h3><a class="toc-backref" href="#id67">Hardware</a><a class="headerlink" href="#hardware" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>The hardware changes include the following:</p>
<ul>
<li><p class="first">There is a new bit in the MSR that determines whether the current
process is running in secure mode, MSR(S) bit 41. MSR(S)=1, process
is in secure mode, MSR(s)=0 process is in normal mode.</p>
</li>
<li><p class="first">The MSR(S) bit can only be set by the Ultravisor.</p>
</li>
<li><p class="first">HRFID cannot be used to set the MSR(S) bit. If the hypervisor needs
to return to a SVM it must use an ultracall. It can determine if
the VM it is returning to is secure.</p>
</li>
<li><p class="first">There is a new Ultravisor privileged register, SMFCTRL, which has an
enable/disable bit SMFCTRL(E).</p>
</li>
<li><p class="first">The privilege of a process is now determined by three MSR bits,
MSR(S, HV, PR). In each of the tables below the modes are listed
from least privilege to highest privilege. The higher privilege
modes can access all the resources of the lower privilege modes.</p>
<p><strong>Secure Mode MSR Settings</strong></p>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="13%" />
<col width="13%" />
<col width="63%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">S</th>
<th class="head">HV</th>
<th class="head">PR</th>
<th class="head">Privilege</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>1</td>
<td>0</td>
<td>1</td>
<td>Problem</td>
</tr>
<tr class="row-odd"><td>1</td>
<td>0</td>
<td>0</td>
<td>Privileged(OS)</td>
</tr>
<tr class="row-even"><td>1</td>
<td>1</td>
<td>0</td>
<td>Ultravisor</td>
</tr>
<tr class="row-odd"><td>1</td>
<td>1</td>
<td>1</td>
<td>Reserved</td>
</tr>
</tbody>
</table>
<p><strong>Normal Mode MSR Settings</strong></p>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="13%" />
<col width="13%" />
<col width="63%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">S</th>
<th class="head">HV</th>
<th class="head">PR</th>
<th class="head">Privilege</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>0</td>
<td>0</td>
<td>1</td>
<td>Problem</td>
</tr>
<tr class="row-odd"><td>0</td>
<td>0</td>
<td>0</td>
<td>Privileged(OS)</td>
</tr>
<tr class="row-even"><td>0</td>
<td>1</td>
<td>0</td>
<td>Hypervisor</td>
</tr>
<tr class="row-odd"><td>0</td>
<td>1</td>
<td>1</td>
<td>Problem (Host)</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Memory is partitioned into secure and normal memory. Only processes
that are running in secure mode can access secure memory.</p>
</li>
<li><p class="first">The hardware does not allow anything that is not running secure to
access secure memory. This means that the Hypervisor cannot access
the memory of the SVM without using an ultracall (asking the
Ultravisor). The Ultravisor will only allow the hypervisor to see
the SVM memory encrypted.</p>
</li>
<li><p class="first">I/O systems are not allowed to directly address secure memory. This
limits the SVMs to virtual I/O only.</p>
</li>
<li><p class="first">The architecture allows the SVM to share pages of memory with the
hypervisor that are not protected with encryption. However, this
sharing must be initiated by the SVM.</p>
</li>
<li><p class="first">When a process is running in secure mode all hypercalls
(syscall lev=1) go to the Ultravisor.</p>
</li>
<li><p class="first">When a process is in secure mode all interrupts go to the
Ultravisor.</p>
</li>
<li><p class="first">The following resources have become Ultravisor privileged and
require an Ultravisor interface to manipulate:</p>
<ul class="simple">
<li>Processor configurations registers (SCOMs).</li>
<li>Stop state information.</li>
<li>The debug registers CIABR, DAWR, and DAWRX when SMFCTRL(D) is set.
If SMFCTRL(D) is not set they do not work in secure mode. When set,
reading and writing requires an Ultravisor call, otherwise that
will cause a Hypervisor Emulation Assistance interrupt.</li>
<li>PTCR and partition table entries (partition table is in secure
memory). An attempt to write to PTCR will cause a Hypervisor
Emulation Assitance interrupt.</li>
<li>LDBAR (LD Base Address Register) and IMC (In-Memory Collection)
non-architected registers. An attempt to write to them will cause a
Hypervisor Emulation Assistance interrupt.</li>
<li>Paging for an SVM, sharing of memory with Hypervisor for an SVM.
(Including Virtual Processor Area (VPA) and virtual I/O).</li>
</ul>
</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="software-microcode">
<h3><a class="toc-backref" href="#id68">Software/Microcode</a><a class="headerlink" href="#software-microcode" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>The software changes include:</p>
<ul class="simple">
<li>SVMs are created from normal VM using (open source) tooling supplied
by IBM.</li>
<li>All SVMs start as normal VMs and utilize an ultracall, UV_ESM
(Enter Secure Mode), to make the transition.</li>
<li>When the UV_ESM ultracall is made the Ultravisor copies the VM into
secure memory, decrypts the verification information, and checks the
integrity of the SVM. If the integrity check passes the Ultravisor
passes control in secure mode.</li>
<li>The verification information includes the pass phrase for the
encrypted disk associated with the SVM. This pass phrase is given
to the SVM when requested.</li>
<li>The Ultravisor is not involved in protecting the encrypted disk of
the SVM while at rest.</li>
<li>For external interrupts the Ultravisor saves the state of the SVM,
and reflects the interrupt to the hypervisor for processing.
For hypercalls, the Ultravisor inserts neutral state into all
registers not needed for the hypercall then reflects the call to
the hypervisor for processing. The H_RANDOM hypercall is performed
by the Ultravisor and not reflected.</li>
<li>For virtual I/O to work bounce buffering must be done.</li>
<li>The Ultravisor uses AES (IAPM) for protection of SVM memory. IAPM
is a mode of AES that provides integrity and secrecy concurrently.</li>
<li>The movement of data between normal and secure pages is coordinated
with the Ultravisor by a new HMM plug-in in the Hypervisor.</li>
</ul>
<p>The Ultravisor offers new services to the hypervisor and SVMs. These
are accessed through ultracalls.</p>
</div></blockquote>
</div>
<div class="section" id="terminology">
<h3><a class="toc-backref" href="#id69">Terminology</a><a class="headerlink" href="#terminology" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li>Hypercalls: special system calls used to request services from
Hypervisor.</li>
<li>Normal memory: Memory that is accessible to Hypervisor.</li>
<li>Normal page: Page backed by normal memory and available to
Hypervisor.</li>
<li>Shared page: A page backed by normal memory and available to both
the Hypervisor/QEMU and the SVM (i.e page has mappings in SVM and
Hypervisor/QEMU).</li>
<li>Secure memory: Memory that is accessible only to Ultravisor and
SVMs.</li>
<li>Secure page: Page backed by secure memory and only available to
Ultravisor and SVM.</li>
<li>SVM: Secure Virtual Machine.</li>
<li>Ultracalls: special system calls used to request services from
Ultravisor.</li>
</ul>
</div></blockquote>
</div>
</div>
<div class="section" id="ultravisor-calls-api">
<h2><a class="toc-backref" href="#id70">Ultravisor calls API</a><a class="headerlink" href="#ultravisor-calls-api" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>This section describes Ultravisor calls (ultracalls) needed to
support Secure Virtual Machines (SVM)s and Paravirtualized KVM. The
ultracalls allow the SVMs and Hypervisor to request services from the
Ultravisor such as accessing a register or memory region that can only
be accessed when running in Ultravisor-privileged mode.</p>
<p>The specific service needed from an ultracall is specified in register
R3 (the first parameter to the ultracall). Other parameters to the
ultracall, if any, are specified in registers R4 through R12.</p>
<p>Return value of all ultracalls is in register R3. Other output values
from the ultracall, if any, are returned in registers R4 through R12.
The only exception to this register usage is the <code class="docutils literal notranslate"><span class="pre">UV_RETURN</span></code>
ultracall described below.</p>
<p>Each ultracall returns specific error codes, applicable in the context
of the ultracall. However, like with the PowerPC Architecture Platform
Reference (PAPR), if no specific error code is defined for a
particular situation, then the ultracall will fallback to an erroneous
parameter-position based code. i.e U_PARAMETER, U_P2, U_P3 etc
depending on the ultracall parameter that may have caused the error.</p>
<p>Some ultracalls involve transferring a page of data between Ultravisor
and Hypervisor.  Secure pages that are transferred from secure memory
to normal memory may be encrypted using dynamically generated keys.
When the secure pages are transferred back to secure memory, they may
be decrypted using the same dynamically generated keys. Generation and
management of these keys will be covered in a separate document.</p>
<p>For now this only covers ultracalls currently implemented and being
used by Hypervisor and SVMs but others can be added here when it
makes sense.</p>
<p>The full specification for all hypercalls/ultracalls will eventually
be made available in the public/OpenPower version of the PAPR
specification.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If PEF is not enabled, the ultracalls will be redirected to the
Hypervisor which must handle/fail the calls.</p>
</div>
</div></blockquote>
<div class="section" id="ultracalls-used-by-hypervisor">
<h3><a class="toc-backref" href="#id71">Ultracalls used by Hypervisor</a><a class="headerlink" href="#ultracalls-used-by-hypervisor" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div>This section describes the virtual memory management ultracalls used
by the Hypervisor to manage SVMs.</div></blockquote>
<div class="section" id="uv-page-out">
<h4>UV_PAGE_OUT<a class="headerlink" href="#uv-page-out" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div>Encrypt and move the contents of a page from secure memory to normal
memory.</div></blockquote>
<div class="section" id="syntax">
<h5>Syntax<a class="headerlink" href="#syntax" title="Permalink to this headline">¶</a></h5>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">uint64_t</span> <span class="n">ultracall</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">UV_PAGE_OUT</span><span class="p">,</span>
        <span class="kt">uint16_t</span> <span class="n">lpid</span><span class="p">,</span>          <span class="cm">/* LPAR ID */</span>
        <span class="kt">uint64_t</span> <span class="n">dest_ra</span><span class="p">,</span>       <span class="cm">/* real address of destination page */</span>
        <span class="kt">uint64_t</span> <span class="n">src_gpa</span><span class="p">,</span>       <span class="cm">/* source guest-physical-address */</span>
        <span class="kt">uint8_t</span>  <span class="n">flags</span><span class="p">,</span>         <span class="cm">/* flags */</span>
        <span class="kt">uint64_t</span> <span class="n">order</span><span class="p">)</span>         <span class="cm">/* page size order */</span>
</pre></div>
</div>
</div>
<div class="section" id="return-values">
<h5>Return values<a class="headerlink" href="#return-values" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><p>One of the following values:</p>
<blockquote>
<div><ul class="simple">
<li>U_SUCCESS     on success.</li>
<li>U_PARAMETER   if <code class="docutils literal notranslate"><span class="pre">lpid</span></code> is invalid.</li>
<li>U_P2          if <code class="docutils literal notranslate"><span class="pre">dest_ra</span></code> is invalid.</li>
<li>U_P3          if the <code class="docutils literal notranslate"><span class="pre">src_gpa</span></code> address is invalid.</li>
<li>U_P4          if any bit in the <code class="docutils literal notranslate"><span class="pre">flags</span></code> is unrecognized</li>
<li>U_P5          if the <code class="docutils literal notranslate"><span class="pre">order</span></code> parameter is unsupported.</li>
<li>U_FUNCTION    if functionality is not supported.</li>
<li>U_BUSY        if page cannot be currently paged-out.</li>
</ul>
</div></blockquote>
</div></blockquote>
</div>
<div class="section" id="description">
<h5>Description<a class="headerlink" href="#description" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><p>Encrypt the contents of a secure-page and make it available to
Hypervisor in a normal page.</p>
<p>By default, the source page is unmapped from the SVM’s partition-
scoped page table. But the Hypervisor can provide a hint to the
Ultravisor to retain the page mapping by setting the <code class="docutils literal notranslate"><span class="pre">UV_SNAPSHOT</span></code>
flag in <code class="docutils literal notranslate"><span class="pre">flags</span></code> parameter.</p>
<p>If the source page is already a shared page the call returns
U_SUCCESS, without doing anything.</p>
</div></blockquote>
</div>
<div class="section" id="use-cases">
<h5>Use cases<a class="headerlink" href="#use-cases" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><ol class="arabic simple">
<li>QEMU attempts to access an address belonging to the SVM but the
page frame for that address is not mapped into QEMU’s address
space. In this case, the Hypervisor will allocate a page frame,
map it into QEMU’s address space and issue the <code class="docutils literal notranslate"><span class="pre">UV_PAGE_OUT</span></code>
call to retrieve the encrypted contents of the page.</li>
<li>When Ultravisor runs low on secure memory and it needs to page-out
an LRU page. In this case, Ultravisor will issue the
<code class="docutils literal notranslate"><span class="pre">H_SVM_PAGE_OUT</span></code> hypercall to the Hypervisor. The Hypervisor will
then allocate a normal page and issue the <code class="docutils literal notranslate"><span class="pre">UV_PAGE_OUT</span></code> ultracall
and the Ultravisor will encrypt and move the contents of the secure
page into the normal page.</li>
<li>When Hypervisor accesses SVM data, the Hypervisor requests the
Ultravisor to transfer the corresponding page into a insecure page,
which the Hypervisor can access. The data in the normal page will
be encrypted though.</li>
</ol>
</div></blockquote>
</div>
</div>
<div class="section" id="uv-page-in">
<h4>UV_PAGE_IN<a class="headerlink" href="#uv-page-in" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div>Move the contents of a page from normal memory to secure memory.</div></blockquote>
<div class="section" id="id1">
<h5>Syntax<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h5>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">uint64_t</span> <span class="n">ultracall</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">UV_PAGE_IN</span><span class="p">,</span>
        <span class="kt">uint16_t</span> <span class="n">lpid</span><span class="p">,</span>          <span class="cm">/* the LPAR ID */</span>
        <span class="kt">uint64_t</span> <span class="n">src_ra</span><span class="p">,</span>        <span class="cm">/* source real address of page */</span>
        <span class="kt">uint64_t</span> <span class="n">dest_gpa</span><span class="p">,</span>      <span class="cm">/* destination guest physical address */</span>
        <span class="kt">uint64_t</span> <span class="n">flags</span><span class="p">,</span>         <span class="cm">/* flags */</span>
        <span class="kt">uint64_t</span> <span class="n">order</span><span class="p">)</span>         <span class="cm">/* page size order */</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h5>Return values<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><p>One of the following values:</p>
<blockquote>
<div><ul class="simple">
<li>U_SUCCESS     on success.</li>
<li>U_BUSY        if page cannot be currently paged-in.</li>
<li>U_FUNCTION    if functionality is not supported</li>
<li>U_PARAMETER   if <code class="docutils literal notranslate"><span class="pre">lpid</span></code> is invalid.</li>
<li>U_P2          if <code class="docutils literal notranslate"><span class="pre">src_ra</span></code> is invalid.</li>
<li>U_P3          if the <code class="docutils literal notranslate"><span class="pre">dest_gpa</span></code> address is invalid.</li>
<li>U_P4          if any bit in the <code class="docutils literal notranslate"><span class="pre">flags</span></code> is unrecognized</li>
<li>U_P5          if the <code class="docutils literal notranslate"><span class="pre">order</span></code> parameter is unsupported.</li>
</ul>
</div></blockquote>
</div></blockquote>
</div>
<div class="section" id="id3">
<h5>Description<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><p>Move the contents of the page identified by <code class="docutils literal notranslate"><span class="pre">src_ra</span></code> from normal
memory to secure memory and map it to the guest physical address
<code class="docutils literal notranslate"><span class="pre">dest_gpa</span></code>.</p>
<p>If <cite>dest_gpa</cite> refers to a shared address, map the page into the
partition-scoped page-table of the SVM.  If <cite>dest_gpa</cite> is not shared,
copy the contents of the page into the corresponding secure page.
Depending on the context, decrypt the page before being copied.</p>
<p>The caller provides the attributes of the page through the <code class="docutils literal notranslate"><span class="pre">flags</span></code>
parameter. Valid values for <code class="docutils literal notranslate"><span class="pre">flags</span></code> are:</p>
<blockquote>
<div><ul class="simple">
<li>CACHE_INHIBITED</li>
<li>CACHE_ENABLED</li>
<li>WRITE_PROTECTION</li>
</ul>
</div></blockquote>
<p>The Hypervisor must pin the page in memory before making
<code class="docutils literal notranslate"><span class="pre">UV_PAGE_IN</span></code> ultracall.</p>
</div></blockquote>
</div>
<div class="section" id="id4">
<h5>Use cases<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><ol class="arabic simple">
<li>When a normal VM switches to secure mode, all its pages residing
in normal memory, are moved into secure memory.</li>
<li>When an SVM requests to share a page with Hypervisor the Hypervisor
allocates a page and informs the Ultravisor.</li>
<li>When an SVM accesses a secure page that has been paged-out,
Ultravisor invokes the Hypervisor to locate the page. After
locating the page, the Hypervisor uses UV_PAGE_IN to make the
page available to Ultravisor.</li>
</ol>
</div></blockquote>
</div>
</div>
<div class="section" id="uv-page-inval">
<h4>UV_PAGE_INVAL<a class="headerlink" href="#uv-page-inval" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div>Invalidate the Ultravisor mapping of a page.</div></blockquote>
<div class="section" id="id5">
<h5>Syntax<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h5>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">uint64_t</span> <span class="n">ultracall</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">UV_PAGE_INVAL</span><span class="p">,</span>
        <span class="kt">uint16_t</span> <span class="n">lpid</span><span class="p">,</span>          <span class="cm">/* the LPAR ID */</span>
        <span class="kt">uint64_t</span> <span class="n">guest_pa</span><span class="p">,</span>      <span class="cm">/* destination guest-physical-address */</span>
        <span class="kt">uint64_t</span> <span class="n">order</span><span class="p">)</span>         <span class="cm">/* page size order */</span>
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h5>Return values<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><p>One of the following values:</p>
<blockquote>
<div><ul class="simple">
<li>U_SUCCESS     on success.</li>
<li>U_PARAMETER   if <code class="docutils literal notranslate"><span class="pre">lpid</span></code> is invalid.</li>
<li><dl class="first docutils">
<dt>U_P2          if <code class="docutils literal notranslate"><span class="pre">guest_pa</span></code> is invalid (or corresponds to a secure</dt>
<dd>page mapping).</dd>
</dl>
</li>
<li>U_P3          if the <code class="docutils literal notranslate"><span class="pre">order</span></code> is invalid.</li>
<li>U_FUNCTION    if functionality is not supported.</li>
<li>U_BUSY        if page cannot be currently invalidated.</li>
</ul>
</div></blockquote>
</div></blockquote>
</div>
<div class="section" id="id7">
<h5>Description<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div>This ultracall informs Ultravisor that the page mapping in Hypervisor
corresponding to the given guest physical address has been invalidated
and that the Ultravisor should not access the page. If the specified
<code class="docutils literal notranslate"><span class="pre">guest_pa</span></code> corresponds to a secure page, Ultravisor will ignore the
attempt to invalidate the page and return U_P2.</div></blockquote>
</div>
<div class="section" id="id8">
<h5>Use cases<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><ol class="arabic simple">
<li>When a shared page is unmapped from the QEMU’s page table, possibly
because it is paged-out to disk, Ultravisor needs to know that the
page should not be accessed from its side too.</li>
</ol>
</div></blockquote>
</div>
</div>
<div class="section" id="uv-write-pate">
<h4>UV_WRITE_PATE<a class="headerlink" href="#uv-write-pate" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div>Validate and write the partition table entry (PATE) for a given
partition.</div></blockquote>
<div class="section" id="id9">
<h5>Syntax<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h5>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">uint64_t</span> <span class="n">ultracall</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">UV_WRITE_PATE</span><span class="p">,</span>
        <span class="kt">uint32_t</span> <span class="n">lpid</span><span class="p">,</span>          <span class="cm">/* the LPAR ID */</span>
        <span class="kt">uint64_t</span> <span class="n">dw0</span>            <span class="cm">/* the first double word to write */</span>
        <span class="kt">uint64_t</span> <span class="n">dw1</span><span class="p">)</span>           <span class="cm">/* the second double word to write */</span>
</pre></div>
</div>
</div>
<div class="section" id="id10">
<h5>Return values<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><p>One of the following values:</p>
<blockquote>
<div><ul class="simple">
<li>U_SUCCESS     on success.</li>
<li>U_BUSY        if PATE cannot be currently written to.</li>
<li>U_FUNCTION    if functionality is not supported.</li>
<li>U_PARAMETER   if <code class="docutils literal notranslate"><span class="pre">lpid</span></code> is invalid.</li>
<li>U_P2          if <code class="docutils literal notranslate"><span class="pre">dw0</span></code> is invalid.</li>
<li>U_P3          if the <code class="docutils literal notranslate"><span class="pre">dw1</span></code> address is invalid.</li>
<li><dl class="first docutils">
<dt>U_PERMISSION  if the Hypervisor is attempting to change the PATE</dt>
<dd>of a secure virtual machine or if called from a
context other than Hypervisor.</dd>
</dl>
</li>
</ul>
</div></blockquote>
</div></blockquote>
</div>
<div class="section" id="id11">
<h5>Description<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div>Validate and write a LPID and its partition-table-entry for the given
LPID.  If the LPID is already allocated and initialized, this call
results in changing the partition table entry.</div></blockquote>
</div>
<div class="section" id="id12">
<h5>Use cases<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><ol class="arabic simple">
<li>The Partition table resides in Secure memory and its entries,
called PATE (Partition Table Entries), point to the partition-
scoped page tables for the Hypervisor as well as each of the
virtual machines (both secure and normal). The Hypervisor
operates in partition 0 and its partition-scoped page tables
reside in normal memory.</li>
<li>This ultracall allows the Hypervisor to register the partition-
scoped and process-scoped page table entries for the Hypervisor
and other partitions (virtual machines) with the Ultravisor.</li>
<li>If the value of the PATE for an existing partition (VM) changes,
the TLB cache for the partition is flushed.</li>
<li>The Hypervisor is responsible for allocating LPID. The LPID and
its PATE entry are registered together.  The Hypervisor manages
the PATE entries for a normal VM and can change the PATE entry
anytime. Ultravisor manages the PATE entries for an SVM and
Hypervisor is not allowed to modify them.</li>
</ol>
</div></blockquote>
</div>
</div>
<div class="section" id="uv-return">
<h4>UV_RETURN<a class="headerlink" href="#uv-return" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div>Return control from the Hypervisor back to the Ultravisor after
processing an hypercall or interrupt that was forwarded (aka
<em>reflected</em>) to the Hypervisor.</div></blockquote>
<div class="section" id="id13">
<h5>Syntax<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h5>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">uint64_t</span> <span class="n">ultracall</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">UV_RETURN</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id14">
<h5>Return values<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div>This call never returns to Hypervisor on success.  It returns
U_INVALID if ultracall is not made from a Hypervisor context.</div></blockquote>
</div>
<div class="section" id="id15">
<h5>Description<a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><p>When an SVM makes an hypercall or incurs some other exception, the
Ultravisor usually forwards (aka <em>reflects</em>) the exceptions to the
Hypervisor.  After processing the exception, Hypervisor uses the
<code class="docutils literal notranslate"><span class="pre">UV_RETURN</span></code> ultracall to return control back to the SVM.</p>
<p>The expected register state on entry to this ultracall is:</p>
<ul class="simple">
<li>Non-volatile registers are restored to their original values.</li>
<li>If returning from an hypercall, register R0 contains the return
value (<strong>unlike other ultracalls</strong>) and, registers R4 through R12
contain any output values of the hypercall.</li>
<li>R3 contains the ultracall number, i.e UV_RETURN.</li>
<li>If returning with a synthesized interrupt, R2 contains the
synthesized interrupt number.</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="id16">
<h5>Use cases<a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><ol class="arabic simple">
<li>Ultravisor relies on the Hypervisor to provide several services to
the SVM such as processing hypercall and other exceptions. After
processing the exception, Hypervisor uses UV_RETURN to return
control back to the Ultravisor.</li>
<li>Hypervisor has to use this ultracall to return control to the SVM.</li>
</ol>
</div></blockquote>
</div>
</div>
<div class="section" id="uv-register-mem-slot">
<h4>UV_REGISTER_MEM_SLOT<a class="headerlink" href="#uv-register-mem-slot" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div>Register an SVM address-range with specified properties.</div></blockquote>
<div class="section" id="id17">
<h5>Syntax<a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h5>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">uint64_t</span> <span class="n">ultracall</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">UV_REGISTER_MEM_SLOT</span><span class="p">,</span>
        <span class="kt">uint64_t</span> <span class="n">lpid</span><span class="p">,</span>          <span class="cm">/* LPAR ID of the SVM */</span>
        <span class="kt">uint64_t</span> <span class="n">start_gpa</span><span class="p">,</span>     <span class="cm">/* start guest physical address */</span>
        <span class="kt">uint64_t</span> <span class="n">size</span><span class="p">,</span>          <span class="cm">/* size of address range in bytes */</span>
        <span class="kt">uint64_t</span> <span class="n">flags</span>          <span class="cm">/* reserved for future expansion */</span>
        <span class="kt">uint16_t</span> <span class="n">slotid</span><span class="p">)</span>        <span class="cm">/* slot identifier */</span>
</pre></div>
</div>
</div>
<div class="section" id="id18">
<h5>Return values<a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><p>One of the following values:</p>
<blockquote>
<div><ul class="simple">
<li>U_SUCCESS     on success.</li>
<li>U_PARAMETER   if <code class="docutils literal notranslate"><span class="pre">lpid</span></code> is invalid.</li>
<li>U_P2          if <code class="docutils literal notranslate"><span class="pre">start_gpa</span></code> is invalid.</li>
<li>U_P3          if <code class="docutils literal notranslate"><span class="pre">size</span></code> is invalid.</li>
<li>U_P4          if any bit in the <code class="docutils literal notranslate"><span class="pre">flags</span></code> is unrecognized.</li>
<li>U_P5          if the <code class="docutils literal notranslate"><span class="pre">slotid</span></code> parameter is unsupported.</li>
<li>U_PERMISSION  if called from context other than Hypervisor.</li>
<li>U_FUNCTION    if functionality is not supported.</li>
</ul>
</div></blockquote>
</div></blockquote>
</div>
<div class="section" id="id19">
<h5>Description<a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div>Register a memory range for an SVM.  The memory range starts at the
guest physical address <code class="docutils literal notranslate"><span class="pre">start_gpa</span></code> and is <code class="docutils literal notranslate"><span class="pre">size</span></code> bytes long.</div></blockquote>
</div>
<div class="section" id="id20">
<h5>Use cases<a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><ol class="arabic simple">
<li>When a virtual machine goes secure, all the memory slots managed by
the Hypervisor move into secure memory. The Hypervisor iterates
through each of memory slots, and registers the slot with
Ultravisor.  Hypervisor may discard some slots such as those used
for firmware (SLOF).</li>
<li>When new memory is hot-plugged, a new memory slot gets registered.</li>
</ol>
</div></blockquote>
</div>
</div>
<div class="section" id="uv-unregister-mem-slot">
<h4>UV_UNREGISTER_MEM_SLOT<a class="headerlink" href="#uv-unregister-mem-slot" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div>Unregister an SVM address-range that was previously registered using
UV_REGISTER_MEM_SLOT.</div></blockquote>
<div class="section" id="id21">
<h5>Syntax<a class="headerlink" href="#id21" title="Permalink to this headline">¶</a></h5>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">uint64_t</span> <span class="n">ultracall</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">UV_UNREGISTER_MEM_SLOT</span><span class="p">,</span>
        <span class="kt">uint64_t</span> <span class="n">lpid</span><span class="p">,</span>          <span class="cm">/* LPAR ID of the SVM */</span>
        <span class="kt">uint64_t</span> <span class="n">slotid</span><span class="p">)</span>        <span class="cm">/* reservation slotid */</span>
</pre></div>
</div>
</div>
<div class="section" id="id22">
<h5>Return values<a class="headerlink" href="#id22" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><p>One of the following values:</p>
<blockquote>
<div><ul class="simple">
<li>U_SUCCESS     on success.</li>
<li>U_FUNCTION    if functionality is not supported.</li>
<li>U_PARAMETER   if <code class="docutils literal notranslate"><span class="pre">lpid</span></code> is invalid.</li>
<li>U_P2          if <code class="docutils literal notranslate"><span class="pre">slotid</span></code> is invalid.</li>
<li>U_PERMISSION  if called from context other than Hypervisor.</li>
</ul>
</div></blockquote>
</div></blockquote>
</div>
<div class="section" id="id23">
<h5>Description<a class="headerlink" href="#id23" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div>Release the memory slot identified by <code class="docutils literal notranslate"><span class="pre">slotid</span></code> and free any
resources allocated towards the reservation.</div></blockquote>
</div>
<div class="section" id="id24">
<h5>Use cases<a class="headerlink" href="#id24" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><ol class="arabic simple">
<li>Memory hot-remove.</li>
</ol>
</div></blockquote>
</div>
</div>
<div class="section" id="uv-svm-terminate">
<h4>UV_SVM_TERMINATE<a class="headerlink" href="#uv-svm-terminate" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div>Terminate an SVM and release its resources.</div></blockquote>
<div class="section" id="id25">
<h5>Syntax<a class="headerlink" href="#id25" title="Permalink to this headline">¶</a></h5>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">uint64_t</span> <span class="n">ultracall</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">UV_SVM_TERMINATE</span><span class="p">,</span>
        <span class="kt">uint64_t</span> <span class="n">lpid</span><span class="p">,</span>          <span class="cm">/* LPAR ID of the SVM */</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id26">
<h5>Return values<a class="headerlink" href="#id26" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><p>One of the following values:</p>
<blockquote>
<div><ul class="simple">
<li>U_SUCCESS     on success.</li>
<li>U_FUNCTION    if functionality is not supported.</li>
<li>U_PARAMETER   if <code class="docutils literal notranslate"><span class="pre">lpid</span></code> is invalid.</li>
<li>U_INVALID     if VM is not secure.</li>
<li>U_PERMISSION  if not called from a Hypervisor context.</li>
</ul>
</div></blockquote>
</div></blockquote>
</div>
<div class="section" id="id27">
<h5>Description<a class="headerlink" href="#id27" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div>Terminate an SVM and release all its resources.</div></blockquote>
</div>
<div class="section" id="id28">
<h5>Use cases<a class="headerlink" href="#id28" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><ol class="arabic simple">
<li>Called by Hypervisor when terminating an SVM.</li>
</ol>
</div></blockquote>
</div>
</div>
</div>
<div class="section" id="ultracalls-used-by-svm">
<h3><a class="toc-backref" href="#id72">Ultracalls used by SVM</a><a class="headerlink" href="#ultracalls-used-by-svm" title="Permalink to this headline">¶</a></h3>
<div class="section" id="uv-share-page">
<h4>UV_SHARE_PAGE<a class="headerlink" href="#uv-share-page" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div>Share a set of guest physical pages with the Hypervisor.</div></blockquote>
<div class="section" id="id29">
<h5>Syntax<a class="headerlink" href="#id29" title="Permalink to this headline">¶</a></h5>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">uint64_t</span> <span class="n">ultracall</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">UV_SHARE_PAGE</span><span class="p">,</span>
        <span class="kt">uint64_t</span> <span class="n">gfn</span><span class="p">,</span>   <span class="cm">/* guest page frame number */</span>
        <span class="kt">uint64_t</span> <span class="n">num</span><span class="p">)</span>   <span class="cm">/* number of pages of size PAGE_SIZE */</span>
</pre></div>
</div>
</div>
<div class="section" id="id30">
<h5>Return values<a class="headerlink" href="#id30" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><p>One of the following values:</p>
<blockquote>
<div><ul class="simple">
<li>U_SUCCESS     on success.</li>
<li>U_FUNCTION    if functionality is not supported.</li>
<li>U_INVALID     if the VM is not secure.</li>
<li>U_PARAMETER   if <code class="docutils literal notranslate"><span class="pre">gfn</span></code> is invalid.</li>
<li>U_P2          if <code class="docutils literal notranslate"><span class="pre">num</span></code> is invalid.</li>
</ul>
</div></blockquote>
</div></blockquote>
</div>
<div class="section" id="id31">
<h5>Description<a class="headerlink" href="#id31" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><p>Share the <code class="docutils literal notranslate"><span class="pre">num</span></code> pages starting at guest physical frame number <code class="docutils literal notranslate"><span class="pre">gfn</span></code>
with the Hypervisor. Assume page size is PAGE_SIZE bytes. Zero the
pages before returning.</p>
<p>If the address is already backed by a secure page, unmap the page and
back it with an insecure page, with the help of the Hypervisor. If it
is not backed by any page yet, mark the PTE as insecure and back it
with an insecure page when the address is accessed. If it is already
backed by an insecure page, zero the page and return.</p>
</div></blockquote>
</div>
<div class="section" id="id32">
<h5>Use cases<a class="headerlink" href="#id32" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><ol class="arabic simple">
<li>The Hypervisor cannot access the SVM pages since they are backed by
secure pages. Hence an SVM must explicitly request Ultravisor for
pages it can share with Hypervisor.</li>
<li>Shared pages are needed to support virtio and Virtual Processor Area
(VPA) in SVMs.</li>
</ol>
</div></blockquote>
</div>
</div>
<div class="section" id="uv-unshare-page">
<h4>UV_UNSHARE_PAGE<a class="headerlink" href="#uv-unshare-page" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div>Restore a shared SVM page to its initial state.</div></blockquote>
<div class="section" id="id33">
<h5>Syntax<a class="headerlink" href="#id33" title="Permalink to this headline">¶</a></h5>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">uint64_t</span> <span class="n">ultracall</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">UV_UNSHARE_PAGE</span><span class="p">,</span>
        <span class="kt">uint64_t</span> <span class="n">gfn</span><span class="p">,</span>   <span class="cm">/* guest page frame number */</span>
        <span class="n">uint73</span> <span class="n">num</span><span class="p">)</span>     <span class="cm">/* number of pages of size PAGE_SIZE*/</span>
</pre></div>
</div>
</div>
<div class="section" id="id34">
<h5>Return values<a class="headerlink" href="#id34" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><p>One of the following values:</p>
<blockquote>
<div><ul class="simple">
<li>U_SUCCESS     on success.</li>
<li>U_FUNCTION    if functionality is not supported.</li>
<li>U_INVALID     if VM is not secure.</li>
<li>U_PARAMETER   if <code class="docutils literal notranslate"><span class="pre">gfn</span></code> is invalid.</li>
<li>U_P2          if <code class="docutils literal notranslate"><span class="pre">num</span></code> is invalid.</li>
</ul>
</div></blockquote>
</div></blockquote>
</div>
<div class="section" id="id35">
<h5>Description<a class="headerlink" href="#id35" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><p>Stop sharing <code class="docutils literal notranslate"><span class="pre">num</span></code> pages starting at <code class="docutils literal notranslate"><span class="pre">gfn</span></code> with the Hypervisor.
Assume that the page size is PAGE_SIZE. Zero the pages before
returning.</p>
<p>If the address is already backed by an insecure page, unmap the page
and back it with a secure page. Inform the Hypervisor to release
reference to its shared page. If the address is not backed by a page
yet, mark the PTE as secure and back it with a secure page when that
address is accessed. If it is already backed by an secure page zero
the page and return.</p>
</div></blockquote>
</div>
<div class="section" id="id36">
<h5>Use cases<a class="headerlink" href="#id36" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><ol class="arabic simple">
<li>The SVM may decide to unshare a page from the Hypervisor.</li>
</ol>
</div></blockquote>
</div>
</div>
<div class="section" id="uv-unshare-all-pages">
<h4>UV_UNSHARE_ALL_PAGES<a class="headerlink" href="#uv-unshare-all-pages" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div>Unshare all pages the SVM has shared with Hypervisor.</div></blockquote>
<div class="section" id="id37">
<h5>Syntax<a class="headerlink" href="#id37" title="Permalink to this headline">¶</a></h5>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">uint64_t</span> <span class="n">ultracall</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">UV_UNSHARE_ALL_PAGES</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id38">
<h5>Return values<a class="headerlink" href="#id38" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><p>One of the following values:</p>
<blockquote>
<div><ul class="simple">
<li>U_SUCCESS     on success.</li>
<li>U_FUNCTION    if functionality is not supported.</li>
<li>U_INVAL       if VM is not secure.</li>
</ul>
</div></blockquote>
</div></blockquote>
</div>
<div class="section" id="id39">
<h5>Description<a class="headerlink" href="#id39" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div>Unshare all shared pages from the Hypervisor. All unshared pages are
zeroed on return. Only pages explicitly shared by the SVM with the
Hypervisor (using UV_SHARE_PAGE ultracall) are unshared. Ultravisor
may internally share some pages with the Hypervisor without explicit
request from the SVM.  These pages will not be unshared by this
ultracall.</div></blockquote>
</div>
<div class="section" id="id40">
<h5>Use cases<a class="headerlink" href="#id40" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><ol class="arabic simple">
<li>This call is needed when <code class="docutils literal notranslate"><span class="pre">kexec</span></code> is used to boot a different
kernel. It may also be needed during SVM reset.</li>
</ol>
</div></blockquote>
</div>
</div>
<div class="section" id="uv-esm">
<h4>UV_ESM<a class="headerlink" href="#uv-esm" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div>Secure the virtual machine (<em>enter secure mode</em>).</div></blockquote>
<div class="section" id="id41">
<h5>Syntax<a class="headerlink" href="#id41" title="Permalink to this headline">¶</a></h5>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">uint64_t</span> <span class="n">ultracall</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">UV_ESM</span><span class="p">,</span>
        <span class="kt">uint64_t</span> <span class="n">esm_blob_addr</span><span class="p">,</span> <span class="cm">/* location of the ESM blob */</span>
        <span class="n">unint64_t</span> <span class="n">fdt</span><span class="p">)</span>          <span class="cm">/* Flattened device tree */</span>
</pre></div>
</div>
</div>
<div class="section" id="id42">
<h5>Return values<a class="headerlink" href="#id42" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><p>One of the following values:</p>
<blockquote>
<div><ul class="simple">
<li>U_SUCCESS     on success (including if VM is already secure).</li>
<li>U_FUNCTION    if functionality is not supported.</li>
<li>U_INVALID     if VM is not secure.</li>
<li>U_PARAMETER   if <code class="docutils literal notranslate"><span class="pre">esm_blob_addr</span></code> is invalid.</li>
<li>U_P2          if <code class="docutils literal notranslate"><span class="pre">fdt</span></code> is invalid.</li>
<li>U_PERMISSION  if any integrity checks fail.</li>
<li>U_RETRY       insufficient memory to create SVM.</li>
<li>U_NO_KEY      symmetric key unavailable.</li>
</ul>
</div></blockquote>
</div></blockquote>
</div>
<div class="section" id="id43">
<h5>Description<a class="headerlink" href="#id43" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div>Secure the virtual machine. On successful completion, return
control to the virtual machine at the address specified in the
ESM blob.</div></blockquote>
</div>
<div class="section" id="id44">
<h5>Use cases<a class="headerlink" href="#id44" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><ol class="arabic simple">
<li>A normal virtual machine can choose to switch to a secure mode.</li>
</ol>
</div></blockquote>
</div>
</div>
</div>
</div>
<div class="section" id="hypervisor-calls-api">
<h2><a class="toc-backref" href="#id73">Hypervisor Calls API</a><a class="headerlink" href="#hypervisor-calls-api" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>This document describes the Hypervisor calls (hypercalls) that are
needed to support the Ultravisor. Hypercalls are services provided by
the Hypervisor to virtual machines and Ultravisor.</p>
<p>Register usage for these hypercalls is identical to that of the other
hypercalls defined in the Power Architecture Platform Reference (PAPR)
document.  i.e on input, register R3 identifies the specific service
that is being requested and registers R4 through R11 contain
additional parameters to the hypercall, if any. On output, register
R3 contains the return value and registers R4 through R9 contain any
other output values from the hypercall.</p>
<p>This document only covers hypercalls currently implemented/planned
for Ultravisor usage but others can be added here when it makes sense.</p>
<p>The full specification for all hypercalls/ultracalls will eventually
be made available in the public/OpenPower version of the PAPR
specification.</p>
</div></blockquote>
<div class="section" id="hypervisor-calls-to-support-ultravisor">
<h3><a class="toc-backref" href="#id74">Hypervisor calls to support Ultravisor</a><a class="headerlink" href="#hypervisor-calls-to-support-ultravisor" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div>Following are the set of hypercalls needed to support Ultravisor.</div></blockquote>
<div class="section" id="h-svm-init-start">
<h4>H_SVM_INIT_START<a class="headerlink" href="#h-svm-init-start" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div>Begin the process of converting a normal virtual machine into an SVM.</div></blockquote>
<div class="section" id="id45">
<h5>Syntax<a class="headerlink" href="#id45" title="Permalink to this headline">¶</a></h5>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">uint64_t</span> <span class="n">hypercall</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">H_SVM_INIT_START</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id46">
<h5>Return values<a class="headerlink" href="#id46" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><p>One of the following values:</p>
<blockquote>
<div><ul class="simple">
<li>H_SUCCESS      on success.</li>
</ul>
</div></blockquote>
</div></blockquote>
</div>
<div class="section" id="id47">
<h5>Description<a class="headerlink" href="#id47" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div>Initiate the process of securing a virtual machine. This involves
coordinating with the Ultravisor, using ultracalls, to allocate
resources in the Ultravisor for the new SVM, transferring the VM’s
pages from normal to secure memory etc. When the process is
completed, Ultravisor issues the H_SVM_INIT_DONE hypercall.</div></blockquote>
</div>
<div class="section" id="id48">
<h5>Use cases<a class="headerlink" href="#id48" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><ol class="arabic simple">
<li>Ultravisor uses this hypercall to inform Hypervisor that a VM
has initiated the process of switching to secure mode.</li>
</ol>
</div></blockquote>
</div>
</div>
<div class="section" id="h-svm-init-done">
<h4>H_SVM_INIT_DONE<a class="headerlink" href="#h-svm-init-done" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div>Complete the process of securing an SVM.</div></blockquote>
<div class="section" id="id49">
<h5>Syntax<a class="headerlink" href="#id49" title="Permalink to this headline">¶</a></h5>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">uint64_t</span> <span class="n">hypercall</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">H_SVM_INIT_DONE</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id50">
<h5>Return values<a class="headerlink" href="#id50" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><p>One of the following values:</p>
<blockquote>
<div><ul class="simple">
<li>H_SUCCESS             on success.</li>
<li><dl class="first docutils">
<dt>H_UNSUPPORTED         if called from the wrong context (e.g.</dt>
<dd>from an SVM or before an H_SVM_INIT_START
hypercall).</dd>
</dl>
</li>
</ul>
</div></blockquote>
</div></blockquote>
</div>
<div class="section" id="id51">
<h5>Description<a class="headerlink" href="#id51" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div>Complete the process of securing a virtual machine. This call must
be made after a prior call to <code class="docutils literal notranslate"><span class="pre">H_SVM_INIT_START</span></code> hypercall.</div></blockquote>
</div>
<div class="section" id="id52">
<h5>Use cases<a class="headerlink" href="#id52" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div>On successfully securing a virtual machine, the Ultravisor informs
Hypervisor about it. Hypervisor can use this call to finish setting
up its internal state for this virtual machine.</div></blockquote>
</div>
</div>
<div class="section" id="h-svm-init-abort">
<h4>H_SVM_INIT_ABORT<a class="headerlink" href="#h-svm-init-abort" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div>Abort the process of securing an SVM.</div></blockquote>
<div class="section" id="id53">
<h5>Syntax<a class="headerlink" href="#id53" title="Permalink to this headline">¶</a></h5>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">uint64_t</span> <span class="n">hypercall</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">H_SVM_INIT_ABORT</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id54">
<h5>Return values<a class="headerlink" href="#id54" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><p>One of the following values:</p>
<blockquote>
<div><ul class="simple">
<li><dl class="first docutils">
<dt>H_PARAMETER           on successfully cleaning up the state,</dt>
<dd>Hypervisor will return this value to the
<strong>guest</strong>, to indicate that the underlying
UV_ESM ultracall failed.</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>H_STATE               if called after a VM has gone secure (i.e</dt>
<dd>H_SVM_INIT_DONE hypercall was successful).</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>H_UNSUPPORTED         if called from a wrong context (e.g. from a</dt>
<dd>normal VM).</dd>
</dl>
</li>
</ul>
</div></blockquote>
</div></blockquote>
</div>
<div class="section" id="id55">
<h5>Description<a class="headerlink" href="#id55" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><p>Abort the process of securing a virtual machine. This call must
be made after a prior call to <code class="docutils literal notranslate"><span class="pre">H_SVM_INIT_START</span></code> hypercall and
before a call to <code class="docutils literal notranslate"><span class="pre">H_SVM_INIT_DONE</span></code>.</p>
<p>On entry into this hypercall the non-volatile GPRs and FPRs are
expected to contain the values they had at the time the VM issued
the UV_ESM ultracall. Further <code class="docutils literal notranslate"><span class="pre">SRR0</span></code> is expected to contain the
address of the instruction after the <code class="docutils literal notranslate"><span class="pre">UV_ESM</span></code> ultracall and <code class="docutils literal notranslate"><span class="pre">SRR1</span></code>
the MSR value with which to return to the VM.</p>
<p>This hypercall will cleanup any partial state that was established for
the VM since the prior <code class="docutils literal notranslate"><span class="pre">H_SVM_INIT_START</span></code> hypercall, including paging
out pages that were paged-into secure memory, and issue the
<code class="docutils literal notranslate"><span class="pre">UV_SVM_TERMINATE</span></code> ultracall to terminate the VM.</p>
<p>After the partial state is cleaned up, control returns to the VM
(<strong>not Ultravisor</strong>), at the address specified in <code class="docutils literal notranslate"><span class="pre">SRR0</span></code> with the
MSR values set to the value in <code class="docutils literal notranslate"><span class="pre">SRR1</span></code>.</p>
</div></blockquote>
</div>
<div class="section" id="id56">
<h5>Use cases<a class="headerlink" href="#id56" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div>If after a successful call to <code class="docutils literal notranslate"><span class="pre">H_SVM_INIT_START</span></code>, the Ultravisor
encounters an error while securing a virtual machine, either due
to lack of resources or because the VM’s security information could
not be validated, Ultravisor informs the Hypervisor about it.
Hypervisor should use this call to clean up any internal state for
this virtual machine and return to the VM.</div></blockquote>
</div>
</div>
<div class="section" id="h-svm-page-in">
<h4>H_SVM_PAGE_IN<a class="headerlink" href="#h-svm-page-in" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div>Move the contents of a page from normal memory to secure memory.</div></blockquote>
<div class="section" id="id57">
<h5>Syntax<a class="headerlink" href="#id57" title="Permalink to this headline">¶</a></h5>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">uint64_t</span> <span class="n">hypercall</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">H_SVM_PAGE_IN</span><span class="p">,</span>
        <span class="kt">uint64_t</span> <span class="n">guest_pa</span><span class="p">,</span>      <span class="cm">/* guest-physical-address */</span>
        <span class="kt">uint64_t</span> <span class="n">flags</span><span class="p">,</span>         <span class="cm">/* flags */</span>
        <span class="kt">uint64_t</span> <span class="n">order</span><span class="p">)</span>         <span class="cm">/* page size order */</span>
</pre></div>
</div>
</div>
<div class="section" id="id58">
<h5>Return values<a class="headerlink" href="#id58" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><p>One of the following values:</p>
<blockquote>
<div><ul class="simple">
<li>H_SUCCESS     on success.</li>
<li>H_PARAMETER   if <code class="docutils literal notranslate"><span class="pre">guest_pa</span></code> is invalid.</li>
<li>H_P2          if <code class="docutils literal notranslate"><span class="pre">flags</span></code> is invalid.</li>
<li>H_P3          if <code class="docutils literal notranslate"><span class="pre">order</span></code> of page is invalid.</li>
</ul>
</div></blockquote>
</div></blockquote>
</div>
<div class="section" id="id59">
<h5>Description<a class="headerlink" href="#id59" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><p>Retrieve the content of the page, belonging to the VM at the specified
guest physical address.</p>
<p>Only valid value(s) in <code class="docutils literal notranslate"><span class="pre">flags</span></code> are:</p>
<blockquote>
<div><ul class="simple">
<li>H_PAGE_IN_SHARED which indicates that the page is to be shared
with the Ultravisor.</li>
<li>H_PAGE_IN_NONSHARED indicates that the UV is not anymore
interested in the page. Applicable if the page is a shared page.</li>
</ul>
</div></blockquote>
<p>The <code class="docutils literal notranslate"><span class="pre">order</span></code> parameter must correspond to the configured page size.</p>
</div></blockquote>
</div>
<div class="section" id="id60">
<h5>Use cases<a class="headerlink" href="#id60" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><ol class="arabic simple">
<li>When a normal VM becomes a secure VM (using the UV_ESM ultracall),
the Ultravisor uses this hypercall to move contents of each page of
the VM from normal memory to secure memory.</li>
<li>Ultravisor uses this hypercall to ask Hypervisor to provide a page
in normal memory that can be shared between the SVM and Hypervisor.</li>
<li>Ultravisor uses this hypercall to page-in a paged-out page. This
can happen when the SVM touches a paged-out page.</li>
<li>If SVM wants to disable sharing of pages with Hypervisor, it can
inform Ultravisor to do so. Ultravisor will then use this hypercall
and inform Hypervisor that it has released access to the normal
page.</li>
</ol>
</div></blockquote>
</div>
</div>
<div class="section" id="h-svm-page-out">
<h4>H_SVM_PAGE_OUT<a class="headerlink" href="#h-svm-page-out" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div>Move the contents of the page to normal memory.</div></blockquote>
<div class="section" id="id61">
<h5>Syntax<a class="headerlink" href="#id61" title="Permalink to this headline">¶</a></h5>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">uint64_t</span> <span class="n">hypercall</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">H_SVM_PAGE_OUT</span><span class="p">,</span>
        <span class="kt">uint64_t</span> <span class="n">guest_pa</span><span class="p">,</span>      <span class="cm">/* guest-physical-address */</span>
        <span class="kt">uint64_t</span> <span class="n">flags</span><span class="p">,</span>         <span class="cm">/* flags (currently none) */</span>
        <span class="kt">uint64_t</span> <span class="n">order</span><span class="p">)</span>         <span class="cm">/* page size order */</span>
</pre></div>
</div>
</div>
<div class="section" id="id62">
<h5>Return values<a class="headerlink" href="#id62" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><p>One of the following values:</p>
<blockquote>
<div><ul class="simple">
<li>H_SUCCESS     on success.</li>
<li>H_PARAMETER   if <code class="docutils literal notranslate"><span class="pre">guest_pa</span></code> is invalid.</li>
<li>H_P2          if <code class="docutils literal notranslate"><span class="pre">flags</span></code> is invalid.</li>
<li>H_P3          if <code class="docutils literal notranslate"><span class="pre">order</span></code> is invalid.</li>
</ul>
</div></blockquote>
</div></blockquote>
</div>
<div class="section" id="id63">
<h5>Description<a class="headerlink" href="#id63" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><p>Move the contents of the page identified by <code class="docutils literal notranslate"><span class="pre">guest_pa</span></code> to normal
memory.</p>
<p>Currently <code class="docutils literal notranslate"><span class="pre">flags</span></code> is unused and must be set to 0. The <code class="docutils literal notranslate"><span class="pre">order</span></code>
parameter must correspond to the configured page size.</p>
</div></blockquote>
</div>
<div class="section" id="id64">
<h5>Use cases<a class="headerlink" href="#id64" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><ol class="arabic simple">
<li>If Ultravisor is running low on secure pages, it can move the
contents of some secure pages, into normal pages using this
hypercall. The content will be encrypted.</li>
</ol>
</div></blockquote>
</div>
</div>
</div>
</div>
<div class="section" id="references">
<h2><a class="toc-backref" href="#id75">References</a><a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="https://developer.ibm.com/articles/l-support-protected-computing/">Supporting Protected Computing on IBM Power Architecture</a></li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>