

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Linux USB Printer Gadget Driver &mdash; The Linux Kernel  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Linux Gadget Serial Driver v2.0" href="gadget_serial.html" />
    <link rel="prev" title="Multifunction Composite Gadget" href="gadget_multi.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.6.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kbuild/index.html">Kernel Build System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../livepatch/index.html">Kernel Livepatching</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../locking/index.html">locking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../accounting/index.html">Accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../block/index.html">Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cdrom/index.html">cdrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ide/index.html">Integrated Drive Electronics (IDE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fpga/index.html">fpga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../isdn/index.html">ISDN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../leds/index.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../media/index.html">Linux Media Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../power/index.html">Power Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../timers/index.html">timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../virt/index.html">Linux Virtualization Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">USB support</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="acm.html">Linux ACM driver v0.16</a></li>
<li class="toctree-l2"><a class="reference internal" href="authorization.html">Authorizing (or not) your USB devices to connect to the system</a></li>
<li class="toctree-l2"><a class="reference internal" href="chipidea.html">ChipIdea Highspeed Dual Role Controller Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="dwc3.html">DWC3 driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="ehci.html">EHCI driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="functionfs.html">How FunctionFS works</a></li>
<li class="toctree-l2"><a class="reference internal" href="gadget_configfs.html">Linux USB gadget configured through configfs</a></li>
<li class="toctree-l2"><a class="reference internal" href="gadget_hid.html">Linux USB HID gadget driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="gadget_multi.html">Multifunction Composite Gadget</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Linux USB Printer Gadget Driver</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#general">General</a></li>
<li class="toctree-l3"><a class="reference internal" href="#howto-use-this-driver">Howto Use This Driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-the-example-code">Using The Example Code</a></li>
<li class="toctree-l3"><a class="reference internal" href="#example-code">Example Code</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="gadget_serial.html">Linux Gadget Serial Driver v2.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="gadget-testing.html">Gadget Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="iuu_phoenix.html">Infinity Usb Unlimited Readme</a></li>
<li class="toctree-l2"><a class="reference internal" href="mass-storage.html">Mass Storage Gadget (MSG)</a></li>
<li class="toctree-l2"><a class="reference internal" href="misc_usbsevseg.html">USB 7-Segment Numeric Display</a></li>
<li class="toctree-l2"><a class="reference internal" href="mtouchusb.html">mtouchusb driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="ohci.html">OHCI</a></li>
<li class="toctree-l2"><a class="reference internal" href="usbip_protocol.html">USB/IP protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="usbmon.html">usbmon</a></li>
<li class="toctree-l2"><a class="reference internal" href="usb-serial.html">USB serial</a></li>
<li class="toctree-l2"><a class="reference internal" href="usb-help.html">USB references</a></li>
<li class="toctree-l2"><a class="reference internal" href="text_files.html">Linux CDC ACM inf</a></li>
<li class="toctree-l2"><a class="reference internal" href="text_files.html#linux-inf">Linux inf</a></li>
<li class="toctree-l2"><a class="reference internal" href="text_files.html#usb-devfs-drop-permissions-source">USB devfs drop permissions source</a></li>
<li class="toctree-l2"><a class="reference internal" href="text_files.html#credits">Credits</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mic/index.html">Intel Many Integrated Core (MIC) architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scheduler/index.html">Linux Scheduler</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../asm-annotations.html">Assembler Annotations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../arm/index.html">ARM Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../arm64/index.html">ARM64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ia64/index.html">IA-64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../m68k/index.html">m68k Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mips/index.html">MIPS-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nios2/nios2.html">Linux on the Nios II architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../openrisc/index.html">OpenRISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parisc/index.html">PA-RISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../powerpc/index.html">powerpc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../riscv/index.html">RISC-V architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../s390/index.html">s390 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sh/index.html">SuperH Interfaces Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sparc/index.html">Sparc Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../x86/index.html">x86-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../xtensa/index.html">Xtensa Architecture</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/ext4/index.html">ext4 Data Structures and Algorithms</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">USB support</a> &raquo;</li>
        
      <li>Linux USB Printer Gadget Driver</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/usb/gadget_printer.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="linux-usb-printer-gadget-driver">
<h1>Linux USB Printer Gadget Driver<a class="headerlink" href="#linux-usb-printer-gadget-driver" title="Permalink to this headline">¶</a></h1>
<p>06/04/2007</p>
<p>Copyright (C) 2007 Craig W. Nadler &lt;<a class="reference external" href="mailto:craig&#37;&#52;&#48;nadler&#46;us">craig<span>&#64;</span>nadler<span>&#46;</span>us</a>&gt;</p>
<div class="section" id="general">
<h2>General<a class="headerlink" href="#general" title="Permalink to this headline">¶</a></h2>
<p>This driver may be used if you are writing printer firmware using Linux as
the embedded OS. This driver has nothing to do with using a printer with
your Linux host system.</p>
<p>You will need a USB device controller and a Linux driver for it that accepts
a gadget / “device class” driver using the Linux USB Gadget API. After the
USB device controller driver is loaded then load the printer gadget driver.
This will present a printer interface to the USB Host that your USB Device
port is connected to.</p>
<p>This driver is structured for printer firmware that runs in user mode. The
user mode printer firmware will read and write data from the kernel mode
printer gadget driver using a device file. The printer returns a printer status
byte when the USB HOST sends a device request to get the printer status.  The
user space firmware can read or write this status byte using a device file
/dev/g_printer . Both blocking and non-blocking read/write calls are supported.</p>
</div>
<div class="section" id="howto-use-this-driver">
<h2>Howto Use This Driver<a class="headerlink" href="#howto-use-this-driver" title="Permalink to this headline">¶</a></h2>
<p>To load the USB device controller driver and the printer gadget driver. The
following example uses the Netchip 2280 USB device controller driver:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>modprobe net2280
modprobe g_printer
</pre></div>
</div>
<p>The follow command line parameter can be used when loading the printer gadget
(ex: modprobe g_printer idVendor=0x0525 idProduct=0xa4a8 ):</p>
<dl class="docutils">
<dt>idVendor</dt>
<dd>This is the Vendor ID used in the device descriptor. The default is
the Netchip vendor id 0x0525. YOU MUST CHANGE TO YOUR OWN VENDOR ID
BEFORE RELEASING A PRODUCT. If you plan to release a product and don’t
already have a Vendor ID please see www.usb.org for details on how to
get one.</dd>
<dt>idProduct</dt>
<dd>This is the Product ID used in the device descriptor. The default
is 0xa4a8, you should change this to an ID that’s not used by any of
your other USB products if you have any. It would be a good idea to
start numbering your products starting with say 0x0001.</dd>
<dt>bcdDevice</dt>
<dd>This is the version number of your product. It would be a good idea
to put your firmware version here.</dd>
<dt>iManufacturer</dt>
<dd>A string containing the name of the Vendor.</dd>
<dt>iProduct</dt>
<dd>A string containing the Product Name.</dd>
<dt>iSerialNum</dt>
<dd>A string containing the Serial Number. This should be changed for
each unit of your product.</dd>
<dt>iPNPstring</dt>
<dd>The PNP ID string used for this printer. You will want to set
either on the command line or hard code the PNP ID string used for
your printer product.</dd>
<dt>qlen</dt>
<dd>The number of 8k buffers to use per endpoint. The default is 10, you
should tune this for your product. You may also want to tune the
size of each buffer for your product.</dd>
</dl>
</div>
<div class="section" id="using-the-example-code">
<h2>Using The Example Code<a class="headerlink" href="#using-the-example-code" title="Permalink to this headline">¶</a></h2>
<p>This example code talks to stdout, instead of a print engine.</p>
<p>To compile the test code below:</p>
<ol class="arabic">
<li><p class="first">save it to a file called prn_example.c</p>
</li>
<li><p class="first">compile the code with the follow command:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>gcc prn_example.c -o prn_example
</pre></div>
</div>
</li>
</ol>
<p>To read printer data from the host to stdout:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># prn_example -read_data
</pre></div>
</div>
<p>To write printer data from a file (data_file) to the host:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># cat data_file | prn_example -write_data
</pre></div>
</div>
<p>To get the current printer status for the gadget driver::</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># prn_example -get_status

Printer status is:
     Printer is NOT Selected
     Paper is Out
     Printer OK
</pre></div>
</div>
<p>To set printer to Selected/On-line:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># prn_example -selected
</pre></div>
</div>
<p>To set printer to Not Selected/Off-line:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># prn_example -not_selected
</pre></div>
</div>
<p>To set paper status to paper out:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># prn_example -paper_out
</pre></div>
</div>
<p>To set paper status to paper loaded:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># prn_example -paper_loaded
</pre></div>
</div>
<p>To set error status to printer OK:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># prn_example -no_error
</pre></div>
</div>
<p>To set error status to ERROR:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># prn_example -error
</pre></div>
</div>
</div>
<div class="section" id="example-code">
<h2>Example Code<a class="headerlink" href="#example-code" title="Permalink to this headline">¶</a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;linux/poll.h&gt;
#include &lt;sys/ioctl.h&gt;
#include &lt;linux/usb/g_printer.h&gt;

#define PRINTER_FILE                  &quot;/dev/g_printer&quot;
#define BUF_SIZE                      512


/*
 * &#39;usage()&#39; - Show program usage.
 */

static void
usage(const char *option)             /* I - Option string or NULL */
{
      if (option) {
              fprintf(stderr,&quot;prn_example: Unknown option \&quot;%s\&quot;!\n&quot;,
                              option);
      }

      fputs(&quot;\n&quot;, stderr);
      fputs(&quot;Usage: prn_example -[options]\n&quot;, stderr);
      fputs(&quot;Options:\n&quot;, stderr);
      fputs(&quot;\n&quot;, stderr);
      fputs(&quot;-get_status    Get the current printer status.\n&quot;, stderr);
      fputs(&quot;-selected      Set the selected status to selected.\n&quot;, stderr);
      fputs(&quot;-not_selected  Set the selected status to NOT selected.\n&quot;,
                      stderr);
      fputs(&quot;-error         Set the error status to error.\n&quot;, stderr);
      fputs(&quot;-no_error      Set the error status to NO error.\n&quot;, stderr);
      fputs(&quot;-paper_out     Set the paper status to paper out.\n&quot;, stderr);
      fputs(&quot;-paper_loaded  Set the paper status to paper loaded.\n&quot;,
                      stderr);
      fputs(&quot;-read_data     Read printer data from driver.\n&quot;, stderr);
      fputs(&quot;-write_data    Write printer sata to driver.\n&quot;, stderr);
      fputs(&quot;-NB_read_data  (Non-Blocking) Read printer data from driver.\n&quot;,
                      stderr);
      fputs(&quot;\n\n&quot;, stderr);

      exit(1);
}


static int
read_printer_data()
{
      struct pollfd   fd[1];

      /* Open device file for printer gadget. */
      fd[0].fd = open(PRINTER_FILE, O_RDWR);
      if (fd[0].fd &lt; 0) {
              printf(&quot;Error %d opening %s\n&quot;, fd[0].fd, PRINTER_FILE);
              close(fd[0].fd);
              return(-1);
      }

      fd[0].events = POLLIN | POLLRDNORM;

      while (1) {
              static char buf[BUF_SIZE];
              int bytes_read;
              int retval;

              /* Wait for up to 1 second for data. */
              retval = poll(fd, 1, 1000);

              if (retval &amp;&amp; (fd[0].revents &amp; POLLRDNORM)) {

                      /* Read data from printer gadget driver. */
                      bytes_read = read(fd[0].fd, buf, BUF_SIZE);

                      if (bytes_read &lt; 0) {
                              printf(&quot;Error %d reading from %s\n&quot;,
                                              fd[0].fd, PRINTER_FILE);
                              close(fd[0].fd);
                              return(-1);
                      } else if (bytes_read &gt; 0) {
                              /* Write data to standard OUTPUT (stdout). */
                              fwrite(buf, 1, bytes_read, stdout);
                              fflush(stdout);
                      }

              }

      }

      /* Close the device file. */
      close(fd[0].fd);

      return 0;
}


static int
write_printer_data()
{
      struct pollfd   fd[1];

      /* Open device file for printer gadget. */
      fd[0].fd = open (PRINTER_FILE, O_RDWR);
      if (fd[0].fd &lt; 0) {
              printf(&quot;Error %d opening %s\n&quot;, fd[0].fd, PRINTER_FILE);
              close(fd[0].fd);
              return(-1);
      }

      fd[0].events = POLLOUT | POLLWRNORM;

      while (1) {
              int retval;
              static char buf[BUF_SIZE];
              /* Read data from standard INPUT (stdin). */
              int bytes_read = fread(buf, 1, BUF_SIZE, stdin);

              if (!bytes_read) {
                      break;
              }

              while (bytes_read) {

                      /* Wait for up to 1 second to sent data. */
                      retval = poll(fd, 1, 1000);

                      /* Write data to printer gadget driver. */
                      if (retval &amp;&amp; (fd[0].revents &amp; POLLWRNORM)) {
                              retval = write(fd[0].fd, buf, bytes_read);
                              if (retval &lt; 0) {
                                      printf(&quot;Error %d writing to %s\n&quot;,
                                                      fd[0].fd,
                                                      PRINTER_FILE);
                                      close(fd[0].fd);
                                      return(-1);
                              } else {
                                      bytes_read -= retval;
                              }

                      }

              }

      }

      /* Wait until the data has been sent. */
      fsync(fd[0].fd);

      /* Close the device file. */
      close(fd[0].fd);

      return 0;
}


static int
read_NB_printer_data()
{
      int             fd;
      static char     buf[BUF_SIZE];
      int             bytes_read;

      /* Open device file for printer gadget. */
      fd = open(PRINTER_FILE, O_RDWR|O_NONBLOCK);
      if (fd &lt; 0) {
              printf(&quot;Error %d opening %s\n&quot;, fd, PRINTER_FILE);
              close(fd);
              return(-1);
      }

      while (1) {
              /* Read data from printer gadget driver. */
              bytes_read = read(fd, buf, BUF_SIZE);
              if (bytes_read &lt;= 0) {
                      break;
              }

              /* Write data to standard OUTPUT (stdout). */
              fwrite(buf, 1, bytes_read, stdout);
              fflush(stdout);
      }

      /* Close the device file. */
      close(fd);

      return 0;
}


static int
get_printer_status()
{
      int     retval;
      int     fd;

      /* Open device file for printer gadget. */
      fd = open(PRINTER_FILE, O_RDWR);
      if (fd &lt; 0) {
              printf(&quot;Error %d opening %s\n&quot;, fd, PRINTER_FILE);
              close(fd);
              return(-1);
      }

      /* Make the IOCTL call. */
      retval = ioctl(fd, GADGET_GET_PRINTER_STATUS);
      if (retval &lt; 0) {
              fprintf(stderr, &quot;ERROR: Failed to set printer status\n&quot;);
              return(-1);
      }

      /* Close the device file. */
      close(fd);

      return(retval);
}


static int
set_printer_status(unsigned char buf, int clear_printer_status_bit)
{
      int     retval;
      int     fd;

      retval = get_printer_status();
      if (retval &lt; 0) {
              fprintf(stderr, &quot;ERROR: Failed to get printer status\n&quot;);
              return(-1);
      }

      /* Open device file for printer gadget. */
      fd = open(PRINTER_FILE, O_RDWR);

      if (fd &lt; 0) {
              printf(&quot;Error %d opening %s\n&quot;, fd, PRINTER_FILE);
              close(fd);
              return(-1);
      }

      if (clear_printer_status_bit) {
              retval &amp;= ~buf;
      } else {
              retval |= buf;
      }

      /* Make the IOCTL call. */
      if (ioctl(fd, GADGET_SET_PRINTER_STATUS, (unsigned char)retval)) {
              fprintf(stderr, &quot;ERROR: Failed to set printer status\n&quot;);
              return(-1);
      }

      /* Close the device file. */
      close(fd);

      return 0;
}


static int
display_printer_status()
{
      char    printer_status;

      printer_status = get_printer_status();
      if (printer_status &lt; 0) {
              fprintf(stderr, &quot;ERROR: Failed to get printer status\n&quot;);
              return(-1);
      }

      printf(&quot;Printer status is:\n&quot;);
      if (printer_status &amp; PRINTER_SELECTED) {
              printf(&quot;     Printer is Selected\n&quot;);
      } else {
              printf(&quot;     Printer is NOT Selected\n&quot;);
      }
      if (printer_status &amp; PRINTER_PAPER_EMPTY) {
              printf(&quot;     Paper is Out\n&quot;);
      } else {
              printf(&quot;     Paper is Loaded\n&quot;);
      }
      if (printer_status &amp; PRINTER_NOT_ERROR) {
              printf(&quot;     Printer OK\n&quot;);
      } else {
              printf(&quot;     Printer ERROR\n&quot;);
      }

      return(0);
}


int
main(int  argc, char *argv[])
{
      int     i;              /* Looping var */
      int     retval = 0;

      /* No Args */
      if (argc == 1) {
              usage(0);
              exit(0);
      }

      for (i = 1; i &lt; argc &amp;&amp; !retval; i ++) {

              if (argv[i][0] != &#39;-&#39;) {
                      continue;
              }

              if (!strcmp(argv[i], &quot;-get_status&quot;)) {
                      if (display_printer_status()) {
                              retval = 1;
                      }

              } else if (!strcmp(argv[i], &quot;-paper_loaded&quot;)) {
                      if (set_printer_status(PRINTER_PAPER_EMPTY, 1)) {
                              retval = 1;
                      }

              } else if (!strcmp(argv[i], &quot;-paper_out&quot;)) {
                      if (set_printer_status(PRINTER_PAPER_EMPTY, 0)) {
                              retval = 1;
                      }

              } else if (!strcmp(argv[i], &quot;-selected&quot;)) {
                      if (set_printer_status(PRINTER_SELECTED, 0)) {
                              retval = 1;
                      }

              } else if (!strcmp(argv[i], &quot;-not_selected&quot;)) {
                      if (set_printer_status(PRINTER_SELECTED, 1)) {
                              retval = 1;
                      }

              } else if (!strcmp(argv[i], &quot;-error&quot;)) {
                      if (set_printer_status(PRINTER_NOT_ERROR, 1)) {
                              retval = 1;
                      }

              } else if (!strcmp(argv[i], &quot;-no_error&quot;)) {
                      if (set_printer_status(PRINTER_NOT_ERROR, 0)) {
                              retval = 1;
                      }

              } else if (!strcmp(argv[i], &quot;-read_data&quot;)) {
                      if (read_printer_data()) {
                              retval = 1;
                      }

              } else if (!strcmp(argv[i], &quot;-write_data&quot;)) {
                      if (write_printer_data()) {
                              retval = 1;
                      }

              } else if (!strcmp(argv[i], &quot;-NB_read_data&quot;)) {
                      if (read_NB_printer_data()) {
                              retval = 1;
                      }

              } else {
                      usage(argv[i]);
                      retval = 1;
              }
      }

      exit(retval);
}
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="gadget_serial.html" class="btn btn-neutral float-right" title="Linux Gadget Serial Driver v2.0" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="gadget_multi.html" class="btn btn-neutral float-left" title="Multifunction Composite Gadget" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>