

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>4. Kernel Stacks &mdash; The Linux Kernel  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="5. Kernel Entries" href="entry_64.html" />
    <link rel="prev" title="3. Kernel level exception handling" href="exception-tables.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.6.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kbuild/index.html">Kernel Build System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../livepatch/index.html">Kernel Livepatching</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../locking/index.html">locking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../accounting/index.html">Accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../block/index.html">Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cdrom/index.html">cdrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ide/index.html">Integrated Drive Electronics (IDE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fpga/index.html">fpga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../isdn/index.html">ISDN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../leds/index.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../media/index.html">Linux Media Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../power/index.html">Power Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../timers/index.html">timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../virt/index.html">Linux Virtualization Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usb/index.html">USB support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mic/index.html">Intel Many Integrated Core (MIC) architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scheduler/index.html">Linux Scheduler</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../asm-annotations.html">Assembler Annotations</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../arm/index.html">ARM Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../arm64/index.html">ARM64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ia64/index.html">IA-64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../m68k/index.html">m68k Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mips/index.html">MIPS-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nios2/nios2.html">Linux on the Nios II architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../openrisc/index.html">OpenRISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parisc/index.html">PA-RISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../powerpc/index.html">powerpc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../riscv/index.html">RISC-V architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../s390/index.html">s390 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sh/index.html">SuperH Interfaces Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sparc/index.html">Sparc Architecture</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">x86-specific Documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="boot.html">1. The Linux/x86 Boot Protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="topology.html">2. x86 Topology</a></li>
<li class="toctree-l2"><a class="reference internal" href="exception-tables.html">3. Kernel level exception handling</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">4. Kernel Stacks</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#kernel-stacks-on-x86-64-bit">4.1. Kernel stacks on x86-64 bit</a></li>
<li class="toctree-l3"><a class="reference internal" href="#printing-backtraces-on-x86">4.2. Printing backtraces on x86</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="entry_64.html">5. Kernel Entries</a></li>
<li class="toctree-l2"><a class="reference internal" href="earlyprintk.html">6. Early Printk</a></li>
<li class="toctree-l2"><a class="reference internal" href="orc-unwinder.html">7. ORC unwinder</a></li>
<li class="toctree-l2"><a class="reference internal" href="zero-page.html">8. Zero Page</a></li>
<li class="toctree-l2"><a class="reference internal" href="tlb.html">9. The TLB</a></li>
<li class="toctree-l2"><a class="reference internal" href="mtrr.html">10. MTRR (Memory Type Range Register) control</a></li>
<li class="toctree-l2"><a class="reference internal" href="pat.html">11. PAT (Page Attribute Table)</a></li>
<li class="toctree-l2"><a class="reference internal" href="intel-iommu.html">12. Linux IOMMU Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="intel_txt.html">13. Intel(R) TXT Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="amd-memory-encryption.html">14. AMD Memory Encryption</a></li>
<li class="toctree-l2"><a class="reference internal" href="pti.html">15. Page Table Isolation (PTI)</a></li>
<li class="toctree-l2"><a class="reference internal" href="mds.html">16. Microarchitectural Data Sampling (MDS) mitigation</a></li>
<li class="toctree-l2"><a class="reference internal" href="microcode.html">17. The Linux Microcode Loader</a></li>
<li class="toctree-l2"><a class="reference internal" href="resctrl_ui.html">18. User Interface for Resource Control feature</a></li>
<li class="toctree-l2"><a class="reference internal" href="tsx_async_abort.html">19. TSX Async Abort (TAA) mitigation</a></li>
<li class="toctree-l2"><a class="reference internal" href="usb-legacy-support.html">20. USB Legacy support</a></li>
<li class="toctree-l2"><a class="reference internal" href="i386/index.html">21. i386 Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="x86_64/index.html">22. x86_64 Support</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../xtensa/index.html">Xtensa Architecture</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/ext4/index.html">ext4 Data Structures and Algorithms</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">x86-specific Documentation</a> &raquo;</li>
        
      <li>4. Kernel Stacks</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/x86/kernel-stacks.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="kernel-stacks">
<h1>4. Kernel Stacks<a class="headerlink" href="#kernel-stacks" title="Permalink to this headline">¶</a></h1>
<div class="section" id="kernel-stacks-on-x86-64-bit">
<h2>4.1. Kernel stacks on x86-64 bit<a class="headerlink" href="#kernel-stacks-on-x86-64-bit" title="Permalink to this headline">¶</a></h2>
<p>Most of the text from Keith Owens, hacked by AK</p>
<p>x86_64 page size (PAGE_SIZE) is 4K.</p>
<p>Like all other architectures, x86_64 has a kernel stack for every
active thread.  These thread stacks are THREAD_SIZE (2*PAGE_SIZE) big.
These stacks contain useful data as long as a thread is alive or a
zombie. While the thread is in user space the kernel stack is empty
except for the thread_info structure at the bottom.</p>
<p>In addition to the per thread stacks, there are specialized stacks
associated with each CPU.  These stacks are only used while the kernel
is in control on that CPU; when a CPU returns to user space the
specialized stacks contain no useful data.  The main CPU stacks are:</p>
<ul>
<li><p class="first">Interrupt stack.  IRQ_STACK_SIZE</p>
<p>Used for external hardware interrupts.  If this is the first external
hardware interrupt (i.e. not a nested hardware interrupt) then the
kernel switches from the current task to the interrupt stack.  Like
the split thread and interrupt stacks on i386, this gives more room
for kernel interrupt processing without having to increase the size
of every per thread stack.</p>
<p>The interrupt stack is also used when processing a softirq.</p>
</li>
</ul>
<p>Switching to the kernel interrupt stack is done by software based on a
per CPU interrupt nest counter. This is needed because x86-64 “IST”
hardware stacks cannot nest without races.</p>
<p>x86_64 also has a feature which is not available on i386, the ability
to automatically switch to a new stack for designated events such as
double fault or NMI, which makes it easier to handle these unusual
events on x86_64.  This feature is called the Interrupt Stack Table
(IST).  There can be up to 7 IST entries per CPU. The IST code is an
index into the Task State Segment (TSS). The IST entries in the TSS
point to dedicated stacks; each stack can be a different size.</p>
<p>An IST is selected by a non-zero value in the IST field of an
interrupt-gate descriptor.  When an interrupt occurs and the hardware
loads such a descriptor, the hardware automatically sets the new stack
pointer based on the IST value, then invokes the interrupt handler.  If
the interrupt came from user mode, then the interrupt handler prologue
will switch back to the per-thread stack.  If software wants to allow
nested IST interrupts then the handler must adjust the IST values on
entry to and exit from the interrupt handler.  (This is occasionally
done, e.g. for debug exceptions.)</p>
<p>Events with different IST codes (i.e. with different stacks) can be
nested.  For example, a debug interrupt can safely be interrupted by an
NMI.  arch/x86_64/kernel/entry.S::paranoidentry adjusts the stack
pointers on entry to and exit from all IST events, in theory allowing
IST events with the same code to be nested.  However in most cases, the
stack size allocated to an IST assumes no nesting for the same code.
If that assumption is ever broken then the stacks will become corrupt.</p>
<p>The currently assigned IST stacks are:</p>
<ul>
<li><p class="first">ESTACK_DF.  EXCEPTION_STKSZ (PAGE_SIZE).</p>
<p>Used for interrupt 8 - Double Fault Exception (#DF).</p>
<p>Invoked when handling one exception causes another exception. Happens
when the kernel is very confused (e.g. kernel stack pointer corrupt).
Using a separate stack allows the kernel to recover from it well enough
in many cases to still output an oops.</p>
</li>
<li><p class="first">ESTACK_NMI.  EXCEPTION_STKSZ (PAGE_SIZE).</p>
<p>Used for non-maskable interrupts (NMI).</p>
<p>NMI can be delivered at any time, including when the kernel is in the
middle of switching stacks.  Using IST for NMI events avoids making
assumptions about the previous state of the kernel stack.</p>
</li>
<li><p class="first">ESTACK_DB.  EXCEPTION_STKSZ (PAGE_SIZE).</p>
<p>Used for hardware debug interrupts (interrupt 1) and for software
debug interrupts (INT3).</p>
<p>When debugging a kernel, debug interrupts (both hardware and
software) can occur at any time.  Using IST for these interrupts
avoids making assumptions about the previous state of the kernel
stack.</p>
<p>To handle nested #DB correctly there exist two instances of DB stacks. On
#DB entry the IST stackpointer for #DB is switched to the second instance
so a nested #DB starts from a clean stack. The nested #DB switches
the IST stackpointer to a guard hole to catch triple nesting.</p>
</li>
<li><p class="first">ESTACK_MCE.  EXCEPTION_STKSZ (PAGE_SIZE).</p>
<p>Used for interrupt 18 - Machine Check Exception (#MC).</p>
<p>MCE can be delivered at any time, including when the kernel is in the
middle of switching stacks.  Using IST for MCE events avoids making
assumptions about the previous state of the kernel stack.</p>
</li>
</ul>
<p>For more details see the Intel IA32 or AMD AMD64 architecture manuals.</p>
</div>
<div class="section" id="printing-backtraces-on-x86">
<h2>4.2. Printing backtraces on x86<a class="headerlink" href="#printing-backtraces-on-x86" title="Permalink to this headline">¶</a></h2>
<p>The question about the ‘?’ preceding function names in an x86 stacktrace
keeps popping up, here’s an indepth explanation. It helps if the reader
stares at print_context_stack() and the whole machinery in and around
arch/x86/kernel/dumpstack.c.</p>
<p>Adapted from Ingo’s mail, Message-ID: &lt;<a class="reference external" href="mailto:20150521101614&#46;GA10889&#37;&#52;&#48;gmail&#46;com">20150521101614<span>&#46;</span>GA10889<span>&#64;</span>gmail<span>&#46;</span>com</a>&gt;:</p>
<p>We always scan the full kernel stack for return addresses stored on
the kernel stack(s) <a class="footnote-reference" href="#id2" id="id1">[1]</a>, from stack top to stack bottom, and print out
anything that ‘looks like’ a kernel text address.</p>
<p>If it fits into the frame pointer chain, we print it without a question
mark, knowing that it’s part of the real backtrace.</p>
<p>If the address does not fit into our expected frame pointer chain we
still print it, but we print a ‘?’. It can mean two things:</p>
<blockquote>
<div><ul class="simple">
<li>either the address is not part of the call chain: it’s just stale
values on the kernel stack, from earlier function calls. This is
the common case.</li>
<li>or it is part of the call chain, but the frame pointer was not set
up properly within the function, so we don’t recognize it.</li>
</ul>
</div></blockquote>
<p>This way we will always print out the real call chain (plus a few more
entries), regardless of whether the frame pointer was set up correctly
or not - but in most cases we’ll get the call chain right as well. The
entries printed are strictly in stack order, so you can deduce more
information from that as well.</p>
<p>The most important property of this method is that we _never_ lose
information: we always strive to print _all_ addresses on the stack(s)
that look like kernel text addresses, so if debug information is wrong,
we still print out the real call chain as well - just with more question
marks than ideal.</p>
<table class="docutils footnote" frame="void" id="id2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>For things like IRQ and IST stacks, we also scan those stacks, in
the right order, and try to cross from one stack into another
reconstructing the call chain. This works most of the time.</td></tr>
</tbody>
</table>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="entry_64.html" class="btn btn-neutral float-right" title="5. Kernel Entries" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="exception-tables.html" class="btn btn-neutral float-left" title="3. Kernel level exception handling" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>