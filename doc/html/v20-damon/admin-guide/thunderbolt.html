

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>USB4 and Thunderbolt &mdash; The Linux Kernel  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Using UFS" href="ufs.html" />
    <link rel="prev" title="Linux Magic System Request Key Hacks" href="sysrq.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.8.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">The Linux kernel user’s and administrator’s guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="README.html">Linux kernel release 5.x &lt;http://kernel.org/&gt;</a></li>
<li class="toctree-l2"><a class="reference internal" href="kernel-parameters.html">The kernel’s command-line parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="devices.html">Linux allocated devices (4.x+ version)</a></li>
<li class="toctree-l2"><a class="reference internal" href="sysctl/index.html">Documentation for /proc/sys</a></li>
<li class="toctree-l2"><a class="reference internal" href="hw-vuln/index.html">Hardware vulnerabilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="reporting-bugs.html">Reporting bugs</a></li>
<li class="toctree-l2"><a class="reference internal" href="security-bugs.html">Security bugs</a></li>
<li class="toctree-l2"><a class="reference internal" href="bug-hunting.html">Bug hunting</a></li>
<li class="toctree-l2"><a class="reference internal" href="bug-bisect.html">Bisecting a bug</a></li>
<li class="toctree-l2"><a class="reference internal" href="tainted-kernels.html">Tainted kernels</a></li>
<li class="toctree-l2"><a class="reference internal" href="ramoops.html">Ramoops oops/panic logger</a></li>
<li class="toctree-l2"><a class="reference internal" href="dynamic-debug-howto.html">Dynamic debug</a></li>
<li class="toctree-l2"><a class="reference internal" href="init.html">Explaining the “No working init found.” boot hang message</a></li>
<li class="toctree-l2"><a class="reference internal" href="kdump/index.html">Documentation for Kdump - The kexec-based Crash Dumping Solution</a></li>
<li class="toctree-l2"><a class="reference internal" href="perf/index.html">Performance monitor support</a></li>
<li class="toctree-l2"><a class="reference internal" href="sysfs-rules.html">Rules on how to access information in sysfs</a></li>
<li class="toctree-l2"><a class="reference internal" href="acpi/index.html">ACPI Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="aoe/index.html">ATA over Ethernet (AoE)</a></li>
<li class="toctree-l2"><a class="reference internal" href="auxdisplay/index.html">Auxiliary Display Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="bcache.html">A block layer cache (bcache)</a></li>
<li class="toctree-l2"><a class="reference internal" href="binderfs.html">The Android binderfs Filesystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="binfmt-misc.html">Kernel Support for miscellaneous Binary Formats (binfmt_misc)</a></li>
<li class="toctree-l2"><a class="reference internal" href="blockdev/index.html">The Linux RapidIO Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="bootconfig.html">Boot Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="braille-console.html">Linux Braille Console</a></li>
<li class="toctree-l2"><a class="reference internal" href="btmrvl.html">btmrvl driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="cgroup-v1/index.html">Control Groups version 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="cgroup-v2.html">Control Group v2</a></li>
<li class="toctree-l2"><a class="reference internal" href="cifs/index.html">CIFS</a></li>
<li class="toctree-l2"><a class="reference internal" href="clearing-warn-once.html">Clearing WARN_ONCE</a></li>
<li class="toctree-l2"><a class="reference internal" href="cpu-load.html">CPU load</a></li>
<li class="toctree-l2"><a class="reference internal" href="cputopology.html">How CPU topology info is exported via sysfs</a></li>
<li class="toctree-l2"><a class="reference internal" href="dell_rbu.html">Dell Remote BIOS Update driver (dell_rbu)</a></li>
<li class="toctree-l2"><a class="reference internal" href="device-mapper/index.html">Device Mapper</a></li>
<li class="toctree-l2"><a class="reference internal" href="edid.html">EDID</a></li>
<li class="toctree-l2"><a class="reference internal" href="efi-stub.html">The EFI Boot Stub</a></li>
<li class="toctree-l2"><a class="reference internal" href="ext4.html">ext4 General Information</a></li>
<li class="toctree-l2"><a class="reference internal" href="nfs/index.html">NFS</a></li>
<li class="toctree-l2"><a class="reference internal" href="gpio/index.html">gpio</a></li>
<li class="toctree-l2"><a class="reference internal" href="highuid.html">Notes on the change from 16-bit UIDs to 32-bit UIDs</a></li>
<li class="toctree-l2"><a class="reference internal" href="hw_random.html">Linux support for random number generator in i8xx chipsets</a></li>
<li class="toctree-l2"><a class="reference internal" href="initrd.html">Using the initial RAM disk (initrd)</a></li>
<li class="toctree-l2"><a class="reference internal" href="iostats.html">I/O statistics fields</a></li>
<li class="toctree-l2"><a class="reference internal" href="java.html">Java(tm) Binary Kernel Support for Linux v1.03</a></li>
<li class="toctree-l2"><a class="reference internal" href="jfs.html">IBM’s Journaled File System (JFS) for Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="kernel-per-CPU-kthreads.html">Reducing OS jitter due to per-cpu kthreads</a></li>
<li class="toctree-l2"><a class="reference internal" href="laptops/index.html">Laptop Drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="lcd-panel-cgram.html">Parallel port LCD/Keypad Panel support</a></li>
<li class="toctree-l2"><a class="reference internal" href="ldm.html">LDM - Logical Disk Manager (Dynamic Disks)</a></li>
<li class="toctree-l2"><a class="reference internal" href="lockup-watchdogs.html">Softlockup detector and hardlockup detector (aka nmi_watchdog)</a></li>
<li class="toctree-l2"><a class="reference internal" href="LSM/index.html">Linux Security Module Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="md.html">RAID arrays</a></li>
<li class="toctree-l2"><a class="reference internal" href="media/index.html">Media subsystem admin and user guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="mm/index.html">Memory Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="module-signing.html">Kernel module signing facility</a></li>
<li class="toctree-l2"><a class="reference internal" href="mono.html">Mono(tm) Binary Kernel Support for Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="namespaces/index.html">Namespaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="numastat.html">Numa policy hit/miss statistics</a></li>
<li class="toctree-l2"><a class="reference internal" href="parport.html">Parport</a></li>
<li class="toctree-l2"><a class="reference internal" href="perf-security.html">Perf events and tool security</a></li>
<li class="toctree-l2"><a class="reference internal" href="pm/index.html">Power Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="pnp.html">Linux Plug and Play Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="rapidio.html">RapidIO Subsystem Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="ras.html">Reliability, Availability and Serviceability</a></li>
<li class="toctree-l2"><a class="reference internal" href="rtc.html">Real Time Clock (RTC) Drivers for Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="serial-console.html">Linux Serial Console</a></li>
<li class="toctree-l2"><a class="reference internal" href="svga.html">Video Mode Selection Support 2.13</a></li>
<li class="toctree-l2"><a class="reference internal" href="sysrq.html">Linux Magic System Request Key Hacks</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">USB4 and Thunderbolt</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#security-levels-and-how-to-use-them">Security levels and how to use them</a></li>
<li class="toctree-l3"><a class="reference internal" href="#authorizing-devices-when-security-level-is-user-or-secure">Authorizing devices when security level is <code class="docutils literal notranslate"><span class="pre">user</span></code> or <code class="docutils literal notranslate"><span class="pre">secure</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#dma-protection-utilizing-iommu">DMA protection utilizing IOMMU</a></li>
<li class="toctree-l3"><a class="reference internal" href="#upgrading-nvm-on-thunderbolt-device-or-host">Upgrading NVM on Thunderbolt device or host</a></li>
<li class="toctree-l3"><a class="reference internal" href="#upgrading-nvm-when-host-controller-is-in-safe-mode">Upgrading NVM when host controller is in safe mode</a></li>
<li class="toctree-l3"><a class="reference internal" href="#networking-over-thunderbolt-cable">Networking over Thunderbolt cable</a></li>
<li class="toctree-l3"><a class="reference internal" href="#forcing-power">Forcing power</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="ufs.html">Using UFS</a></li>
<li class="toctree-l2"><a class="reference internal" href="unicode.html">Unicode support</a></li>
<li class="toctree-l2"><a class="reference internal" href="vga-softcursor.html">Software cursor for VGA</a></li>
<li class="toctree-l2"><a class="reference internal" href="video-output.html">Video Output Switcher Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="wimax/index.html">WiMAX subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="xfs.html">The SGI XFS Filesystem</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../kbuild/index.html">Kernel Build System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devicetree/index.html">Open Firmware and Device Tree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../livepatch/index.html">Kernel Livepatching</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../locking/index.html">locking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../accounting/index.html">Accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../block/index.html">Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cdrom/index.html">cdrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cpu-freq/index.html">Linux CPUFreq - CPU frequency and voltage scaling code in the Linux(TM) kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ide/index.html">Integrated Drive Electronics (IDE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fpga/index.html">fpga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../isdn/index.html">ISDN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../leds/index.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../power/index.html">Power Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../timers/index.html">timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../virt/index.html">Linux Virtualization Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usb/index.html">USB support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scsi/index.html">Linux SCSI Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scheduler/index.html">Linux Scheduler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mhi/index.html">MHI</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../asm-annotations.html">Assembler Annotations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../arm/index.html">ARM Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../arm64/index.html">ARM64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ia64/index.html">IA-64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../m68k/index.html">m68k Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mips/index.html">MIPS-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nios2/nios2.html">Linux on the Nios II architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../openrisc/index.html">OpenRISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parisc/index.html">PA-RISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../powerpc/index.html">powerpc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../riscv/index.html">RISC-V architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../s390/index.html">s390 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sh/index.html">SuperH Interfaces Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sparc/index.html">Sparc Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../x86/index.html">x86-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../xtensa/index.html">Xtensa Architecture</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/ext4/index.html">ext4 Data Structures and Algorithms</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">The Linux kernel user’s and administrator’s guide</a> &raquo;</li>
        
      <li>USB4 and Thunderbolt</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/admin-guide/thunderbolt.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="usb4-and-thunderbolt">
<h1>USB4 and Thunderbolt<a class="headerlink" href="#usb4-and-thunderbolt" title="Permalink to this headline">¶</a></h1>
<p>USB4 is the public specification based on Thunderbolt 3 protocol with
some differences at the register level among other things. Connection
manager is an entity running on the host router (host controller)
responsible for enumerating routers and establishing tunnels. A
connection manager can be implemented either in firmware or software.
Typically PCs come with a firmware connection manager for Thunderbolt 3
and early USB4 capable systems. Apple systems on the other hand use
software connection manager and the later USB4 compliant devices follow
the suit.</p>
<p>The Linux Thunderbolt driver supports both and can detect at runtime which
connection manager implementation is to be used. To be on the safe side the
software connection manager in Linux also advertises security level
<code class="docutils literal notranslate"><span class="pre">user</span></code> which means PCIe tunneling is disabled by default. The
documentation below applies to both implementations with the exception that
the software connection manager only supports <code class="docutils literal notranslate"><span class="pre">user</span></code> security level and
is expected to be accompanied with an IOMMU based DMA protection.</p>
<div class="section" id="security-levels-and-how-to-use-them">
<h2>Security levels and how to use them<a class="headerlink" href="#security-levels-and-how-to-use-them" title="Permalink to this headline">¶</a></h2>
<p>The interface presented here is not meant for end users. Instead there
should be a userspace tool that handles all the low-level details, keeps
a database of the authorized devices and prompts users for new connections.</p>
<p>More details about the sysfs interface for Thunderbolt devices can be
found in <code class="docutils literal notranslate"><span class="pre">Documentation/ABI/testing/sysfs-bus-thunderbolt</span></code>.</p>
<p>Those users who just want to connect any device without any sort of
manual work can add following line to
<code class="docutils literal notranslate"><span class="pre">/etc/udev/rules.d/99-local.rules</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ACTION==&quot;add&quot;, SUBSYSTEM==&quot;thunderbolt&quot;, ATTR{authorized}==&quot;0&quot;, ATTR{authorized}=&quot;1&quot;
</pre></div>
</div>
<p>This will authorize all devices automatically when they appear. However,
keep in mind that this bypasses the security levels and makes the system
vulnerable to DMA attacks.</p>
<p>Starting with Intel Falcon Ridge Thunderbolt controller there are 4
security levels available. Intel Titan Ridge added one more security level
(usbonly). The reason for these is the fact that the connected devices can
be DMA masters and thus read contents of the host memory without CPU and OS
knowing about it. There are ways to prevent this by setting up an IOMMU but
it is not always available for various reasons.</p>
<p>The security levels are as follows:</p>
<blockquote>
<div><dl class="simple">
<dt>none</dt><dd><p>All devices are automatically connected by the firmware. No user
approval is needed. In BIOS settings this is typically called
<em>Legacy mode</em>.</p>
</dd>
<dt>user</dt><dd><p>User is asked whether the device is allowed to be connected.
Based on the device identification information available through
<code class="docutils literal notranslate"><span class="pre">/sys/bus/thunderbolt/devices</span></code>, the user then can make the decision.
In BIOS settings this is typically called <em>Unique ID</em>.</p>
</dd>
<dt>secure</dt><dd><p>User is asked whether the device is allowed to be connected. In
addition to UUID the device (if it supports secure connect) is sent
a challenge that should match the expected one based on a random key
written to the <code class="docutils literal notranslate"><span class="pre">key</span></code> sysfs attribute. In BIOS settings this is
typically called <em>One time saved key</em>.</p>
</dd>
<dt>dponly</dt><dd><p>The firmware automatically creates tunnels for Display Port and
USB. No PCIe tunneling is done. In BIOS settings this is
typically called <em>Display Port Only</em>.</p>
</dd>
<dt>usbonly</dt><dd><p>The firmware automatically creates tunnels for the USB controller and
Display Port in a dock. All PCIe links downstream of the dock are
removed.</p>
</dd>
</dl>
</div></blockquote>
<p>The current security level can be read from
<code class="docutils literal notranslate"><span class="pre">/sys/bus/thunderbolt/devices/domainX/security</span></code> where <code class="docutils literal notranslate"><span class="pre">domainX</span></code> is
the Thunderbolt domain the host controller manages. There is typically
one domain per Thunderbolt host controller.</p>
<p>If the security level reads as <code class="docutils literal notranslate"><span class="pre">user</span></code> or <code class="docutils literal notranslate"><span class="pre">secure</span></code> the connected
device must be authorized by the user before PCIe tunnels are created
(e.g the PCIe device appears).</p>
<p>Each Thunderbolt device plugged in will appear in sysfs under
<code class="docutils literal notranslate"><span class="pre">/sys/bus/thunderbolt/devices</span></code>. The device directory carries
information that can be used to identify the particular device,
including its name and UUID.</p>
</div>
<div class="section" id="authorizing-devices-when-security-level-is-user-or-secure">
<h2>Authorizing devices when security level is <code class="docutils literal notranslate"><span class="pre">user</span></code> or <code class="docutils literal notranslate"><span class="pre">secure</span></code><a class="headerlink" href="#authorizing-devices-when-security-level-is-user-or-secure" title="Permalink to this headline">¶</a></h2>
<p>When a device is plugged in it will appear in sysfs as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/sys/bus/thunderbolt/devices/0-1/authorized   - 0
/sys/bus/thunderbolt/devices/0-1/device       - 0x8004
/sys/bus/thunderbolt/devices/0-1/device_name  - Thunderbolt to FireWire Adapter
/sys/bus/thunderbolt/devices/0-1/vendor       - 0x1
/sys/bus/thunderbolt/devices/0-1/vendor_name  - Apple, Inc.
/sys/bus/thunderbolt/devices/0-1/unique_id    - e0376f00-0300-0100-ffff-ffffffffffff
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">authorized</span></code> attribute reads 0 which means no PCIe tunnels are
created yet. The user can authorize the device by simply entering:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># echo 1 &gt; /sys/bus/thunderbolt/devices/0-1/authorized
</pre></div>
</div>
<p>This will create the PCIe tunnels and the device is now connected.</p>
<p>If the device supports secure connect, and the domain security level is
set to <code class="docutils literal notranslate"><span class="pre">secure</span></code>, it has an additional attribute <code class="docutils literal notranslate"><span class="pre">key</span></code> which can hold
a random 32-byte value used for authorization and challenging the device in
future connects:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/sys/bus/thunderbolt/devices/0-3/authorized   - 0
/sys/bus/thunderbolt/devices/0-3/device       - 0x305
/sys/bus/thunderbolt/devices/0-3/device_name  - AKiTiO Thunder3 PCIe Box
/sys/bus/thunderbolt/devices/0-3/key          -
/sys/bus/thunderbolt/devices/0-3/vendor       - 0x41
/sys/bus/thunderbolt/devices/0-3/vendor_name  - inXtron
/sys/bus/thunderbolt/devices/0-3/unique_id    - dc010000-0000-8508-a22d-32ca6421cb16
</pre></div>
</div>
<p>Notice the key is empty by default.</p>
<p>If the user does not want to use secure connect they can just <code class="docutils literal notranslate"><span class="pre">echo</span> <span class="pre">1</span></code>
to the <code class="docutils literal notranslate"><span class="pre">authorized</span></code> attribute and the PCIe tunnels will be created in
the same way as in the <code class="docutils literal notranslate"><span class="pre">user</span></code> security level.</p>
<p>If the user wants to use secure connect, the first time the device is
plugged a key needs to be created and sent to the device:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># key=$(openssl rand -hex 32)
# echo $key &gt; /sys/bus/thunderbolt/devices/0-3/key
# echo 1 &gt; /sys/bus/thunderbolt/devices/0-3/authorized
</pre></div>
</div>
<p>Now the device is connected (PCIe tunnels are created) and in addition
the key is stored on the device NVM.</p>
<p>Next time the device is plugged in the user can verify (challenge) the
device using the same key:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># echo $key &gt; /sys/bus/thunderbolt/devices/0-3/key
# echo 2 &gt; /sys/bus/thunderbolt/devices/0-3/authorized
</pre></div>
</div>
<p>If the challenge the device returns back matches the one we expect based
on the key, the device is connected and the PCIe tunnels are created.
However, if the challenge fails no tunnels are created and error is
returned to the user.</p>
<p>If the user still wants to connect the device they can either approve
the device without a key or write a new key and write 1 to the
<code class="docutils literal notranslate"><span class="pre">authorized</span></code> file to get the new key stored on the device NVM.</p>
</div>
<div class="section" id="dma-protection-utilizing-iommu">
<h2>DMA protection utilizing IOMMU<a class="headerlink" href="#dma-protection-utilizing-iommu" title="Permalink to this headline">¶</a></h2>
<p>Recent systems from 2018 and forward with Thunderbolt ports may natively
support IOMMU. This means that Thunderbolt security is handled by an IOMMU
so connected devices cannot access memory regions outside of what is
allocated for them by drivers. When Linux is running on such system it
automatically enables IOMMU if not enabled by the user already. These
systems can be identified by reading <code class="docutils literal notranslate"><span class="pre">1</span></code> from
<code class="docutils literal notranslate"><span class="pre">/sys/bus/thunderbolt/devices/domainX/iommu_dma_protection</span></code> attribute.</p>
<p>The driver does not do anything special in this case but because DMA
protection is handled by the IOMMU, security levels (if set) are
redundant. For this reason some systems ship with security level set to
<code class="docutils literal notranslate"><span class="pre">none</span></code>. Other systems have security level set to <code class="docutils literal notranslate"><span class="pre">user</span></code> in order to
support downgrade to older OS, so users who want to automatically
authorize devices when IOMMU DMA protection is enabled can use the
following <code class="docutils literal notranslate"><span class="pre">udev</span></code> rule:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ACTION==&quot;add&quot;, SUBSYSTEM==&quot;thunderbolt&quot;, ATTRS{iommu_dma_protection}==&quot;1&quot;, ATTR{authorized}==&quot;0&quot;, ATTR{authorized}=&quot;1&quot;
</pre></div>
</div>
</div>
<div class="section" id="upgrading-nvm-on-thunderbolt-device-or-host">
<h2>Upgrading NVM on Thunderbolt device or host<a class="headerlink" href="#upgrading-nvm-on-thunderbolt-device-or-host" title="Permalink to this headline">¶</a></h2>
<p>Since most of the functionality is handled in firmware running on a
host controller or a device, it is important that the firmware can be
upgraded to the latest where possible bugs in it have been fixed.
Typically OEMs provide this firmware from their support site.</p>
<p>There is also a central site which has links where to download firmware
for some machines:</p>
<blockquote>
<div><p><a class="reference external" href="https://thunderbolttechnology.net/updates">Thunderbolt Updates</a></p>
</div></blockquote>
<p>Before you upgrade firmware on a device or host, please make sure it is a
suitable upgrade. Failing to do that may render the device (or host) in a
state where it cannot be used properly anymore without special tools!</p>
<p>Host NVM upgrade on Apple Macs is not supported.</p>
<p>Once the NVM image has been downloaded, you need to plug in a
Thunderbolt device so that the host controller appears. It does not
matter which device is connected (unless you are upgrading NVM on a
device - then you need to connect that particular device).</p>
<p>Note an OEM-specific method to power the controller up (“force power”) may
be available for your system in which case there is no need to plug in a
Thunderbolt device.</p>
<p>After that we can write the firmware to the non-active parts of the NVM
of the host or device. As an example here is how Intel NUC6i7KYK (Skull
Canyon) Thunderbolt controller NVM is upgraded:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># dd if=KYK_TBT_FW_0018.bin of=/sys/bus/thunderbolt/devices/0-0/nvm_non_active0/nvmem
</pre></div>
</div>
<p>Once the operation completes we can trigger NVM authentication and
upgrade process as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># echo 1 &gt; /sys/bus/thunderbolt/devices/0-0/nvm_authenticate
</pre></div>
</div>
<p>If no errors are returned, the host controller shortly disappears. Once
it comes back the driver notices it and initiates a full power cycle.
After a while the host controller appears again and this time it should
be fully functional.</p>
<p>We can verify that the new NVM firmware is active by running the following
commands:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># cat /sys/bus/thunderbolt/devices/0-0/nvm_authenticate
0x0
# cat /sys/bus/thunderbolt/devices/0-0/nvm_version
18.0
</pre></div>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">nvm_authenticate</span></code> contains anything other than 0x0 it is the error
code from the last authentication cycle, which means the authentication
of the NVM image failed.</p>
<p>Note names of the NVMem devices <code class="docutils literal notranslate"><span class="pre">nvm_activeN</span></code> and <code class="docutils literal notranslate"><span class="pre">nvm_non_activeN</span></code>
depend on the order they are registered in the NVMem subsystem. N in
the name is the identifier added by the NVMem subsystem.</p>
</div>
<div class="section" id="upgrading-nvm-when-host-controller-is-in-safe-mode">
<h2>Upgrading NVM when host controller is in safe mode<a class="headerlink" href="#upgrading-nvm-when-host-controller-is-in-safe-mode" title="Permalink to this headline">¶</a></h2>
<p>If the existing NVM is not properly authenticated (or is missing) the
host controller goes into safe mode which means that the only available
functionality is flashing a new NVM image. When in this mode, reading
<code class="docutils literal notranslate"><span class="pre">nvm_version</span></code> fails with <code class="docutils literal notranslate"><span class="pre">ENODATA</span></code> and the device identification
information is missing.</p>
<p>To recover from this mode, one needs to flash a valid NVM image to the
host controller in the same way it is done in the previous chapter.</p>
</div>
<div class="section" id="networking-over-thunderbolt-cable">
<h2>Networking over Thunderbolt cable<a class="headerlink" href="#networking-over-thunderbolt-cable" title="Permalink to this headline">¶</a></h2>
<p>Thunderbolt technology allows software communication between two hosts
connected by a Thunderbolt cable.</p>
<p>It is possible to tunnel any kind of traffic over a Thunderbolt link but
currently we only support Apple ThunderboltIP protocol.</p>
<p>If the other host is running Windows or macOS, the only thing you need to
do is to connect a Thunderbolt cable between the two hosts; the
<code class="docutils literal notranslate"><span class="pre">thunderbolt-net</span></code> driver is loaded automatically. If the other host is
also Linux you should load <code class="docutils literal notranslate"><span class="pre">thunderbolt-net</span></code> manually on one host (it
does not matter which one):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># modprobe thunderbolt-net
</pre></div>
</div>
<p>This triggers module load on the other host automatically. If the driver
is built-in to the kernel image, there is no need to do anything.</p>
<p>The driver will create one virtual ethernet interface per Thunderbolt
port which are named like <code class="docutils literal notranslate"><span class="pre">thunderbolt0</span></code> and so on. From this point
you can either use standard userspace tools like <code class="docutils literal notranslate"><span class="pre">ifconfig</span></code> to
configure the interface or let your GUI handle it automatically.</p>
</div>
<div class="section" id="forcing-power">
<h2>Forcing power<a class="headerlink" href="#forcing-power" title="Permalink to this headline">¶</a></h2>
<p>Many OEMs include a method that can be used to force the power of a
Thunderbolt controller to an “On” state even if nothing is connected.
If supported by your machine this will be exposed by the WMI bus with
a sysfs attribute called “force_power”.</p>
<dl>
<dt>For example the intel-wmi-thunderbolt driver exposes this attribute in:</dt><dd><p>/sys/bus/wmi/devices/86CCFD48-205E-4A77-9C48-2021CBEDE341/force_power</p>
<p>To force the power to on, write 1 to this attribute file.
To disable force power, write 0 to this attribute file.</p>
</dd>
</dl>
<p>Note: it’s currently not possible to query the force power state of a platform.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="ufs.html" class="btn btn-neutral float-right" title="Using UFS" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="sysrq.html" class="btn btn-neutral float-left" title="Linux Magic System Request Key Hacks" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright The kernel development community

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>