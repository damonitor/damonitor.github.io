

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>MEN Chameleon Bus &mdash; The Linux Kernel  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.7.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/mm/damon/index.html">DAMON: Data Access MONitor</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>MEN Chameleon Bus</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/driver-api/men-chameleon-bus.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="men-chameleon-bus">
<h1>MEN Chameleon Bus<a class="headerlink" href="#men-chameleon-bus" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>This document describes the architecture and implementation of the MEN
Chameleon Bus (called MCB throughout this document).</p>
<div class="section" id="scope-of-this-document">
<h3>Scope of this Document<a class="headerlink" href="#scope-of-this-document" title="Permalink to this headline">¶</a></h3>
<p>This document is intended to be a short overview of the current
implementation and does by no means describe the complete possibilities of MCB
based devices.</p>
</div>
<div class="section" id="limitations-of-the-current-implementation">
<h3>Limitations of the current implementation<a class="headerlink" href="#limitations-of-the-current-implementation" title="Permalink to this headline">¶</a></h3>
<p>The current implementation is limited to PCI and PCIe based carrier devices
that only use a single memory resource and share the PCI legacy IRQ.  Not
implemented are:</p>
<ul class="simple">
<li>Multi-resource MCB devices like the VME Controller or M-Module carrier.</li>
<li>MCB devices that need another MCB device, like SRAM for a DMA Controller’s
buffer descriptors or a video controller’s video memory.</li>
<li>A per-carrier IRQ domain for carrier devices that have one (or more) IRQs
per MCB device like PCIe based carriers with MSI or MSI-X support.</li>
</ul>
</div>
</div>
<div class="section" id="architecture">
<h2>Architecture<a class="headerlink" href="#architecture" title="Permalink to this headline">¶</a></h2>
<p>MCB is divided into 3 functional blocks:</p>
<ul class="simple">
<li>The MEN Chameleon Bus itself,</li>
<li>drivers for MCB Carrier Devices and</li>
<li>the parser for the Chameleon table.</li>
</ul>
<div class="section" id="id1">
<h3>MEN Chameleon Bus<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>The MEN Chameleon Bus is an artificial bus system that attaches to a so
called Chameleon FPGA device found on some hardware produced my MEN Mikro
Elektronik GmbH. These devices are multi-function devices implemented in a
single FPGA and usually attached via some sort of PCI or PCIe link. Each
FPGA contains a header section describing the content of the FPGA. The
header lists the device id, PCI BAR, offset from the beginning of the PCI
BAR, size in the FPGA, interrupt number and some other properties currently
not handled by the MCB implementation.</p>
</div>
<div class="section" id="carrier-devices">
<h3>Carrier Devices<a class="headerlink" href="#carrier-devices" title="Permalink to this headline">¶</a></h3>
<p>A carrier device is just an abstraction for the real world physical bus the
Chameleon FPGA is attached to. Some IP Core drivers may need to interact with
properties of the carrier device (like querying the IRQ number of a PCI
device). To provide abstraction from the real hardware bus, an MCB carrier
device provides callback methods to translate the driver’s MCB function calls
to hardware related function calls. For example a carrier device may
implement the get_irq() method which can be translated into a hardware bus
query for the IRQ number the device should use.</p>
</div>
<div class="section" id="parser">
<h3>Parser<a class="headerlink" href="#parser" title="Permalink to this headline">¶</a></h3>
<p>The parser reads the first 512 bytes of a Chameleon device and parses the
Chameleon table. Currently the parser only supports the Chameleon v2 variant
of the Chameleon table but can easily be adopted to support an older or
possible future variant. While parsing the table’s entries new MCB devices
are allocated and their resources are assigned according to the resource
assignment in the Chameleon table. After resource assignment is finished, the
MCB devices are registered at the MCB and thus at the driver core of the
Linux kernel.</p>
</div>
</div>
<div class="section" id="resource-handling">
<h2>Resource handling<a class="headerlink" href="#resource-handling" title="Permalink to this headline">¶</a></h2>
<p>The current implementation assigns exactly one memory and one IRQ resource
per MCB device. But this is likely going to change in the future.</p>
<div class="section" id="memory-resources">
<h3>Memory Resources<a class="headerlink" href="#memory-resources" title="Permalink to this headline">¶</a></h3>
<p>Each MCB device has exactly one memory resource, which can be requested from
the MCB bus. This memory resource is the physical address of the MCB device
inside the carrier and is intended to be passed to <a class="reference internal" href="device-io.html#c.ioremap" title="ioremap"><code class="xref c c-func docutils literal notranslate"><span class="pre">ioremap()</span></code></a> and friends. It
is already requested from the kernel by calling request_mem_region().</p>
</div>
<div class="section" id="irqs">
<h3>IRQs<a class="headerlink" href="#irqs" title="Permalink to this headline">¶</a></h3>
<p>Each MCB device has exactly one IRQ resource, which can be requested from the
MCB bus. If a carrier device driver implements the -&gt;get_irq() callback
method, the IRQ number assigned by the carrier device will be returned,
otherwise the IRQ number inside the Chameleon table will be returned. This
number is suitable to be passed to <a class="reference internal" href="../core-api/genericirq.html#c.request_irq" title="request_irq"><code class="xref c c-func docutils literal notranslate"><span class="pre">request_irq()</span></code></a>.</p>
</div>
</div>
<div class="section" id="writing-an-mcb-driver">
<h2>Writing an MCB driver<a class="headerlink" href="#writing-an-mcb-driver" title="Permalink to this headline">¶</a></h2>
<div class="section" id="the-driver-structure">
<h3>The driver structure<a class="headerlink" href="#the-driver-structure" title="Permalink to this headline">¶</a></h3>
<p>Each MCB driver has a structure to identify the device driver as well as
device ids which identify the IP Core inside the FPGA. The driver structure
also contains callback methods which get executed on driver probe and
removal from the system:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>static const struct mcb_device_id foo_ids[] = {
        { .device = 0x123 },
        { }
};
MODULE_DEVICE_TABLE(mcb, foo_ids);

static struct mcb_driver foo_driver = {
driver = {
        .name = &quot;foo-bar&quot;,
        .owner = THIS_MODULE,
},
        .probe = foo_probe,
        .remove = foo_remove,
        .id_table = foo_ids,
};
</pre></div>
</div>
</div>
<div class="section" id="probing-and-attaching">
<h3>Probing and attaching<a class="headerlink" href="#probing-and-attaching" title="Permalink to this headline">¶</a></h3>
<p>When a driver is loaded and the MCB devices it services are found, the MCB
core will call the driver’s probe callback method. When the driver is removed
from the system, the MCB core will call the driver’s remove callback method:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>static init foo_probe(struct mcb_device *mdev, const struct mcb_device_id *id);
static void foo_remove(struct mcb_device *mdev);
</pre></div>
</div>
</div>
<div class="section" id="initializing-the-driver">
<h3>Initializing the driver<a class="headerlink" href="#initializing-the-driver" title="Permalink to this headline">¶</a></h3>
<p>When the kernel is booted or your foo driver module is inserted, you have to
perform driver initialization. Usually it is enough to register your driver
module at the MCB core:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>static int __init foo_init(void)
{
        return mcb_register_driver(&amp;foo_driver);
}
module_init(foo_init);

static void __exit foo_exit(void)
{
        mcb_unregister_driver(&amp;foo_driver);
}
module_exit(foo_exit);
</pre></div>
</div>
<p>The module_mcb_driver() macro can be used to reduce the above code:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>module_mcb_driver(foo_driver);
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>