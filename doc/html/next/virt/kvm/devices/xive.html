

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>POWER9 eXternal Interrupt Virtualization Engine (XIVE Gen1) &mdash; The Linux Kernel  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../../../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.8.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../admin-guide/mm/damon/index.html">Monitoring Data Accesses</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../vm/damon/index.html">DAMON: Data Access MONitor</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
      <li>POWER9 eXternal Interrupt Virtualization Engine (XIVE Gen1)</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/virt/kvm/devices/xive.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="power9-external-interrupt-virtualization-engine-xive-gen1">
<h1>POWER9 eXternal Interrupt Virtualization Engine (XIVE Gen1)<a class="headerlink" href="#power9-external-interrupt-virtualization-engine-xive-gen1" title="Permalink to this headline">Â¶</a></h1>
<dl class="docutils">
<dt>Device types supported:</dt>
<dd><ul class="first last simple">
<li>KVM_DEV_TYPE_XIVE     POWER9 XIVE Interrupt Controller generation 1</li>
</ul>
</dd>
</dl>
<p>This device acts as a VM interrupt controller. It provides the KVM
interface to configure the interrupt sources of a VM in the underlying
POWER9 XIVE interrupt controller.</p>
<p>Only one XIVE instance may be instantiated. A guest XIVE device
requires a POWER9 host and the guest OS should have support for the
XIVE native exploitation interrupt mode. If not, it should run using
the legacy interrupt mode, referred as XICS (POWER7/8).</p>
<ul>
<li><p class="first">Device Mappings</p>
<p>The KVM device exposes different MMIO ranges of the XIVE HW which
are required for interrupt management. These are exposed to the
guest in VMAs populated with a custom VM fault handler.</p>
<ol class="arabic simple">
<li>Thread Interrupt Management Area (TIMA)</li>
</ol>
<p>Each thread has an associated Thread Interrupt Management context
composed of a set of registers. These registers let the thread
handle priority management and interrupt acknowledgment. The most
important are :</p>
<blockquote>
<div><ul class="simple">
<li>Interrupt Pending Buffer     (IPB)</li>
<li>Current Processor Priority   (CPPR)</li>
<li>Notification Source Register (NSR)</li>
</ul>
</div></blockquote>
<p>They are exposed to software in four different pages each proposing
a view with a different privilege. The first page is for the
physical thread context and the second for the hypervisor. Only the
third (operating system) and the fourth (user level) are exposed the
guest.</p>
<ol class="arabic simple" start="2">
<li>Event State Buffer (ESB)</li>
</ol>
<p>Each source is associated with an Event State Buffer (ESB) with
either a pair of even/odd pair of pages which provides commands to
manage the source: to trigger, to EOI, to turn off the source for
instance.</p>
<ol class="arabic simple" start="3">
<li>Device pass-through</li>
</ol>
<p>When a device is passed-through into the guest, the source
interrupts are from a different HW controller (PHB4) and the ESB
pages exposed to the guest should accommadate this change.</p>
<p>The passthru_irq helpers, kvmppc_xive_set_mapped() and
kvmppc_xive_clr_mapped() are called when the device HW irqs are
mapped into or unmapped from the guest IRQ number space. The KVM
device extends these helpers to clear the ESB pages of the guest IRQ
number being mapped and then lets the VM fault handler repopulate.
The handler will insert the ESB page corresponding to the HW
interrupt of the device being passed-through or the initial IPI ESB
page if the device has being removed.</p>
<p>The ESB remapping is fully transparent to the guest and the OS
device driver. All handling is done within VFIO and the above
helpers in KVM-PPC.</p>
</li>
<li><p class="first">Groups:</p>
</li>
</ul>
<ol class="arabic simple">
<li><dl class="first docutils">
<dt>KVM_DEV_XIVE_GRP_CTRL</dt>
<dd>Provides global controls on the device</dd>
</dl>
</li>
</ol>
<blockquote>
<div><dl class="docutils">
<dt>Attributes:</dt>
<dd><p class="first">1.1 KVM_DEV_XIVE_RESET (write only)
Resets the interrupt controller configuration for sources and event
queues. To be used by kexec and kdump.</p>
<p>Errors: none</p>
<p>1.2 KVM_DEV_XIVE_EQ_SYNC (write only)
Sync all the sources and queues and mark the EQ pages dirty. This
to make sure that a consistent memory state is captured when
migrating the VM.</p>
<p>Errors: none</p>
<p>1.3 KVM_DEV_XIVE_NR_SERVERS (write only)
The kvm_device_attr.addr points to a __u32 value which is the number of
interrupt server numbers (ie, highest possible vcpu id plus one).</p>
<p>Errors:</p>
<blockquote class="last">
<div><table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="86%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>-EINVAL</td>
<td>Value greater than KVM_MAX_VCPU_ID.</td>
</tr>
<tr class="row-even"><td>-EFAULT</td>
<td>Invalid user pointer for attr-&gt;addr.</td>
</tr>
<tr class="row-odd"><td>-EBUSY</td>
<td>A vCPU is already connected to the device.</td>
</tr>
</tbody>
</table>
</div></blockquote>
</dd>
</dl>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><dl class="first docutils">
<dt>KVM_DEV_XIVE_GRP_SOURCE (write only)</dt>
<dd>Initializes a new source in the XIVE device and mask it.</dd>
</dl>
</li>
</ol>
<blockquote>
<div><dl class="docutils">
<dt>Attributes:</dt>
<dd>Interrupt source number  (64-bit)</dd>
</dl>
<p>The kvm_device_attr.addr points to a __u64 value:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>bits:     | 63   ....  2 |   1   |   0
values:   |    unused    | level | type
</pre></div>
</div>
<ul class="simple">
<li>type:  0:MSI 1:LSI</li>
<li>level: assertion level in case of an LSI.</li>
</ul>
<p>Errors:</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="86%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>-E2BIG</td>
<td>Interrupt source number is out of range</td>
</tr>
<tr class="row-even"><td>-ENOMEM</td>
<td>Could not create a new source block</td>
</tr>
<tr class="row-odd"><td>-EFAULT</td>
<td>Invalid user pointer for attr-&gt;addr.</td>
</tr>
<tr class="row-even"><td>-ENXIO</td>
<td>Could not allocate underlying HW interrupt</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div></blockquote>
<ol class="arabic simple" start="3">
<li><dl class="first docutils">
<dt>KVM_DEV_XIVE_GRP_SOURCE_CONFIG (write only)</dt>
<dd>Configures source targeting</dd>
</dl>
</li>
</ol>
<blockquote>
<div><dl class="docutils">
<dt>Attributes:</dt>
<dd>Interrupt source number  (64-bit)</dd>
</dl>
<p>The kvm_device_attr.addr points to a __u64 value:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>bits:     | 63   ....  33 |  32  | 31 .. 3 |  2 .. 0
values:   |    eisn       | mask |  server | priority
</pre></div>
</div>
<ul class="simple">
<li>priority: 0-7 interrupt priority level</li>
<li>server: CPU number chosen to handle the interrupt</li>
<li>mask: mask flag (unused)</li>
<li>eisn: Effective Interrupt Source Number</li>
</ul>
<p>Errors:</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>-ENOENT</td>
<td>Unknown source number</td>
</tr>
<tr class="row-even"><td>-EINVAL</td>
<td>Not initialized source number</td>
</tr>
<tr class="row-odd"><td>-EINVAL</td>
<td>Invalid priority</td>
</tr>
<tr class="row-even"><td>-EINVAL</td>
<td>Invalid CPU number.</td>
</tr>
<tr class="row-odd"><td>-EFAULT</td>
<td>Invalid user pointer for attr-&gt;addr.</td>
</tr>
<tr class="row-even"><td>-ENXIO</td>
<td>CPU event queues not configured or configuration of the
underlying HW interrupt failed</td>
</tr>
<tr class="row-odd"><td>-EBUSY</td>
<td>No CPU available to serve interrupt</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div></blockquote>
<ol class="arabic simple" start="4">
<li><dl class="first docutils">
<dt>KVM_DEV_XIVE_GRP_EQ_CONFIG (read-write)</dt>
<dd>Configures an event queue of a CPU</dd>
</dl>
</li>
</ol>
<blockquote>
<div><dl class="docutils">
<dt>Attributes:</dt>
<dd>EQ descriptor identifier (64-bit)</dd>
</dl>
<p>The EQ descriptor identifier is a tuple (server, priority):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>bits:     | 63   ....  32 | 31 .. 3 |  2 .. 0
values:   |    unused     |  server | priority
</pre></div>
</div>
<p>The kvm_device_attr.addr points to:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct kvm_ppc_xive_eq {
    __u32 flags;
    __u32 qshift;
    __u64 qaddr;
    __u32 qtoggle;
    __u32 qindex;
    __u8  pad[40];
};
</pre></div>
</div>
<ul class="simple">
<li><dl class="first docutils">
<dt>flags: queue flags</dt>
<dd><dl class="first last docutils">
<dt>KVM_XIVE_EQ_ALWAYS_NOTIFY (required)</dt>
<dd>forces notification without using the coalescing mechanism
provided by the XIVE END ESBs.</dd>
</dl>
</dd>
</dl>
</li>
<li>qshift: queue size (power of 2)</li>
<li>qaddr: real address of queue</li>
<li>qtoggle: current queue toggle bit</li>
<li>qindex: current queue index</li>
<li>pad: reserved for future use</li>
</ul>
<p>Errors:</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="85%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>-ENOENT</td>
<td>Invalid CPU number</td>
</tr>
<tr class="row-even"><td>-EINVAL</td>
<td>Invalid priority</td>
</tr>
<tr class="row-odd"><td>-EINVAL</td>
<td>Invalid flags</td>
</tr>
<tr class="row-even"><td>-EINVAL</td>
<td>Invalid queue size</td>
</tr>
<tr class="row-odd"><td>-EINVAL</td>
<td>Invalid queue address</td>
</tr>
<tr class="row-even"><td>-EFAULT</td>
<td>Invalid user pointer for attr-&gt;addr.</td>
</tr>
<tr class="row-odd"><td>-EIO</td>
<td>Configuration of the underlying HW failed</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div></blockquote>
<ol class="arabic simple" start="5">
<li><dl class="first docutils">
<dt>KVM_DEV_XIVE_GRP_SOURCE_SYNC (write only)</dt>
<dd>Synchronize the source to flush event notifications</dd>
</dl>
</li>
</ol>
<blockquote>
<div><dl class="docutils">
<dt>Attributes:</dt>
<dd>Interrupt source number  (64-bit)</dd>
</dl>
<p>Errors:</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="19%" />
<col width="81%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>-ENOENT</td>
<td>Unknown source number</td>
</tr>
<tr class="row-even"><td>-EINVAL</td>
<td>Not initialized source number</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div></blockquote>
<ul>
<li><p class="first">VCPU state</p>
<p>The XIVE IC maintains VP interrupt state in an internal structure
called the NVT. When a VP is not dispatched on a HW processor
thread, this structure can be updated by HW if the VP is the target
of an event notification.</p>
<p>It is important for migration to capture the cached IPB from the NVT
as it synthesizes the priorities of the pending interrupts. We
capture a bit more to report debug information.</p>
<p>KVM_REG_PPC_VP_STATE (2 * 64bits):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>bits:     |  63  ....  32  |  31  ....  0  |
values:   |   TIMA word0   |   TIMA word1  |
bits:     | 127       ..........       64  |
values:   |            unused              |
</pre></div>
</div>
</li>
<li><p class="first">Migration:</p>
<p>Saving the state of a VM using the XIVE native exploitation mode
should follow a specific sequence. When the VM is stopped :</p>
<ol class="arabic simple">
<li>Mask all sources (PQ=01) to stop the flow of events.</li>
</ol>
<p>2. Sync the XIVE device with the KVM control KVM_DEV_XIVE_EQ_SYNC to
flush any in-flight event notification and to stabilize the EQs. At
this stage, the EQ pages are marked dirty to make sure they are
transferred in the migration sequence.</p>
<p>3. Capture the state of the source targeting, the EQs configuration
and the state of thread interrupt context registers.</p>
<p>Restore is similar:</p>
<ol class="arabic simple">
<li>Restore the EQ configuration. As targeting depends on it.</li>
<li>Restore targeting</li>
<li>Restore the thread interrupt contexts</li>
<li>Restore the source states</li>
<li>Let the vCPU run</li>
</ol>
</li>
</ul>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>