<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>amd-pstate CPU Performance Scaling Driver &mdash; The Linux Kernel  documentation</title><link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/theme_rtd_colors.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> The Linux Kernel
          </a>
              <div class="version">
                6.0.0-rc3-mm-unstable-damon
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../mm/damon/index.html">DAMON: Data Access MONitor</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mm/damon/index.html">DAMON: Data Access MONitor</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">The Linux Kernel</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
      <li><code class="docutils literal notranslate"><span class="pre">amd-pstate</span></code> CPU Performance Scaling Driver</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/admin-guide/pm/amd-pstate.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="amd-pstate-cpu-performance-scaling-driver">
<h1><code class="docutils literal notranslate"><span class="pre">amd-pstate</span></code> CPU Performance Scaling Driver<a class="headerlink" href="#amd-pstate-cpu-performance-scaling-driver" title="Permalink to this headline">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Copyright</dt>
<dd class="field-odd"><p>© 2021 Advanced Micro Devices, Inc.</p>
</dd>
<dt class="field-even">Author</dt>
<dd class="field-even"><p>Huang Rui &lt;<a class="reference external" href="mailto:ray&#46;huang&#37;&#52;&#48;amd&#46;com">ray<span>&#46;</span>huang<span>&#64;</span>amd<span>&#46;</span>com</a>&gt;</p>
</dd>
</dl>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">amd-pstate</span></code> is the AMD CPU performance scaling driver that introduces a
new CPU frequency control mechanism on modern AMD APU and CPU series in
Linux kernel. The new mechanism is based on Collaborative Processor
Performance Control (CPPC) which provides finer grain frequency management
than legacy ACPI hardware P-States. Current AMD CPU/APU platforms are using
the ACPI P-states driver to manage CPU frequency and clocks with switching
only in 3 P-states. CPPC replaces the ACPI P-states controls and allows a
flexible, low-latency interface for the Linux kernel to directly
communicate the performance hints to hardware.</p>
<p><code class="docutils literal notranslate"><span class="pre">amd-pstate</span></code> leverages the Linux kernel governors such as <code class="docutils literal notranslate"><span class="pre">schedutil</span></code>,
<code class="docutils literal notranslate"><span class="pre">ondemand</span></code>, etc. to manage the performance hints which are provided by
CPPC hardware functionality that internally follows the hardware
specification (for details refer to AMD64 Architecture Programmer’s Manual
Volume 2: System Programming <a class="footnote-reference brackets" href="#id4" id="id1">1</a>). Currently, <code class="docutils literal notranslate"><span class="pre">amd-pstate</span></code> supports basic
frequency control function according to kernel governors on some of the
Zen2 and Zen3 processors, and we will implement more AMD specific functions
in future after we verify them on the hardware and SBIOS.</p>
</section>
<section id="amd-cppc-overview">
<h2>AMD CPPC Overview<a class="headerlink" href="#amd-cppc-overview" title="Permalink to this headline">¶</a></h2>
<p>Collaborative Processor Performance Control (CPPC) interface enumerates a
continuous, abstract, and unit-less performance value in a scale that is
not tied to a specific performance state / frequency. This is an ACPI
standard <a class="footnote-reference brackets" href="#id5" id="id2">2</a> which software can specify application performance goals and
hints as a relative target to the infrastructure limits. AMD processors
provide the low latency register model (MSR) instead of an AML code
interpreter for performance adjustments. <code class="docutils literal notranslate"><span class="pre">amd-pstate</span></code> will initialize a
<code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">cpufreq_driver</span></code> instance, <code class="docutils literal notranslate"><span class="pre">amd_pstate_driver</span></code>, with the callbacks
to manage each performance update behavior.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Highest Perf ------&gt;+-----------------------+                         +-----------------------+
                    |                       |                         |                       |
                    |                       |                         |                       |
                    |                       |          Max Perf  ----&gt;|                       |
                    |                       |                         |                       |
                    |                       |                         |                       |
Nominal Perf ------&gt;+-----------------------+                         +-----------------------+
                    |                       |                         |                       |
                    |                       |                         |                       |
                    |                       |                         |                       |
                    |                       |                         |                       |
                    |                       |                         |                       |
                    |                       |                         |                       |
                    |                       |      Desired Perf  ----&gt;|                       |
                    |                       |                         |                       |
                    |                       |                         |                       |
                    |                       |                         |                       |
                    |                       |                         |                       |
                    |                       |                         |                       |
                    |                       |                         |                       |
                    |                       |                         |                       |
                    |                       |                         |                       |
                    |                       |                         |                       |
 Lowest non-        |                       |                         |                       |
 linear perf ------&gt;+-----------------------+                         +-----------------------+
                    |                       |                         |                       |
                    |                       |       Lowest perf  ----&gt;|                       |
                    |                       |                         |                       |
 Lowest perf ------&gt;+-----------------------+                         +-----------------------+
                    |                       |                         |                       |
                    |                       |                         |                       |
                    |                       |                         |                       |
         0   ------&gt;+-----------------------+                         +-----------------------+

                                    AMD P-States Performance Scale
</pre></div>
</div>
<section id="amd-cppc-performance-capability">
<span id="perf-cap"></span><h3>AMD CPPC Performance Capability<a class="headerlink" href="#amd-cppc-performance-capability" title="Permalink to this headline">¶</a></h3>
<section id="highest-performance-ro">
<h4>Highest Performance (RO)<a class="headerlink" href="#highest-performance-ro" title="Permalink to this headline">¶</a></h4>
<p>This is the absolute maximum performance an individual processor may reach,
assuming ideal conditions. This performance level may not be sustainable
for long durations and may only be achievable if other platform components
are in a specific state; for example, it may require other processors to be in
an idle state. This would be equivalent to the highest frequencies
supported by the processor.</p>
</section>
<section id="nominal-guaranteed-performance-ro">
<h4>Nominal (Guaranteed) Performance (RO)<a class="headerlink" href="#nominal-guaranteed-performance-ro" title="Permalink to this headline">¶</a></h4>
<p>This is the maximum sustained performance level of the processor, assuming
ideal operating conditions. In the absence of an external constraint (power,
thermal, etc.), this is the performance level the processor is expected to
be able to maintain continuously. All cores/processors are expected to be
able to sustain their nominal performance state simultaneously.</p>
</section>
<section id="lowest-non-linear-performance-ro">
<h4>Lowest non-linear Performance (RO)<a class="headerlink" href="#lowest-non-linear-performance-ro" title="Permalink to this headline">¶</a></h4>
<p>This is the lowest performance level at which nonlinear power savings are
achieved, for example, due to the combined effects of voltage and frequency
scaling. Above this threshold, lower performance levels should be generally
more energy efficient than higher performance levels. This register
effectively conveys the most efficient performance level to <code class="docutils literal notranslate"><span class="pre">amd-pstate</span></code>.</p>
</section>
<section id="lowest-performance-ro">
<h4>Lowest Performance (RO)<a class="headerlink" href="#lowest-performance-ro" title="Permalink to this headline">¶</a></h4>
<p>This is the absolute lowest performance level of the processor. Selecting a
performance level lower than the lowest nonlinear performance level may
cause an efficiency penalty but should reduce the instantaneous power
consumption of the processor.</p>
</section>
</section>
<section id="amd-cppc-performance-control">
<h3>AMD CPPC Performance Control<a class="headerlink" href="#amd-cppc-performance-control" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">amd-pstate</span></code> passes performance goals through these registers. The
register drives the behavior of the desired performance target.</p>
<section id="minimum-requested-performance-rw">
<h4>Minimum requested performance (RW)<a class="headerlink" href="#minimum-requested-performance-rw" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">amd-pstate</span></code> specifies the minimum allowed performance level.</p>
</section>
<section id="maximum-requested-performance-rw">
<h4>Maximum requested performance (RW)<a class="headerlink" href="#maximum-requested-performance-rw" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">amd-pstate</span></code> specifies a limit the maximum performance that is expected
to be supplied by the hardware.</p>
</section>
<section id="desired-performance-target-rw">
<h4>Desired performance target (RW)<a class="headerlink" href="#desired-performance-target-rw" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">amd-pstate</span></code> specifies a desired target in the CPPC performance scale as
a relative number. This can be expressed as percentage of nominal
performance (infrastructure max). Below the nominal sustained performance
level, desired performance expresses the average performance level of the
processor subject to hardware. Above the nominal performance level,
the processor must provide at least nominal performance requested and go higher
if current operating conditions allow.</p>
</section>
<section id="energy-performance-preference-epp-rw">
<h4>Energy Performance Preference (EPP) (RW)<a class="headerlink" href="#energy-performance-preference-epp-rw" title="Permalink to this headline">¶</a></h4>
<p>This attribute provides a hint to the hardware if software wants to bias
toward performance (0x0) or energy efficiency (0xff).</p>
</section>
</section>
</section>
<section id="key-governors-support">
<h2>Key Governors Support<a class="headerlink" href="#key-governors-support" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">amd-pstate</span></code> can be used with all the (generic) scaling governors listed
by the <code class="docutils literal notranslate"><span class="pre">scaling_available_governors</span></code> policy attribute in <code class="docutils literal notranslate"><span class="pre">sysfs</span></code>. Then,
it is responsible for the configuration of policy objects corresponding to
CPUs and provides the <code class="docutils literal notranslate"><span class="pre">CPUFreq</span></code> core (and the scaling governors attached
to the policy objects) with accurate information on the maximum and minimum
operating frequencies supported by the hardware. Users can check the
<code class="docutils literal notranslate"><span class="pre">scaling_cur_freq</span></code> information comes from the <code class="docutils literal notranslate"><span class="pre">CPUFreq</span></code> core.</p>
<p><code class="docutils literal notranslate"><span class="pre">amd-pstate</span></code> mainly supports <code class="docutils literal notranslate"><span class="pre">schedutil</span></code> and <code class="docutils literal notranslate"><span class="pre">ondemand</span></code> for dynamic
frequency control. It is to fine tune the processor configuration on
<code class="docutils literal notranslate"><span class="pre">amd-pstate</span></code> to the <code class="docutils literal notranslate"><span class="pre">schedutil</span></code> with CPU CFS scheduler. <code class="docutils literal notranslate"><span class="pre">amd-pstate</span></code>
registers the adjust_perf callback to implement performance update behavior
similar to CPPC. It is initialized by <code class="docutils literal notranslate"><span class="pre">sugov_start</span></code> and then populates the
CPU’s update_util_data pointer to assign <code class="docutils literal notranslate"><span class="pre">sugov_update_single_perf</span></code> as the
utilization update callback function in the CPU scheduler. The CPU scheduler
will call <code class="docutils literal notranslate"><span class="pre">cpufreq_update_util</span></code> and assigns the target performance according
to the <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">sugov_cpu</span></code> that the utilization update belongs to.
Then, <code class="docutils literal notranslate"><span class="pre">amd-pstate</span></code> updates the desired performance according to the CPU
scheduler assigned.</p>
</section>
<section id="processor-support">
<h2>Processor Support<a class="headerlink" href="#processor-support" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">amd-pstate</span></code> initialization will fail if the <code class="docutils literal notranslate"><span class="pre">_CPC</span></code> entry in the ACPI
SBIOS does not exist in the detected processor. It uses <code class="docutils literal notranslate"><span class="pre">acpi_cpc_valid</span></code>
to check the existence of <code class="docutils literal notranslate"><span class="pre">_CPC</span></code>. All Zen based processors support the legacy
ACPI hardware P-States function, so when <code class="docutils literal notranslate"><span class="pre">amd-pstate</span></code> fails initialization,
the kernel will fall back to initialize the <code class="docutils literal notranslate"><span class="pre">acpi-cpufreq</span></code> driver.</p>
<p>There are two types of hardware implementations for <code class="docutils literal notranslate"><span class="pre">amd-pstate</span></code>: one is
<a class="reference internal" href="#perf-cap">Full MSR Support</a> and another is <a class="reference internal" href="#perf-cap">Shared Memory Support</a>. It can use the <code class="xref c c-macro docutils literal notranslate"><span class="pre">X86_FEATURE_CPPC</span></code> feature flag to
indicate the different types. (For details, refer to the Processor Programming
Reference (PPR) for AMD Family 19h Model 51h, Revision A1 Processors <a class="footnote-reference brackets" href="#id6" id="id3">3</a>.)
<code class="docutils literal notranslate"><span class="pre">amd-pstate</span></code> is to register different <code class="docutils literal notranslate"><span class="pre">static_call</span></code> instances for different
hardware implementations.</p>
<p>Currently, some of the Zen2 and Zen3 processors support <code class="docutils literal notranslate"><span class="pre">amd-pstate</span></code>. In the
future, it will be supported on more and more AMD processors.</p>
<section id="full-msr-support">
<h3>Full MSR Support<a class="headerlink" href="#full-msr-support" title="Permalink to this headline">¶</a></h3>
<p>Some new Zen3 processors such as Cezanne provide the MSR registers directly
while the <code class="xref c c-macro docutils literal notranslate"><span class="pre">X86_FEATURE_CPPC</span></code> CPU feature flag is set.
<code class="docutils literal notranslate"><span class="pre">amd-pstate</span></code> can handle the MSR register to implement the fast switch
function in <code class="docutils literal notranslate"><span class="pre">CPUFreq</span></code> that can reduce the latency of frequency control in
interrupt context. The functions with a <code class="docutils literal notranslate"><span class="pre">pstate_xxx</span></code> prefix represent the
operations on MSR registers.</p>
</section>
<section id="shared-memory-support">
<h3>Shared Memory Support<a class="headerlink" href="#shared-memory-support" title="Permalink to this headline">¶</a></h3>
<p>If the <code class="xref c c-macro docutils literal notranslate"><span class="pre">X86_FEATURE_CPPC</span></code> CPU feature flag is not set, the
processor supports the shared memory solution. In this case, <code class="docutils literal notranslate"><span class="pre">amd-pstate</span></code>
uses the <code class="docutils literal notranslate"><span class="pre">cppc_acpi</span></code> helper methods to implement the callback functions
that are defined on <code class="docutils literal notranslate"><span class="pre">static_call</span></code>. The functions with the <code class="docutils literal notranslate"><span class="pre">cppc_xxx</span></code> prefix
represent the operations of ACPI CPPC helpers for the shared memory solution.</p>
<p>AMD P-States and ACPI hardware P-States always can be supported in one
processor. But AMD P-States has the higher priority and if it is enabled
with <code class="xref c c-macro docutils literal notranslate"><span class="pre">MSR_AMD_CPPC_ENABLE</span></code> or <code class="docutils literal notranslate"><span class="pre">cppc_set_enable</span></code>, it will respond
to the request from AMD P-States.</p>
</section>
</section>
<section id="user-space-interface-in-sysfs">
<h2>User Space Interface in <code class="docutils literal notranslate"><span class="pre">sysfs</span></code><a class="headerlink" href="#user-space-interface-in-sysfs" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">amd-pstate</span></code> exposes several global attributes (files) in <code class="docutils literal notranslate"><span class="pre">sysfs</span></code> to
control its functionality at the system level. They are located in the
<code class="docutils literal notranslate"><span class="pre">/sys/devices/system/cpu/cpufreq/policyX/</span></code> directory and affect all CPUs.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>root@hr-test1:/home/ray# ls /sys/devices/system/cpu/cpufreq/policy0/*amd*
/sys/devices/system/cpu/cpufreq/policy0/amd_pstate_highest_perf
/sys/devices/system/cpu/cpufreq/policy0/amd_pstate_lowest_nonlinear_freq
/sys/devices/system/cpu/cpufreq/policy0/amd_pstate_max_freq
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">amd_pstate_highest_perf</span> <span class="pre">/</span> <span class="pre">amd_pstate_max_freq</span></code></p>
<p>Maximum CPPC performance and CPU frequency that the driver is allowed to
set, in percent of the maximum supported CPPC performance level (the highest
performance supported in <a class="reference internal" href="#perf-cap">AMD CPPC Performance Capability</a>).
In some ASICs, the highest CPPC performance is not the one in the <code class="docutils literal notranslate"><span class="pre">_CPC</span></code>
table, so we need to expose it to sysfs. If boost is not active, but
still supported, this maximum frequency will be larger than the one in
<code class="docutils literal notranslate"><span class="pre">cpuinfo</span></code>.
This attribute is read-only.</p>
<p><code class="docutils literal notranslate"><span class="pre">amd_pstate_lowest_nonlinear_freq</span></code></p>
<p>The lowest non-linear CPPC CPU frequency that the driver is allowed to set,
in percent of the maximum supported CPPC performance level. (Please see the
lowest non-linear performance in <a class="reference internal" href="#perf-cap">AMD CPPC Performance Capability</a>.)
This attribute is read-only.</p>
<p>Other performance and frequency values can be read back from
<code class="docutils literal notranslate"><span class="pre">/sys/devices/system/cpu/cpuX/acpi_cppc/</span></code>, see <a class="reference internal" href="../acpi/cppc_sysfs.html#cppc-sysfs"><span class="std std-ref">CPPC</span></a>.</p>
</section>
<section id="amd-pstate-vs-acpi-cpufreq">
<h2><code class="docutils literal notranslate"><span class="pre">amd-pstate</span></code> vs <code class="docutils literal notranslate"><span class="pre">acpi-cpufreq</span></code><a class="headerlink" href="#amd-pstate-vs-acpi-cpufreq" title="Permalink to this headline">¶</a></h2>
<p>On the majority of AMD platforms supported by <code class="docutils literal notranslate"><span class="pre">acpi-cpufreq</span></code>, the ACPI tables
provided by the platform firmware are used for CPU performance scaling, but
only provide 3 P-states on AMD processors.
However, on modern AMD APU and CPU series, hardware provides the Collaborative
Processor Performance Control according to the ACPI protocol and customizes this
for AMD platforms. That is, fine-grained and continuous frequency ranges
instead of the legacy hardware P-states. <code class="docutils literal notranslate"><span class="pre">amd-pstate</span></code> is the kernel
module which supports the new AMD P-States mechanism on most of the future AMD
platforms. The AMD P-States mechanism is the more performance and energy
efficiency frequency management method on AMD processors.</p>
</section>
<section id="kernel-module-options-for-amd-pstate">
<h2>Kernel Module Options for <code class="docutils literal notranslate"><span class="pre">amd-pstate</span></code><a class="headerlink" href="#kernel-module-options-for-amd-pstate" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">shared_mem</span></code>
Use a module param (shared_mem) to enable related processors manually with
<strong>amd_pstate.shared_mem=1</strong>.
Due to the performance issue on the processors with <a class="reference internal" href="#perf-cap">Shared Memory Support</a>, we disable it presently and will re-enable this by default
once we address performance issue with this solution.</p>
<p>To check whether the current processor is using <a class="reference internal" href="#perf-cap">Full MSR Support</a>
or <a class="reference internal" href="#perf-cap">Shared Memory Support</a> :</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ray@hr-test1:~$ lscpu | grep cppc
Flags:                           fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ht syscall nx mmxext fxsr_opt pdpe1gb rdtscp lm constant_tsc rep_good nopl nonstop_tsc cpuid extd_apicid aperfmperf rapl pni pclmulqdq monitor ssse3 fma cx16 sse4_1 sse4_2 x2apic movbe popcnt aes xsave avx f16c rdrand lahf_lm cmp_legacy svm extapic cr8_legacy abm sse4a misalignsse 3dnowprefetch osvw ibs skinit wdt tce topoext perfctr_core perfctr_nb bpext perfctr_llc mwaitx cpb cat_l3 cdp_l3 hw_pstate ssbd mba ibrs ibpb stibp vmmcall fsgsbase bmi1 avx2 smep bmi2 erms invpcid cqm rdt_a rdseed adx smap clflushopt clwb sha_ni xsaveopt xsavec xgetbv1 xsaves cqm_llc cqm_occup_llc cqm_mbm_total cqm_mbm_local clzero irperf xsaveerptr rdpru wbnoinvd cppc arat npt lbrv svm_lock nrip_save tsc_scale vmcb_clean flushbyasid decodeassists pausefilter pfthreshold avic v_vmsave_vmload vgif v_spec_ctrl umip pku ospke vaes vpclmulqdq rdpid overflow_recov succor smca fsrm
</pre></div>
</div>
<p>If the CPU flags have <code class="docutils literal notranslate"><span class="pre">cppc</span></code>, then this processor supports <a class="reference internal" href="#perf-cap">Full MSR Support</a>. Otherwise, it supports <a class="reference internal" href="#perf-cap">Shared Memory Support</a>.</p>
</section>
<section id="cpupower-tool-support-for-amd-pstate">
<h2><code class="docutils literal notranslate"><span class="pre">cpupower</span></code> tool support for <code class="docutils literal notranslate"><span class="pre">amd-pstate</span></code><a class="headerlink" href="#cpupower-tool-support-for-amd-pstate" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">amd-pstate</span></code> is supported by the <code class="docutils literal notranslate"><span class="pre">cpupower</span></code> tool, which can be used to dump
frequency information. Development is in progress to support more and more
operations for the new <code class="docutils literal notranslate"><span class="pre">amd-pstate</span></code> module with this tool.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>root@hr-test1:/home/ray# cpupower frequency-info
analyzing CPU 0:
  driver: amd-pstate
  CPUs which run at the same hardware frequency: 0
  CPUs which need to have their frequency coordinated by software: 0
  maximum transition latency: 131 us
  hardware limits: 400 MHz - 4.68 GHz
  available cpufreq governors: ondemand conservative powersave userspace performance schedutil
  current policy: frequency should be within 400 MHz and 4.68 GHz.
                  The governor &quot;schedutil&quot; may decide which speed to use
                  within this range.
  current CPU frequency: Unable to call hardware
  current CPU frequency: 4.02 GHz (asserted by call to kernel)
  boost state support:
    Supported: yes
    Active: yes
    AMD PSTATE Highest Performance: 166. Maximum Frequency: 4.68 GHz.
    AMD PSTATE Nominal Performance: 117. Nominal Frequency: 3.30 GHz.
    AMD PSTATE Lowest Non-linear Performance: 39. Lowest Non-linear Frequency: 1.10 GHz.
    AMD PSTATE Lowest Performance: 15. Lowest Frequency: 400 MHz.
</pre></div>
</div>
</section>
<section id="diagnostics-and-tuning">
<h2>Diagnostics and Tuning<a class="headerlink" href="#diagnostics-and-tuning" title="Permalink to this headline">¶</a></h2>
<section id="trace-events">
<h3>Trace Events<a class="headerlink" href="#trace-events" title="Permalink to this headline">¶</a></h3>
<p>There are two static trace events that can be used for <code class="docutils literal notranslate"><span class="pre">amd-pstate</span></code>
diagnostics. One of them is the <code class="docutils literal notranslate"><span class="pre">cpu_frequency</span></code> trace event generally used
by <code class="docutils literal notranslate"><span class="pre">CPUFreq</span></code>, and the other one is the <code class="docutils literal notranslate"><span class="pre">amd_pstate_perf</span></code> trace event
specific to <code class="docutils literal notranslate"><span class="pre">amd-pstate</span></code>.  The following sequence of shell commands can
be used to enable them and see their output (if the kernel is
configured to support event tracing).</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>root@hr-test1:/home/ray# cd /sys/kernel/tracing/
root@hr-test1:/sys/kernel/tracing# echo 1 &gt; events/amd_cpu/enable
root@hr-test1:/sys/kernel/tracing# cat trace
# tracer: nop
#
# entries-in-buffer/entries-written: 47827/42233061   #P:2
#
#                                _-----=&gt; irqs-off
#                               / _----=&gt; need-resched
#                              | / _---=&gt; hardirq/softirq
#                              || / _--=&gt; preempt-depth
#                              ||| /     delay
#           TASK-PID     CPU#  ||||   TIMESTAMP  FUNCTION
#              | |         |   ||||      |         |
         &lt;idle&gt;-0       [015] dN...  4995.979886: amd_pstate_perf: amd_min_perf=85 amd_des_perf=85 amd_max_perf=166 cpu_id=15 changed=false fast_switch=true
         &lt;idle&gt;-0       [007] d.h..  4995.979893: amd_pstate_perf: amd_min_perf=85 amd_des_perf=85 amd_max_perf=166 cpu_id=7 changed=false fast_switch=true
            cat-2161    [000] d....  4995.980841: amd_pstate_perf: amd_min_perf=85 amd_des_perf=85 amd_max_perf=166 cpu_id=0 changed=false fast_switch=true
           sshd-2125    [004] d.s..  4995.980968: amd_pstate_perf: amd_min_perf=85 amd_des_perf=85 amd_max_perf=166 cpu_id=4 changed=false fast_switch=true
         &lt;idle&gt;-0       [007] d.s..  4995.980968: amd_pstate_perf: amd_min_perf=85 amd_des_perf=85 amd_max_perf=166 cpu_id=7 changed=false fast_switch=true
         &lt;idle&gt;-0       [003] d.s..  4995.980971: amd_pstate_perf: amd_min_perf=85 amd_des_perf=85 amd_max_perf=166 cpu_id=3 changed=false fast_switch=true
         &lt;idle&gt;-0       [011] d.s..  4995.980996: amd_pstate_perf: amd_min_perf=85 amd_des_perf=85 amd_max_perf=166 cpu_id=11 changed=false fast_switch=true
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">cpu_frequency</span></code> trace event will be triggered either by the <code class="docutils literal notranslate"><span class="pre">schedutil</span></code> scaling
governor (for the policies it is attached to), or by the <code class="docutils literal notranslate"><span class="pre">CPUFreq</span></code> core (for the
policies with other scaling governors).</p>
</section>
<section id="tracer-tool">
<h3>Tracer Tool<a class="headerlink" href="#tracer-tool" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">amd_pstate_tracer.py</span></code> can record and parse <code class="docutils literal notranslate"><span class="pre">amd-pstate</span></code> trace log, then
generate performance plots. This utility can be used to debug and tune the
performance of <code class="docutils literal notranslate"><span class="pre">amd-pstate</span></code> driver. The tracer tool needs to import intel
pstate tracer.</p>
<p>Tracer tool located in <code class="docutils literal notranslate"><span class="pre">linux/tools/power/x86/amd_pstate_tracer</span></code>. It can be
used in two ways. If trace file is available, then directly parse the file
with command</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>./amd_pstate_trace.py [-c cpus] -t &lt;trace_file&gt; -n &lt;test_name&gt;
</pre></div>
</div>
<p>Or generate trace file with root privilege, then parse and plot with command</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>sudo ./amd_pstate_trace.py [-c cpus] -n &lt;test_name&gt; -i &lt;interval&gt; [-m kbytes]
</pre></div>
</div>
<p>The test result can be found in <code class="docutils literal notranslate"><span class="pre">results/test_name</span></code>. Following is the example
about part of the output.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>common_cpu  common_secs  common_usecs  min_perf  des_perf  max_perf  freq    mperf   apef    tsc       load   duration_ms  sample_num  elapsed_time  common_comm
CPU_005     712          116384        39        49        166       0.7565  9645075 2214891 38431470  25.1   11.646       469         2.496         kworker/5:0-40
CPU_006     712          116408        39        49        166       0.6769  8950227 1839034 37192089  24.06  11.272       470         2.496         kworker/6:0-1264
</pre></div>
</div>
</section>
</section>
<section id="reference">
<h2>Reference<a class="headerlink" href="#reference" title="Permalink to this headline">¶</a></h2>
<dl class="footnote brackets">
<dt class="label" id="id4"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>AMD64 Architecture Programmer’s Manual Volume 2: System Programming,
<a class="reference external" href="https://www.amd.com/system/files/TechDocs/24593.pdf">https://www.amd.com/system/files/TechDocs/24593.pdf</a></p>
</dd>
<dt class="label" id="id5"><span class="brackets"><a class="fn-backref" href="#id2">2</a></span></dt>
<dd><p>Advanced Configuration and Power Interface Specification,
<a class="reference external" href="https://uefi.org/sites/default/files/resources/ACPI_Spec_6_4_Jan22.pdf">https://uefi.org/sites/default/files/resources/ACPI_Spec_6_4_Jan22.pdf</a></p>
</dd>
<dt class="label" id="id6"><span class="brackets"><a class="fn-backref" href="#id3">3</a></span></dt>
<dd><p>Processor Programming Reference (PPR) for AMD Family 19h Model 51h, Revision A1 Processors
<a class="reference external" href="https://www.amd.com/system/files/TechDocs/56569-A1-PUB.zip">https://www.amd.com/system/files/TechDocs/56569-A1-PUB.zip</a></p>
</dd>
</dl>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright The kernel development community.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>