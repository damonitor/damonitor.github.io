

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Mounting root file system via SMB (cifs.ko) &mdash; The Linux Kernel  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.8.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/mm/damon/index.html">Monitoring Data Accesses</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../vm/damon/index.html">DAMON: Data Access MONitor</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>Mounting root file system via SMB (cifs.ko)</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/filesystems/cifs/cifsroot.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="mounting-root-file-system-via-smb-cifs-ko">
<h1>Mounting root file system via SMB (cifs.ko)<a class="headerlink" href="#mounting-root-file-system-via-smb-cifs-ko" title="Permalink to this headline">¶</a></h1>
<p>Written 2019 by Paulo Alcantara &lt;<a class="reference external" href="mailto:palcantara&#37;&#52;&#48;suse&#46;de">palcantara<span>&#64;</span>suse<span>&#46;</span>de</a>&gt;</p>
<p>Written 2019 by Aurelien Aptel &lt;<a class="reference external" href="mailto:aaptel&#37;&#52;&#48;suse&#46;com">aaptel<span>&#64;</span>suse<span>&#46;</span>com</a>&gt;</p>
<p>The CONFIG_CIFS_ROOT option enables experimental root file system
support over the SMB protocol via cifs.ko.</p>
<p>It introduces a new kernel command-line option called ‘cifsroot=’
which will tell the kernel to mount the root file system over the
network by utilizing SMB or CIFS protocol.</p>
<p>In order to mount, the network stack will also need to be set up by
using ‘ip=’ config option. For more details, see
Documentation/admin-guide/nfs/nfsroot.rst.</p>
<p>A CIFS root mount currently requires the use of SMB1+UNIX Extensions
which is only supported by the Samba server. SMB1 is the older
deprecated version of the protocol but it has been extended to support
POSIX features (See [1]). The equivalent extensions for the newer
recommended version of the protocol (SMB3) have not been fully
implemented yet which means SMB3 doesn’t support some required POSIX
file system objects (e.g. block devices, pipes, sockets).</p>
<p>As a result, a CIFS root will default to SMB1 for now but the version
to use can nonetheless be changed via the ‘vers=’ mount option.  This
default will change once the SMB3 POSIX extensions are fully
implemented.</p>
<div class="section" id="server-configuration">
<h2>Server configuration<a class="headerlink" href="#server-configuration" title="Permalink to this headline">¶</a></h2>
<p>To enable SMB1+UNIX extensions you will need to set these global
settings in Samba smb.conf:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[global]
server min protocol = NT1
unix extension = yes        # default
</pre></div>
</div>
</div>
<div class="section" id="kernel-command-line">
<h2>Kernel command line<a class="headerlink" href="#kernel-command-line" title="Permalink to this headline">¶</a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>root=/dev/cifs
</pre></div>
</div>
<p>This is just a virtual device that basically tells the kernel to mount
the root file system via SMB protocol.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cifsroot=//&lt;server-ip&gt;/&lt;share&gt;[,options]
</pre></div>
</div>
<p>Enables the kernel to mount the root file system via SMB that are
located in the &lt;server-ip&gt; and &lt;share&gt; specified in this option.</p>
<p>The default mount options are set in fs/cifs/cifsroot.c.</p>
<dl class="docutils">
<dt>server-ip</dt>
<dd>IPv4 address of the server.</dd>
<dt>share</dt>
<dd>Path to SMB share (rootfs).</dd>
<dt>options</dt>
<dd>Optional mount options. For more information, see mount.cifs(8).</dd>
</dl>
</div>
<div class="section" id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<p>Export root file system as a Samba share in smb.conf file:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>...
[linux]
        path = /path/to/rootfs
        read only = no
        guest ok = yes
        force user = root
        force group = root
        browseable = yes
        writeable = yes
        admin users = root
        public = yes
        create mask = 0777
        directory mask = 0777
...
</pre></div>
</div>
<p>Restart smb service:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># systemctl restart smb
</pre></div>
</div>
<p>Test it under QEMU on a kernel built with CONFIG_CIFS_ROOT and
CONFIG_IP_PNP options enabled:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># qemu-system-x86_64 -enable-kvm -cpu host -m 1024 \
-kernel /path/to/linux/arch/x86/boot/bzImage -nographic \
-append &quot;root=/dev/cifs rw ip=dhcp cifsroot=//10.0.2.2/linux,username=foo,password=bar console=ttyS0 3&quot;
</pre></div>
</div>
<p>1: <a class="reference external" href="https://wiki.samba.org/index.php/UNIX_Extensions">https://wiki.samba.org/index.php/UNIX_Extensions</a></p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>