

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Booting AArch64 Linux &mdash; The Linux Kernel  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.7.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/mm/damon/index.html">DAMON: Data Access MONitor</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Booting AArch64 Linux</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/arm64/booting.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="booting-aarch64-linux">
<h1>Booting AArch64 Linux<a class="headerlink" href="#booting-aarch64-linux" title="Permalink to this headline">¶</a></h1>
<p>Author: Will Deacon &lt;<a class="reference external" href="mailto:will&#46;deacon&#37;&#52;&#48;arm&#46;com">will<span>&#46;</span>deacon<span>&#64;</span>arm<span>&#46;</span>com</a>&gt;</p>
<p>Date  : 07 September 2012</p>
<p>This document is based on the ARM booting document by Russell King and
is relevant to all public releases of the AArch64 Linux kernel.</p>
<p>The AArch64 exception model is made up of a number of exception levels
(EL0 - EL3), with EL0 and EL1 having a secure and a non-secure
counterpart.  EL2 is the hypervisor level and exists only in non-secure
mode. EL3 is the highest priority level and exists only in secure mode.</p>
<p>For the purposes of this document, we will use the term <cite>boot loader</cite>
simply to define all software that executes on the CPU(s) before control
is passed to the Linux kernel.  This may include secure monitor and
hypervisor code, or it may just be a handful of instructions for
preparing a minimal boot environment.</p>
<p>Essentially, the boot loader should provide (as a minimum) the
following:</p>
<ol class="arabic simple">
<li>Setup and initialise the RAM</li>
<li>Setup the device tree</li>
<li>Decompress the kernel image</li>
<li>Call the kernel image</li>
</ol>
<div class="section" id="setup-and-initialise-ram">
<h2>1. Setup and initialise RAM<a class="headerlink" href="#setup-and-initialise-ram" title="Permalink to this headline">¶</a></h2>
<p>Requirement: MANDATORY</p>
<p>The boot loader is expected to find and initialise all RAM that the
kernel will use for volatile data storage in the system.  It performs
this in a machine dependent manner.  (It may use internal algorithms
to automatically locate and size all RAM, or it may use knowledge of
the RAM in the machine, or any other method the boot loader designer
sees fit.)</p>
</div>
<div class="section" id="setup-the-device-tree">
<h2>2. Setup the device tree<a class="headerlink" href="#setup-the-device-tree" title="Permalink to this headline">¶</a></h2>
<p>Requirement: MANDATORY</p>
<p>The device tree blob (dtb) must be placed on an 8-byte boundary and must
not exceed 2 megabytes in size. Since the dtb will be mapped cacheable
using blocks of up to 2 megabytes in size, it must not be placed within
any 2M region which must be mapped with any specific attributes.</p>
<p>NOTE: versions prior to v4.2 also require that the DTB be placed within
the 512 MB region starting at text_offset bytes below the kernel Image.</p>
</div>
<div class="section" id="decompress-the-kernel-image">
<h2>3. Decompress the kernel image<a class="headerlink" href="#decompress-the-kernel-image" title="Permalink to this headline">¶</a></h2>
<p>Requirement: OPTIONAL</p>
<p>The AArch64 kernel does not currently provide a decompressor and
therefore requires decompression (gzip etc.) to be performed by the boot
loader if a compressed Image target (e.g. Image.gz) is used.  For
bootloaders that do not implement this requirement, the uncompressed
Image target is available instead.</p>
</div>
<div class="section" id="call-the-kernel-image">
<h2>4. Call the kernel image<a class="headerlink" href="#call-the-kernel-image" title="Permalink to this headline">¶</a></h2>
<p>Requirement: MANDATORY</p>
<p>The decompressed kernel image contains a 64-byte header as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u32 code0;                    /* Executable code */
u32 code1;                    /* Executable code */
u64 text_offset;              /* Image load offset, little endian */
u64 image_size;               /* Effective Image size, little endian */
u64 flags;                    /* kernel flags, little endian */
u64 res2      = 0;            /* reserved */
u64 res3      = 0;            /* reserved */
u64 res4      = 0;            /* reserved */
u32 magic     = 0x644d5241;   /* Magic number, little endian, &quot;ARM\x64&quot; */
u32 res5;                     /* reserved (used for PE COFF offset) */
</pre></div>
</div>
<p>Header notes:</p>
<ul>
<li><p class="first">As of v3.17, all fields are little endian unless stated otherwise.</p>
</li>
<li><p class="first">code0/code1 are responsible for branching to stext.</p>
</li>
<li><p class="first">when booting through EFI, code0/code1 are initially skipped.
res5 is an offset to the PE header and the PE header has the EFI
entry point (efi_stub_entry).  When the stub has done its work, it
jumps to code0 to resume the normal boot process.</p>
</li>
<li><p class="first">Prior to v3.17, the endianness of text_offset was not specified.  In
these cases image_size is zero and text_offset is 0x80000 in the
endianness of the kernel.  Where image_size is non-zero image_size is
little-endian and must be respected.  Where image_size is zero,
text_offset can be assumed to be 0x80000.</p>
</li>
<li><p class="first">The flags field (introduced in v3.17) is a little-endian 64-bit field
composed as follows:</p>
<table border="1" class="docutils">
<colgroup>
<col width="17%" />
<col width="83%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>Bit 0</td>
<td>Kernel endianness.  1 if BE, 0 if LE.</td>
</tr>
<tr class="row-even"><td>Bit 1-2</td>
<td><p class="first">Kernel Page size.</p>
<blockquote class="last">
<div><ul class="simple">
<li>0 - Unspecified.</li>
<li>1 - 4K</li>
<li>2 - 16K</li>
<li>3 - 64K</li>
</ul>
</div></blockquote>
</td>
</tr>
<tr class="row-odd"><td>Bit 3</td>
<td><p class="first">Kernel physical placement</p>
<blockquote class="last">
<div><dl class="docutils">
<dt>0</dt>
<dd>2MB aligned base should be as close as possible
to the base of DRAM, since memory below it is not
accessible via the linear mapping</dd>
<dt>1</dt>
<dd>2MB aligned base may be anywhere in physical
memory</dd>
</dl>
</div></blockquote>
</td>
</tr>
<tr class="row-even"><td>Bits 4-63</td>
<td>Reserved.</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">When image_size is zero, a bootloader should attempt to keep as much
memory as possible free for use by the kernel immediately after the
end of the kernel image. The amount of space required will vary
depending on selected features, and is effectively unbound.</p>
</li>
</ul>
<p>The Image must be placed text_offset bytes from a 2MB aligned base
address anywhere in usable system RAM and called there. The region
between the 2 MB aligned base address and the start of the image has no
special significance to the kernel, and may be used for other purposes.
At least image_size bytes from the start of the image must be free for
use by the kernel.
NOTE: versions prior to v4.6 cannot make use of memory below the
physical offset of the Image so it is recommended that the Image be
placed as close as possible to the start of system RAM.</p>
<p>If an initrd/initramfs is passed to the kernel at boot, it must reside
entirely within a 1 GB aligned physical memory window of up to 32 GB in
size that fully covers the kernel Image as well.</p>
<p>Any memory described to the kernel (even that below the start of the
image) which is not marked as reserved from the kernel (e.g., with a
memreserve region in the device tree) will be considered as available to
the kernel.</p>
<p>Before jumping into the kernel, the following conditions must be met:</p>
<ul>
<li><p class="first">Quiesce all DMA capable devices so that memory does not get
corrupted by bogus network packets or disk data.  This will save
you many hours of debug.</p>
</li>
<li><p class="first">Primary CPU general-purpose register settings:</p>
<blockquote>
<div><ul class="simple">
<li>x0 = physical address of device tree blob (dtb) in system RAM.</li>
<li>x1 = 0 (reserved for future use)</li>
<li>x2 = 0 (reserved for future use)</li>
<li>x3 = 0 (reserved for future use)</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">CPU mode</p>
<p>All forms of interrupts must be masked in PSTATE.DAIF (Debug, SError,
IRQ and FIQ).
The CPU must be in either EL2 (RECOMMENDED in order to have access to
the virtualisation extensions) or non-secure EL1.</p>
</li>
<li><p class="first">Caches, MMUs</p>
<p>The MMU must be off.
Instruction cache may be on or off.
The address range corresponding to the loaded kernel image must be
cleaned to the PoC. In the presence of a system cache or other
coherent masters with caches enabled, this will typically require
cache maintenance by VA rather than set/way operations.
System caches which respect the architected cache maintenance by VA
operations must be configured and may be enabled.
System caches which do not respect architected cache maintenance by VA
operations (not recommended) must be configured and disabled.</p>
</li>
<li><p class="first">Architected timers</p>
<p>CNTFRQ must be programmed with the timer frequency and CNTVOFF must
be programmed with a consistent value on all CPUs.  If entering the
kernel at EL1, CNTHCTL_EL2 must have EL1PCTEN (bit 0) set where
available.</p>
</li>
<li><p class="first">Coherency</p>
<p>All CPUs to be booted by the kernel must be part of the same coherency
domain on entry to the kernel.  This may require IMPLEMENTATION DEFINED
initialisation to enable the receiving of maintenance operations on
each CPU.</p>
</li>
<li><p class="first">System registers</p>
<p>All writable architected system registers at the exception level where
the kernel image will be entered must be initialised by software at a
higher exception level to prevent execution in an UNKNOWN state.</p>
<ul class="simple">
<li>SCR_EL3.FIQ must have the same value across all CPUs the kernel is
executing on.</li>
<li>The value of SCR_EL3.FIQ must be the same as the one present at boot
time whenever the kernel is executing.</li>
</ul>
<p>For systems with a GICv3 interrupt controller to be used in v3 mode:
- If EL3 is present:</p>
<blockquote>
<div><ul class="simple">
<li>ICC_SRE_EL3.Enable (bit 3) must be initialiased to 0b1.</li>
<li>ICC_SRE_EL3.SRE (bit 0) must be initialised to 0b1.</li>
<li>ICC_CTLR_EL3.PMHE (bit 6) must be set to the same value across
all CPUs the kernel is executing on, and must stay constant
for the lifetime of the kernel.</li>
</ul>
</div></blockquote>
<ul>
<li><p class="first">If the kernel is entered at EL1:</p>
<blockquote>
<div><ul class="simple">
<li>ICC.SRE_EL2.Enable (bit 3) must be initialised to 0b1</li>
<li>ICC_SRE_EL2.SRE (bit 0) must be initialised to 0b1.</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">The DT or ACPI tables must describe a GICv3 interrupt controller.</p>
</li>
</ul>
<p>For systems with a GICv3 interrupt controller to be used in
compatibility (v2) mode:</p>
<ul>
<li><p class="first">If EL3 is present:</p>
<blockquote>
<div><p>ICC_SRE_EL3.SRE (bit 0) must be initialised to 0b0.</p>
</div></blockquote>
</li>
<li><p class="first">If the kernel is entered at EL1:</p>
<blockquote>
<div><p>ICC_SRE_EL2.SRE (bit 0) must be initialised to 0b0.</p>
</div></blockquote>
</li>
<li><p class="first">The DT or ACPI tables must describe a GICv2 interrupt controller.</p>
</li>
</ul>
<p>For CPUs with pointer authentication functionality:
- If EL3 is present:</p>
<blockquote>
<div><ul class="simple">
<li>SCR_EL3.APK (bit 16) must be initialised to 0b1</li>
<li>SCR_EL3.API (bit 17) must be initialised to 0b1</li>
</ul>
</div></blockquote>
<ul class="simple">
<li>If the kernel is entered at EL1:<ul>
<li>HCR_EL2.APK (bit 40) must be initialised to 0b1</li>
<li>HCR_EL2.API (bit 41) must be initialised to 0b1</li>
</ul>
</li>
</ul>
<p>For CPUs with Activity Monitors Unit v1 (AMUv1) extension present:
- If EL3 is present:</p>
<blockquote>
<div><p>CPTR_EL3.TAM (bit 30) must be initialised to 0b0
CPTR_EL2.TAM (bit 30) must be initialised to 0b0
AMCNTENSET0_EL0 must be initialised to 0b1111
AMCNTENSET1_EL0 must be initialised to a platform specific value
having 0b1 set for the corresponding bit for each of the auxiliary
counters present.</p>
</div></blockquote>
<ul class="simple">
<li>If the kernel is entered at EL1:
AMCNTENSET0_EL0 must be initialised to 0b1111
AMCNTENSET1_EL0 must be initialised to a platform specific value
having 0b1 set for the corresponding bit for each of the auxiliary
counters present.</li>
</ul>
</li>
</ul>
<p>The requirements described above for CPU mode, caches, MMUs, architected
timers, coherency and system registers apply to all CPUs.  All CPUs must
enter the kernel in the same exception level.</p>
<p>The boot loader is expected to enter the kernel on each CPU in the
following manner:</p>
<ul>
<li><p class="first">The primary CPU must jump directly to the first instruction of the
kernel image.  The device tree blob passed by this CPU must contain
an ‘enable-method’ property for each cpu node.  The supported
enable-methods are described below.</p>
<p>It is expected that the bootloader will generate these device tree
properties and insert them into the blob prior to kernel entry.</p>
</li>
<li><p class="first">CPUs with a “spin-table” enable-method must have a ‘cpu-release-addr’
property in their cpu node.  This property identifies a
naturally-aligned 64-bit zero-initalised memory location.</p>
<p>These CPUs should spin outside of the kernel in a reserved area of
memory (communicated to the kernel by a /memreserve/ region in the
device tree) polling their cpu-release-addr location, which must be
contained in the reserved region.  A wfe instruction may be inserted
to reduce the overhead of the busy-loop and a sev will be issued by
the primary CPU.  When a read of the location pointed to by the
cpu-release-addr returns a non-zero value, the CPU must jump to this
value.  The value will be written as a single 64-bit little-endian
value, so CPUs must convert the read value to their native endianness
before jumping to it.</p>
</li>
<li><p class="first">CPUs with a “psci” enable method should remain outside of
the kernel (i.e. outside of the regions of memory described to the
kernel in the memory node, or in a reserved area of memory described
to the kernel by a /memreserve/ region in the device tree).  The
kernel will issue CPU_ON calls as described in ARM document number ARM
DEN 0022A (“Power State Coordination Interface System Software on ARM
processors”) to bring CPUs into the kernel.</p>
<p>The device tree should contain a ‘psci’ node, as described in
Documentation/devicetree/bindings/arm/psci.yaml.</p>
</li>
<li><p class="first">Secondary CPU general-purpose register settings
x0 = 0 (reserved for future use)
x1 = 0 (reserved for future use)
x2 = 0 (reserved for future use)
x3 = 0 (reserved for future use)</p>
</li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>