

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>6.3. The cpia2 driver &mdash; The Linux Kernel  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.14.0-rc1-mm1</div><div>NOTE: This is not the latest version of the doc.  Visit <a href="https://docs.kernel.org" style="color:#bbbbbb"> here </a> for the latest version.
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../mm/damon/index.html">Monitoring Data Accesses</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../vm/damon/index.html">DAMON: Data Access MONitor</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li><span class="section-number">6.3. </span>The cpia2 driver</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/admin-guide/media/cpia2.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="the-cpia2-driver">
<h1><span class="section-number">6.3. </span>The cpia2 driver<a class="headerlink" href="#the-cpia2-driver" title="Permalink to this headline">¶</a></h1>
<p>Authors: Peter Pregler &lt;<a class="reference external" href="mailto:Peter_Pregler&#37;&#52;&#48;email&#46;com">Peter_Pregler<span>&#64;</span>email<span>&#46;</span>com</a>&gt;,
Scott J. Bertin &lt;<a class="reference external" href="mailto:scottbertin&#37;&#52;&#48;yahoo&#46;com">scottbertin<span>&#64;</span>yahoo<span>&#46;</span>com</a>&gt;, and
Jarl Totland &lt;<a class="reference external" href="mailto:Jarl&#46;Totland&#37;&#52;&#48;bdc&#46;no">Jarl<span>&#46;</span>Totland<span>&#64;</span>bdc<span>&#46;</span>no</a>&gt; for the original cpia driver, which
this one was modelled from.</p>
<div class="section" id="introduction">
<h2><span class="section-number">6.3.1. </span>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>This is a driver for STMicroelectronics’s CPiA2 (second generation
Colour Processor Interface ASIC) based cameras. This camera outputs an MJPEG
stream at up to vga size. It implements the Video4Linux interface as much as
possible.  Since the V4L interface does not support compressed formats, only
an mjpeg enabled application can be used with the camera. We have modified the
gqcam application to view this stream.</p>
<p>The driver is implemented as two kernel modules. The cpia2 module
contains the camera functions and the V4L interface.  The cpia2_usb module
contains usb specific functions.  The main reason for this was the size of the
module was getting out of hand, so I separated them.  It is not likely that
there will be a parallel port version.</p>
</div>
<div class="section" id="features">
<h2><span class="section-number">6.3.2. </span>Features<a class="headerlink" href="#features" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Supports cameras with the Vision stv6410 (CIF) and stv6500 (VGA) cmos
sensors. I only have the vga sensor, so can’t test the other.</p></li>
<li><p>Image formats: VGA, QVGA, CIF, QCIF, and a number of sizes in between.
VGA and QVGA are the native image sizes for the VGA camera. CIF is done
in the coprocessor by scaling QVGA.  All other sizes are done by clipping.</p></li>
<li><p>Palette: YCrCb, compressed with MJPEG.</p></li>
<li><p>Some compression parameters are settable.</p></li>
<li><p>Sensor framerate is adjustable (up to 30 fps CIF, 15 fps VGA).</p></li>
<li><p>Adjust brightness, color, contrast while streaming.</p></li>
<li><p>Flicker control settable for 50 or 60 Hz mains frequency.</p></li>
</ul>
</div>
<div class="section" id="making-and-installing-the-stv672-driver-modules">
<h2><span class="section-number">6.3.3. </span>Making and installing the stv672 driver modules<a class="headerlink" href="#making-and-installing-the-stv672-driver-modules" title="Permalink to this headline">¶</a></h2>
<div class="section" id="requirements">
<h3><span class="section-number">6.3.3.1. </span>Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h3>
<p>Video4Linux must be either compiled into the kernel or
available as a module.  Video4Linux2 is automatically detected and made
available at compile time.</p>
</div>
<div class="section" id="setup">
<h3><span class="section-number">6.3.3.2. </span>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h3>
<p>Use <code class="docutils literal notranslate"><span class="pre">modprobe</span> <span class="pre">cpia2</span></code> to load and <code class="docutils literal notranslate"><span class="pre">modprobe</span> <span class="pre">-r</span> <span class="pre">cpia2</span></code> to unload. This
may be done automatically by your distribution.</p>
</div>
<div class="section" id="driver-options">
<h3><span class="section-number">6.3.3.3. </span>Driver options<a class="headerlink" href="#driver-options" title="Permalink to this headline">¶</a></h3>
<table class="docutils align-default">
<colgroup>
<col style="width: 20%" />
<col style="width: 80%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Option</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>video_nr</p></td>
<td><p>video device to register (0=/dev/video0, etc)
range -1 to 64.  default is -1 (first available)
If you have more than 1 camera, this MUST be -1.</p></td>
</tr>
<tr class="row-odd"><td><p>buffer_size</p></td>
<td><p>Size for each frame buffer in bytes (default 68k)</p></td>
</tr>
<tr class="row-even"><td><p>num_buffers</p></td>
<td><p>Number of frame buffers (1-32, default 3)</p></td>
</tr>
<tr class="row-odd"><td><p>alternate</p></td>
<td><p>USB Alternate (2-7, default 7)</p></td>
</tr>
<tr class="row-even"><td><p>flicker_freq</p></td>
<td><p>Frequency for flicker reduction(50 or 60, default 60)</p></td>
</tr>
<tr class="row-odd"><td><p>flicker_mode</p></td>
<td><p>0 to disable, or 1 to enable flicker reduction.
(default 0). This is only effective if the camera
uses a stv0672 coprocessor.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="setting-the-options">
<h3><span class="section-number">6.3.3.4. </span>Setting the options<a class="headerlink" href="#setting-the-options" title="Permalink to this headline">¶</a></h3>
<p>If you are using modules, edit /etc/modules.conf and add an options
line like this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>options cpia2 num_buffers=3 buffer_size=65535
</pre></div>
</div>
<p>If the driver is compiled into the kernel, at boot time specify them
like this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cpia2.num_buffers=3 cpia2.buffer_size=65535
</pre></div>
</div>
</div>
<div class="section" id="what-buffer-size-should-i-use">
<h3><span class="section-number">6.3.3.5. </span>What buffer size should I use?<a class="headerlink" href="#what-buffer-size-should-i-use" title="Permalink to this headline">¶</a></h3>
<p>The maximum image size depends on the alternate you choose, and the
frame rate achieved by the camera.  If the compression engine is able to
keep up with the frame rate, the maximum image size is given by the table
below.</p>
<p>The compression engine starts out at maximum compression, and will
increase image quality until it is close to the size in the table.  As long
as the compression engine can keep up with the frame rate, after a short time
the images will all be about the size in the table, regardless of resolution.</p>
<p>At low alternate settings, the compression engine may not be able to
compress the image enough and will reduce the frame rate by producing larger
images.</p>
<p>The default of 68k should be good for most users.  This will handle
any alternate at frame rates down to 15fps.  For lower frame rates, it may
be necessary to increase the buffer size to avoid having frames dropped due
to insufficient space.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 30%" />
<col style="width: 30%" />
<col style="width: 24%" />
<col style="width: 15%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Alternate</p></th>
<th class="head"><p>bytes/ms</p></th>
<th class="head"><p>15fps</p></th>
<th class="head"><p>30fps</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>2</p></td>
<td><p>128</p></td>
<td><p>8533</p></td>
<td><p>4267</p></td>
</tr>
<tr class="row-odd"><td><p>3</p></td>
<td><p>384</p></td>
<td><p>25600</p></td>
<td><p>12800</p></td>
</tr>
<tr class="row-even"><td><p>4</p></td>
<td><p>640</p></td>
<td><p>42667</p></td>
<td><p>21333</p></td>
</tr>
<tr class="row-odd"><td><p>5</p></td>
<td><p>768</p></td>
<td><p>51200</p></td>
<td><p>25600</p></td>
</tr>
<tr class="row-even"><td><p>6</p></td>
<td><p>896</p></td>
<td><p>59733</p></td>
<td><p>29867</p></td>
</tr>
<tr class="row-odd"><td><p>7</p></td>
<td><p>1023</p></td>
<td><p>68200</p></td>
<td><p>34100</p></td>
</tr>
</tbody>
</table>
<p>Table: Image size(bytes)</p>
</div>
<div class="section" id="how-many-buffers-should-i-use">
<h3><span class="section-number">6.3.3.6. </span>How many buffers should I use?<a class="headerlink" href="#how-many-buffers-should-i-use" title="Permalink to this headline">¶</a></h3>
<p>For normal streaming, 3 should give the best results.  With only 2,
it is possible for the camera to finish sending one image just after a
program has started reading the other.  If this happens, the driver must drop
a frame.  The exception to this is if you have a heavily loaded machine.  In
this case use 2 buffers.  You are probably not reading at the full frame rate.
If the camera can send multiple images before a read finishes, it could
overwrite the third buffer before the read finishes, leading to a corrupt
image.  Single and double buffering have extra checks to avoid overwriting.</p>
</div>
<div class="section" id="using-the-camera">
<h3><span class="section-number">6.3.3.7. </span>Using the camera<a class="headerlink" href="#using-the-camera" title="Permalink to this headline">¶</a></h3>
<p>We are providing a modified gqcam application to view the output. In
order to avoid confusion, here it is called mview.  There is also the qx5view
program which can also control the lights on the qx5 microscope. MJPEG Tools
(<a class="reference external" href="http://mjpeg.sourceforge.net">http://mjpeg.sourceforge.net</a>) can also be used to record from the camera.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright The kernel development community

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>