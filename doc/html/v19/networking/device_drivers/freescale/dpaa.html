

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>The QorIQ DPAA Ethernet Driver &mdash; The Linux Kernel  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../../../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.8.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../admin-guide/mm/damon/index.html">Monitoring Data Accesses</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../vm/damon/index.html">DAMON: Data Access MONitor</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
      <li>The QorIQ DPAA Ethernet Driver</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/networking/device_drivers/freescale/dpaa.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="the-qoriq-dpaa-ethernet-driver">
<h1>The QorIQ DPAA Ethernet Driver<a class="headerlink" href="#the-qoriq-dpaa-ethernet-driver" title="Permalink to this headline">¶</a></h1>
<p>Authors:
- Madalin Bucur &lt;<a class="reference external" href="mailto:madalin&#46;bucur&#37;&#52;&#48;nxp&#46;com">madalin<span>&#46;</span>bucur<span>&#64;</span>nxp<span>&#46;</span>com</a>&gt;
- Camelia Groza &lt;<a class="reference external" href="mailto:camelia&#46;groza&#37;&#52;&#48;nxp&#46;com">camelia<span>&#46;</span>groza<span>&#64;</span>nxp<span>&#46;</span>com</a>&gt;</p>
<div class="section" id="dpaa-ethernet-overview">
<h2>DPAA Ethernet Overview<a class="headerlink" href="#dpaa-ethernet-overview" title="Permalink to this headline">¶</a></h2>
<p>DPAA stands for Data Path Acceleration Architecture and it is a
set of networking acceleration IPs that are available on several
generations of SoCs, both on PowerPC and ARM64.</p>
<p>The Freescale DPAA architecture consists of a series of hardware blocks
that support Ethernet connectivity. The Ethernet driver depends upon the
following drivers in the Linux kernel:</p>
<blockquote>
<div><ul class="simple">
<li><dl class="first docutils">
<dt>Peripheral Access Memory Unit (PAMU) (* needed only for PPC platforms)</dt>
<dd>drivers/iommu/fsl_*</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Frame Manager (FMan)</dt>
<dd>drivers/net/ethernet/freescale/fman</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Queue Manager (QMan), Buffer Manager (BMan)</dt>
<dd>drivers/soc/fsl/qbman</dd>
</dl>
</li>
</ul>
</div></blockquote>
<p>A simplified view of the dpaa_eth interfaces mapped to FMan MACs:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>dpaa_eth       /eth0\     ...       /ethN\
driver        |      |             |      |
-------------   ----   -----------   ----   -------------
     -Ports  / Tx  Rx \    ...    / Tx  Rx \
FMan        |          |         |          |
     -MACs  |   MAC0   |         |   MACN   |
           /   dtsec0   \  ...  /   dtsecN   \ (or tgec)
          /              \     /              \(or memac)
---------  --------------  ---  --------------  ---------
    FMan, FMan Port, FMan SP, FMan MURAM drivers
---------------------------------------------------------
    FMan HW blocks: MURAM, MACs, Ports, SP
---------------------------------------------------------
</pre></div>
</div>
<p>The dpaa_eth relation to the QMan, BMan and FMan:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>            ________________________________
dpaa_eth   /            eth0                \
driver    /                                  \
---------   -^-   -^-   -^-   ---    ---------
QMan driver / \   / \   / \  \   /  | BMan    |
           |Rx | |Rx | |Tx | |Tx |  | driver  |
---------  |Dfl| |Err| |Cnf| |FQs|  |         |
QMan HW    |FQ | |FQ | |FQs| |   |  |         |
           /   \ /   \ /   \  \ /   |         |
---------   ---   ---   ---   -v-    ---------
          |        FMan QMI         |         |
          | FMan HW       FMan BMI  | BMan HW |
            -----------------------   --------
</pre></div>
</div>
<p>where the acronyms used above (and in the code) are:</p>
<table border="1" class="docutils">
<colgroup>
<col width="20%" />
<col width="80%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>DPAA</td>
<td>Data Path Acceleration Architecture</td>
</tr>
<tr class="row-even"><td>FMan</td>
<td>DPAA Frame Manager</td>
</tr>
<tr class="row-odd"><td>QMan</td>
<td>DPAA Queue Manager</td>
</tr>
<tr class="row-even"><td>BMan</td>
<td>DPAA Buffers Manager</td>
</tr>
<tr class="row-odd"><td>QMI</td>
<td>QMan interface in FMan</td>
</tr>
<tr class="row-even"><td>BMI</td>
<td>BMan interface in FMan</td>
</tr>
<tr class="row-odd"><td>FMan SP</td>
<td>FMan Storage Profiles</td>
</tr>
<tr class="row-even"><td>MURAM</td>
<td>Multi-user RAM in FMan</td>
</tr>
<tr class="row-odd"><td>FQ</td>
<td>QMan Frame Queue</td>
</tr>
<tr class="row-even"><td>Rx Dfl FQ</td>
<td>default reception FQ</td>
</tr>
<tr class="row-odd"><td>Rx Err FQ</td>
<td>Rx error frames FQ</td>
</tr>
<tr class="row-even"><td>Tx Cnf FQ</td>
<td>Tx confirmation FQs</td>
</tr>
<tr class="row-odd"><td>Tx FQs</td>
<td>transmission frame queues</td>
</tr>
<tr class="row-even"><td>dtsec</td>
<td>datapath three speed Ethernet controller (10/100/1000 Mbps)</td>
</tr>
<tr class="row-odd"><td>tgec</td>
<td>ten gigabit Ethernet controller (10 Gbps)</td>
</tr>
<tr class="row-even"><td>memac</td>
<td>multirate Ethernet MAC (10/100/1000/10000)</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="dpaa-ethernet-supported-socs">
<h2>DPAA Ethernet Supported SoCs<a class="headerlink" href="#dpaa-ethernet-supported-socs" title="Permalink to this headline">¶</a></h2>
<p>The DPAA drivers enable the Ethernet controllers present on the following SoCs:</p>
<p>PPC
- P1023
- P2041
- P3041
- P4080
- P5020
- P5040
- T1023
- T1024
- T1040
- T1042
- T2080
- T4240
- B4860</p>
<p>ARM
- LS1043A
- LS1046A</p>
</div>
<div class="section" id="configuring-dpaa-ethernet-in-your-kernel">
<h2>Configuring DPAA Ethernet in your kernel<a class="headerlink" href="#configuring-dpaa-ethernet-in-your-kernel" title="Permalink to this headline">¶</a></h2>
<p>To enable the DPAA Ethernet driver, the following Kconfig options are required:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># common for arch/arm64 and arch/powerpc platforms
CONFIG_FSL_DPAA=y
CONFIG_FSL_FMAN=y
CONFIG_FSL_DPAA_ETH=y
CONFIG_FSL_XGMAC_MDIO=y

# for arch/powerpc only
CONFIG_FSL_PAMU=y

# common options needed for the PHYs used on the RDBs
CONFIG_VITESSE_PHY=y
CONFIG_REALTEK_PHY=y
CONFIG_AQUANTIA_PHY=y
</pre></div>
</div>
</div>
<div class="section" id="dpaa-ethernet-frame-processing">
<h2>DPAA Ethernet Frame Processing<a class="headerlink" href="#dpaa-ethernet-frame-processing" title="Permalink to this headline">¶</a></h2>
<p>On Rx, buffers for the incoming frames are retrieved from the buffers found
in the dedicated interface buffer pool. The driver initializes and seeds these
with one page buffers.</p>
<p>On Tx, all transmitted frames are returned to the driver through Tx
confirmation frame queues. The driver is then responsible for freeing the
buffers. In order to do this properly, a backpointer is added to the buffer
before transmission that points to the skb. When the buffer returns to the
driver on a confirmation FQ, the skb can be correctly consumed.</p>
</div>
<div class="section" id="dpaa-ethernet-features">
<h2>DPAA Ethernet Features<a class="headerlink" href="#dpaa-ethernet-features" title="Permalink to this headline">¶</a></h2>
<p>Currently the DPAA Ethernet driver enables the basic features required for
a Linux Ethernet driver. The support for advanced features will be added
gradually.</p>
<p>The driver has Rx and Tx checksum offloading for UDP and TCP. Currently the Rx
checksum offload feature is enabled by default and cannot be controlled through
ethtool. Also, rx-flow-hash and rx-hashing was added. The addition of RSS
provides a big performance boost for the forwarding scenarios, allowing
different traffic flows received by one interface to be processed by different
CPUs in parallel.</p>
<p>The driver has support for multiple prioritized Tx traffic classes. Priorities
range from 0 (lowest) to 3 (highest). These are mapped to HW workqueues with
strict priority levels. Each traffic class contains NR_CPU TX queues. By
default, only one traffic class is enabled and the lowest priority Tx queues
are used. Higher priority traffic classes can be enabled with the mqprio
qdisc. For example, all four traffic classes are enabled on an interface with
the following command. Furthermore, skb priority levels are mapped to traffic
classes as follows:</p>
<blockquote>
<div><ul class="simple">
<li>priorities 0 to 3 - traffic class 0 (low priority)</li>
<li>priorities 4 to 7 - traffic class 1 (medium-low priority)</li>
<li>priorities 8 to 11 - traffic class 2 (medium-high priority)</li>
<li>priorities 12 to 15 - traffic class 3 (high priority)</li>
</ul>
</div></blockquote>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>tc qdisc add dev &lt;int&gt; root handle 1: \
       mqprio num_tc 4 map 0 0 0 0 1 1 1 1 2 2 2 2 3 3 3 3 hw 1
</pre></div>
</div>
</div>
<div class="section" id="dpaa-irq-affinity-and-receive-side-scaling">
<h2>DPAA IRQ Affinity and Receive Side Scaling<a class="headerlink" href="#dpaa-irq-affinity-and-receive-side-scaling" title="Permalink to this headline">¶</a></h2>
<p>Traffic coming on the DPAA Rx queues or on the DPAA Tx confirmation
queues is seen by the CPU as ingress traffic on a certain portal.
The DPAA QMan portal interrupts are affined each to a certain CPU.
The same portal interrupt services all the QMan portal consumers.</p>
<p>By default the DPAA Ethernet driver enables RSS, making use of the
DPAA FMan Parser and Keygen blocks to distribute traffic on 128
hardware frame queues using a hash on IP v4/v6 source and destination
and L4 source and destination ports, in present in the received frame.
When RSS is disabled, all traffic received by a certain interface is
received on the default Rx frame queue. The default DPAA Rx frame
queues are configured to put the received traffic into a pool channel
that allows any available CPU portal to dequeue the ingress traffic.
The default frame queues have the HOLDACTIVE option set, ensuring that
traffic bursts from a certain queue are serviced by the same CPU.
This ensures a very low rate of frame reordering. A drawback of this
is that only one CPU at a time can service the traffic received by a
certain interface when RSS is not enabled.</p>
<p>To implement RSS, the DPAA Ethernet driver allocates an extra set of
128 Rx frame queues that are configured to dedicated channels, in a
round-robin manner. The mapping of the frame queues to CPUs is now
hardcoded, there is no indirection table to move traffic for a certain
FQ (hash result) to another CPU. The ingress traffic arriving on one
of these frame queues will arrive at the same portal and will always
be processed by the same CPU. This ensures intra-flow order preservation
and workload distribution for multiple traffic flows.</p>
<p>RSS can be turned off for a certain interface using ethtool, i.e.:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># ethtool -N fm1-mac9 rx-flow-hash tcp4 &quot;&quot;
</pre></div>
</div>
<p>To turn it back on, one needs to set rx-flow-hash for tcp4/6 or udp4/6:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># ethtool -N fm1-mac9 rx-flow-hash udp4 sfdn
</pre></div>
</div>
<p>There is no independent control for individual protocols, any command
run for one of tcp4|udp4|ah4|esp4|sctp4|tcp6|udp6|ah6|esp6|sctp6 is
going to control the rx-flow-hashing for all protocols on that interface.</p>
<p>Besides using the FMan Keygen computed hash for spreading traffic on the
128 Rx FQs, the DPAA Ethernet driver also sets the skb hash value when
the NETIF_F_RXHASH feature is on (active by default). This can be turned
on or off through ethtool, i.e.:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># ethtool -K fm1-mac9 rx-hashing off
# ethtool -k fm1-mac9 | grep hash
receive-hashing: off
# ethtool -K fm1-mac9 rx-hashing on
Actual changes:
receive-hashing: on
# ethtool -k fm1-mac9 | grep hash
receive-hashing: on
</pre></div>
</div>
<p>Please note that Rx hashing depends upon the rx-flow-hashing being on
for that interface - turning off rx-flow-hashing will also disable the
rx-hashing (without ethtool reporting it as off as that depends on the
NETIF_F_RXHASH feature flag).</p>
</div>
<div class="section" id="debugging">
<h2>Debugging<a class="headerlink" href="#debugging" title="Permalink to this headline">¶</a></h2>
<p>The following statistics are exported for each interface through ethtool:</p>
<blockquote>
<div><ul>
<li><p class="first">interrupt count per CPU</p>
</li>
<li><p class="first">Rx packets count per CPU</p>
</li>
<li><p class="first">Tx packets count per CPU</p>
</li>
<li><p class="first">Tx confirmed packets count per CPU</p>
</li>
<li><p class="first">Tx S/G frames count per CPU</p>
</li>
<li><p class="first">Tx error count per CPU</p>
</li>
<li><p class="first">Rx error count per CPU</p>
</li>
<li><p class="first">Rx error count per type</p>
</li>
<li><p class="first">congestion related statistics:</p>
<blockquote>
<div><ul class="simple">
<li>congestion status</li>
<li>time spent in congestion</li>
<li>number of time the device entered congestion</li>
<li>dropped packets count per cause</li>
</ul>
</div></blockquote>
</li>
</ul>
</div></blockquote>
<p>The driver also exports the following information in sysfs:</p>
<blockquote>
<div><ul class="simple">
<li>the FQ IDs for each FQ type
/sys/devices/platform/soc/&lt;addr&gt;.fman/&lt;addr&gt;.ethernet/dpaa-ethernet.&lt;id&gt;/net/fm&lt;nr&gt;-mac&lt;nr&gt;/fqids</li>
<li>the ID of the buffer pool in use
/sys/devices/platform/soc/&lt;addr&gt;.fman/&lt;addr&gt;.ethernet/dpaa-ethernet.&lt;id&gt;/net/fm&lt;nr&gt;-mac&lt;nr&gt;/bpids</li>
</ul>
</div></blockquote>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>