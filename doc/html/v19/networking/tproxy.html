

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Transparent proxy support &mdash; The Linux Kernel  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.8.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/mm/damon/index.html">Monitoring Data Accesses</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../vm/damon/index.html">DAMON: Data Access MONitor</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Transparent proxy support</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/networking/tproxy.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="transparent-proxy-support">
<h1>Transparent proxy support<a class="headerlink" href="#transparent-proxy-support" title="Permalink to this headline">¶</a></h1>
<p>This feature adds Linux 2.2-like transparent proxy support to current kernels.
To use it, enable the socket match and the TPROXY target in your kernel config.
You will need policy routing too, so be sure to enable that as well.</p>
<p>From Linux 4.18 transparent proxy support is also available in nf_tables.</p>
<div class="section" id="making-non-local-sockets-work">
<h2>1. Making non-local sockets work<a class="headerlink" href="#making-non-local-sockets-work" title="Permalink to this headline">¶</a></h2>
<p>The idea is that you identify packets with destination address matching a local
socket on your box, set the packet mark to a certain value:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># iptables -t mangle -N DIVERT
# iptables -t mangle -A PREROUTING -p tcp -m socket -j DIVERT
# iptables -t mangle -A DIVERT -j MARK --set-mark 1
# iptables -t mangle -A DIVERT -j ACCEPT
</pre></div>
</div>
<p>Alternatively you can do this in nft with the following commands:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># nft add table filter
# nft add chain filter divert &quot;{ type filter hook prerouting priority -150; }&quot;
# nft add rule filter divert meta l4proto tcp socket transparent 1 meta mark set 1 accept
</pre></div>
</div>
<p>And then match on that value using policy routing to have those packets
delivered locally:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># ip rule add fwmark 1 lookup 100
# ip route add local 0.0.0.0/0 dev lo table 100
</pre></div>
</div>
<p>Because of certain restrictions in the IPv4 routing output code you’ll have to
modify your application to allow it to send datagrams _from_ non-local IP
addresses. All you have to do is enable the (SOL_IP, IP_TRANSPARENT) socket
option before calling bind:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>fd = socket(AF_INET, SOCK_STREAM, 0);
/* - 8&lt; -*/
int value = 1;
setsockopt(fd, SOL_IP, IP_TRANSPARENT, &amp;value, sizeof(value));
/* - 8&lt; -*/
name.sin_family = AF_INET;
name.sin_port = htons(0xCAFE);
name.sin_addr.s_addr = htonl(0xDEADBEEF);
bind(fd, &amp;name, sizeof(name));
</pre></div>
</div>
<p>A trivial patch for netcat is available here:
<a class="reference external" href="http://people.netfilter.org/hidden/tproxy/netcat-ip_transparent-support.patch">http://people.netfilter.org/hidden/tproxy/netcat-ip_transparent-support.patch</a></p>
</div>
<div class="section" id="redirecting-traffic">
<h2>2. Redirecting traffic<a class="headerlink" href="#redirecting-traffic" title="Permalink to this headline">¶</a></h2>
<p>Transparent proxying often involves “intercepting” traffic on a router. This is
usually done with the iptables REDIRECT target; however, there are serious
limitations of that method. One of the major issues is that it actually
modifies the packets to change the destination address – which might not be
acceptable in certain situations. (Think of proxying UDP for example: you won’t
be able to find out the original destination address. Even in case of TCP
getting the original destination address is racy.)</p>
<p>The ‘TPROXY’ target provides similar functionality without relying on NAT. Simply
add rules like this to the iptables ruleset above:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># iptables -t mangle -A PREROUTING -p tcp --dport 80 -j TPROXY \
  --tproxy-mark 0x1/0x1 --on-port 50080
</pre></div>
</div>
<p>Or the following rule to nft:</p>
<p># nft add rule filter divert tcp dport 80 tproxy to :50080 meta mark set 1 accept</p>
<p>Note that for this to work you’ll have to modify the proxy to enable (SOL_IP,
IP_TRANSPARENT) for the listening socket.</p>
<p>As an example implementation, tcprdr is available here:
<a class="reference external" href="https://git.breakpoint.cc/cgit/fw/tcprdr.git/">https://git.breakpoint.cc/cgit/fw/tcprdr.git/</a>
This tool is written by Florian Westphal and it was used for testing during the
nf_tables implementation.</p>
</div>
<div class="section" id="iptables-and-nf-tables-extensions">
<h2>3. Iptables and nf_tables extensions<a class="headerlink" href="#iptables-and-nf-tables-extensions" title="Permalink to this headline">¶</a></h2>
<p>To use tproxy you’ll need to have the following modules compiled for iptables:</p>
<blockquote>
<div><ul class="simple">
<li>NETFILTER_XT_MATCH_SOCKET</li>
<li>NETFILTER_XT_TARGET_TPROXY</li>
</ul>
</div></blockquote>
<p>Or the floowing modules for nf_tables:</p>
<blockquote>
<div><ul class="simple">
<li>NFT_SOCKET</li>
<li>NFT_TPROXY</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="application-support">
<h2>4. Application support<a class="headerlink" href="#application-support" title="Permalink to this headline">¶</a></h2>
<div class="section" id="squid">
<h3>4.1. Squid<a class="headerlink" href="#squid" title="Permalink to this headline">¶</a></h3>
<p>Squid 3.HEAD has support built-in. To use it, pass
‘–enable-linux-netfilter’ to configure and set the ‘tproxy’ option on
the HTTP listener you redirect traffic to with the TPROXY iptables
target.</p>
<p>For more information please consult the following page on the Squid
wiki: <a class="reference external" href="http://wiki.squid-cache.org/Features/Tproxy4">http://wiki.squid-cache.org/Features/Tproxy4</a></p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>