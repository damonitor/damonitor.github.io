

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>dm-switch &mdash; The Linux Kernel  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.14.0-rc1-mm1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../mm/damon/index.html">Monitoring Data Accesses</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../vm/damon/index.html">DAMON: Data Access MONitor</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>dm-switch</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/admin-guide/device-mapper/switch.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="dm-switch">
<h1>dm-switch<a class="headerlink" href="#dm-switch" title="Permalink to this headline">¶</a></h1>
<p>The device-mapper switch target creates a device that supports an
arbitrary mapping of fixed-size regions of I/O across a fixed set of
paths.  The path used for any specific region can be switched
dynamically by sending the target a message.</p>
<p>It maps I/O to underlying block devices efficiently when there is a large
number of fixed-sized address regions but there is no simple pattern
that would allow for a compact representation of the mapping such as
dm-stripe.</p>
<div class="section" id="background">
<h2>Background<a class="headerlink" href="#background" title="Permalink to this headline">¶</a></h2>
<p>Dell EqualLogic and some other iSCSI storage arrays use a distributed
frameless architecture.  In this architecture, the storage group
consists of a number of distinct storage arrays (“members”) each having
independent controllers, disk storage and network adapters.  When a LUN
is created it is spread across multiple members.  The details of the
spreading are hidden from initiators connected to this storage system.
The storage group exposes a single target discovery portal, no matter
how many members are being used.  When iSCSI sessions are created, each
session is connected to an eth port on a single member.  Data to a LUN
can be sent on any iSCSI session, and if the blocks being accessed are
stored on another member the I/O will be forwarded as required.  This
forwarding is invisible to the initiator.  The storage layout is also
dynamic, and the blocks stored on disk may be moved from member to
member as needed to balance the load.</p>
<p>This architecture simplifies the management and configuration of both
the storage group and initiators.  In a multipathing configuration, it
is possible to set up multiple iSCSI sessions to use multiple network
interfaces on both the host and target to take advantage of the
increased network bandwidth.  An initiator could use a simple round
robin algorithm to send I/O across all paths and let the storage array
members forward it as necessary, but there is a performance advantage to
sending data directly to the correct member.</p>
<p>A device-mapper table already lets you map different regions of a
device onto different targets.  However in this architecture the LUN is
spread with an address region size on the order of 10s of MBs, which
means the resulting table could have more than a million entries and
consume far too much memory.</p>
<p>Using this device-mapper switch target we can now build a two-layer
device hierarchy:</p>
<blockquote>
<div><p>Upper Tier - Determine which array member the I/O should be sent to.
Lower Tier - Load balance amongst paths to a particular member.</p>
</div></blockquote>
<p>The lower tier consists of a single dm multipath device for each member.
Each of these multipath devices contains the set of paths directly to
the array member in one priority group, and leverages existing path
selectors to load balance amongst these paths.  We also build a
non-preferred priority group containing paths to other array members for
failover reasons.</p>
<p>The upper tier consists of a single dm-switch device.  This device uses
a bitmap to look up the location of the I/O and choose the appropriate
lower tier device to route the I/O.  By using a bitmap we are able to
use 4 bits for each address range in a 16 member group (which is very
large for us).  This is a much denser representation than the dm table
b-tree can achieve.</p>
<div class="section" id="construction-parameters">
<h3>Construction Parameters<a class="headerlink" href="#construction-parameters" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><dl class="simple">
<dt>&lt;num_paths&gt; &lt;region_size&gt; &lt;num_optional_args&gt; [&lt;optional_args&gt;…] [&lt;dev_path&gt; &lt;offset&gt;]+</dt><dd><dl class="simple">
<dt>&lt;num_paths&gt;</dt><dd><p>The number of paths across which to distribute the I/O.</p>
</dd>
<dt>&lt;region_size&gt;</dt><dd><p>The number of 512-byte sectors in a region. Each region can be redirected
to any of the available paths.</p>
</dd>
<dt>&lt;num_optional_args&gt;</dt><dd><p>The number of optional arguments. Currently, no optional arguments
are supported and so this must be zero.</p>
</dd>
<dt>&lt;dev_path&gt;</dt><dd><p>The block device that represents a specific path to the device.</p>
</dd>
<dt>&lt;offset&gt;</dt><dd><p>The offset of the start of data on the specific &lt;dev_path&gt; (in units
of 512-byte sectors). This number is added to the sector number when
forwarding the request to the specific path. Typically it is zero.</p>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
</div>
<div class="section" id="messages">
<h3>Messages<a class="headerlink" href="#messages" title="Permalink to this headline">¶</a></h3>
<p>set_region_mappings &lt;index&gt;:&lt;path_nr&gt; [&lt;index&gt;]:&lt;path_nr&gt; [&lt;index&gt;]:&lt;path_nr&gt;…</p>
<p>Modify the region table by specifying which regions are redirected to
which paths.</p>
<dl class="simple">
<dt>&lt;index&gt;</dt><dd><p>The region number (region size was specified in constructor parameters).
If index is omitted, the next region (previous index + 1) is used.
Expressed in hexadecimal (WITHOUT any prefix like 0x).</p>
</dd>
<dt>&lt;path_nr&gt;</dt><dd><p>The path number in the range 0 … (&lt;num_paths&gt; - 1).
Expressed in hexadecimal (WITHOUT any prefix like 0x).</p>
</dd>
<dt>R&lt;n&gt;,&lt;m&gt;</dt><dd><p>This parameter allows repetitive patterns to be loaded quickly. &lt;n&gt; and &lt;m&gt;
are hexadecimal numbers. The last &lt;n&gt; mappings are repeated in the next &lt;m&gt;
slots.</p>
</dd>
</dl>
</div>
<div class="section" id="status">
<h3>Status<a class="headerlink" href="#status" title="Permalink to this headline">¶</a></h3>
<p>No status line is reported.</p>
</div>
<div class="section" id="example">
<h3>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h3>
<p>Assume that you have volumes vg1/switch0 vg1/switch1 vg1/switch2 with
the same size.</p>
<p>Create a switch device with 64kB region size:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>dmsetup create switch --table &quot;0 `blockdev --getsz /dev/vg1/switch0`
    switch 3 128 0 /dev/vg1/switch0 0 /dev/vg1/switch1 0 /dev/vg1/switch2 0&quot;
</pre></div>
</div>
<p>Set mappings for the first 7 entries to point to devices switch0, switch1,
switch2, switch0, switch1, switch2, switch1:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>dmsetup message switch 0 set_region_mappings 0:0 :1 :2 :0 :1 :2 :1
</pre></div>
</div>
<p>Set repetitive mapping. This command:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>dmsetup message switch 0 set_region_mappings 1000:1 :2 R2,10
</pre></div>
</div>
<p>is equivalent to:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>dmsetup message switch 0 set_region_mappings 1000:1 :2 :1 :2 :1 :2 :1 :2 \
    :1 :2 :1 :2 :1 :2 :1 :2 :1 :2
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright The kernel development community

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>