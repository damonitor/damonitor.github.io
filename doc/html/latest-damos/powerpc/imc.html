

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>IMC (In-Memory Collection Counters) &mdash; The Linux Kernel  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.7.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/mm/damon/index.html">Monitoring Data Accesses</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../vm/damon/index.html">DAMON: Data Access MONitor</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>IMC (In-Memory Collection Counters)</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/powerpc/imc.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="imc-in-memory-collection-counters">
<span id="imc"></span><h1><a class="toc-backref" href="#id1">IMC (In-Memory Collection Counters)</a><a class="headerlink" href="#imc-in-memory-collection-counters" title="Permalink to this headline">¶</a></h1>
<p>Anju T Sudhakar, 10 May 2019</p>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#imc-in-memory-collection-counters" id="id1">IMC (In-Memory Collection Counters)</a><ul>
<li><a class="reference internal" href="#basic-overview" id="id2">Basic overview</a></li>
<li><a class="reference internal" href="#imc-example-usage" id="id3">IMC example usage</a></li>
<li><a class="reference internal" href="#imc-trace-mode" id="id4">IMC Trace-mode</a><ul>
<li><a class="reference internal" href="#ldbar-register-layout" id="id5">LDBAR Register Layout</a></li>
<li><a class="reference internal" href="#trace-imc-scom-bit-representation" id="id6">TRACE_IMC_SCOM bit representation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#trace-imc-example-usage" id="id7">Trace IMC example usage</a></li>
<li><a class="reference internal" href="#benefits-of-using-imc-trace-mode" id="id8">Benefits of using IMC trace-mode</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="basic-overview">
<h2><a class="toc-backref" href="#id2">Basic overview</a><a class="headerlink" href="#basic-overview" title="Permalink to this headline">¶</a></h2>
<p>IMC (In-Memory collection counters) is a hardware monitoring facility that
collects large numbers of hardware performance events at Nest level (these are
on-chip but off-core), Core level and Thread level.</p>
<p>The Nest PMU counters are handled by a Nest IMC microcode which runs in the OCC
(On-Chip Controller) complex. The microcode collects the counter data and moves
the nest IMC counter data to memory.</p>
<p>The Core and Thread IMC PMU counters are handled in the core. Core level PMU
counters give us the IMC counters’ data per core and thread level PMU counters
give us the IMC counters’ data per CPU thread.</p>
<p>OPAL obtains the IMC PMU and supported events information from the IMC Catalog
and passes on to the kernel via the device tree. The event’s information
contains:</p>
<ul class="simple">
<li>Event name</li>
<li>Event Offset</li>
<li>Event description</li>
</ul>
<p>and possibly also:</p>
<ul class="simple">
<li>Event scale</li>
<li>Event unit</li>
</ul>
<p>Some PMUs may have a common scale and unit values for all their supported
events. For those cases, the scale and unit properties for those events must be
inherited from the PMU.</p>
<p>The event offset in the memory is where the counter data gets accumulated.</p>
<dl class="docutils">
<dt>IMC catalog is available at:</dt>
<dd><a class="reference external" href="https://github.com/open-power/ima-catalog">https://github.com/open-power/ima-catalog</a></dd>
</dl>
<p>The kernel discovers the IMC counters information in the device tree at the
<cite>imc-counters</cite> device node which has a compatible field
<cite>ibm,opal-in-memory-counters</cite>. From the device tree, the kernel parses the PMUs
and their event’s information and register the PMU and its attributes in the
kernel.</p>
</div>
<div class="section" id="imc-example-usage">
<h2><a class="toc-backref" href="#id3">IMC example usage</a><a class="headerlink" href="#imc-example-usage" title="Permalink to this headline">¶</a></h2>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># perf list</span>
<span class="o">[</span>...<span class="o">]</span>
nest_mcs01/PM_MCS01_64B_RD_DISP_PORT01/            <span class="o">[</span>Kernel PMU event<span class="o">]</span>
nest_mcs01/PM_MCS01_64B_RD_DISP_PORT23/            <span class="o">[</span>Kernel PMU event<span class="o">]</span>
<span class="o">[</span>...<span class="o">]</span>
core_imc/CPM_0THRD_NON_IDLE_PCYC/                  <span class="o">[</span>Kernel PMU event<span class="o">]</span>
core_imc/CPM_1THRD_NON_IDLE_INST/                  <span class="o">[</span>Kernel PMU event<span class="o">]</span>
<span class="o">[</span>...<span class="o">]</span>
thread_imc/CPM_0THRD_NON_IDLE_PCYC/                <span class="o">[</span>Kernel PMU event<span class="o">]</span>
thread_imc/CPM_1THRD_NON_IDLE_INST/                <span class="o">[</span>Kernel PMU event<span class="o">]</span>
</pre></div>
</div>
<p>To see per chip data for nest_mcs0/PM_MCS_DOWN_128B_DATA_XFER_MC0/:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># ./perf stat -e &quot;nest_mcs01/PM_MCS01_64B_WR_DISP_PORT01/&quot; -a --per-socket</span>
</pre></div>
</div>
<p>To see non-idle instructions for core 0:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># ./perf stat -e &quot;core_imc/CPM_NON_IDLE_INST/&quot; -C 0 -I 1000</span>
</pre></div>
</div>
<p>To see non-idle instructions for a “make”:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># ./perf stat -e &quot;thread_imc/CPM_NON_IDLE_PCYC/&quot; make</span>
</pre></div>
</div>
</div>
<div class="section" id="imc-trace-mode">
<h2><a class="toc-backref" href="#id4">IMC Trace-mode</a><a class="headerlink" href="#imc-trace-mode" title="Permalink to this headline">¶</a></h2>
<p>POWER9 supports two modes for IMC which are the Accumulation mode and Trace
mode. In Accumulation mode, event counts are accumulated in system Memory.
Hypervisor then reads the posted counts periodically or when requested. In IMC
Trace mode, the 64 bit trace SCOM value is initialized with the event
information. The CPMCxSEL and CPMC_LOAD in the trace SCOM, specifies the event
to be monitored and the sampling duration. On each overflow in the CPMCxSEL,
hardware snapshots the program counter along with event counts and writes into
memory pointed by LDBAR.</p>
<p>LDBAR is a 64 bit special purpose per thread register, it has bits to indicate
whether hardware is configured for accumulation or trace mode.</p>
<div class="section" id="ldbar-register-layout">
<h3><a class="toc-backref" href="#id5">LDBAR Register Layout</a><a class="headerlink" href="#ldbar-register-layout" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="24%" />
<col width="76%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>0</td>
<td>Enable/Disable</td>
</tr>
<tr class="row-even"><td rowspan="2">1</td>
<td>0: Accumulation Mode</td>
</tr>
<tr class="row-odd"><td>1: Trace Mode</td>
</tr>
<tr class="row-even"><td>2:3</td>
<td>Reserved</td>
</tr>
<tr class="row-odd"><td>4-6</td>
<td>PB scope</td>
</tr>
<tr class="row-even"><td>7</td>
<td>Reserved</td>
</tr>
<tr class="row-odd"><td>8:50</td>
<td>Counter Address</td>
</tr>
<tr class="row-even"><td>51:63</td>
<td>Reserved</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="trace-imc-scom-bit-representation">
<h3><a class="toc-backref" href="#id6">TRACE_IMC_SCOM bit representation</a><a class="headerlink" href="#trace-imc-scom-bit-representation" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="37%" />
<col width="63%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>0:1</td>
<td>SAMPSEL</td>
</tr>
<tr class="row-even"><td>2:33</td>
<td>CPMC_LOAD</td>
</tr>
<tr class="row-odd"><td>34:40</td>
<td>CPMC1SEL</td>
</tr>
<tr class="row-even"><td>41:47</td>
<td>CPMC2SEL</td>
</tr>
<tr class="row-odd"><td>48:50</td>
<td>BUFFERSIZE</td>
</tr>
<tr class="row-even"><td>51:63</td>
<td>RESERVED</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>CPMC_LOAD contains the sampling duration. SAMPSEL and CPMCxSEL determines the
event to count. BUFFERSIZE indicates the memory range. On each overflow,
hardware snapshots the program counter along with event counts and updates the
memory and reloads the CMPC_LOAD value for the next sampling duration. IMC
hardware does not support exceptions, so it quietly wraps around if memory
buffer reaches the end.</p>
<p><em>Currently the event monitored for trace-mode is fixed as cycle.</em></p>
</div>
</div>
<div class="section" id="trace-imc-example-usage">
<h2><a class="toc-backref" href="#id7">Trace IMC example usage</a><a class="headerlink" href="#trace-imc-example-usage" title="Permalink to this headline">¶</a></h2>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># perf list</span>
<span class="o">[</span>....<span class="o">]</span>
trace_imc/trace_cycles/                            <span class="o">[</span>Kernel PMU event<span class="o">]</span>
</pre></div>
</div>
<p>To record an application/process with trace-imc event:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># perf record -e trace_imc/trace_cycles/ yes &gt; /dev/null</span>
<span class="o">[</span> perf record: Woken up <span class="m">1</span> <span class="nb">times</span> to write data <span class="o">]</span>
<span class="o">[</span> perf record: Captured and wrote <span class="m">0</span>.012 MB perf.data <span class="o">(</span><span class="m">21</span> samples<span class="o">)</span> <span class="o">]</span>
</pre></div>
</div>
<p>The <cite>perf.data</cite> generated, can be read using perf report.</p>
</div>
<div class="section" id="benefits-of-using-imc-trace-mode">
<h2><a class="toc-backref" href="#id8">Benefits of using IMC trace-mode</a><a class="headerlink" href="#benefits-of-using-imc-trace-mode" title="Permalink to this headline">¶</a></h2>
<p>PMI (Performance Monitoring Interrupts) interrupt handling is avoided, since IMC
trace mode snapshots the program counter and updates to the memory. And this
also provide a way for the operating system to do instruction sampling in real
time without PMI processing overhead.</p>
<p>Performance data using <cite>perf top</cite> with and without trace-imc event.</p>
<p>PMI interrupts count when <cite>perf top</cite> command is executed without trace-imc event.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># grep PMI /proc/interrupts</span>
PMI:          <span class="m">0</span>          <span class="m">0</span>          <span class="m">0</span>          <span class="m">0</span>   Performance monitoring interrupts
<span class="c1"># ./perf top</span>
...
<span class="c1"># grep PMI /proc/interrupts</span>
PMI:      <span class="m">39735</span>       <span class="m">8710</span>      <span class="m">17338</span>      <span class="m">17801</span>   Performance monitoring interrupts
<span class="c1"># ./perf top -e trace_imc/trace_cycles/</span>
...
<span class="c1"># grep PMI /proc/interrupts</span>
PMI:      <span class="m">39735</span>       <span class="m">8710</span>      <span class="m">17338</span>      <span class="m">17801</span>   Performance monitoring interrupts
</pre></div>
</div>
<p>That is, the PMI interrupt counts do not increment when using the <cite>trace_imc</cite> event.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>