

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Linux Phonet protocol family &mdash; The Linux Kernel  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.8.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/mm/damon/index.html">Monitoring Data Accesses</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../vm/damon/index.html">DAMON: Data Access MONitor</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Linux Phonet protocol family</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/networking/phonet.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="linux-phonet-protocol-family">
<h1>Linux Phonet protocol family<a class="headerlink" href="#linux-phonet-protocol-family" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Phonet is a packet protocol used by Nokia cellular modems for both IPC
and RPC. With the Linux Phonet socket family, Linux host processes can
receive and send messages from/to the modem, or any other external
device attached to the modem. The modem takes care of routing.</p>
<p>Phonet packets can be exchanged through various hardware connections
depending on the device, such as:</p>
<blockquote>
<div><ul class="simple">
<li>USB with the CDC Phonet interface,</li>
<li>infrared,</li>
<li>Bluetooth,</li>
<li>an RS232 serial port (with a dedicated “FBUS” line discipline),</li>
<li>the SSI bus with some TI OMAP processors.</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="packets-format">
<h2>Packets format<a class="headerlink" href="#packets-format" title="Permalink to this headline">¶</a></h2>
<p>Phonet packets have a common header as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct phonethdr {
  uint8_t  pn_media;  /* Media type (link-layer identifier) */
  uint8_t  pn_rdev;   /* Receiver device ID */
  uint8_t  pn_sdev;   /* Sender device ID */
  uint8_t  pn_res;    /* Resource ID or function */
  uint16_t pn_length; /* Big-endian message byte length (minus 6) */
  uint8_t  pn_robj;   /* Receiver object ID */
  uint8_t  pn_sobj;   /* Sender object ID */
};
</pre></div>
</div>
<p>On Linux, the link-layer header includes the pn_media byte (see below).
The next 7 bytes are part of the network-layer header.</p>
<p>The device ID is split: the 6 higher-order bits constitute the device
address, while the 2 lower-order bits are used for multiplexing, as are
the 8-bit object identifiers. As such, Phonet can be considered as a
network layer with 6 bits of address space and 10 bits for transport
protocol (much like port numbers in IP world).</p>
<p>The modem always has address number zero. All other device have a their
own 6-bit address.</p>
</div>
<div class="section" id="link-layer">
<h2>Link layer<a class="headerlink" href="#link-layer" title="Permalink to this headline">¶</a></h2>
<p>Phonet links are always point-to-point links. The link layer header
consists of a single Phonet media type byte. It uniquely identifies the
link through which the packet is transmitted, from the modem’s
perspective. Each Phonet network device shall prepend and set the media
type byte as appropriate. For convenience, a common phonet_header_ops
link-layer header operations structure is provided. It sets the
media type according to the network device hardware address.</p>
<p>Linux Phonet network interfaces support a dedicated link layer packets
type (ETH_P_PHONET) which is out of the Ethernet type range. They can
only send and receive Phonet packets.</p>
<p>The virtual TUN tunnel device driver can also be used for Phonet. This
requires IFF_TUN mode, _without_ the IFF_NO_PI flag. In this case,
there is no link-layer header, so there is no Phonet media type byte.</p>
<p>Note that Phonet interfaces are not allowed to re-order packets, so
only the (default) Linux FIFO qdisc should be used with them.</p>
</div>
<div class="section" id="network-layer">
<h2>Network layer<a class="headerlink" href="#network-layer" title="Permalink to this headline">¶</a></h2>
<p>The Phonet socket address family maps the Phonet packet header:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct sockaddr_pn {
  sa_family_t spn_family;    /* AF_PHONET */
  uint8_t     spn_obj;       /* Object ID */
  uint8_t     spn_dev;       /* Device ID */
  uint8_t     spn_resource;  /* Resource or function */
  uint8_t     spn_zero[...]; /* Padding */
};
</pre></div>
</div>
<p>The resource field is only used when sending and receiving;
It is ignored by bind() and getsockname().</p>
</div>
<div class="section" id="low-level-datagram-protocol">
<h2>Low-level datagram protocol<a class="headerlink" href="#low-level-datagram-protocol" title="Permalink to this headline">¶</a></h2>
<p>Applications can send Phonet messages using the Phonet datagram socket
protocol from the PF_PHONET family. Each socket is bound to one of the
2^10 object IDs available, and can send and receive packets with any
other peer.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct sockaddr_pn addr = { .spn_family = AF_PHONET, };
ssize_t len;
socklen_t addrlen = sizeof(addr);
int fd;

fd = socket(PF_PHONET, SOCK_DGRAM, 0);
bind(fd, (struct sockaddr *)&amp;addr, sizeof(addr));
/* ... */

sendto(fd, msg, msglen, 0, (struct sockaddr *)&amp;addr, sizeof(addr));
len = recvfrom(fd, buf, sizeof(buf), 0,
               (struct sockaddr *)&amp;addr, &amp;addrlen);
</pre></div>
</div>
<p>This protocol follows the SOCK_DGRAM connection-less semantics.
However, connect() and getpeername() are not supported, as they did
not seem useful with Phonet usages (could be added easily).</p>
</div>
<div class="section" id="resource-subscription">
<h2>Resource subscription<a class="headerlink" href="#resource-subscription" title="Permalink to this headline">¶</a></h2>
<p>A Phonet datagram socket can be subscribed to any number of 8-bits
Phonet resources, as follow:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>uint32_t res = 0xXX;
ioctl(fd, SIOCPNADDRESOURCE, &amp;res);
</pre></div>
</div>
<p>Subscription is similarly cancelled using the SIOCPNDELRESOURCE I/O
control request, or when the socket is closed.</p>
<p>Note that no more than one socket can be subcribed to any given
resource at a time. If not, ioctl() will return EBUSY.</p>
</div>
<div class="section" id="phonet-pipe-protocol">
<h2>Phonet Pipe protocol<a class="headerlink" href="#phonet-pipe-protocol" title="Permalink to this headline">¶</a></h2>
<p>The Phonet Pipe protocol is a simple sequenced packets protocol
with end-to-end congestion control. It uses the passive listening
socket paradigm. The listening socket is bound to an unique free object
ID. Each listening socket can handle up to 255 simultaneous
connections, one per accept()’d socket.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>int lfd, cfd;

lfd = socket(PF_PHONET, SOCK_SEQPACKET, PN_PROTO_PIPE);
listen (lfd, INT_MAX);

/* ... */
cfd = accept(lfd, NULL, NULL);
for (;;)
{
  char buf[...];
  ssize_t len = read(cfd, buf, sizeof(buf));

  /* ... */

  write(cfd, msg, msglen);
}
</pre></div>
</div>
<p>Connections are traditionally established between two endpoints by a
“third party” application. This means that both endpoints are passive.</p>
<p>As of Linux kernel version 2.6.39, it is also possible to connect
two endpoints directly, using connect() on the active side. This is
intended to support the newer Nokia Wireless Modem API, as found in
e.g. the Nokia Slim Modem in the ST-Ericsson U8500 platform:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct sockaddr_spn spn;
int fd;

fd = socket(PF_PHONET, SOCK_SEQPACKET, PN_PROTO_PIPE);
memset(&amp;spn, 0, sizeof(spn));
spn.spn_family = AF_PHONET;
spn.spn_obj = ...;
spn.spn_dev = ...;
spn.spn_resource = 0xD9;
connect(fd, (struct sockaddr *)&amp;spn, sizeof(spn));
/* normal I/O here ... */
close(fd);
</pre></div>
</div>
<p>The pipe protocol provides two socket options at the SOL_PNPIPE level:</p>
<blockquote>
<div><p>PNPIPE_ENCAP accepts one integer value (int) of:</p>
<blockquote>
<div><dl class="docutils">
<dt>PNPIPE_ENCAP_NONE:</dt>
<dd>The socket operates normally (default).</dd>
<dt>PNPIPE_ENCAP_IP:</dt>
<dd>The socket is used as a backend for a virtual IP
interface. This requires CAP_NET_ADMIN capability. GPRS data
support on Nokia modems can use this. Note that the socket cannot
be reliably poll()’d or read() from while in this mode.</dd>
</dl>
</div></blockquote>
<dl class="docutils">
<dt>PNPIPE_IFINDEX</dt>
<dd>is a read-only integer value. It contains the
interface index of the network interface created by PNPIPE_ENCAP,
or zero if encapsulation is off.</dd>
<dt>PNPIPE_HANDLE</dt>
<dd>is a read-only integer value. It contains the underlying
identifier (“pipe handle”) of the pipe. This is only defined for
socket descriptors that are already connected or being connected.</dd>
</dl>
</div></blockquote>
</div>
<div class="section" id="authors">
<h2>Authors<a class="headerlink" href="#authors" title="Permalink to this headline">¶</a></h2>
<p>Linux Phonet was initially written by Sakari Ailus.</p>
<p>Other contributors include Mikä Liljeberg, Andras Domokos,
Carlos Chinea and Rémi Denis-Courmont.</p>
<p>Copyright © 2008 Nokia Corporation.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>