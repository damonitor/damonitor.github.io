

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>DAMON-based Reclamation &mdash; The Linux Kernel  documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="DAMON: Data Access MONitor" href="../../../vm/damon/index.html" />
    <link rel="prev" title="Detailed Usages" href="usage.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.13.0-rc5-mm1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Monitoring Data Accesses</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="start.html">Getting Started</a></li>
<li class="toctree-l2"><a class="reference internal" href="guide.html">Optimization Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="usage.html">Detailed Usages</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">DAMON-based Reclamation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#where-proactive-reclamation-is-required">Where Proactive Reclamation is Required?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-it-works">How It Works?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#interface-module-parameters">Interface: Module Parameters</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#enabled">enabled</a></li>
<li class="toctree-l4"><a class="reference internal" href="#min-age">min_age</a></li>
<li class="toctree-l4"><a class="reference internal" href="#limit-sz">limit_sz</a></li>
<li class="toctree-l4"><a class="reference internal" href="#limit-ms">limit_ms</a></li>
<li class="toctree-l4"><a class="reference internal" href="#wmarks-interval">wmarks_interval</a></li>
<li class="toctree-l4"><a class="reference internal" href="#wmarks-high">wmarks_high</a></li>
<li class="toctree-l4"><a class="reference internal" href="#wmarks-mid">wmarks_mid</a></li>
<li class="toctree-l4"><a class="reference internal" href="#wmarks-low">wmarks_low</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sample-interval">sample_interval</a></li>
<li class="toctree-l4"><a class="reference internal" href="#aggr-interval">aggr_interval</a></li>
<li class="toctree-l4"><a class="reference internal" href="#min-nr-regions">min_nr_regions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#max-nr-regions">max_nr_regions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#monitor-region-start">monitor_region_start</a></li>
<li class="toctree-l4"><a class="reference internal" href="#monitor-region-end">monitor_region_end</a></li>
<li class="toctree-l4"><a class="reference internal" href="#kdamond-pid">kdamond_pid</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#example">Example</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../vm/damon/index.html">DAMON: Data Access MONitor</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Monitoring Data Accesses</a> &raquo;</li>
        
      <li>DAMON-based Reclamation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/admin-guide/mm/damon/reclaim.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="damon-based-reclamation">
<h1>DAMON-based Reclamation<a class="headerlink" href="#damon-based-reclamation" title="Permalink to this headline">¶</a></h1>
<p>DAMON-based Reclamation (DAMON_RECLAIM) is a static kernel module that aimed to
be used for proactive and lightweight reclamation under light memory pressure.
It doesn’t aim to replace the LRU-list based page_granularity reclamation, but
to be selectively used for different level of memory pressure and requirements.</p>
<div class="section" id="where-proactive-reclamation-is-required">
<h2>Where Proactive Reclamation is Required?<a class="headerlink" href="#where-proactive-reclamation-is-required" title="Permalink to this headline">¶</a></h2>
<p>On general memory over-committed systems, proactively reclaiming cold pages
helps saving memory and reducing latency spikes that incurred by the direct
reclaim of the process or CPU consumption of kswapd, while incurring only
minimal performance degradation <a class="footnote-reference brackets" href="#id4" id="id1">1</a> <a class="footnote-reference brackets" href="#id5" id="id2">2</a> .</p>
<p>Free Pages Reporting <a class="footnote-reference brackets" href="#id6" id="id3">3</a> based memory over-commit virtualization systems are
good example of the cases.  In such systems, the guest VMs reports their free
memory to host, and the host reallocates the reported memory to other guests.
As a result, the memory of the systems are fully utilized.  However, the
guests could be not so memory-frugal, mainly because some kernel subsystems and
user-space applications are designed to use as much memory as available.  Then,
guests could report only small amount of memory as free to host, results in
memory utilization drop of the systems.  Running the proactive reclamation in
guests could mitigate this problem.</p>
</div>
<div class="section" id="how-it-works">
<h2>How It Works?<a class="headerlink" href="#how-it-works" title="Permalink to this headline">¶</a></h2>
<p>DAMON_RECLAIM finds memory regions that didn’t accessed for specific time
duration and page out.  To avoid it consuming too much CPU for the paging out
operation, a speed limit can be configured.  Under the speed limit, it pages
out memory regions that didn’t accessed longer time first.  System
administrators can also configure under what situation this scheme should
automatically activated and deactivated with three memory pressure watermarks.</p>
</div>
<div class="section" id="interface-module-parameters">
<h2>Interface: Module Parameters<a class="headerlink" href="#interface-module-parameters" title="Permalink to this headline">¶</a></h2>
<p>To use this feature, you should first ensure your system is running on a kernel
that is built with <code class="docutils literal notranslate"><span class="pre">CONFIG_DAMON_RECLAIM=y</span></code>.</p>
<p>To let sysadmins enable or disable it and tune for the given system,
DAMON_RECLAIM utilizes module parameters.  That is, you can put
<code class="docutils literal notranslate"><span class="pre">damon_reclaim.&lt;parameter&gt;=&lt;value&gt;</span></code> on the kernel boot command line or write
proper values to <code class="docutils literal notranslate"><span class="pre">/sys/modules/damon_reclaim/parameters/&lt;parameter&gt;</span></code> files.</p>
<p>Note that the parameter values except <code class="docutils literal notranslate"><span class="pre">enabled</span></code> are applied only when
DAMON_RECLAIM starts.  Therefore, if you want to apply new parameter values in
runtime and DAMON_RECLAIM is already enabled, you should disable and re-enable
it via <code class="docutils literal notranslate"><span class="pre">enabled</span></code> parameter file.  Writing of the new values to proper
parameter values should be done before the re-enablement.</p>
<p>Below are the description of each parameter.</p>
<div class="section" id="enabled">
<h3>enabled<a class="headerlink" href="#enabled" title="Permalink to this headline">¶</a></h3>
<p>Enable or disable DAMON_RECLAIM.</p>
<p>You can enable DAMON_RCLAIM by setting the value of this parameter as <code class="docutils literal notranslate"><span class="pre">Y</span></code>.
Setting it as <code class="docutils literal notranslate"><span class="pre">N</span></code> disables DAMON_RECLAIM.  Note that DAMON_RECLAIM could do
no real monitoring and reclamation due to the watermarks-based activation
condition.  Refer to below descriptions for the watermarks parameter for this.</p>
</div>
<div class="section" id="min-age">
<h3>min_age<a class="headerlink" href="#min-age" title="Permalink to this headline">¶</a></h3>
<p>Time threshold for cold memory regions identification in microseconds.</p>
<p>If a memory region is not accessed for this or longer time, DAMON_RECLAIM
identifies the region as cold, and reclaims it.</p>
</div>
<div class="section" id="limit-sz">
<h3>limit_sz<a class="headerlink" href="#limit-sz" title="Permalink to this headline">¶</a></h3>
<p>Maximum bytes of memory that can be reclaimed in a charging window.</p>
<p>DAMON_RECLAIM counts amount of memory which has reclaimed within current
charging time window and avoids reclaiming more than this limit in current time
window.  This could be useful for limiting CPU consumption of DAMON_RECLAIM.</p>
</div>
<div class="section" id="limit-ms">
<h3>limit_ms<a class="headerlink" href="#limit-ms" title="Permalink to this headline">¶</a></h3>
<p>The reclaimed memory charging window in milliseconds.</p>
</div>
<div class="section" id="wmarks-interval">
<h3>wmarks_interval<a class="headerlink" href="#wmarks-interval" title="Permalink to this headline">¶</a></h3>
<p>Minimal time to wait before checking the watermarks, when DAMON_RECLAIM is
enabled but inactive due to its watermarks rule.</p>
</div>
<div class="section" id="wmarks-high">
<h3>wmarks_high<a class="headerlink" href="#wmarks-high" title="Permalink to this headline">¶</a></h3>
<p>Free memory rate (per thousand) for the high watermark.</p>
<p>If free memory of the system in bytes per thousand bytes is higher than this,
DAMON_RECLAIM becomes inactive, so it does nothing but only periodically checks
the watermarks.</p>
</div>
<div class="section" id="wmarks-mid">
<h3>wmarks_mid<a class="headerlink" href="#wmarks-mid" title="Permalink to this headline">¶</a></h3>
<p>Free memory rate (per thousand) for the middle watermark.</p>
<p>If free memory of the system in bytes per thousand bytes is between this and
the low watermark, DAMON_RECLAIM becomes active, so starts the monitoring and
the reclaiming.</p>
</div>
<div class="section" id="wmarks-low">
<h3>wmarks_low<a class="headerlink" href="#wmarks-low" title="Permalink to this headline">¶</a></h3>
<p>Free memory rate (per thousand) for the low watermark.</p>
<p>If free memory of the system in bytes per thousand bytes is lower than this,
DAMON_RECLAIM becomes inactive, so it does nothing but periodically checks the
watermarks.  In the case, the system falls back to the LRU-list based page
granularity reclamation logic.</p>
</div>
<div class="section" id="sample-interval">
<h3>sample_interval<a class="headerlink" href="#sample-interval" title="Permalink to this headline">¶</a></h3>
<p>Sampling interval for the monitoring in microseconds.</p>
<p>The sampling interval of DAMON for the cold memory monitoring.  Please refer to
the DAMON documentation (<a class="reference internal" href="usage.html"><span class="doc">Detailed Usages</span></a>) for more detail.</p>
</div>
<div class="section" id="aggr-interval">
<h3>aggr_interval<a class="headerlink" href="#aggr-interval" title="Permalink to this headline">¶</a></h3>
<p>Aggregation interval for the monitoring in microseconds.</p>
<p>The aggregation interval of DAMON for the cold memory monitoring.  Please
refer to the DAMON documentation (<a class="reference internal" href="usage.html"><span class="doc">Detailed Usages</span></a>) for more detail.</p>
</div>
<div class="section" id="min-nr-regions">
<h3>min_nr_regions<a class="headerlink" href="#min-nr-regions" title="Permalink to this headline">¶</a></h3>
<p>Minimum number of monitoring regions.</p>
<p>The minimal number of monitoring regions of DAMON for the cold memory
monitoring.  This can be used to set lower-bound of the monitoring quality.
But, setting this too high could result in increased monitoring overhead.
Please refer to the DAMON documentation (<a class="reference internal" href="usage.html"><span class="doc">Detailed Usages</span></a>) for more detail.</p>
</div>
<div class="section" id="max-nr-regions">
<h3>max_nr_regions<a class="headerlink" href="#max-nr-regions" title="Permalink to this headline">¶</a></h3>
<p>Maximum number of monitoring regions.</p>
<p>The maximum number of monitoring regions of DAMON for the cold memory
monitoring.  This can be used to set upper-bound of the monitoring overhead.
However, setting this too low could result in bad monitoring quality.  Please
refer to the DAMON documentation (<a class="reference internal" href="usage.html"><span class="doc">Detailed Usages</span></a>) for more detail.</p>
</div>
<div class="section" id="monitor-region-start">
<h3>monitor_region_start<a class="headerlink" href="#monitor-region-start" title="Permalink to this headline">¶</a></h3>
<p>Start of target memory region in physical address.</p>
<p>The start physical address of memory region that DAMON_RECLAIM will do work
against.  That is, DAMON_RECLAIM will find cold memory regions in this region
and reclaims.  By default, biggest System RAM is used as the region.</p>
</div>
<div class="section" id="monitor-region-end">
<h3>monitor_region_end<a class="headerlink" href="#monitor-region-end" title="Permalink to this headline">¶</a></h3>
<p>End of target memory region in physical address.</p>
<p>The end physical address of memory region that DAMON_RECLAIM will do work
against.  That is, DAMON_RECLAIM will find cold memory regions in this region
and reclaims.  By default, biggest System RAM is used as the region.</p>
</div>
<div class="section" id="kdamond-pid">
<h3>kdamond_pid<a class="headerlink" href="#kdamond-pid" title="Permalink to this headline">¶</a></h3>
<p>PID of the DAMON thread.</p>
<p>If DAMON_RECLAIM is enabled, this becomes the PID of the worker thread.  Else,
-1.</p>
</div>
</div>
<div class="section" id="example">
<h2>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h2>
<p>Below runtime example commands make DAMON_RECLAIM to find memory regions that
not accessed for 30 seconds or more and pages out.  The reclamation is limited
to be done only up to 1 GiB per second to avoid DAMON_RECLAIM consuming too
much CPU time for the paging out operation.  It also asks DAMON_RECLAIM to do
nothing if the system’s free memory rate is more than 50%, but start the real
works if it becomes lower than 40%.  If DAMON_RECLAIM doesn’t make progress and
therefore the free memory rate becomes lower than 20%, it asks DAMON_RECLAIM to
do nothing again, so that we can fall back to the LRU-list based page
granularity reclamation.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># cd /sys/modules/damon_reclaim/parameters
# echo 30000000 &gt; min_age
# echo $((1 * 1024 * 1024 * 1024)) &gt; limit_sz
# echo 1000 &gt; limit_ms
# echo 500 &gt; wmarks_high
# echo 400 &gt; wmarks_mid
# echo 200 &gt; wmarks_low
# echo Y &gt; enabled
</pre></div>
</div>
<dl class="footnote brackets">
<dt class="label" id="id4"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p><a class="reference external" href="https://research.google/pubs/pub48551/">https://research.google/pubs/pub48551/</a></p>
</dd>
<dt class="label" id="id5"><span class="brackets"><a class="fn-backref" href="#id2">2</a></span></dt>
<dd><p><a class="reference external" href="https://lwn.net/Articles/787611/">https://lwn.net/Articles/787611/</a></p>
</dd>
<dt class="label" id="id6"><span class="brackets"><a class="fn-backref" href="#id3">3</a></span></dt>
<dd><p><a class="reference external" href="https://www.kernel.org/doc/html/latest/vm/free_page_reporting.html">https://www.kernel.org/doc/html/latest/vm/free_page_reporting.html</a></p>
</dd>
</dl>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../../vm/damon/index.html" class="btn btn-neutral float-right" title="DAMON: Data Access MONitor" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="usage.html" class="btn btn-neutral float-left" title="Detailed Usages" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright The kernel development community

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>