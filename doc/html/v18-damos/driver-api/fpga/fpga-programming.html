

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>In-kernel API for FPGA Programming &mdash; The Linux Kernel  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.7.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/mm/damon/index.html">Monitoring Data Accesses</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../vm/damon/index.html">DAMON: Data Access MONitor</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>In-kernel API for FPGA Programming</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/driver-api/fpga/fpga-programming.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="in-kernel-api-for-fpga-programming">
<h1>In-kernel API for FPGA Programming<a class="headerlink" href="#in-kernel-api-for-fpga-programming" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>The in-kernel API for FPGA programming is a combination of APIs from
FPGA manager, bridge, and regions.  The actual function used to
trigger FPGA programming is <a class="reference internal" href="#c.fpga_region_program_fpga" title="fpga_region_program_fpga"><code class="xref c c-func docutils literal notranslate"><span class="pre">fpga_region_program_fpga()</span></code></a>.</p>
<p><a class="reference internal" href="#c.fpga_region_program_fpga" title="fpga_region_program_fpga"><code class="xref c c-func docutils literal notranslate"><span class="pre">fpga_region_program_fpga()</span></code></a> uses functionality supplied by
the FPGA manager and bridges.  It will:</p>
<blockquote>
<div><ul class="simple">
<li>lock the region’s mutex</li>
<li>lock the mutex of the region’s FPGA manager</li>
<li>build a list of FPGA bridges if a method has been specified to do so</li>
<li>disable the bridges</li>
<li>program the FPGA using info passed in <code class="xref c c-member docutils literal notranslate"><span class="pre">fpga_region-&gt;info</span></code>.</li>
<li>re-enable the bridges</li>
<li>release the locks</li>
</ul>
</div></blockquote>
<p>The struct fpga_image_info specifies what FPGA image to program.  It is
allocated/freed by <a class="reference internal" href="#c.fpga_image_info_alloc" title="fpga_image_info_alloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">fpga_image_info_alloc()</span></code></a> and freed with
<a class="reference internal" href="#c.fpga_image_info_free" title="fpga_image_info_free"><code class="xref c c-func docutils literal notranslate"><span class="pre">fpga_image_info_free()</span></code></a></p>
</div>
<div class="section" id="how-to-program-an-fpga-using-a-region">
<h2>How to program an FPGA using a region<a class="headerlink" href="#how-to-program-an-fpga-using-a-region" title="Permalink to this headline">¶</a></h2>
<p>When the FPGA region driver probed, it was given a pointer to an FPGA manager
driver so it knows which manager to use.  The region also either has a list of
bridges to control during programming or it has a pointer to a function that
will generate that list.  Here’s some sample code of what to do next:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#include &lt;linux/fpga/fpga-mgr.h&gt;
#include &lt;linux/fpga/fpga-region.h&gt;

struct fpga_image_info *info;
int ret;

/*
 * First, alloc the struct with information about the FPGA image to
 * program.
 */
info = fpga_image_info_alloc(dev);
if (!info)
        return -ENOMEM;

/* Set flags as needed, such as: */
info-&gt;flags = FPGA_MGR_PARTIAL_RECONFIG;

/*
 * Indicate where the FPGA image is. This is pseudo-code; you&#39;re
 * going to use one of these three.
 */
if (image is in a scatter gather table) {

        info-&gt;sgt = [your scatter gather table]

} else if (image is in a buffer) {

        info-&gt;buf = [your image buffer]
        info-&gt;count = [image buffer size]

} else if (image is in a firmware file) {

        info-&gt;firmware_name = devm_kstrdup(dev, firmware_name,
                                           GFP_KERNEL);

}

/* Add info to region and do the programming */
region-&gt;info = info;
ret = fpga_region_program_fpga(region);

/* Deallocate the image info if you&#39;re done with it */
region-&gt;info = NULL;
fpga_image_info_free(info);

if (ret)
        return ret;

/* Now enumerate whatever hardware has appeared in the FPGA. */
</pre></div>
</div>
</div>
<div class="section" id="api-for-programming-an-fpga">
<h2>API for programming an FPGA<a class="headerlink" href="#api-for-programming-an-fpga" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference internal" href="#c.fpga_region_program_fpga" title="fpga_region_program_fpga"><code class="xref c c-func docutils literal notranslate"><span class="pre">fpga_region_program_fpga()</span></code></a> —  Program an FPGA</li>
<li><a class="reference internal" href="#c.fpga_image_info" title="fpga_image_info"><code class="xref c c-type docutils literal notranslate"><span class="pre">fpga_image_info</span></code></a> —  Specifies what FPGA image to program</li>
<li><a class="reference internal" href="#c.fpga_image_info_alloc" title="fpga_image_info_alloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">fpga_image_info_alloc()</span></code></a> —  Allocate an FPGA image info struct</li>
<li><a class="reference internal" href="#c.fpga_image_info_free" title="fpga_image_info_free"><code class="xref c c-func docutils literal notranslate"><span class="pre">fpga_image_info_free()</span></code></a> —  Free an FPGA image info struct</li>
</ul>
<dl class="function">
<dt id="c.fpga_region_program_fpga">
int <code class="descname">fpga_region_program_fpga</code><span class="sig-paren">(</span>struct <a class="reference internal" href="fpga-region.html#c.fpga_region" title="fpga_region">fpga_region</a> *<em>&nbsp;region</em><span class="sig-paren">)</span><a class="headerlink" href="#c.fpga_region_program_fpga" title="Permalink to this definition">¶</a></dt>
<dd><p>program FPGA</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">fpga_region</span> <span class="pre">*</span> <span class="pre">region</span></code></dt>
<dd>FPGA region</dd>
</dl>
<p><strong>Description</strong></p>
<p>Program an FPGA using fpga image info (region-&gt;info).
If the region has a get_bridges function, the exclusive reference for the
bridges will be held if programming succeeds.  This is intended to prevent
reprogramming the region until the caller considers it safe to do so.
The caller will need to call <a class="reference internal" href="fpga-region.html#c.fpga_bridges_put" title="fpga_bridges_put"><code class="xref c c-func docutils literal notranslate"><span class="pre">fpga_bridges_put()</span></code></a> before attempting to
reprogram the region.</p>
<p>Return 0 for success or negative error code.</p>
<p>FPGA Manager flags</p>
<p>Flags used in the <a class="reference internal" href="#c.fpga_image_info" title="fpga_image_info"><code class="xref c c-type docutils literal notranslate"><span class="pre">fpga_image_info-&gt;flags</span></code></a> field</p>
<p><code class="docutils literal notranslate"><span class="pre">FPGA_MGR_PARTIAL_RECONFIG</span></code>: do partial reconfiguration if supported</p>
<p><code class="docutils literal notranslate"><span class="pre">FPGA_MGR_EXTERNAL_CONFIG</span></code>: FPGA has been configured prior to Linux booting</p>
<p><code class="docutils literal notranslate"><span class="pre">FPGA_MGR_ENCRYPTED_BITSTREAM</span></code>: indicates bitstream is encrypted</p>
<p><code class="docutils literal notranslate"><span class="pre">FPGA_MGR_BITSTREAM_LSB_FIRST</span></code>: SPI bitstream bit order is LSB first</p>
<p><code class="docutils literal notranslate"><span class="pre">FPGA_MGR_COMPRESSED_BITSTREAM</span></code>: FPGA bitstream is compressed</p>
<dl class="type">
<dt id="c.fpga_image_info">
struct <code class="descname">fpga_image_info</code><a class="headerlink" href="#c.fpga_image_info" title="Permalink to this definition">¶</a></dt>
<dd><p>information specific to a FPGA image</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct fpga_image_info {
  u32 flags;
  u32 enable_timeout_us;
  u32 disable_timeout_us;
  u32 config_complete_timeout_us;
  char *firmware_name;
  struct sg_table *sgt;
  const char *buf;
  size_t count;
  int region_id;
  struct device *dev;
#ifdef CONFIG_OF;
  struct device_node *overlay;
#endif;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">flags</span></code></dt>
<dd>boolean flags as defined above</dd>
<dt><code class="docutils literal notranslate"><span class="pre">enable_timeout_us</span></code></dt>
<dd>maximum time to enable traffic through bridge (uSec)</dd>
<dt><code class="docutils literal notranslate"><span class="pre">disable_timeout_us</span></code></dt>
<dd>maximum time to disable traffic through bridge (uSec)</dd>
<dt><code class="docutils literal notranslate"><span class="pre">config_complete_timeout_us</span></code></dt>
<dd>maximum time for FPGA to switch to operating
status in the write_complete op.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">firmware_name</span></code></dt>
<dd>name of FPGA image firmware file</dd>
<dt><code class="docutils literal notranslate"><span class="pre">sgt</span></code></dt>
<dd>scatter/gather table containing FPGA image</dd>
<dt><code class="docutils literal notranslate"><span class="pre">buf</span></code></dt>
<dd>contiguous buffer containing FPGA image</dd>
<dt><code class="docutils literal notranslate"><span class="pre">count</span></code></dt>
<dd>size of buf</dd>
<dt><code class="docutils literal notranslate"><span class="pre">region_id</span></code></dt>
<dd>id of target region</dd>
<dt><code class="docutils literal notranslate"><span class="pre">dev</span></code></dt>
<dd>device that owns this</dd>
<dt><code class="docutils literal notranslate"><span class="pre">overlay</span></code></dt>
<dd>Device Tree overlay</dd>
</dl>
<dl class="function">
<dt id="c.fpga_image_info_alloc">
struct <a class="reference internal" href="#c.fpga_image_info" title="fpga_image_info">fpga_image_info</a> * <code class="descname">fpga_image_info_alloc</code><span class="sig-paren">(</span>struct <a class="reference internal" href="../infrastructure.html#c.device" title="device">device</a> *<em>&nbsp;dev</em><span class="sig-paren">)</span><a class="headerlink" href="#c.fpga_image_info_alloc" title="Permalink to this definition">¶</a></dt>
<dd><p>Allocate a FPGA image info struct</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">device</span> <span class="pre">*</span> <span class="pre">dev</span></code></dt>
<dd>owning device</dd>
</dl>
<p><strong>Return</strong></p>
<p>struct fpga_image_info or NULL</p>
<dl class="function">
<dt id="c.fpga_image_info_free">
void <code class="descname">fpga_image_info_free</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.fpga_image_info" title="fpga_image_info">fpga_image_info</a> *<em>&nbsp;info</em><span class="sig-paren">)</span><a class="headerlink" href="#c.fpga_image_info_free" title="Permalink to this definition">¶</a></dt>
<dd><p>Free a FPGA image info struct</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">fpga_image_info</span> <span class="pre">*</span> <span class="pre">info</span></code></dt>
<dd>FPGA image info struct to free</dd>
</dl>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>