

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Mandatory File Locking For The Linux Operating System &mdash; The Linux Kernel  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.8.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/mm/damon/index.html">Monitoring Data Accesses</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../vm/damon/index.html">DAMON: Data Access MONitor</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Mandatory File Locking For The Linux Operating System</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/filesystems/mandatory-locking.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="mandatory-file-locking-for-the-linux-operating-system">
<h1>Mandatory File Locking For The Linux Operating System<a class="headerlink" href="#mandatory-file-locking-for-the-linux-operating-system" title="Permalink to this headline">¶</a></h1>
<blockquote>
<div><p>Andy Walker &lt;<a class="reference external" href="mailto:andy&#37;&#52;&#48;lysaker&#46;kvaerner&#46;no">andy<span>&#64;</span>lysaker<span>&#46;</span>kvaerner<span>&#46;</span>no</a>&gt;</p>
<blockquote>
<div><blockquote>
<div>15 April 1996</div></blockquote>
<p>(Updated September 2007)</p>
</div></blockquote>
</div></blockquote>
<div class="section" id="why-you-should-avoid-mandatory-locking">
<h2>0. Why you should avoid mandatory locking<a class="headerlink" href="#why-you-should-avoid-mandatory-locking" title="Permalink to this headline">¶</a></h2>
<p>The Linux implementation is prey to a number of difficult-to-fix race
conditions which in practice make it not dependable:</p>
<blockquote>
<div><ul class="simple">
<li>The write system call checks for a mandatory lock only once
at its start.  It is therefore possible for a lock request to
be granted after this check but before the data is modified.
A process may then see file data change even while a mandatory
lock was held.</li>
<li>Similarly, an exclusive lock may be granted on a file after
the kernel has decided to proceed with a read, but before the
read has actually completed, and the reading process may see
the file data in a state which should not have been visible
to it.</li>
<li>Similar races make the claimed mutual exclusion between lock
and mmap similarly unreliable.</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="what-is-mandatory-locking">
<h2>1. What is  mandatory locking?<a class="headerlink" href="#what-is-mandatory-locking" title="Permalink to this headline">¶</a></h2>
<p>Mandatory locking is kernel enforced file locking, as opposed to the more usual
cooperative file locking used to guarantee sequential access to files among
processes. File locks are applied using the flock() and fcntl() system calls
(and the lockf() library routine which is a wrapper around fcntl().) It is
normally a process’ responsibility to check for locks on a file it wishes to
update, before applying its own lock, updating the file and unlocking it again.
The most commonly used example of this (and in the case of sendmail, the most
troublesome) is access to a user’s mailbox. The mail user agent and the mail
transfer agent must guard against updating the mailbox at the same time, and
prevent reading the mailbox while it is being updated.</p>
<p>In a perfect world all processes would use and honour a cooperative, or
“advisory” locking scheme. However, the world isn’t perfect, and there’s
a lot of poorly written code out there.</p>
<p>In trying to address this problem, the designers of System V UNIX came up
with a “mandatory” locking scheme, whereby the operating system kernel would
block attempts by a process to write to a file that another process holds a
“read” -or- “shared” lock on, and block attempts to both read and write to a
file that a process holds a “write ” -or- “exclusive” lock on.</p>
<p>The System V mandatory locking scheme was intended to have as little impact as
possible on existing user code. The scheme is based on marking individual files
as candidates for mandatory locking, and using the existing fcntl()/lockf()
interface for applying locks just as if they were normal, advisory locks.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<ol class="last arabic simple">
<li>In saying “file” in the paragraphs above I am actually not telling
the whole truth. System V locking is based on fcntl(). The granularity of
fcntl() is such that it allows the locking of byte ranges in files, in
addition to entire files, so the mandatory locking rules also have byte
level granularity.</li>
<li>POSIX.1 does not specify any scheme for mandatory locking, despite
borrowing the fcntl() locking scheme from System V. The mandatory locking
scheme is defined by the System V Interface Definition (SVID) Version 3.</li>
</ol>
</div>
</div>
<div class="section" id="marking-a-file-for-mandatory-locking">
<h2>2. Marking a file for mandatory locking<a class="headerlink" href="#marking-a-file-for-mandatory-locking" title="Permalink to this headline">¶</a></h2>
<p>A file is marked as a candidate for mandatory locking by setting the group-id
bit in its file mode but removing the group-execute bit. This is an otherwise
meaningless combination, and was chosen by the System V implementors so as not
to break existing user programs.</p>
<p>Note that the group-id bit is usually automatically cleared by the kernel when
a setgid file is written to. This is a security measure. The kernel has been
modified to recognize the special case of a mandatory lock candidate and to
refrain from clearing this bit. Similarly the kernel has been modified not
to run mandatory lock candidates with setgid privileges.</p>
</div>
<div class="section" id="available-implementations">
<h2>3. Available implementations<a class="headerlink" href="#available-implementations" title="Permalink to this headline">¶</a></h2>
<p>I have considered the implementations of mandatory locking available with
SunOS 4.1.x, Solaris 2.x and HP-UX 9.x.</p>
<p>Generally I have tried to make the most sense out of the behaviour exhibited
by these three reference systems. There are many anomalies.</p>
<p>All the reference systems reject all calls to open() for a file on which
another process has outstanding mandatory locks. This is in direct
contravention of SVID 3, which states that only calls to open() with the
O_TRUNC flag set should be rejected. The Linux implementation follows the SVID
definition, which is the “Right Thing”, since only calls with O_TRUNC can
modify the contents of the file.</p>
<p>HP-UX even disallows open() with O_TRUNC for a file with advisory locks, not
just mandatory locks. That would appear to contravene POSIX.1.</p>
<p>mmap() is another interesting case. All the operating systems mentioned
prevent mandatory locks from being applied to an mmap()’ed file, but  HP-UX
also disallows advisory locks for such a file. SVID actually specifies the
paranoid HP-UX behaviour.</p>
<p>In my opinion only MAP_SHARED mappings should be immune from locking, and then
only from mandatory locks - that is what is currently implemented.</p>
<p>SunOS is so hopeless that it doesn’t even honour the O_NONBLOCK flag for
mandatory locks, so reads and writes to locked files always block when they
should return EAGAIN.</p>
<p>I’m afraid that this is such an esoteric area that the semantics described
below are just as valid as any others, so long as the main points seem to
agree.</p>
</div>
<div class="section" id="semantics">
<h2>4. Semantics<a class="headerlink" href="#semantics" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>Mandatory locks can only be applied via the fcntl()/lockf() locking
interface - in other words the System V/POSIX interface. BSD style
locks using flock() never result in a mandatory lock.</li>
<li>If a process has locked a region of a file with a mandatory read lock, then
other processes are permitted to read from that region. If any of these
processes attempts to write to the region it will block until the lock is
released, unless the process has opened the file with the O_NONBLOCK
flag in which case the system call will return immediately with the error
status EAGAIN.</li>
<li>If a process has locked a region of a file with a mandatory write lock, all
attempts to read or write to that region block until the lock is released,
unless a process has opened the file with the O_NONBLOCK flag in which case
the system call will return immediately with the error status EAGAIN.</li>
<li>Calls to open() with O_TRUNC, or to creat(), on a existing file that has
any mandatory locks owned by other processes will be rejected with the
error status EAGAIN.</li>
<li>Attempts to apply a mandatory lock to a file that is memory mapped and
shared (via mmap() with MAP_SHARED) will be rejected with the error status
EAGAIN.</li>
<li>Attempts to create a shared memory map of a file (via mmap() with MAP_SHARED)
that has any mandatory locks in effect will be rejected with the error status
EAGAIN.</li>
</ol>
</div>
<div class="section" id="which-system-calls-are-affected">
<h2>5. Which system calls are affected?<a class="headerlink" href="#which-system-calls-are-affected" title="Permalink to this headline">¶</a></h2>
<p>Those which modify a file’s contents, not just the inode. That gives read(),
write(), readv(), writev(), open(), creat(), mmap(), truncate() and
ftruncate(). truncate() and ftruncate() are considered to be “write” actions
for the purposes of mandatory locking.</p>
<p>The affected region is usually defined as stretching from the current position
for the total number of bytes read or written. For the truncate calls it is
defined as the bytes of a file removed or added (we must also consider bytes
added, as a lock can specify just “the whole file”, rather than a specific
range of bytes.)</p>
<p>Note 3: I may have overlooked some system calls that need mandatory lock
checking in my eagerness to get this code out the door. Please let me know, or
better still fix the system calls yourself and submit a patch to me or Linus.</p>
</div>
<div class="section" id="warning">
<h2>6. Warning!<a class="headerlink" href="#warning" title="Permalink to this headline">¶</a></h2>
<p>Not even root can override a mandatory lock, so runaway processes can wreak
havoc if they lock crucial files. The way around it is to change the file
permissions (remove the setgid bit) before trying to read or write to it.
Of course, that might be a bit tricky if the system is hung :-(</p>
</div>
<div class="section" id="the-mand-mount-option">
<h2>7. The “mand” mount option<a class="headerlink" href="#the-mand-mount-option" title="Permalink to this headline">¶</a></h2>
<p>Mandatory locking is disabled on all filesystems by default, and must be
administratively enabled by mounting with “-o mand”. That mount option
is only allowed if the mounting task has the CAP_SYS_ADMIN capability.</p>
<p>Since kernel v4.5, it is possible to disable mandatory locking
altogether by setting CONFIG_MANDATORY_FILE_LOCKING to “n”. A kernel
with this disabled will reject attempts to mount filesystems with the
“mand” mount option with the error status EPERM.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>