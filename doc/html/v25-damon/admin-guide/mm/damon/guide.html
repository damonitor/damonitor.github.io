

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Optimization Guide &mdash; The Linux Kernel  documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Detailed Usages" href="usage.html" />
    <link rel="prev" title="Getting Started" href="start.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.12.0-rc3-mm1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Monitoring Data Accesses</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="start.html">Getting Started</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Optimization Guide</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#check-the-signs">Check The Signs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#profile">Profile</a></li>
<li class="toctree-l3"><a class="reference internal" href="#optimize">Optimize</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#memory-configuration">Memory Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#program-modification">Program Modification</a></li>
<li class="toctree-l4"><a class="reference internal" href="#personalized-damon-application">Personalized DAMON Application</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#reference-practices">Reference Practices</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="usage.html">Detailed Usages</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../vm/damon/index.html">DAMON: Data Access MONitor</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Monitoring Data Accesses</a> &raquo;</li>
        
      <li>Optimization Guide</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/admin-guide/mm/damon/guide.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="optimization-guide">
<h1>Optimization Guide<a class="headerlink" href="#optimization-guide" title="Permalink to this headline">¶</a></h1>
<p>This document helps you estimating the amount of benefit that you could get
from DAMON-based optimizations, and describes how you could achieve it.  You
are assumed to already read <a class="reference internal" href="start.html"><span class="doc">Getting Started</span></a>.</p>
<div class="section" id="check-the-signs">
<h2>Check The Signs<a class="headerlink" href="#check-the-signs" title="Permalink to this headline">¶</a></h2>
<p>No optimization can provide same extent of benefit to every case.  Therefore
you should first guess how much improvements you could get using DAMON.  If
some of below conditions match your situation, you could consider using DAMON.</p>
<ul class="simple">
<li><p><em>Low IPC and High Cache Miss Ratios.</em>  Low IPC means most of the CPU time is
spent waiting for the completion of time-consuming operations such as memory
access, while high cache miss ratios mean the caches don’t help it well.
DAMON is not for cache level optimization, but DRAM level.  However,
improving DRAM management will also help this case by reducing the memory
operation latency.</p></li>
<li><p><em>Memory Over-commitment and Unknown Users.</em>  If you are doing memory
overcommitment and you cannot control every user of your system, a memory
bank run could happen at any time.  You can estimate when it will happen
based on DAMON’s monitoring results and act earlier to avoid or deal better
with the crisis.</p></li>
<li><p><em>Frequent Memory Pressure.</em>  Frequent memory pressure means your system has
wrong configurations or memory hogs.  DAMON will help you find the right
configuration and/or the criminals.</p></li>
<li><p><em>Heterogeneous Memory System.</em>  If your system is utilizing memory devices
that placed between DRAM and traditional hard disks, such as non-volatile
memory or fast SSDs, DAMON could help you utilizing the devices more
efficiently.</p></li>
</ul>
</div>
<div class="section" id="profile">
<h2>Profile<a class="headerlink" href="#profile" title="Permalink to this headline">¶</a></h2>
<p>If you found some positive signals, you could start by profiling your workloads
using DAMON.  Find major workloads on your systems and analyze their data
access pattern to find something wrong or can be improved.  The DAMON user
space tool (<code class="docutils literal notranslate"><span class="pre">damo</span></code>) will be useful for this.  You can get <code class="docutils literal notranslate"><span class="pre">damo</span></code> from
<code class="docutils literal notranslate"><span class="pre">tools/damon/</span></code> directory in the DAMON development tree (<code class="docutils literal notranslate"><span class="pre">damon/master</span></code>
branch of <a class="reference external" href="https://github.com/sjp38/linux.git">https://github.com/sjp38/linux.git</a>).</p>
<p>We recommend you to start from working set size distribution check using <code class="docutils literal notranslate"><span class="pre">damo</span>
<span class="pre">report</span> <span class="pre">wss</span></code>.  If the distribution is ununiform or quite different from what
you estimated, you could consider <a class="reference internal" href="#memory-configuration">Memory Configuration</a> optimization.</p>
<p>Then, review the overall access pattern in heatmap form using <code class="docutils literal notranslate"><span class="pre">damo</span> <span class="pre">report</span>
<span class="pre">heats</span></code>.  If it shows a simple pattern consists of a small number of memory
regions having high contrast of access temperature, you could consider manual
<a class="reference internal" href="#program-modification">Program Modification</a>.</p>
<p>If you still want to absorb more benefits, you should develop <a class="reference internal" href="#personalized-damon-application">Personalized
DAMON Application</a> for your special case.</p>
<p>You don’t need to take only one approach among the above plans, but you could
use multiple of the above approaches to maximize the benefit.</p>
</div>
<div class="section" id="optimize">
<h2>Optimize<a class="headerlink" href="#optimize" title="Permalink to this headline">¶</a></h2>
<p>If the profiling result also says it’s worth trying some optimization, you
could consider below approaches.  Note that some of the below approaches assume
that your systems are configured with swap devices or other types of auxiliary
memory so that you don’t strictly required to accommodate the whole working set
in the main memory.  Most of the detailed optimization should be made on your
concrete understanding of your memory devices.</p>
<div class="section" id="memory-configuration">
<h3>Memory Configuration<a class="headerlink" href="#memory-configuration" title="Permalink to this headline">¶</a></h3>
<p>No more no less, DRAM should be large enough to accommodate only important
working sets, because DRAM is highly performance critical but expensive and
heavily consumes the power.  However, knowing the size of the real important
working sets is difficult.  As a consequence, people usually equips
unnecessarily large or too small DRAM.  Many problems stem from such wrong
configurations.</p>
<p>Using the working set size distribution report provided by <code class="docutils literal notranslate"><span class="pre">damo</span> <span class="pre">report</span> <span class="pre">wss</span></code>,
you can know the appropriate DRAM size for you.  For example, roughly speaking,
if you worry about only 95 percentile latency, you don’t need to equip DRAM of
a size larger than 95 percentile working set size.</p>
<p>Let’s see a real example.  Below are the heatmap and the working set size
distributions/changes of <code class="docutils literal notranslate"><span class="pre">freqmine</span></code> workload in PARSEC3 benchmark suite.  The
working set size spikes up to 180 MiB, but keeps smaller than 50 MiB for more
than 95% of the time.  Even though you give only 50 MiB of memory space to the
workload, it will work well for 95% of the time.  Meanwhile, you can save the
130 MiB of memory space.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><div class="figure align-center" id="id12">
<img alt="the access pattern in heatmap format" src="../../../_images/freqmine_heatmap.png" />
<p class="caption"><span class="caption-text">The access pattern in heatmap format.</span><a class="headerlink" href="#id12" title="Permalink to this image">¶</a></p>
</div>
</td>
<td><div class="figure align-center" id="id13">
<img alt="the distribution of working set size" src="../../../_images/freqmine_wss_sz.png" />
<p class="caption"><span class="caption-text">The distribution of working set size.</span><a class="headerlink" href="#id13" title="Permalink to this image">¶</a></p>
</div>
</td>
<td><div class="figure align-center" id="id14">
<img alt="the chronological changes of working set size" src="../../../_images/freqmine_wss_time.png" />
<p class="caption"><span class="caption-text">The chronological changes of working set size.</span><a class="headerlink" href="#id14" title="Permalink to this image">¶</a></p>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="program-modification">
<h3>Program Modification<a class="headerlink" href="#program-modification" title="Permalink to this headline">¶</a></h3>
<p>If the data access pattern heatmap plotted by <code class="docutils literal notranslate"><span class="pre">damo</span> <span class="pre">report</span> <span class="pre">heats</span></code> is quite
simple so that you can understand how the things are going in the workload with
your human eye, you could manually optimize the memory management.</p>
<p>For example, suppose that the workload has two big memory object but only one
object is frequently accessed while the other one is only occasionally
accessed.  Then, you could modify the program source code to keep the hot
object in the main memory by invoking <code class="docutils literal notranslate"><span class="pre">mlock()</span></code> or <code class="docutils literal notranslate"><span class="pre">madvise()</span></code> with
<code class="docutils literal notranslate"><span class="pre">MADV_WILLNEED</span></code>.  Or, you could proactively evict the cold object using
<code class="docutils literal notranslate"><span class="pre">madvise()</span></code> with <code class="docutils literal notranslate"><span class="pre">MADV_COLD</span></code> or <code class="docutils literal notranslate"><span class="pre">MADV_PAGEOUT</span></code>.  Using both together
would be also worthy.</p>
<p>A research work <a class="footnote-reference brackets" href="#id7" id="id1">1</a> using the <code class="docutils literal notranslate"><span class="pre">mlock()</span></code> achieved up to 2.55x performance
speedup.</p>
<p>Let’s see another realistic example access pattern for this kind of
optimizations.  Below are the visualized access patterns of streamcluster
workload in PARSEC3 benchmark suite.  We can easily identify the 100 MiB sized
hot object.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><div class="figure align-center" id="id15">
<img alt="the access pattern in heatmap format" src="../../../_images/streamcluster_heatmap.png" />
<p class="caption"><span class="caption-text">The access pattern in heatmap format.</span><a class="headerlink" href="#id15" title="Permalink to this image">¶</a></p>
</div>
</td>
<td><div class="figure align-center" id="id16">
<img alt="the distribution of working set size" src="../../../_images/streamcluster_wss_sz.png" />
<p class="caption"><span class="caption-text">The distribution of working set size.</span><a class="headerlink" href="#id16" title="Permalink to this image">¶</a></p>
</div>
</td>
<td><div class="figure align-center" id="id17">
<img alt="the chronological changes of working set size" src="../../../_images/streamcluster_wss_time.png" />
<p class="caption"><span class="caption-text">The chronological changes of working set size.</span><a class="headerlink" href="#id17" title="Permalink to this image">¶</a></p>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="personalized-damon-application">
<h3>Personalized DAMON Application<a class="headerlink" href="#personalized-damon-application" title="Permalink to this headline">¶</a></h3>
<p>Above approaches will work well for many general cases, but would not enough
for some special cases.</p>
<p>If this is the case, it might be the time to forget the comfortable use of the
user space tool and dive into the debugfs interface (refer to <a class="reference internal" href="usage.html"><span class="doc">Detailed Usages</span></a> for
the detail) of DAMON.  Using the interface, you can control the DAMON more
flexibly.  Therefore, you can write your personalized DAMON application that
controls the monitoring via the debugfs interface, analyzes the result, and
applies complex optimizations itself.  Using this, you can make more creative
and wise optimizations.</p>
<p>If you are a kernel space programmer, writing kernel space DAMON applications
using the API (refer to the <a class="reference internal" href="../../../vm/damon/api.html"><span class="doc">API Reference</span></a> for more detail) would be an
option.</p>
</div>
</div>
<div class="section" id="reference-practices">
<h2>Reference Practices<a class="headerlink" href="#reference-practices" title="Permalink to this headline">¶</a></h2>
<p>Referencing previously done successful practices could help you getting the
sense for this kind of optimizations.  There is an academic paper <a class="footnote-reference brackets" href="#id7" id="id2">1</a>
reporting the visualized access pattern and manual <a class="reference internal" href="#program-modification">Program
Modification</a> results for a number of realistic workloads.  You can also get
the visualized access patterns <a class="footnote-reference brackets" href="#id9" id="id3">3</a> <a class="footnote-reference brackets" href="#id10" id="id4">4</a> <a class="footnote-reference brackets" href="#id11" id="id5">5</a> and automated DAMON-based memory
operations results for other realistic workloads that collected with latest
version of DAMON <a class="footnote-reference brackets" href="#id8" id="id6">2</a> .</p>
<dl class="footnote brackets">
<dt class="label" id="id7"><span class="brackets">1</span><span class="fn-backref">(<a href="#id1">1</a>,<a href="#id2">2</a>)</span></dt>
<dd><p><a class="reference external" href="https://dl.acm.org/doi/10.1145/3366626.3368125">https://dl.acm.org/doi/10.1145/3366626.3368125</a></p>
</dd>
<dt class="label" id="id8"><span class="brackets"><a class="fn-backref" href="#id6">2</a></span></dt>
<dd><p><a class="reference external" href="https://damonitor.github.io/test/result/perf/latest/html/">https://damonitor.github.io/test/result/perf/latest/html/</a></p>
</dd>
<dt class="label" id="id9"><span class="brackets"><a class="fn-backref" href="#id3">3</a></span></dt>
<dd><p><a class="reference external" href="https://damonitor.github.io/test/result/visual/latest/rec.heatmap.1.png.html">https://damonitor.github.io/test/result/visual/latest/rec.heatmap.1.png.html</a></p>
</dd>
<dt class="label" id="id10"><span class="brackets"><a class="fn-backref" href="#id4">4</a></span></dt>
<dd><p><a class="reference external" href="https://damonitor.github.io/test/result/visual/latest/rec.wss_sz.png.html">https://damonitor.github.io/test/result/visual/latest/rec.wss_sz.png.html</a></p>
</dd>
<dt class="label" id="id11"><span class="brackets"><a class="fn-backref" href="#id5">5</a></span></dt>
<dd><p><a class="reference external" href="https://damonitor.github.io/test/result/visual/latest/rec.wss_time.png.html">https://damonitor.github.io/test/result/visual/latest/rec.wss_time.png.html</a></p>
</dd>
</dl>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="usage.html" class="btn btn-neutral float-right" title="Detailed Usages" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="start.html" class="btn btn-neutral float-left" title="Getting Started" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright The kernel development community

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>