

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Intel MID PTI &mdash; The Linux Kernel  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.6.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/mm/damon/index.html">DAMON: Data Access MONitor</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Intel MID PTI</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/driver-api/pti_intel_mid.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="intel-mid-pti">
<h1>Intel MID PTI<a class="headerlink" href="#intel-mid-pti" title="Permalink to this headline">¶</a></h1>
<p>The Intel MID PTI project is HW implemented in Intel Atom
system-on-a-chip designs based on the Parallel Trace
Interface for MIPI P1149.7 cJTAG standard.  The kernel solution
for this platform involves the following files:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>./include/linux/pti.h
./drivers/.../n_tracesink.h
./drivers/.../n_tracerouter.c
./drivers/.../n_tracesink.c
./drivers/.../pti.c
</pre></div>
</div>
<p>pti.c is the driver that enables various debugging features
popular on platforms from certain mobile manufacturers.
n_tracerouter.c and n_tracesink.c allow extra system information to
be collected and routed to the pti driver, such as trace
debugging data from a modem.  Although n_tracerouter
and n_tracesink are a part of the complete PTI solution,
these two line disciplines can work separately from
pti.c and route any data stream from one /dev/tty node
to another /dev/tty node via kernel-space.  This provides
a stable, reliable connection that will not break unless
the user-space application shuts down (plus avoids
kernel-&gt;user-&gt;kernel context switch overheads of routing
data).</p>
<p>An example debugging usage for this driver system:</p>
<blockquote>
<div><ul class="simple">
<li>Hook /dev/ttyPTI0 to syslogd.  Opening this port will also start
a console device to further capture debugging messages to PTI.</li>
<li>Hook /dev/ttyPTI1 to modem debugging data to write to PTI HW.
This is where n_tracerouter and n_tracesink are used.</li>
<li>Hook /dev/pti to a user-level debugging application for writing
to PTI HW.</li>
<li><cite>Use mipi_</cite> Kernel Driver API in other device drivers for
debugging to PTI by first requesting a PTI write address via
mipi_request_masterchannel(1).</li>
</ul>
</div></blockquote>
<p>Below is example pseudo-code on how a ‘privileged’ application
can hook up n_tracerouter and n_tracesink to any tty on
a system.  ‘Privileged’ means the application has enough
privileges to successfully manipulate the ldisc drivers
but is not just blindly executing as ‘root’. Keep in mind
the use of ioctl(,TIOCSETD,) is not specific to the n_tracerouter
and n_tracesink line discpline drivers but is a generic
operation for a program to use a line discpline driver
on a tty port other than the default n_tty:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">/////////// To hook up n_tracerouter and n_tracesink /////////</span>

<span class="c1">// Note that n_tracerouter depends on n_tracesink.</span>
<span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp"></span>
<span class="cp">#define ONE_TTY &quot;/dev/ttyOne&quot;</span>
<span class="cp">#define TWO_TTY &quot;/dev/ttyTwo&quot;</span>

<span class="c1">// needed global to hand onto ldisc connection</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">g_fd_source</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">g_fd_sink</span>  <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="c1">// these two vars used to grab LDISC values from loaded ldisc drivers</span>
<span class="c1">// in OS.  Look at /proc/tty/ldiscs to get the right numbers from</span>
<span class="c1">// the ldiscs loaded in the system.</span>
<span class="kt">int</span> <span class="n">source_ldisc_num</span><span class="p">,</span> <span class="n">sink_ldisc_num</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

<span class="n">g_fd_source</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">ONE_TTY</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span> <span class="c1">// must be R/W</span>
<span class="n">g_fd_sink</span>   <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">TWO_TTY</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span> <span class="c1">// must be R/W</span>

<span class="k">if</span> <span class="p">(</span><span class="n">g_fd_source</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">g_fd_sink</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
   <span class="c1">// doubt you&#39;ll want to use these exact error lines of code</span>
   <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Error on open(). errno: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">errno</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">errno</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">retval</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">g_fd_sink</span><span class="p">,</span> <span class="n">TIOCSETD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sink_ldisc_num</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Error on ioctl().  errno: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">errno</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">errno</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">retval</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">g_fd_source</span><span class="p">,</span> <span class="n">TIOCSETD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">source_ldisc_num</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Error on ioctl().  errno: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">errno</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">errno</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">/////////// To disconnect n_tracerouter and n_tracesink ////////</span>

<span class="c1">// First make sure data through the ldiscs has stopped.</span>

<span class="c1">// Second, disconnect ldiscs.  This provides a</span>
<span class="c1">// little cleaner shutdown on tty stack.</span>
<span class="n">sink_ldisc_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">source_ldisc_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">ioctl</span><span class="p">(</span><span class="n">g_fd_uart</span><span class="p">,</span> <span class="n">TIOCSETD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sink_ldisc_num</span><span class="p">);</span>
<span class="n">ioctl</span><span class="p">(</span><span class="n">g_fd_gadget</span><span class="p">,</span> <span class="n">TIOCSETD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">source_ldisc_num</span><span class="p">);</span>

<span class="c1">// Three, program closes connection, and cleanup:</span>
<span class="n">close</span><span class="p">(</span><span class="n">g_fd_uart</span><span class="p">);</span>
<span class="n">close</span><span class="p">(</span><span class="n">g_fd_gadget</span><span class="p">);</span>
<span class="n">g_fd_uart</span> <span class="o">=</span> <span class="n">g_fd_gadget</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</pre></div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>