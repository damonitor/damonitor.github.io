

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Triggered Buffers &mdash; The Linux Kernel  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.8.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/mm/damon/index.html">Monitoring Data Accesses</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../vm/damon/index.html">DAMON: Data Access MONitor</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>Triggered Buffers</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/driver-api/iio/triggered-buffers.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="triggered-buffers">
<h1>Triggered Buffers<a class="headerlink" href="#triggered-buffers" title="Permalink to this headline">¶</a></h1>
<p>Now that we know what buffers and triggers are let’s see how they work together.</p>
<div class="section" id="iio-triggered-buffer-setup">
<h2>IIO triggered buffer setup<a class="headerlink" href="#iio-triggered-buffer-setup" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference internal" href="#c.iio_triggered_buffer_setup" title="iio_triggered_buffer_setup"><code class="xref c c-func docutils literal notranslate"><span class="pre">iio_triggered_buffer_setup()</span></code></a> — Setup triggered buffer and pollfunc</li>
<li><a class="reference internal" href="#c.iio_triggered_buffer_cleanup" title="iio_triggered_buffer_cleanup"><code class="xref c c-func docutils literal notranslate"><span class="pre">iio_triggered_buffer_cleanup()</span></code></a> — Free resources allocated by
<a class="reference internal" href="#c.iio_triggered_buffer_setup" title="iio_triggered_buffer_setup"><code class="xref c c-func docutils literal notranslate"><span class="pre">iio_triggered_buffer_setup()</span></code></a></li>
<li>struct <a class="reference internal" href="core.html#c.iio_buffer_setup_ops" title="iio_buffer_setup_ops"><code class="xref c c-type docutils literal notranslate"><span class="pre">iio_buffer_setup_ops</span></code></a> — buffer setup related callbacks</li>
</ul>
<p>A typical triggered buffer setup looks like this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>const struct iio_buffer_setup_ops sensor_buffer_setup_ops = {
  .preenable    = sensor_buffer_preenable,
  .postenable   = sensor_buffer_postenable,
  .postdisable  = sensor_buffer_postdisable,
  .predisable   = sensor_buffer_predisable,
};

irqreturn_t sensor_iio_pollfunc(int irq, void *p)
{
    pf-&gt;timestamp = iio_get_time_ns((struct indio_dev *)p);
    return IRQ_WAKE_THREAD;
}

irqreturn_t sensor_trigger_handler(int irq, void *p)
{
    u16 buf[8];
    int i = 0;

    /* read data for each active channel */
    for_each_set_bit(bit, active_scan_mask, masklength)
        buf[i++] = sensor_get_data(bit)

    iio_push_to_buffers_with_timestamp(indio_dev, buf, timestamp);

    iio_trigger_notify_done(trigger);
    return IRQ_HANDLED;
}

/* setup triggered buffer, usually in probe function */
iio_triggered_buffer_setup(indio_dev, sensor_iio_polfunc,
                           sensor_trigger_handler,
                           sensor_buffer_setup_ops);
</pre></div>
</div>
<p>The important things to notice here are:</p>
<ul class="simple">
<li><a class="reference internal" href="core.html#c.iio_buffer_setup_ops" title="iio_buffer_setup_ops"><code class="xref c c-type docutils literal notranslate"><span class="pre">iio_buffer_setup_ops</span></code></a>, the buffer setup functions to be called at
predefined points in the buffer configuration sequence (e.g. before enable,
after disable). If not specified, the IIO core uses the default
iio_triggered_buffer_setup_ops.</li>
<li><strong>sensor_iio_pollfunc</strong>, the function that will be used as top half of poll
function. It should do as little processing as possible, because it runs in
interrupt context. The most common operation is recording of the current
timestamp and for this reason one can use the IIO core defined
<code class="xref c c-func docutils literal notranslate"><span class="pre">iio_pollfunc_store_time()</span></code> function.</li>
<li><strong>sensor_trigger_handler</strong>, the function that will be used as bottom half of
the poll function. This runs in the context of a kernel thread and all the
processing takes place here. It usually reads data from the device and
stores it in the internal buffer together with the timestamp recorded in the
top half.</li>
</ul>
</div>
<div class="section" id="more-details">
<h2>More details<a class="headerlink" href="#more-details" title="Permalink to this headline">¶</a></h2>
<dl class="function">
<dt id="c.iio_triggered_buffer_setup">
int <code class="descname">iio_triggered_buffer_setup</code><span class="sig-paren">(</span>struct <a class="reference internal" href="core.html#c.iio_dev" title="iio_dev">iio_dev</a> *<em>&nbsp;indio_dev</em>, irqreturn_t (<em>*h</em>)(int irq, void *p), irqreturn_t (*thread) (int irq, void *p), const struct <a class="reference internal" href="core.html#c.iio_buffer_setup_ops" title="iio_buffer_setup_ops">iio_buffer_setup_ops</a> *<em>&nbsp;setup_ops</em><span class="sig-paren">)</span><a class="headerlink" href="#c.iio_triggered_buffer_setup" title="Permalink to this definition">¶</a></dt>
<dd><p>Setup triggered buffer and pollfunc</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">iio_dev</span> <span class="pre">*</span> <span class="pre">indio_dev</span></code></dt>
<dd>IIO device structure</dd>
<dt><code class="docutils literal notranslate"><span class="pre">irqreturn_t</span> <span class="pre">(*)(int</span> <span class="pre">irq,</span> <span class="pre">void</span> <span class="pre">*p)</span> <span class="pre">h</span></code></dt>
<dd>Function which will be used as pollfunc top half</dd>
<dt><code class="docutils literal notranslate"><span class="pre">irqreturn_t</span> <span class="pre">(*)(int</span> <span class="pre">irq,</span> <span class="pre">void</span> <span class="pre">*p)</span> <span class="pre">thread</span></code></dt>
<dd>Function which will be used as pollfunc bottom half</dd>
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">struct</span> <span class="pre">iio_buffer_setup_ops</span> <span class="pre">*</span> <span class="pre">setup_ops</span></code></dt>
<dd>Buffer setup functions to use for this device.
If NULL the default setup functions for triggered
buffers will be used.</dd>
</dl>
<p><strong>Description</strong></p>
<p>This function combines some common tasks which will normally be performed
when setting up a triggered buffer. It will allocate the buffer and the
pollfunc.</p>
<p>Before calling this function the indio_dev structure should already be
completely initialized, but not yet registered. In practice this means that
this function should be called right before <a class="reference internal" href="core.html#c.iio_device_register" title="iio_device_register"><code class="xref c c-func docutils literal notranslate"><span class="pre">iio_device_register()</span></code></a>.</p>
<p>To free the resources allocated by this function call
<a class="reference internal" href="#c.iio_triggered_buffer_cleanup" title="iio_triggered_buffer_cleanup"><code class="xref c c-func docutils literal notranslate"><span class="pre">iio_triggered_buffer_cleanup()</span></code></a>.</p>
<dl class="function">
<dt id="c.iio_triggered_buffer_cleanup">
void <code class="descname">iio_triggered_buffer_cleanup</code><span class="sig-paren">(</span>struct <a class="reference internal" href="core.html#c.iio_dev" title="iio_dev">iio_dev</a> *<em>&nbsp;indio_dev</em><span class="sig-paren">)</span><a class="headerlink" href="#c.iio_triggered_buffer_cleanup" title="Permalink to this definition">¶</a></dt>
<dd><p>Free resources allocated by <a class="reference internal" href="#c.iio_triggered_buffer_setup" title="iio_triggered_buffer_setup"><code class="xref c c-func docutils literal notranslate"><span class="pre">iio_triggered_buffer_setup()</span></code></a></p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">iio_dev</span> <span class="pre">*</span> <span class="pre">indio_dev</span></code></dt>
<dd>IIO device structure</dd>
</dl>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>