

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Netdev features mess and how to get out from it alive &mdash; The Linux Kernel  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.8.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/mm/damon/index.html">Monitoring Data Accesses</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../vm/damon/index.html">DAMON: Data Access MONitor</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Netdev features mess and how to get out from it alive</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/networking/netdev-features.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="netdev-features-mess-and-how-to-get-out-from-it-alive">
<h1>Netdev features mess and how to get out from it alive<a class="headerlink" href="#netdev-features-mess-and-how-to-get-out-from-it-alive" title="Permalink to this headline">¶</a></h1>
<dl class="docutils">
<dt>Author:</dt>
<dd>Michał Mirosław &lt;<a class="reference external" href="mailto:mirq-linux&#37;&#52;&#48;rere&#46;qmqm&#46;pl">mirq-linux<span>&#64;</span>rere<span>&#46;</span>qmqm<span>&#46;</span>pl</a>&gt;</dd>
</dl>
<div class="section" id="part-i-feature-sets">
<h2>Part I: Feature sets<a class="headerlink" href="#part-i-feature-sets" title="Permalink to this headline">¶</a></h2>
<p>Long gone are the days when a network card would just take and give packets
verbatim.  Today’s devices add multiple features and bugs (read: offloads)
that relieve an OS of various tasks like generating and checking checksums,
splitting packets, classifying them.  Those capabilities and their state
are commonly referred to as netdev features in Linux kernel world.</p>
<p>There are currently three sets of features relevant to the driver, and
one used internally by network core:</p>
<blockquote>
<div><ol class="arabic simple">
<li>netdev-&gt;hw_features set contains features whose state may possibly
be changed (enabled or disabled) for a particular device by user’s
request.  This set should be initialized in ndo_init callback and not
changed later.</li>
<li>netdev-&gt;features set contains features which are currently enabled
for a device.  This should be changed only by network core or in
error paths of ndo_set_features callback.</li>
<li>netdev-&gt;vlan_features set contains features whose state is inherited
by child VLAN devices (limits netdev-&gt;features set).  This is currently
used for all VLAN devices whether tags are stripped or inserted in
hardware or software.</li>
<li>netdev-&gt;wanted_features set contains feature set requested by user.
This set is filtered by ndo_fix_features callback whenever it or
some device-specific conditions change. This set is internal to
networking core and should not be referenced in drivers.</li>
</ol>
</div></blockquote>
</div>
<div class="section" id="part-ii-controlling-enabled-features">
<h2>Part II: Controlling enabled features<a class="headerlink" href="#part-ii-controlling-enabled-features" title="Permalink to this headline">¶</a></h2>
<p>When current feature set (netdev-&gt;features) is to be changed, new set
is calculated and filtered by calling ndo_fix_features callback
and netdev_fix_features(). If the resulting set differs from current
set, it is passed to ndo_set_features callback and (if the callback
returns success) replaces value stored in netdev-&gt;features.
NETDEV_FEAT_CHANGE notification is issued after that whenever current
set might have changed.</p>
<dl class="docutils">
<dt>The following events trigger recalculation:</dt>
<dd><ol class="first last arabic simple">
<li>device’s registration, after ndo_init returned success</li>
<li>user requested changes in features state</li>
<li><a class="reference internal" href="kapi.html#c.netdev_update_features" title="netdev_update_features"><code class="xref c c-func docutils literal notranslate"><span class="pre">netdev_update_features()</span></code></a> is called</li>
</ol>
</dd>
</dl>
<p>ndo_*_features callbacks are called with rtnl_lock held. Missing callbacks
are treated as always returning success.</p>
<p>A driver that wants to trigger recalculation must do so by calling
<a class="reference internal" href="kapi.html#c.netdev_update_features" title="netdev_update_features"><code class="xref c c-func docutils literal notranslate"><span class="pre">netdev_update_features()</span></code></a> while holding rtnl_lock. This should not be done
from ndo_*_features callbacks. netdev-&gt;features should not be modified by
driver except by means of ndo_fix_features callback.</p>
</div>
<div class="section" id="part-iii-implementation-hints">
<h2>Part III: Implementation hints<a class="headerlink" href="#part-iii-implementation-hints" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul class="simple">
<li>ndo_fix_features:</li>
</ul>
</div></blockquote>
<p>All dependencies between features should be resolved here. The resulting
set can be reduced further by networking core imposed limitations (as coded
in netdev_fix_features()). For this reason it is safer to disable a feature
when its dependencies are not met instead of forcing the dependency on.</p>
<p>This callback should not modify hardware nor driver state (should be
stateless).  It can be called multiple times between successive
ndo_set_features calls.</p>
<p>Callback must not alter features contained in NETIF_F_SOFT_FEATURES or
NETIF_F_NEVER_CHANGE sets. The exception is NETIF_F_VLAN_CHALLENGED but
care must be taken as the change won’t affect already configured VLANs.</p>
<blockquote>
<div><ul class="simple">
<li>ndo_set_features:</li>
</ul>
</div></blockquote>
<p>Hardware should be reconfigured to match passed feature set. The set
should not be altered unless some error condition happens that can’t
be reliably detected in ndo_fix_features. In this case, the callback
should update netdev-&gt;features to match resulting hardware state.
Errors returned are not (and cannot be) propagated anywhere except dmesg.
(Note: successful return is zero, &gt;0 means silent error.)</p>
</div>
<div class="section" id="part-iv-features">
<h2>Part IV: Features<a class="headerlink" href="#part-iv-features" title="Permalink to this headline">¶</a></h2>
<p>For current list of features, see include/linux/netdev_features.h.
This section describes semantics of some of them.</p>
<blockquote>
<div><ul class="simple">
<li>Transmit checksumming</li>
</ul>
</div></blockquote>
<p>For complete description, see comments near the top of include/linux/skbuff.h.</p>
<p>Note: NETIF_F_HW_CSUM is a superset of NETIF_F_IP_CSUM + NETIF_F_IPV6_CSUM.
It means that device can fill TCP/UDP-like checksum anywhere in the packets
whatever headers there might be.</p>
<blockquote>
<div><ul class="simple">
<li>Transmit TCP segmentation offload</li>
</ul>
</div></blockquote>
<p>NETIF_F_TSO_ECN means that hardware can properly split packets with CWR bit
set, be it TCPv4 (when NETIF_F_TSO is enabled) or TCPv6 (NETIF_F_TSO6).</p>
<blockquote>
<div><ul class="simple">
<li>Transmit UDP segmentation offload</li>
</ul>
</div></blockquote>
<p>NETIF_F_GSO_UDP_L4 accepts a single UDP header with a payload that exceeds
gso_size. On segmentation, it segments the payload on gso_size boundaries and
replicates the network and UDP headers (fixing up the last one if less than
gso_size).</p>
<blockquote>
<div><ul class="simple">
<li>Transmit DMA from high memory</li>
</ul>
</div></blockquote>
<p>On platforms where this is relevant, NETIF_F_HIGHDMA signals that
ndo_start_xmit can handle skbs with frags in high memory.</p>
<blockquote>
<div><ul class="simple">
<li>Transmit scatter-gather</li>
</ul>
</div></blockquote>
<p>Those features say that ndo_start_xmit can handle fragmented skbs:
NETIF_F_SG — paged skbs (skb_shinfo()-&gt;frags), NETIF_F_FRAGLIST —
chained skbs (skb-&gt;next/prev list).</p>
<blockquote>
<div><ul class="simple">
<li>Software features</li>
</ul>
</div></blockquote>
<p>Features contained in NETIF_F_SOFT_FEATURES are features of networking
stack. Driver should not change behaviour based on them.</p>
<blockquote>
<div><ul class="simple">
<li>LLTX driver (deprecated for hardware drivers)</li>
</ul>
</div></blockquote>
<p>NETIF_F_LLTX is meant to be used by drivers that don’t need locking at all,
e.g. software tunnels.</p>
<p>This is also used in a few legacy drivers that implement their
own locking, don’t use it for new (hardware) drivers.</p>
<blockquote>
<div><ul class="simple">
<li>netns-local device</li>
</ul>
</div></blockquote>
<p>NETIF_F_NETNS_LOCAL is set for devices that are not allowed to move between
network namespaces (e.g. loopback).</p>
<p>Don’t use it in drivers.</p>
<blockquote>
<div><ul class="simple">
<li>VLAN challenged</li>
</ul>
</div></blockquote>
<p>NETIF_F_VLAN_CHALLENGED should be set for devices which can’t cope with VLAN
headers. Some drivers set this because the cards can’t handle the bigger MTU.
[FIXME: Those cases could be fixed in VLAN code by allowing only reduced-MTU
VLANs. This may be not useful, though.]</p>
<ul class="simple">
<li>rx-fcs</li>
</ul>
<p>This requests that the NIC append the Ethernet Frame Checksum (FCS)
to the end of the skb data.  This allows sniffers and other tools to
read the CRC recorded by the NIC on receipt of the packet.</p>
<ul class="simple">
<li>rx-all</li>
</ul>
<p>This requests that the NIC receive all possible frames, including errored
frames (such as bad FCS, etc).  This can be helpful when sniffing a link with
bad packets on it.  Some NICs may receive more packets if also put into normal
PROMISC mode.</p>
<ul class="simple">
<li>rx-gro-hw</li>
</ul>
<p>This requests that the NIC enables Hardware GRO (generic receive offload).
Hardware GRO is basically the exact reverse of TSO, and is generally
stricter than Hardware LRO.  A packet stream merged by Hardware GRO must
be re-segmentable by GSO or TSO back to the exact original packet stream.
Hardware GRO is dependent on RXCSUM since every packet successfully merged
by hardware must also have the checksum verified by hardware.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>