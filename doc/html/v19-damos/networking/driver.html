

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Softnet Driver Issues &mdash; The Linux Kernel  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.8.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/mm/damon/index.html">Monitoring Data Accesses</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../vm/damon/index.html">DAMON: Data Access MONitor</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Softnet Driver Issues</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/networking/driver.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="softnet-driver-issues">
<h1>Softnet Driver Issues<a class="headerlink" href="#softnet-driver-issues" title="Permalink to this headline">¶</a></h1>
<p>Transmit path guidelines:</p>
<ol class="arabic">
<li><p class="first">The ndo_start_xmit method must not return NETDEV_TX_BUSY under
any normal circumstances.  It is considered a hard error unless
there is no way your device can tell ahead of time when it’s
transmit function will become busy.</p>
<p>Instead it must maintain the queue properly.  For example,
for a driver implementing scatter-gather this means:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>static netdev_tx_t drv_hard_start_xmit(struct sk_buff *skb,
                                       struct net_device *dev)
{
        struct drv *dp = netdev_priv(dev);

        lock_tx(dp);
        ...
        /* This is a hard error log it. */
        if (TX_BUFFS_AVAIL(dp) &lt;= (skb_shinfo(skb)-&gt;nr_frags + 1)) {
                netif_stop_queue(dev);
                unlock_tx(dp);
                printk(KERN_ERR PFX &quot;%s: BUG! Tx Ring full when queue awake!\n&quot;,
                       dev-&gt;name);
                return NETDEV_TX_BUSY;
        }

        ... queue packet to card ...
        ... update tx consumer index ...

        if (TX_BUFFS_AVAIL(dp) &lt;= (MAX_SKB_FRAGS + 1))
                netif_stop_queue(dev);

        ...
        unlock_tx(dp);
        ...
        return NETDEV_TX_OK;
}
</pre></div>
</div>
<p>And then at the end of your TX reclamation event handling:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>if (netif_queue_stopped(dp-&gt;dev) &amp;&amp;
    TX_BUFFS_AVAIL(dp) &gt; (MAX_SKB_FRAGS + 1))
        netif_wake_queue(dp-&gt;dev);
</pre></div>
</div>
<p>For a non-scatter-gather supporting card, the three tests simply become:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/* This is a hard error log it. */
if (TX_BUFFS_AVAIL(dp) &lt;= 0)
</pre></div>
</div>
<p>and:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>if (TX_BUFFS_AVAIL(dp) == 0)
</pre></div>
</div>
<p>and:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>if (netif_queue_stopped(dp-&gt;dev) &amp;&amp;
    TX_BUFFS_AVAIL(dp) &gt; 0)
        netif_wake_queue(dp-&gt;dev);
</pre></div>
</div>
</li>
<li><p class="first">An ndo_start_xmit method must not modify the shared parts of a
cloned SKB.</p>
</li>
<li><p class="first">Do not forget that once you return NETDEV_TX_OK from your
ndo_start_xmit method, it is your driver’s responsibility to free
up the SKB and in some finite amount of time.</p>
<p>For example, this means that it is not allowed for your TX
mitigation scheme to let TX packets “hang out” in the TX
ring unreclaimed forever if no new TX packets are sent.
This error can deadlock sockets waiting for send buffer room
to be freed up.</p>
<p>If you return NETDEV_TX_BUSY from the ndo_start_xmit method, you
must not keep any reference to that SKB and you must not attempt
to free it up.</p>
</li>
</ol>
<p>Probing guidelines:</p>
<ol class="arabic simple">
<li>Any hardware layer address you obtain for your device should
be verified.  For example, for ethernet check it with
linux/etherdevice.h:<a class="reference internal" href="kapi.html#c.is_valid_ether_addr" title="is_valid_ether_addr"><code class="xref c c-func docutils literal notranslate"><span class="pre">is_valid_ether_addr()</span></code></a></li>
</ol>
<p>Close/stop guidelines:</p>
<ol class="arabic simple">
<li>After the ndo_stop routine has been called, the hardware must
not receive or transmit any data.  All in flight packets must
be aborted. If necessary, poll or wait for completion of
any reset commands.</li>
<li>The ndo_stop routine will be called by unregister_netdevice
if device is still UP.</li>
</ol>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>