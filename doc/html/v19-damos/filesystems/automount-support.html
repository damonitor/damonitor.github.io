

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Automount Support &mdash; The Linux Kernel  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.8.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/mm/damon/index.html">Monitoring Data Accesses</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../vm/damon/index.html">DAMON: Data Access MONitor</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Automount Support</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/filesystems/automount-support.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="automount-support">
<h1>Automount Support<a class="headerlink" href="#automount-support" title="Permalink to this headline">¶</a></h1>
<p>Support is available for filesystems that wish to do automounting
support (such as kAFS which can be found in fs/afs/ and NFS in
fs/nfs/). This facility includes allowing in-kernel mounts to be
performed and mountpoint degradation to be requested. The latter can
also be requested by userspace.</p>
<div class="section" id="in-kernel-automounting">
<h2>In-Kernel Automounting<a class="headerlink" href="#in-kernel-automounting" title="Permalink to this headline">¶</a></h2>
<p>See section “Mount Traps” of  Documentation/filesystems/autofs.rst</p>
<p>Then from userspace, you can just do something like:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[root@andromeda root]# mount -t afs \#root.afs. /afs
[root@andromeda root]# ls /afs
asd  cambridge  cambridge.redhat.com  grand.central.org
[root@andromeda root]# ls /afs/cambridge
afsdoc
[root@andromeda root]# ls /afs/cambridge/afsdoc/
ChangeLog  html  LICENSE  pdf  RELNOTES-1.2.2
</pre></div>
</div>
<p>And then if you look in the mountpoint catalogue, you’ll see something like:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[root@andromeda root]# cat /proc/mounts
...
#root.afs. /afs afs rw 0 0
#root.cell. /afs/cambridge.redhat.com afs rw 0 0
#afsdoc. /afs/cambridge.redhat.com/afsdoc afs rw 0 0
</pre></div>
</div>
</div>
<div class="section" id="automatic-mountpoint-expiry">
<h2>Automatic Mountpoint Expiry<a class="headerlink" href="#automatic-mountpoint-expiry" title="Permalink to this headline">¶</a></h2>
<p>Automatic expiration of mountpoints is easy, provided you’ve mounted the
mountpoint to be expired in the automounting procedure outlined separately.</p>
<p>To do expiration, you need to follow these steps:</p>
<blockquote>
<div><ol class="arabic">
<li><p class="first">Create at least one list off which the vfsmounts to be expired can be
hung.</p>
</li>
<li><p class="first">When a new mountpoint is created in the -&gt;d_automount method, add
the mnt to the list using mnt_set_expiry():</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>mnt_set_expiry(newmnt, &amp;afs_vfsmounts);
</pre></div>
</div>
</li>
<li><p class="first">When you want mountpoints to be expired, call mark_mounts_for_expiry()
with a pointer to this list. This will process the list, marking every
vfsmount thereon for potential expiry on the next call.</p>
<p>If a vfsmount was already flagged for expiry, and if its usage count is 1
(it’s only referenced by its parent vfsmount), then it will be deleted
from the namespace and thrown away (effectively unmounted).</p>
<p>It may prove simplest to simply call this at regular intervals, using
some sort of timed event to drive it.</p>
</li>
</ol>
</div></blockquote>
<p>The expiration flag is cleared by calls to mntput. This means that expiration
will only happen on the second expiration request after the last time the
mountpoint was accessed.</p>
<p>If a mountpoint is moved, it gets removed from the expiration list. If a bind
mount is made on an expirable mount, the new vfsmount will not be on the
expiration list and will not expire.</p>
<p>If a namespace is copied, all mountpoints contained therein will be copied,
and the copies of those that are on an expiration list will be added to the
same expiration list.</p>
</div>
<div class="section" id="userspace-driven-expiry">
<h2>Userspace Driven Expiry<a class="headerlink" href="#userspace-driven-expiry" title="Permalink to this headline">¶</a></h2>
<p>As an alternative, it is possible for userspace to request expiry of any
mountpoint (though some will be rejected - the current process’s idea of the
rootfs for example). It does this by passing the MNT_EXPIRE flag to
umount(). This flag is considered incompatible with MNT_FORCE and MNT_DETACH.</p>
<p>If the mountpoint in question is in referenced by something other than
umount() or its parent mountpoint, an EBUSY error will be returned and the
mountpoint will not be marked for expiration or unmounted.</p>
<p>If the mountpoint was not already marked for expiry at that time, an EAGAIN
error will be given and it won’t be unmounted.</p>
<p>Otherwise if it was already marked and it wasn’t referenced, unmounting will
take place as usual.</p>
<p>Again, the expiration flag is cleared every time anything other than umount()
looks at a mountpoint.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>