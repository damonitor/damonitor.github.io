

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Asynchronous Operations Handling &mdash; The Linux Kernel  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.8.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/mm/damon/index.html">Monitoring Data Accesses</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../vm/damon/index.html">DAMON: Data Access MONitor</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>Asynchronous Operations Handling</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/filesystems/caching/operations.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="asynchronous-operations-handling">
<h1>Asynchronous Operations Handling<a class="headerlink" href="#asynchronous-operations-handling" title="Permalink to this headline">¶</a></h1>
<p>By: David Howells &lt;<a class="reference external" href="mailto:dhowells&#37;&#52;&#48;redhat&#46;com">dhowells<span>&#64;</span>redhat<span>&#46;</span>com</a>&gt;</p>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>FS-Cache has an asynchronous operations handling facility that it uses for its
data storage and retrieval routines.  Its operations are represented by
fscache_operation structs, though these are usually embedded into some other
structure.</p>
<p>This facility is available to and expected to be be used by the cache backends,
and FS-Cache will create operations and pass them off to the appropriate cache
backend for completion.</p>
<p>To make use of this facility, &lt;linux/fscache-cache.h&gt; should be #included.</p>
</div>
<div class="section" id="operation-record-initialisation">
<h2>Operation Record Initialisation<a class="headerlink" href="#operation-record-initialisation" title="Permalink to this headline">¶</a></h2>
<p>An operation is recorded in an fscache_operation struct:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct fscache_operation {
        union {
                struct work_struct fast_work;
                struct slow_work slow_work;
        };
        unsigned long           flags;
        fscache_operation_processor_t processor;
        ...
};
</pre></div>
</div>
<p>Someone wanting to issue an operation should allocate something with this
struct embedded in it.  They should initialise it by calling:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>void fscache_operation_init(struct fscache_operation *op,
                            fscache_operation_release_t release);
</pre></div>
</div>
<p>with the operation to be initialised and the release function to use.</p>
<p>The op-&gt;flags parameter should be set to indicate the CPU time provision and
the exclusivity (see the Parameters section).</p>
<p>The op-&gt;fast_work, op-&gt;slow_work and op-&gt;processor flags should be set as
appropriate for the CPU time provision (see the Parameters section).</p>
<p>FSCACHE_OP_WAITING may be set in op-&gt;flags prior to each submission of the
operation and waited for afterwards.</p>
</div>
<div class="section" id="parameters">
<h2>Parameters<a class="headerlink" href="#parameters" title="Permalink to this headline">¶</a></h2>
<p>There are a number of parameters that can be set in the operation record’s flag
parameter.  There are three options for the provision of CPU time in these
operations:</p>
<blockquote>
<div><ol class="arabic">
<li><p class="first">The operation may be done synchronously (FSCACHE_OP_MYTHREAD).  A thread
may decide it wants to handle an operation itself without deferring it to
another thread.</p>
<p>This is, for example, used in read operations for calling readpages() on
the backing filesystem in CacheFiles.  Although readpages() does an
asynchronous data fetch, the determination of whether pages exist is done
synchronously - and the netfs does not proceed until this has been
determined.</p>
<p>If this option is to be used, FSCACHE_OP_WAITING must be set in op-&gt;flags
before submitting the operation, and the operating thread must wait for it
to be cleared before proceeding:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>wait_on_bit(&amp;op-&gt;flags, FSCACHE_OP_WAITING,
            TASK_UNINTERRUPTIBLE);
</pre></div>
</div>
</li>
<li><p class="first">The operation may be fast asynchronous (FSCACHE_OP_FAST), in which case it
will be given to keventd to process.  Such an operation is not permitted
to sleep on I/O.</p>
<p>This is, for example, used by CacheFiles to copy data from a backing fs
page to a netfs page after the backing fs has read the page in.</p>
<p>If this option is used, op-&gt;fast_work and op-&gt;processor must be
initialised before submitting the operation:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>INIT_WORK(&amp;op-&gt;fast_work, do_some_work);
</pre></div>
</div>
</li>
<li><p class="first">The operation may be slow asynchronous (FSCACHE_OP_SLOW), in which case it
will be given to the slow work facility to process.  Such an operation is
permitted to sleep on I/O.</p>
<p>This is, for example, used by FS-Cache to handle background writes of
pages that have just been fetched from a remote server.</p>
<p>If this option is used, op-&gt;slow_work and op-&gt;processor must be
initialised before submitting the operation:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>fscache_operation_init_slow(op, processor)
</pre></div>
</div>
</li>
</ol>
</div></blockquote>
<p>Furthermore, operations may be one of two types:</p>
<blockquote>
<div><ol class="arabic">
<li><p class="first">Exclusive (FSCACHE_OP_EXCLUSIVE).  Operations of this type may not run in
conjunction with any other operation on the object being operated upon.</p>
<p>An example of this is the attribute change operation, in which the file
being written to may need truncation.</p>
</li>
<li><p class="first">Shareable.  Operations of this type may be running simultaneously.  It’s
up to the operation implementation to prevent interference between other
operations running at the same time.</p>
</li>
</ol>
</div></blockquote>
</div>
<div class="section" id="procedure">
<h2>Procedure<a class="headerlink" href="#procedure" title="Permalink to this headline">¶</a></h2>
<p>Operations are used through the following procedure:</p>
<blockquote>
<div><ol class="arabic">
<li><p class="first">The submitting thread must allocate the operation and initialise it
itself.  Normally this would be part of a more specific structure with the
generic op embedded within.</p>
</li>
<li><p class="first">The submitting thread must then submit the operation for processing using
one of the following two functions:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>int fscache_submit_op(struct fscache_object *object,
                      struct fscache_operation *op);

int fscache_submit_exclusive_op(struct fscache_object *object,
                                struct fscache_operation *op);
</pre></div>
</div>
<p>The first function should be used to submit non-exclusive ops and the
second to submit exclusive ones.  The caller must still set the
FSCACHE_OP_EXCLUSIVE flag.</p>
<p>If successful, both functions will assign the operation to the specified
object and return 0.  -ENOBUFS will be returned if the object specified is
permanently unavailable.</p>
<p>The operation manager will defer operations on an object that is still
undergoing lookup or creation.  The operation will also be deferred if an
operation of conflicting exclusivity is in progress on the object.</p>
<p>If the operation is asynchronous, the manager will retain a reference to
it, so the caller should put their reference to it by passing it to:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>void fscache_put_operation(struct fscache_operation *op);
</pre></div>
</div>
</li>
<li><p class="first">If the submitting thread wants to do the work itself, and has marked the
operation with FSCACHE_OP_MYTHREAD, then it should monitor
FSCACHE_OP_WAITING as described above and check the state of the object if
necessary (the object might have died while the thread was waiting).</p>
<p>When it has finished doing its processing, it should call
fscache_op_complete() and fscache_put_operation() on it.</p>
</li>
<li><p class="first">The operation holds an effective lock upon the object, preventing other
exclusive ops conflicting until it is released.  The operation can be
enqueued for further immediate asynchronous processing by adjusting the
CPU time provisioning option if necessary, eg:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>op-&gt;flags &amp;= ~FSCACHE_OP_TYPE;
op-&gt;flags |= ~FSCACHE_OP_FAST;
</pre></div>
</div>
<p>and calling:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>void fscache_enqueue_operation(struct fscache_operation *op)
</pre></div>
</div>
<p>This can be used to allow other things to have use of the worker thread
pools.</p>
</li>
</ol>
</div></blockquote>
</div>
<div class="section" id="asynchronous-callback">
<h2>Asynchronous Callback<a class="headerlink" href="#asynchronous-callback" title="Permalink to this headline">¶</a></h2>
<p>When used in asynchronous mode, the worker thread pool will invoke the
processor method with a pointer to the operation.  This should then get at the
container struct by using <a class="reference internal" href="../../driver-api/basics.html#c.container_of" title="container_of"><code class="xref c c-func docutils literal notranslate"><span class="pre">container_of()</span></code></a>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>static void fscache_write_op(struct fscache_operation *_op)
{
        struct fscache_storage *op =
                container_of(_op, struct fscache_storage, op);
...
}
</pre></div>
</div>
<p>The caller holds a reference on the operation, and will invoke
fscache_put_operation() when the processor function returns.  The processor
function is at liberty to call fscache_enqueue_operation() or to take extra
references.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>