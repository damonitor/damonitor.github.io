

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Deprecated Interfaces, Language Features, Attributes, and Conventions &mdash; The Linux Kernel  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.6.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/mm/damon/index.html">DAMON: Data Access MONitor</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Deprecated Interfaces, Language Features, Attributes, and Conventions</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/process/deprecated.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="deprecated-interfaces-language-features-attributes-and-conventions">
<span id="deprecated"></span><h1>Deprecated Interfaces, Language Features, Attributes, and Conventions<a class="headerlink" href="#deprecated-interfaces-language-features-attributes-and-conventions" title="Permalink to this headline">¶</a></h1>
<p>In a perfect world, it would be possible to convert all instances of
some deprecated API into the new API and entirely remove the old API in
a single development cycle. However, due to the size of the kernel, the
maintainership hierarchy, and timing, it’s not always feasible to do these
kinds of conversions at once. This means that new instances may sneak into
the kernel while old ones are being removed, only making the amount of
work to remove the API grow. In order to educate developers about what
has been deprecated and why, this list has been created as a place to
point when uses of deprecated things are proposed for inclusion in the
kernel.</p>
<div class="section" id="id1">
<h2>__deprecated<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>While this attribute does visually mark an interface as deprecated,
it <a class="reference external" href="https://git.kernel.org/linus/771c035372a036f83353eef46dbb829780330234">does not produce warnings during builds any more</a>
because one of the standing goals of the kernel is to build without
warnings and no one was actually doing anything to remove these deprecated
interfaces. While using <cite>__deprecated</cite> is nice to note an old API in
a header file, it isn’t the full solution. Such interfaces must either
be fully removed from the kernel, or added to this file to discourage
others from using them in the future.</p>
</div>
<div class="section" id="open-coded-arithmetic-in-allocator-arguments">
<h2>open-coded arithmetic in allocator arguments<a class="headerlink" href="#open-coded-arithmetic-in-allocator-arguments" title="Permalink to this headline">¶</a></h2>
<p>Dynamic size calculations (especially multiplication) should not be
performed in memory allocator (or similar) function arguments due to the
risk of them overflowing. This could lead to values wrapping around and a
smaller allocation being made than the caller was expecting. Using those
allocations could lead to linear overflows of heap memory and other
misbehaviors. (One exception to this is literal values where the compiler
can warn if they might overflow. Though using literals for arguments as
suggested below is also harmless.)</p>
<p>For example, do not use <code class="docutils literal notranslate"><span class="pre">count</span> <span class="pre">*</span> <span class="pre">size</span></code> as an argument, as in:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>foo = kmalloc(count * size, GFP_KERNEL);
</pre></div>
</div>
<p>Instead, the 2-factor form of the allocator should be used:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>foo = kmalloc_array(count, size, GFP_KERNEL);
</pre></div>
</div>
<p>If no 2-factor form is available, the saturate-on-overflow helpers should
be used:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>bar = vmalloc(array_size(count, size));
</pre></div>
</div>
<p>Another common case to avoid is calculating the size of a structure with
a trailing array of others structures, as in:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>header = kzalloc(sizeof(*header) + count * sizeof(*header-&gt;item),
                 GFP_KERNEL);
</pre></div>
</div>
<p>Instead, use the helper:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>header = kzalloc(struct_size(header, item, count), GFP_KERNEL);
</pre></div>
</div>
<p>See <a class="reference internal" href="../driver-api/basics.html#c.array_size" title="array_size"><code class="xref c c-func docutils literal notranslate"><span class="pre">array_size()</span></code></a>, <a class="reference internal" href="../driver-api/basics.html#c.array3_size" title="array3_size"><code class="xref c c-func docutils literal notranslate"><span class="pre">array3_size()</span></code></a>, and <a class="reference internal" href="../driver-api/basics.html#c.struct_size" title="struct_size"><code class="xref c c-func docutils literal notranslate"><span class="pre">struct_size()</span></code></a>,
for more details as well as the related <code class="xref c c-func docutils literal notranslate"><span class="pre">check_add_overflow()</span></code> and
<code class="xref c c-func docutils literal notranslate"><span class="pre">check_mul_overflow()</span></code> family of functions.</p>
</div>
<div class="section" id="simple-strtol-simple-strtoll-simple-strtoul-simple-strtoull">
<h2>simple_strtol(), simple_strtoll(), simple_strtoul(), simple_strtoull()<a class="headerlink" href="#simple-strtol-simple-strtoll-simple-strtoul-simple-strtoull" title="Permalink to this headline">¶</a></h2>
<p>The <a class="reference internal" href="../core-api/kernel-api.html#c.simple_strtol" title="simple_strtol"><code class="xref c c-func docutils literal notranslate"><span class="pre">simple_strtol()</span></code></a>, <a class="reference internal" href="../core-api/kernel-api.html#c.simple_strtoll" title="simple_strtoll"><code class="xref c c-func docutils literal notranslate"><span class="pre">simple_strtoll()</span></code></a>,
<a class="reference internal" href="../core-api/kernel-api.html#c.simple_strtoul" title="simple_strtoul"><code class="xref c c-func docutils literal notranslate"><span class="pre">simple_strtoul()</span></code></a>, and <a class="reference internal" href="../core-api/kernel-api.html#c.simple_strtoull" title="simple_strtoull"><code class="xref c c-func docutils literal notranslate"><span class="pre">simple_strtoull()</span></code></a> functions
explicitly ignore overflows, which may lead to unexpected results
in callers. The respective <a class="reference internal" href="../driver-api/basics.html#c.kstrtol" title="kstrtol"><code class="xref c c-func docutils literal notranslate"><span class="pre">kstrtol()</span></code></a>, <a class="reference internal" href="../core-api/kernel-api.html#c.kstrtoll" title="kstrtoll"><code class="xref c c-func docutils literal notranslate"><span class="pre">kstrtoll()</span></code></a>,
<a class="reference internal" href="../driver-api/basics.html#c.kstrtoul" title="kstrtoul"><code class="xref c c-func docutils literal notranslate"><span class="pre">kstrtoul()</span></code></a>, and <a class="reference internal" href="../core-api/kernel-api.html#c.kstrtoull" title="kstrtoull"><code class="xref c c-func docutils literal notranslate"><span class="pre">kstrtoull()</span></code></a> functions tend to be the
correct replacements, though note that those require the string to be
NUL or newline terminated.</p>
</div>
<div class="section" id="strcpy">
<h2>strcpy()<a class="headerlink" href="#strcpy" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="../core-api/kernel-api.html#c.strcpy" title="strcpy"><code class="xref c c-func docutils literal notranslate"><span class="pre">strcpy()</span></code></a> performs no bounds checking on the destination
buffer. This could result in linear overflows beyond the
end of the buffer, leading to all kinds of misbehaviors. While
<cite>CONFIG_FORTIFY_SOURCE=y</cite> and various compiler flags help reduce the
risk of using this function, there is no good reason to add new uses of
this function. The safe replacement is <a class="reference internal" href="../core-api/kernel-api.html#c.strscpy" title="strscpy"><code class="xref c c-func docutils literal notranslate"><span class="pre">strscpy()</span></code></a>.</p>
</div>
<div class="section" id="strncpy-on-nul-terminated-strings">
<h2>strncpy() on NUL-terminated strings<a class="headerlink" href="#strncpy-on-nul-terminated-strings" title="Permalink to this headline">¶</a></h2>
<p>Use of <a class="reference internal" href="../core-api/kernel-api.html#c.strncpy" title="strncpy"><code class="xref c c-func docutils literal notranslate"><span class="pre">strncpy()</span></code></a> does not guarantee that the destination buffer
will be NUL terminated. This can lead to various linear read overflows
and other misbehavior due to the missing termination. It also NUL-pads the
destination buffer if the source contents are shorter than the destination
buffer size, which may be a needless performance penalty for callers using
only NUL-terminated strings. The safe replacement is <a class="reference internal" href="../core-api/kernel-api.html#c.strscpy" title="strscpy"><code class="xref c c-func docutils literal notranslate"><span class="pre">strscpy()</span></code></a>.
(Users of <a class="reference internal" href="../core-api/kernel-api.html#c.strscpy" title="strscpy"><code class="xref c c-func docutils literal notranslate"><span class="pre">strscpy()</span></code></a> still needing NUL-padding will need an
explicit <a class="reference internal" href="../core-api/kernel-api.html#c.memset" title="memset"><code class="xref c c-func docutils literal notranslate"><span class="pre">memset()</span></code></a> added.)</p>
<p>If a caller is using non-NUL-terminated strings, <a class="reference internal" href="../core-api/kernel-api.html#c.strncpy" title="strncpy"><code class="xref c c-func docutils literal notranslate"><span class="pre">strncpy()</span></code></a> can
still be used, but destinations should be marked with the <a class="reference external" href="https://gcc.gnu.org/onlinedocs/gcc/Common-Variable-Attributes.html">__nonstring</a>
attribute to avoid future compiler warnings.</p>
</div>
<div class="section" id="strlcpy">
<h2>strlcpy()<a class="headerlink" href="#strlcpy" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="../core-api/kernel-api.html#c.strlcpy" title="strlcpy"><code class="xref c c-func docutils literal notranslate"><span class="pre">strlcpy()</span></code></a> reads the entire source buffer first, possibly exceeding
the given limit of bytes to copy. This is inefficient and can lead to
linear read overflows if a source string is not NUL-terminated. The
safe replacement is <a class="reference internal" href="../core-api/kernel-api.html#c.strscpy" title="strscpy"><code class="xref c c-func docutils literal notranslate"><span class="pre">strscpy()</span></code></a>.</p>
</div>
<div class="section" id="variable-length-arrays-vlas">
<h2>Variable Length Arrays (VLAs)<a class="headerlink" href="#variable-length-arrays-vlas" title="Permalink to this headline">¶</a></h2>
<p>Using stack VLAs produces much worse machine code than statically
sized stack arrays. While these non-trivial <a class="reference external" href="https://git.kernel.org/linus/02361bc77888">performance issues</a> are reason enough to
eliminate VLAs, they are also a security risk. Dynamic growth of a stack
array may exceed the remaining memory in the stack segment. This could
lead to a crash, possible overwriting sensitive contents at the end of the
stack (when built without <cite>CONFIG_THREAD_INFO_IN_TASK=y</cite>), or overwriting
memory adjacent to the stack (when built without <cite>CONFIG_VMAP_STACK=y</cite>)</p>
</div>
<div class="section" id="implicit-switch-case-fall-through">
<h2>Implicit switch case fall-through<a class="headerlink" href="#implicit-switch-case-fall-through" title="Permalink to this headline">¶</a></h2>
<p>The C language allows switch cases to “fall-through” when a “break” statement
is missing at the end of a case. This, however, introduces ambiguity in the
code, as it’s not always clear if the missing break is intentional or a bug.</p>
<p>As there have been a long list of flaws <a class="reference external" href="https://cwe.mitre.org/data/definitions/484.html">due to missing “break” statements</a>, we no longer allow
“implicit fall-through”.</p>
<p>In order to identify intentional fall-through cases, we have adopted a
pseudo-keyword macro ‘fallthrough’ which expands to gcc’s extension
__attribute__((__fallthrough__)).  <a class="reference external" href="https://gcc.gnu.org/onlinedocs/gcc/Statement-Attributes.html">Statement Attributes</a></p>
<p>When the C17/C18  [[fallthrough]] syntax is more commonly supported by
C compilers, static analyzers, and IDEs, we can switch to using that syntax
for the macro pseudo-keyword.</p>
<p>All switch/case blocks must end in one of:</p>
<blockquote>
<div>break;
fallthrough;
continue;
goto &lt;label&gt;;
return [expression];</div></blockquote>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>