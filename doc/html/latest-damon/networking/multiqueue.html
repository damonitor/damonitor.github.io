

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>HOWTO for multiqueue network device support &mdash; The Linux Kernel  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.8.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/mm/damon/index.html">Monitoring Data Accesses</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../vm/damon/index.html">DAMON: Data Access MONitor</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>HOWTO for multiqueue network device support</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/networking/multiqueue.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="howto-for-multiqueue-network-device-support">
<h1>HOWTO for multiqueue network device support<a class="headerlink" href="#howto-for-multiqueue-network-device-support" title="Permalink to this headline">¶</a></h1>
<div class="section" id="section-1-base-driver-requirements-for-implementing-multiqueue-support">
<h2>Section 1: Base driver requirements for implementing multiqueue support<a class="headerlink" href="#section-1-base-driver-requirements-for-implementing-multiqueue-support" title="Permalink to this headline">¶</a></h2>
<div class="section" id="intro-kernel-support-for-multiqueue-devices">
<h3>Intro: Kernel support for multiqueue devices<a class="headerlink" href="#intro-kernel-support-for-multiqueue-devices" title="Permalink to this headline">¶</a></h3>
<p>Kernel support for multiqueue devices is always present.</p>
<p>Base drivers are required to use the new alloc_etherdev_mq() or
alloc_netdev_mq() functions to allocate the subqueues for the device.  The
underlying kernel API will take care of the allocation and deallocation of
the subqueue memory, as well as netdev configuration of where the queues
exist in memory.</p>
<p>The base driver will also need to manage the queues as it does the global
netdev-&gt;queue_lock today.  Therefore base drivers should use the
netif_{start|stop|wake}_subqueue() functions to manage each queue while the
device is still operational.  netdev-&gt;queue_lock is still used when the device
comes online or when it’s completely shut down (<a class="reference internal" href="kapi.html#c.unregister_netdev" title="unregister_netdev"><code class="xref c c-func docutils literal notranslate"><span class="pre">unregister_netdev()</span></code></a>, etc.).</p>
</div>
</div>
<div class="section" id="section-2-qdisc-support-for-multiqueue-devices">
<h2>Section 2: Qdisc support for multiqueue devices<a class="headerlink" href="#section-2-qdisc-support-for-multiqueue-devices" title="Permalink to this headline">¶</a></h2>
<p>Currently two qdiscs are optimized for multiqueue devices.  The first is the
default pfifo_fast qdisc.  This qdisc supports one qdisc per hardware queue.
A new round-robin qdisc, sch_multiq also supports multiple hardware queues. The
qdisc is responsible for classifying the skb’s and then directing the skb’s to
bands and queues based on the value in skb-&gt;queue_mapping.  Use this field in
the base driver to determine which queue to send the skb to.</p>
<p>sch_multiq has been added for hardware that wishes to avoid head-of-line
blocking.  It will cycle though the bands and verify that the hardware queue
associated with the band is not stopped prior to dequeuing a packet.</p>
<p>On qdisc load, the number of bands is based on the number of queues on the
hardware.  Once the association is made, any skb with skb-&gt;queue_mapping set,
will be queued to the band associated with the hardware queue.</p>
</div>
<div class="section" id="section-3-brief-howto-using-multiq-for-multiqueue-devices">
<h2>Section 3: Brief howto using MULTIQ for multiqueue devices<a class="headerlink" href="#section-3-brief-howto-using-multiq-for-multiqueue-devices" title="Permalink to this headline">¶</a></h2>
<p>The userspace command ‘tc,’ part of the iproute2 package, is used to configure
qdiscs.  To add the MULTIQ qdisc to your network device, assuming the device
is called eth0, run the following command:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># tc qdisc add dev eth0 root handle 1: multiq
</pre></div>
</div>
<p>The qdisc will allocate the number of bands to equal the number of queues that
the device reports, and bring the qdisc online.  Assuming eth0 has 4 Tx
queues, the band mapping would look like:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>band 0 =&gt; queue 0
band 1 =&gt; queue 1
band 2 =&gt; queue 2
band 3 =&gt; queue 3
</pre></div>
</div>
<p>Traffic will begin flowing through each queue based on either the simple_tx_hash
function or based on netdev-&gt;select_queue() if you have it defined.</p>
<p>The behavior of tc filters remains the same.  However a new tc action,
skbedit, has been added.  Assuming you wanted to route all traffic to a
specific host, for example 192.168.0.3, through a specific queue you could use
this action and establish a filter such as:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>tc filter add dev eth0 parent 1: protocol ip prio 1 u32 \
        match ip dst 192.168.0.3 \
        action skbedit queue_mapping 3
</pre></div>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Author:</th><td class="field-body">Alexander Duyck &lt;<a class="reference external" href="mailto:alexander&#46;h&#46;duyck&#37;&#52;&#48;intel&#46;com">alexander<span>&#46;</span>h<span>&#46;</span>duyck<span>&#64;</span>intel<span>&#46;</span>com</a>&gt;</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Original Author:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body">Peter P. Waskiewicz Jr. &lt;<a class="reference external" href="mailto:peter&#46;p&#46;waskiewicz&#46;jr&#37;&#52;&#48;intel&#46;com">peter<span>&#46;</span>p<span>&#46;</span>waskiewicz<span>&#46;</span>jr<span>&#64;</span>intel<span>&#46;</span>com</a>&gt;</td>
</tr>
</tbody>
</table>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>