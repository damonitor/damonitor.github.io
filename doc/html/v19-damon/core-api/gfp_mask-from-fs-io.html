

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>GFP masks used from FS/IO context &mdash; The Linux Kernel  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.8.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/mm/damon/index.html">Monitoring Data Accesses</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../vm/damon/index.html">DAMON: Data Access MONitor</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>GFP masks used from FS/IO context</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/core-api/gfp_mask-from-fs-io.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="gfp-masks-used-from-fs-io-context">
<span id="gfp-mask-from-fs-io"></span><h1>GFP masks used from FS/IO context<a class="headerlink" href="#gfp-masks-used-from-fs-io-context" title="Permalink to this headline">¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Date:</th><td class="field-body">May, 2018</td>
</tr>
<tr class="field-even field"><th class="field-name">Author:</th><td class="field-body">Michal Hocko &lt;<a class="reference external" href="mailto:mhocko&#37;&#52;&#48;kernel&#46;org">mhocko<span>&#64;</span>kernel<span>&#46;</span>org</a>&gt;</td>
</tr>
</tbody>
</table>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Code paths in the filesystem and IO stacks must be careful when
allocating memory to prevent recursion deadlocks caused by direct
memory reclaim calling back into the FS or IO paths and blocking on
already held resources (e.g. locks - most commonly those used for the
transaction context).</p>
<p>The traditional way to avoid this deadlock problem is to clear __GFP_FS
respectively __GFP_IO (note the latter implies clearing the first as well) in
the gfp mask when calling an allocator. GFP_NOFS respectively GFP_NOIO can be
used as shortcut. It turned out though that above approach has led to
abuses when the restricted gfp mask is used “just in case” without a
deeper consideration which leads to problems because an excessive use
of GFP_NOFS/GFP_NOIO can lead to memory over-reclaim or other memory
reclaim issues.</p>
</div>
<div class="section" id="new-api">
<h2>New API<a class="headerlink" href="#new-api" title="Permalink to this headline">¶</a></h2>
<p>Since 4.12 we do have a generic scope API for both NOFS and NOIO context
<code class="docutils literal notranslate"><span class="pre">memalloc_nofs_save</span></code>, <code class="docutils literal notranslate"><span class="pre">memalloc_nofs_restore</span></code> respectively <code class="docutils literal notranslate"><span class="pre">memalloc_noio_save</span></code>,
<code class="docutils literal notranslate"><span class="pre">memalloc_noio_restore</span></code> which allow to mark a scope to be a critical
section from a filesystem or I/O point of view. Any allocation from that
scope will inherently drop __GFP_FS respectively __GFP_IO from the given
mask so no memory allocation can recurse back in the FS/IO.</p>
<dl class="function">
<dt id="c.memalloc_nofs_save">
unsigned int <code class="descname">memalloc_nofs_save</code><span class="sig-paren">(</span>void<span class="sig-paren">)</span><a class="headerlink" href="#c.memalloc_nofs_save" title="Permalink to this definition">¶</a></dt>
<dd><p>Marks implicit GFP_NOFS allocation scope.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">void</span></code></dt>
<dd>no arguments</dd>
</dl>
<p><strong>Description</strong></p>
<p>This functions marks the beginning of the GFP_NOFS allocation scope.
All further allocations will implicitly drop __GFP_FS flag and so
they are safe for the FS critical section from the allocation recursion
point of view. Use memalloc_nofs_restore to end the scope with flags
returned by this function.</p>
<p>This function is safe to be used from any context.</p>
<dl class="function">
<dt id="c.memalloc_nofs_restore">
void <code class="descname">memalloc_nofs_restore</code><span class="sig-paren">(</span>unsigned int<em>&nbsp;flags</em><span class="sig-paren">)</span><a class="headerlink" href="#c.memalloc_nofs_restore" title="Permalink to this definition">¶</a></dt>
<dd><p>Ends the implicit GFP_NOFS scope.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">unsigned</span> <span class="pre">int</span> <span class="pre">flags</span></code></dt>
<dd>Flags to restore.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Ends the implicit GFP_NOFS scope started by memalloc_nofs_save function.
Always make sure that that the given flags is the return value from the
pairing memalloc_nofs_save call.</p>
<dl class="function">
<dt id="c.memalloc_noio_save">
unsigned int <code class="descname">memalloc_noio_save</code><span class="sig-paren">(</span>void<span class="sig-paren">)</span><a class="headerlink" href="#c.memalloc_noio_save" title="Permalink to this definition">¶</a></dt>
<dd><p>Marks implicit GFP_NOIO allocation scope.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">void</span></code></dt>
<dd>no arguments</dd>
</dl>
<p><strong>Description</strong></p>
<p>This functions marks the beginning of the GFP_NOIO allocation scope.
All further allocations will implicitly drop __GFP_IO flag and so
they are safe for the IO critical section from the allocation recursion
point of view. Use memalloc_noio_restore to end the scope with flags
returned by this function.</p>
<p>This function is safe to be used from any context.</p>
<dl class="function">
<dt id="c.memalloc_noio_restore">
void <code class="descname">memalloc_noio_restore</code><span class="sig-paren">(</span>unsigned int<em>&nbsp;flags</em><span class="sig-paren">)</span><a class="headerlink" href="#c.memalloc_noio_restore" title="Permalink to this definition">¶</a></dt>
<dd><p>Ends the implicit GFP_NOIO scope.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">unsigned</span> <span class="pre">int</span> <span class="pre">flags</span></code></dt>
<dd>Flags to restore.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Ends the implicit GFP_NOIO scope started by memalloc_noio_save function.
Always make sure that that the given flags is the return value from the
pairing memalloc_noio_save call.</p>
<p>FS/IO code then simply calls the appropriate save function before
any critical section with respect to the reclaim is started - e.g.
lock shared with the reclaim context or when a transaction context
nesting would be possible via reclaim. The restore function should be
called when the critical section ends. All that ideally along with an
explanation what is the reclaim context for easier maintenance.</p>
<p>Please note that the proper pairing of save/restore functions
allows nesting so it is safe to call <code class="docutils literal notranslate"><span class="pre">memalloc_noio_save</span></code> or
<code class="docutils literal notranslate"><span class="pre">memalloc_noio_restore</span></code> respectively from an existing NOIO or NOFS
scope.</p>
</div>
<div class="section" id="what-about-vmalloc-gfp-nofs">
<h2>What about __vmalloc(GFP_NOFS)<a class="headerlink" href="#what-about-vmalloc-gfp-nofs" title="Permalink to this headline">¶</a></h2>
<p>vmalloc doesn’t support GFP_NOFS semantic because there are hardcoded
GFP_KERNEL allocations deep inside the allocator which are quite non-trivial
to fix up. That means that calling <code class="docutils literal notranslate"><span class="pre">vmalloc</span></code> with GFP_NOFS/GFP_NOIO is
almost always a bug. The good news is that the NOFS/NOIO semantic can be
achieved by the scope API.</p>
<p>In the ideal world, upper layers should already mark dangerous contexts
and so no special care is required and vmalloc should be called without
any problems. Sometimes if the context is not really clear or there are
layering violations then the recommended way around that is to wrap <code class="docutils literal notranslate"><span class="pre">vmalloc</span></code>
by the scope API with a comment explaining the problem.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>