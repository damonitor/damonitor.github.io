

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Texas Instruments CPSW switchdev based ethernet driver &mdash; The Linux Kernel  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../../../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.8.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../admin-guide/mm/damon/index.html">Monitoring Data Accesses</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../vm/damon/index.html">DAMON: Data Access MONitor</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
      <li>Texas Instruments CPSW switchdev based ethernet driver</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/networking/device_drivers/ti/cpsw_switchdev.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="texas-instruments-cpsw-switchdev-based-ethernet-driver">
<h1>Texas Instruments CPSW switchdev based ethernet driver<a class="headerlink" href="#texas-instruments-cpsw-switchdev-based-ethernet-driver" title="Permalink to this headline">¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Version:</th><td class="field-body">2.0</td>
</tr>
</tbody>
</table>
<div class="section" id="port-renaming">
<h2>Port renaming<a class="headerlink" href="#port-renaming" title="Permalink to this headline">¶</a></h2>
<p>On older udev versions renaming of ethX to swXpY will not be automatically
supported</p>
<p>In order to rename via udev:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ip -d link show dev sw0p1 | grep switchid

SUBSYSTEM==&quot;net&quot;, ACTION==&quot;add&quot;, ATTR{phys_switch_id}==&lt;switchid&gt;, \
        ATTR{phys_port_name}!=&quot;&quot;, NAME=&quot;sw0$attr{phys_port_name}&quot;
</pre></div>
</div>
</div>
<div class="section" id="dual-mac-mode">
<h2>Dual mac mode<a class="headerlink" href="#dual-mac-mode" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>The new (cpsw_new.c) driver is operating in dual-emac mode by default, thus
working as 2 individual network interfaces. Main differences from legacy CPSW
driver are:</li>
</ul>
<blockquote>
<div><ul>
<li><p class="first">optimized promiscuous mode: The P0_UNI_FLOOD (both ports) is enabled in
addition to ALLMULTI (current port) instead of ALE_BYPASS.
So, Ports in promiscuous mode will keep possibility of mcast and vlan
filtering, which is provides significant benefits when ports are joined
to the same bridge, but without enabling “switch” mode, or to different
bridges.</p>
</li>
<li><p class="first">learning disabled on ports as it make not too much sense for
segregated ports - no forwarding in HW.</p>
</li>
<li><p class="first">enabled basic support for devlink.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>devlink dev show
        platform/48484000.switch

devlink dev param show
platform/48484000.switch:
name switch_mode type driver-specific
values:
        cmode runtime value false
name ale_bypass type driver-specific
values:
        cmode runtime value false
</pre></div>
</div>
</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="devlink-configuration-parameters">
<h2>Devlink configuration parameters<a class="headerlink" href="#devlink-configuration-parameters" title="Permalink to this headline">¶</a></h2>
<p>See Documentation/networking/devlink/ti-cpsw-switch.rst</p>
</div>
<div class="section" id="bridging-in-dual-mac-mode">
<h2>Bridging in dual mac mode<a class="headerlink" href="#bridging-in-dual-mac-mode" title="Permalink to this headline">¶</a></h2>
<p>The dual_mac mode requires two vids to be reserved for internal purposes,
which, by default, equal CPSW Port numbers. As result, bridge has to be
configured in vlan unaware mode or default_pvid has to be adjusted:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ip link add name br0 type bridge
ip link set dev br0 type bridge vlan_filtering 0
echo 0 &gt; /sys/class/net/br0/bridge/default_pvid
ip link set dev sw0p1 master br0
ip link set dev sw0p2 master br0
</pre></div>
</div>
<p>or:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ip link add name br0 type bridge
ip link set dev br0 type bridge vlan_filtering 0
echo 100 &gt; /sys/class/net/br0/bridge/default_pvid
ip link set dev br0 type bridge vlan_filtering 1
ip link set dev sw0p1 master br0
ip link set dev sw0p2 master br0
</pre></div>
</div>
</div>
<div class="section" id="enabling-switch">
<h2>Enabling “switch”<a class="headerlink" href="#enabling-switch" title="Permalink to this headline">¶</a></h2>
<p>The Switch mode can be enabled by configuring devlink driver parameter
“switch_mode” to 1/true:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>devlink dev param set platform/48484000.switch \
name switch_mode value 1 cmode runtime
</pre></div>
</div>
<p>This can be done regardless of the state of Port’s netdev devices - UP/DOWN, but
Port’s netdev devices have to be in UP before joining to the bridge to avoid
overwriting of bridge configuration as CPSW switch driver copletly reloads its
configuration when first Port changes its state to UP.</p>
<p>When the both interfaces joined the bridge - CPSW switch driver will enable
marking packets with offload_fwd_mark flag unless “ale_bypass=0”</p>
<p>All configuration is implemented via switchdev API.</p>
</div>
<div class="section" id="bridge-setup">
<h2>Bridge setup<a class="headerlink" href="#bridge-setup" title="Permalink to this headline">¶</a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>devlink dev param set platform/48484000.switch \
name switch_mode value 1 cmode runtime

ip link add name br0 type bridge
ip link set dev br0 type bridge ageing_time 1000
ip link set dev sw0p1 up
ip link set dev sw0p2 up
ip link set dev sw0p1 master br0
ip link set dev sw0p2 master br0

[*] bridge vlan add dev br0 vid 1 pvid untagged self

[*] if vlan_filtering=1. where default_pvid=1

Note. Steps [*] are mandatory.
</pre></div>
</div>
</div>
<div class="section" id="on-off-stp">
<h2>On/off STP<a class="headerlink" href="#on-off-stp" title="Permalink to this headline">¶</a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ip link set dev BRDEV type bridge stp_state 1/0
</pre></div>
</div>
</div>
<div class="section" id="vlan-configuration">
<h2>VLAN configuration<a class="headerlink" href="#vlan-configuration" title="Permalink to this headline">¶</a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>bridge vlan add dev br0 vid 1 pvid untagged self &lt;---- add cpu port to VLAN 1
</pre></div>
</div>
<p>Note. This step is mandatory for bridge/default_pvid.</p>
</div>
<div class="section" id="add-extra-vlans">
<h2>Add extra VLANs<a class="headerlink" href="#add-extra-vlans" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ol class="arabic">
<li><p class="first">untagged:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>bridge vlan add dev sw0p1 vid 100 pvid untagged master
bridge vlan add dev sw0p2 vid 100 pvid untagged master
bridge vlan add dev br0 vid 100 pvid untagged self &lt;---- Add cpu port to VLAN100
</pre></div>
</div>
</li>
<li><p class="first">tagged:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>bridge vlan add dev sw0p1 vid 100 master
bridge vlan add dev sw0p2 vid 100 master
bridge vlan add dev br0 vid 100 pvid tagged self &lt;---- Add cpu port to VLAN100
</pre></div>
</div>
</li>
</ol>
</div></blockquote>
<div class="section" id="fdbs">
<h3>FDBs<a class="headerlink" href="#fdbs" title="Permalink to this headline">¶</a></h3>
<p>FDBs are automatically added on the appropriate switch port upon detection</p>
<p>Manually adding FDBs:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>bridge fdb add aa:bb:cc:dd:ee:ff dev sw0p1 master vlan 100
bridge fdb add aa:bb:cc:dd:ee:fe dev sw0p2 master &lt;---- Add on all VLANs
</pre></div>
</div>
</div>
<div class="section" id="mdbs">
<h3>MDBs<a class="headerlink" href="#mdbs" title="Permalink to this headline">¶</a></h3>
<p>MDBs are automatically added on the appropriate switch port upon detection</p>
<p>Manually adding MDBs:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>bridge mdb add dev br0 port sw0p1 grp 239.1.1.1 permanent vid 100
bridge mdb add dev br0 port sw0p1 grp 239.1.1.1 permanent &lt;---- Add on all VLANs
</pre></div>
</div>
</div>
</div>
<div class="section" id="multicast-flooding">
<h2>Multicast flooding<a class="headerlink" href="#multicast-flooding" title="Permalink to this headline">¶</a></h2>
<p>CPU port mcast_flooding is always on</p>
<p>Turning flooding on/off on swithch ports:
bridge link set dev sw0p1 mcast_flood on/off</p>
</div>
<div class="section" id="access-and-trunk-port">
<h2>Access and Trunk port<a class="headerlink" href="#access-and-trunk-port" title="Permalink to this headline">¶</a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>bridge vlan add dev sw0p1 vid 100 pvid untagged master
bridge vlan add dev sw0p2 vid 100 master


bridge vlan add dev br0 vid 100 self
ip link add link br0 name br0.100 type vlan id 100
</pre></div>
</div>
<p>Note. Setting PVID on Bridge device itself working only for
default VLAN (default_pvid).</p>
</div>
<div class="section" id="nfs">
<h2>NFS<a class="headerlink" href="#nfs" title="Permalink to this headline">¶</a></h2>
<p>The only way for NFS to work is by chrooting to a minimal environment when
switch configuration that will affect connectivity is needed.
Assuming you are booting NFS with eth1 interface(the script is hacky and
it’s just there to prove NFS is doable).</p>
<p>setup.sh:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#!/bin/sh
mkdir proc
mount -t proc none /proc
ifconfig br0  &gt; /dev/null
if [ $? -ne 0 ]; then
        echo &quot;Setting up bridge&quot;
        ip link add name br0 type bridge
        ip link set dev br0 type bridge ageing_time 1000
        ip link set dev br0 type bridge vlan_filtering 1

        ip link set eth1 down
        ip link set eth1 name sw0p1
        ip link set dev sw0p1 up
        ip link set dev sw0p2 up
        ip link set dev sw0p2 master br0
        ip link set dev sw0p1 master br0
        bridge vlan add dev br0 vid 1 pvid untagged self
        ifconfig sw0p1 0.0.0.0
        udhchc -i br0
fi
umount /proc
</pre></div>
</div>
<p>run_nfs.sh::</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#!/bin/sh
mkdir /tmp/root/bin -p
mkdir /tmp/root/lib -p

cp -r /lib/ /tmp/root/
cp -r /bin/ /tmp/root/
cp /sbin/ip /tmp/root/bin
cp /sbin/bridge /tmp/root/bin
cp /sbin/ifconfig /tmp/root/bin
cp /sbin/udhcpc /tmp/root/bin
cp /path/to/setup.sh /tmp/root/bin
chroot /tmp/root/ busybox sh /bin/setup.sh

run ./run_nfs.sh
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>