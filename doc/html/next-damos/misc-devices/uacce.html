

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Introduction of Uacce &mdash; The Linux Kernel  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.7.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/mm/damon/index.html">Monitoring Data Accesses</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../vm/damon/index.html">DAMON: Data Access MONitor</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Introduction of Uacce</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/misc-devices/uacce.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="introduction-of-uacce">
<h1>Introduction of Uacce<a class="headerlink" href="#introduction-of-uacce" title="Permalink to this headline">¶</a></h1>
<p>Uacce (Unified/User-space-access-intended Accelerator Framework) targets to
provide Shared Virtual Addressing (SVA) between accelerators and processes.
So accelerator can access any data structure of the main cpu.
This differs from the data sharing between cpu and io device, which share
only data content rather than address.
Because of the unified address, hardware and user space of process can
share the same virtual address in the communication.
Uacce takes the hardware accelerator as a heterogeneous processor, while
IOMMU share the same CPU page tables and as a result the same translation
from va to pa.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span> __________________________       __________________________
|                          |     |                          |
|  User application (CPU)  |     |   Hardware Accelerator   |
|__________________________|     |__________________________|

             |                                 |
             | va                              | va
             V                                 V
         __________                        __________
        |          |                      |          |
        |   MMU    |                      |  IOMMU   |
        |__________|                      |__________|
             |                                 |
             |                                 |
             V pa                              V pa
         _______________________________________
        |                                       |
        |              Memory                   |
        |_______________________________________|
</pre></div>
</div>
</div>
<div class="section" id="architecture">
<h1>Architecture<a class="headerlink" href="#architecture" title="Permalink to this headline">¶</a></h1>
<p>Uacce is the kernel module, taking charge of iommu and address sharing.
The user drivers and libraries are called WarpDrive.</p>
<p>The uacce device, built around the IOMMU SVA API, can access multiple
address spaces, including the one without PASID.</p>
<p>A virtual concept, queue, is used for the communication. It provides a
FIFO-like interface. And it maintains a unified address space between the
application and all involved hardware.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>                         ___________________                  ________________
                        |                   |   user API     |                |
                        | WarpDrive library | ------------&gt;  |  user driver   |
                        |___________________|                |________________|
                                 |                                    |
                                 |                                    |
                                 | queue fd                           |
                                 |                                    |
                                 |                                    |
                                 v                                    |
 ___________________         _________                                |
|                   |       |         |                               | mmap memory
| Other framework   |       |  uacce  |                               | r/w interface
| crypto/nic/others |       |_________|                               |
|___________________|                                                 |
         |                       |                                    |
         | register              | register                           |
         |                       |                                    |
         |                       |                                    |
         |                _________________       __________          |
         |               |                 |     |          |         |
          -------------  |  Device Driver  |     |  IOMMU   |         |
                         |_________________|     |__________|         |
                                 |                                    |
                                 |                                    V
                                 |                            ___________________
                                 |                           |                   |
                                 --------------------------  |  Device(Hardware) |
                                                             |___________________|
</pre></div>
</div>
</div>
<div class="section" id="how-does-it-work">
<h1>How does it work<a class="headerlink" href="#how-does-it-work" title="Permalink to this headline">¶</a></h1>
<p>Uacce uses mmap and IOMMU to play the trick.</p>
<p>Uacce creates a chrdev for every device registered to it. New queue is
created when user application open the chrdev. The file descriptor is used
as the user handle of the queue.
The accelerator device present itself as an Uacce object, which exports as
a chrdev to the user space. The user application communicates with the
hardware by ioctl (as control path) or share memory (as data path).</p>
<p>The control path to the hardware is via file operation, while data path is
via mmap space of the queue fd.</p>
<p>The queue file address space:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span> /**
 * enum uacce_qfrt: qfrt type
 * @UACCE_QFRT_MMIO: device mmio region
 * @UACCE_QFRT_DUS: device user share region
 */
enum uacce_qfrt {
        UACCE_QFRT_MMIO = 0,
        UACCE_QFRT_DUS = 1,
};
</pre></div>
</div>
<p>All regions are optional and differ from device type to type.
Each region can be mmapped only once, otherwise -EEXIST returns.</p>
<p>The device mmio region is mapped to the hardware mmio space. It is generally
used for doorbell or other notification to the hardware. It is not fast enough
as data channel.</p>
<p>The device user share region is used for share data buffer between user process
and device.</p>
</div>
<div class="section" id="the-uacce-register-api">
<h1>The Uacce register API<a class="headerlink" href="#the-uacce-register-api" title="Permalink to this headline">¶</a></h1>
<p>The register API is defined in uacce.h.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct uacce_interface {
  char name[UACCE_MAX_NAME_SIZE];
  unsigned int flags;
  const struct uacce_ops *ops;
};
</pre></div>
</div>
<p>According to the IOMMU capability, uacce_interface flags can be:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/**
 * UACCE Device flags:
 * UACCE_DEV_SVA: Shared Virtual Addresses
 *              Support PASID
 *              Support device page faults (PCI PRI or SMMU Stall)
 */
#define UACCE_DEV_SVA               BIT(0)

struct uacce_device *uacce_alloc(struct device *parent,
                                 struct uacce_interface *interface);
int uacce_register(struct uacce_device *uacce);
void uacce_remove(struct uacce_device *uacce);
</pre></div>
</div>
<p>uacce_register results can be:</p>
<ol class="loweralpha simple">
<li>If uacce module is not compiled, ERR_PTR(-ENODEV)</li>
<li>Succeed with the desired flags</li>
<li>Succeed with the negotiated flags, for example</li>
</ol>
<blockquote>
<div><p>uacce_interface.flags = UACCE_DEV_SVA but uacce-&gt;flags = ~UACCE_DEV_SVA</p>
<p>So user driver need check return value as well as the negotiated uacce-&gt;flags.</p>
</div></blockquote>
</div>
<div class="section" id="the-user-driver">
<h1>The user driver<a class="headerlink" href="#the-user-driver" title="Permalink to this headline">¶</a></h1>
<p>The queue file mmap space will need a user driver to wrap the communication
protocol. Uacce provides some attributes in sysfs for the user driver to
match the right accelerator accordingly.
More details in Documentation/ABI/testing/sysfs-driver-uacce.</p>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>