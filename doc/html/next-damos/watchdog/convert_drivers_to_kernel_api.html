

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Converting old watchdog drivers to the watchdog framework &mdash; The Linux Kernel  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.6.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/mm/damon/index.html">DAMON: Data Access MONitor</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Converting old watchdog drivers to the watchdog framework</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/watchdog/convert_drivers_to_kernel_api.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="converting-old-watchdog-drivers-to-the-watchdog-framework">
<h1>Converting old watchdog drivers to the watchdog framework<a class="headerlink" href="#converting-old-watchdog-drivers-to-the-watchdog-framework" title="Permalink to this headline">¶</a></h1>
<p>by Wolfram Sang &lt;<a class="reference external" href="mailto:w&#46;sang&#37;&#52;&#48;pengutronix&#46;de">w<span>&#46;</span>sang<span>&#64;</span>pengutronix<span>&#46;</span>de</a>&gt;</p>
<p>Before the watchdog framework came into the kernel, every driver had to
implement the API on its own. Now, as the framework factored out the common
components, those drivers can be lightened making it a user of the framework.
This document shall guide you for this task. The necessary steps are described
as well as things to look out for.</p>
<div class="section" id="remove-the-file-operations-struct">
<h2>Remove the file_operations struct<a class="headerlink" href="#remove-the-file-operations-struct" title="Permalink to this headline">¶</a></h2>
<p>Old drivers define their own file_operations for actions like open(), write(),
etc… These are now handled by the framework and just call the driver when
needed. So, in general, the ‘file_operations’ struct and assorted functions can
go. Only very few driver-specific details have to be moved to other functions.
Here is a overview of the functions and probably needed actions:</p>
<ul>
<li><p class="first">open: Everything dealing with resource management (file-open checks, magic
close preparations) can simply go. Device specific stuff needs to go to the
driver specific start-function. Note that for some drivers, the start-function
also serves as the ping-function. If that is the case and you need start/stop
to be balanced (clocks!), you are better off refactoring a separate start-function.</p>
</li>
<li><p class="first">close: Same hints as for open apply.</p>
</li>
<li><p class="first">write: Can simply go, all defined behaviour is taken care of by the framework,
i.e. ping on write and magic char (‘V’) handling.</p>
</li>
<li><p class="first">ioctl: While the driver is allowed to have extensions to the IOCTL interface,
the most common ones are handled by the framework, supported by some assistance
from the driver:</p>
<blockquote>
<div><dl class="docutils">
<dt>WDIOC_GETSUPPORT:</dt>
<dd><p class="first last">Returns the mandatory watchdog_info struct from the driver</p>
</dd>
<dt>WDIOC_GETSTATUS:</dt>
<dd><p class="first last">Needs the status-callback defined, otherwise returns 0</p>
</dd>
<dt>WDIOC_GETBOOTSTATUS:</dt>
<dd><p class="first last">Needs the bootstatus member properly set. Make sure it is 0 if you
don’t have further support!</p>
</dd>
<dt>WDIOC_SETOPTIONS:</dt>
<dd><p class="first last">No preparations needed</p>
</dd>
<dt>WDIOC_KEEPALIVE:</dt>
<dd><p class="first last">If wanted, options in watchdog_info need to have WDIOF_KEEPALIVEPING
set</p>
</dd>
<dt>WDIOC_SETTIMEOUT:</dt>
<dd><p class="first last">Options in watchdog_info need to have WDIOF_SETTIMEOUT set
and a set_timeout-callback has to be defined. The core will also
do limit-checking, if min_timeout and max_timeout in the watchdog
device are set. All is optional.</p>
</dd>
<dt>WDIOC_GETTIMEOUT:</dt>
<dd><p class="first last">No preparations needed</p>
</dd>
<dt>WDIOC_GETTIMELEFT:</dt>
<dd><p class="first last">It needs get_timeleft() callback to be defined. Otherwise it
will return EOPNOTSUPP</p>
</dd>
</dl>
</div></blockquote>
<p>Other IOCTLs can be served using the ioctl-callback. Note that this is mainly
intended for porting old drivers; new drivers should not invent private IOCTLs.
Private IOCTLs are processed first. When the callback returns with
-ENOIOCTLCMD, the IOCTLs of the framework will be tried, too. Any other error
is directly given to the user.</p>
</li>
</ul>
<p>Example conversion:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>-static const struct file_operations s3c2410wdt_fops = {
-       .owner          = THIS_MODULE,
-       .llseek         = no_llseek,
-       .write          = s3c2410wdt_write,
-       .unlocked_ioctl = s3c2410wdt_ioctl,
-       .open           = s3c2410wdt_open,
-       .release        = s3c2410wdt_release,
-};
</pre></div>
</div>
<p>Check the functions for device-specific stuff and keep it for later
refactoring. The rest can go.</p>
</div>
<div class="section" id="remove-the-miscdevice">
<h2>Remove the miscdevice<a class="headerlink" href="#remove-the-miscdevice" title="Permalink to this headline">¶</a></h2>
<p>Since the file_operations are gone now, you can also remove the ‘struct
miscdevice’. The framework will create it on watchdog_dev_register() called by
watchdog_register_device():</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>-static struct miscdevice s3c2410wdt_miscdev = {
-       .minor          = WATCHDOG_MINOR,
-       .name           = &quot;watchdog&quot;,
-       .fops           = &amp;s3c2410wdt_fops,
-};
</pre></div>
</div>
</div>
<div class="section" id="remove-obsolete-includes-and-defines">
<h2>Remove obsolete includes and defines<a class="headerlink" href="#remove-obsolete-includes-and-defines" title="Permalink to this headline">¶</a></h2>
<p>Because of the simplifications, a few defines are probably unused now. Remove
them. Includes can be removed, too. For example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>- #include &lt;linux/fs.h&gt;
- #include &lt;linux/miscdevice.h&gt; (if MODULE_ALIAS_MISCDEV is not used)
- #include &lt;linux/uaccess.h&gt; (if no custom IOCTLs are used)
</pre></div>
</div>
</div>
<div class="section" id="add-the-watchdog-operations">
<h2>Add the watchdog operations<a class="headerlink" href="#add-the-watchdog-operations" title="Permalink to this headline">¶</a></h2>
<p>All possible callbacks are defined in ‘struct watchdog_ops’. You can find it
explained in ‘watchdog-kernel-api.txt’ in this directory. start(), stop() and
owner must be set, the rest are optional. You will easily find corresponding
functions in the old driver. Note that you will now get a pointer to the
watchdog_device as a parameter to these functions, so you probably have to
change the function header. Other changes are most likely not needed, because
here simply happens the direct hardware access. If you have device-specific
code left from the above steps, it should be refactored into these callbacks.</p>
<p>Here is a simple example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+static struct watchdog_ops s3c2410wdt_ops = {
+       .owner = THIS_MODULE,
+       .start = s3c2410wdt_start,
+       .stop = s3c2410wdt_stop,
+       .ping = s3c2410wdt_keepalive,
+       .set_timeout = s3c2410wdt_set_heartbeat,
+};
</pre></div>
</div>
<p>A typical function-header change looks like:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>-static void s3c2410wdt_keepalive(void)
+static int s3c2410wdt_keepalive(struct watchdog_device *wdd)
 {
...
+
+       return 0;
 }

...

-       s3c2410wdt_keepalive();
+       s3c2410wdt_keepalive(&amp;s3c2410_wdd);
</pre></div>
</div>
</div>
<div class="section" id="add-the-watchdog-device">
<h2>Add the watchdog device<a class="headerlink" href="#add-the-watchdog-device" title="Permalink to this headline">¶</a></h2>
<p>Now we need to create a ‘struct watchdog_device’ and populate it with the
necessary information for the framework. The struct is also explained in detail
in ‘watchdog-kernel-api.txt’ in this directory. We pass it the mandatory
watchdog_info struct and the newly created watchdog_ops. Often, old drivers
have their own record-keeping for things like bootstatus and timeout using
static variables. Those have to be converted to use the members in
watchdog_device. Note that the timeout values are unsigned int. Some drivers
use signed int, so this has to be converted, too.</p>
<p>Here is a simple example for a watchdog device:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+static struct watchdog_device s3c2410_wdd = {
+       .info = &amp;s3c2410_wdt_ident,
+       .ops = &amp;s3c2410wdt_ops,
+};
</pre></div>
</div>
</div>
<div class="section" id="handle-the-nowayout-feature">
<h2>Handle the ‘nowayout’ feature<a class="headerlink" href="#handle-the-nowayout-feature" title="Permalink to this headline">¶</a></h2>
<p>A few drivers use nowayout statically, i.e. there is no module parameter for it
and only CONFIG_WATCHDOG_NOWAYOUT determines if the feature is going to be
used. This needs to be converted by initializing the status variable of the
watchdog_device like this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>.status = WATCHDOG_NOWAYOUT_INIT_STATUS,
</pre></div>
</div>
<p>Most drivers, however, also allow runtime configuration of nowayout, usually
by adding a module parameter. The conversion for this would be something like:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>watchdog_set_nowayout(&amp;s3c2410_wdd, nowayout);
</pre></div>
</div>
<p>The module parameter itself needs to stay, everything else related to nowayout
can go, though. This will likely be some code in open(), close() or write().</p>
</div>
<div class="section" id="register-the-watchdog-device">
<h2>Register the watchdog device<a class="headerlink" href="#register-the-watchdog-device" title="Permalink to this headline">¶</a></h2>
<p>Replace misc_register(&amp;miscdev) with watchdog_register_device(&amp;watchdog_dev).
Make sure the return value gets checked and the error message, if present,
still fits. Also convert the unregister case:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>-       ret = misc_register(&amp;s3c2410wdt_miscdev);
+       ret = watchdog_register_device(&amp;s3c2410_wdd);

...

-       misc_deregister(&amp;s3c2410wdt_miscdev);
+       watchdog_unregister_device(&amp;s3c2410_wdd);
</pre></div>
</div>
</div>
<div class="section" id="update-the-kconfig-entry">
<h2>Update the Kconfig-entry<a class="headerlink" href="#update-the-kconfig-entry" title="Permalink to this headline">¶</a></h2>
<p>The entry for the driver now needs to select WATCHDOG_CORE:</p>
<blockquote>
<div><ul class="simple">
<li>select WATCHDOG_CORE</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="create-a-patch-and-send-it-to-upstream">
<h2>Create a patch and send it to upstream<a class="headerlink" href="#create-a-patch-and-send-it-to-upstream" title="Permalink to this headline">¶</a></h2>
<p>Make sure you understood Documentation/process/submitting-patches.rst and send your patch to
<a class="reference external" href="mailto:linux-watchdog&#37;&#52;&#48;vger&#46;kernel&#46;org">linux-watchdog<span>&#64;</span>vger<span>&#46;</span>kernel<span>&#46;</span>org</a>. We are looking forward to it :)</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>