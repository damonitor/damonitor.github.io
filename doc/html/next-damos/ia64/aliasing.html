

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Memory Attribute Aliasing on IA-64 &mdash; The Linux Kernel  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.7.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/mm/damon/index.html">Monitoring Data Accesses</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../vm/damon/index.html">DAMON: Data Access MONitor</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Memory Attribute Aliasing on IA-64</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/ia64/aliasing.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="memory-attribute-aliasing-on-ia-64">
<h1>Memory Attribute Aliasing on IA-64<a class="headerlink" href="#memory-attribute-aliasing-on-ia-64" title="Permalink to this headline">¶</a></h1>
<p>Bjorn Helgaas &lt;<a class="reference external" href="mailto:bjorn&#46;helgaas&#37;&#52;&#48;hp&#46;com">bjorn<span>&#46;</span>helgaas<span>&#64;</span>hp<span>&#46;</span>com</a>&gt;</p>
<p>May 4, 2006</p>
<div class="section" id="memory-attributes">
<h2>Memory Attributes<a class="headerlink" href="#memory-attributes" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Itanium supports several attributes for virtual memory references.
The attribute is part of the virtual translation, i.e., it is
contained in the TLB entry.  The ones of most interest to the Linux
kernel are:</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="8%" />
<col width="92%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>WB</td>
<td>Write-back (cacheable)</td>
</tr>
<tr class="row-even"><td>UC</td>
<td>Uncacheable</td>
</tr>
<tr class="row-odd"><td>WC</td>
<td>Write-coalescing</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>System memory typically uses the WB attribute.  The UC attribute is
used for memory-mapped I/O devices.  The WC attribute is uncacheable
like UC is, but writes may be delayed and combined to increase
performance for things like frame buffers.</p>
<p>The Itanium architecture requires that we avoid accessing the same
page with both a cacheable mapping and an uncacheable mapping[1].</p>
<p>The design of the chipset determines which attributes are supported
on which regions of the address space.  For example, some chipsets
support either WB or UC access to main memory, while others support
only WB access.</p>
</div></blockquote>
</div>
<div class="section" id="memory-map">
<h2>Memory Map<a class="headerlink" href="#memory-map" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Platform firmware describes the physical memory map and the
supported attributes for each region.  At boot-time, the kernel uses
the EFI GetMemoryMap() interface.  ACPI can also describe memory
devices and the attributes they support, but Linux/ia64 currently
doesn’t use this information.</p>
<p>The kernel uses the efi_memmap table returned from GetMemoryMap() to
learn the attributes supported by each region of physical address
space.  Unfortunately, this table does not completely describe the
address space because some machines omit some or all of the MMIO
regions from the map.</p>
<p>The kernel maintains another table, kern_memmap, which describes the
memory Linux is actually using and the attribute for each region.
This contains only system memory; it does not contain MMIO space.</p>
<p>The kern_memmap table typically contains only a subset of the system
memory described by the efi_memmap.  Linux/ia64 can’t use all memory
in the system because of constraints imposed by the identity mapping
scheme.</p>
<p>The efi_memmap table is preserved unmodified because the original
boot-time information is required for kexec.</p>
</div></blockquote>
</div>
<div class="section" id="kernel-identify-mappings">
<h2>Kernel Identify Mappings<a class="headerlink" href="#kernel-identify-mappings" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Linux/ia64 identity mappings are done with large pages, currently
either 16MB or 64MB, referred to as “granules.”  Cacheable mappings
are speculative[2], so the processor can read any location in the
page at any time, independent of the programmer’s intentions.  This
means that to avoid attribute aliasing, Linux can create a cacheable
identity mapping only when the entire granule supports cacheable
access.</p>
<p>Therefore, kern_memmap contains only full granule-sized regions that
can referenced safely by an identity mapping.</p>
<p>Uncacheable mappings are not speculative, so the processor will
generate UC accesses only to locations explicitly referenced by
software.  This allows UC identity mappings to cover granules that
are only partially populated, or populated with a combination of UC
and WB regions.</p>
</div></blockquote>
</div>
<div class="section" id="user-mappings">
<h2>User Mappings<a class="headerlink" href="#user-mappings" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div>User mappings are typically done with 16K or 64K pages.  The smaller
page size allows more flexibility because only 16K or 64K has to be
homogeneous with respect to memory attributes.</div></blockquote>
</div>
<div class="section" id="potential-attribute-aliasing-cases">
<h2>Potential Attribute Aliasing Cases<a class="headerlink" href="#potential-attribute-aliasing-cases" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div>There are several ways the kernel creates new mappings:</div></blockquote>
<div class="section" id="mmap-of-dev-mem">
<h3>mmap of /dev/mem<a class="headerlink" href="#mmap-of-dev-mem" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>This uses <a class="reference internal" href="../core-api/mm-api.html#c.remap_pfn_range" title="remap_pfn_range"><code class="xref c c-func docutils literal notranslate"><span class="pre">remap_pfn_range()</span></code></a>, which creates user mappings.  These
mappings may be either WB or UC.  If the region being mapped
happens to be in kern_memmap, meaning that it may also be mapped
by a kernel identity mapping, the user mapping must use the same
attribute as the kernel mapping.</p>
<p>If the region is not in kern_memmap, the user mapping should use
an attribute reported as being supported in the EFI memory map.</p>
<p>Since the EFI memory map does not describe MMIO on some
machines, this should use an uncacheable mapping as a fallback.</p>
</div></blockquote>
</div>
<div class="section" id="mmap-of-sys-class-pci-bus-legacy-mem">
<h3>mmap of /sys/class/pci_bus/…/legacy_mem<a class="headerlink" href="#mmap-of-sys-class-pci-bus-legacy-mem" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>This is very similar to mmap of /dev/mem, except that legacy_mem
only allows mmap of the one megabyte “legacy MMIO” area for a
specific PCI bus.  Typically this is the first megabyte of
physical address space, but it may be different on machines with
several VGA devices.</p>
<p>“X” uses this to access VGA frame buffers.  Using legacy_mem
rather than /dev/mem allows multiple instances of X to talk to
different VGA cards.</p>
<p>The /dev/mem mmap constraints apply.</p>
</div></blockquote>
</div>
<div class="section" id="mmap-of-proc-bus-pci">
<h3>mmap of /proc/bus/pci/…/??.?<a class="headerlink" href="#mmap-of-proc-bus-pci" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>This is an MMIO mmap of PCI functions, which additionally may or
may not be requested as using the WC attribute.</p>
<p>If WC is requested, and the region in kern_memmap is either WC
or UC, and the EFI memory map designates the region as WC, then
the WC mapping is allowed.</p>
<p>Otherwise, the user mapping must use the same attribute as the
kernel mapping.</p>
</div></blockquote>
</div>
<div class="section" id="read-write-of-dev-mem">
<h3>read/write of /dev/mem<a class="headerlink" href="#read-write-of-dev-mem" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>This uses copy_from_user(), which implicitly uses a kernel
identity mapping.  This is obviously safe for things in
kern_memmap.</p>
<p>There may be corner cases of things that are not in kern_memmap,
but could be accessed this way.  For example, registers in MMIO
space are not in kern_memmap, but could be accessed with a UC
mapping.  This would not cause attribute aliasing.  But
registers typically can be accessed only with four-byte or
eight-byte accesses, and the copy_from_user() path doesn’t allow
any control over the access size, so this would be dangerous.</p>
</div></blockquote>
</div>
<div class="section" id="ioremap">
<h3>ioremap()<a class="headerlink" href="#ioremap" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>This returns a mapping for use inside the kernel.</p>
<p>If the region is in kern_memmap, we should use the attribute
specified there.</p>
<p>If the EFI memory map reports that the entire granule supports
WB, we should use that (granules that are partially reserved
or occupied by firmware do not appear in kern_memmap).</p>
<p>If the granule contains non-WB memory, but we can cover the
region safely with kernel page table mappings, we can use
ioremap_page_range() as most other architectures do.</p>
<p>Failing all of the above, we have to fall back to a UC mapping.</p>
</div></blockquote>
</div>
</div>
<div class="section" id="past-problem-cases">
<h2>Past Problem Cases<a class="headerlink" href="#past-problem-cases" title="Permalink to this headline">¶</a></h2>
<div class="section" id="mmap-of-various-mmio-regions-from-dev-mem-by-x-on-intel-platforms">
<h3>mmap of various MMIO regions from /dev/mem by “X” on Intel platforms<a class="headerlink" href="#mmap-of-various-mmio-regions-from-dev-mem-by-x-on-intel-platforms" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>The EFI memory map may not report these MMIO regions.</p>
<p>These must be allowed so that X will work.  This means that
when the EFI memory map is incomplete, every /dev/mem mmap must
succeed.  It may create either WB or UC user mappings, depending
on whether the region is in kern_memmap or the EFI memory map.</p>
</div></blockquote>
</div>
<div class="section" id="mmap-of-0x0-0x9ffff-dev-mem-by-hwinfo-on-hp-sx1000-with-vga-enabled">
<h3>mmap of 0x0-0x9FFFF /dev/mem by “hwinfo” on HP sx1000 with VGA enabled<a class="headerlink" href="#mmap-of-0x0-0x9ffff-dev-mem-by-hwinfo-on-hp-sx1000-with-vga-enabled" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>The EFI memory map reports the following attributes:</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="38%" />
<col width="18%" />
<col width="45%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>0x00000-0x9FFFF</td>
<td>WB only</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td>0xA0000-0xBFFFF</td>
<td>UC only</td>
<td>(VGA frame buffer)</td>
</tr>
<tr class="row-odd"><td>0xC0000-0xFFFFF</td>
<td>WB only</td>
<td>&#160;</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>This mmap is done with user pages, not kernel identity mappings,
so it is safe to use WB mappings.</p>
<p>The kernel VGA driver may ioremap the VGA frame buffer at 0xA0000,
which uses a granule-sized UC mapping.  This granule will cover some
WB-only memory, but since UC is non-speculative, the processor will
never generate an uncacheable reference to the WB-only areas unless
the driver explicitly touches them.</p>
</div></blockquote>
</div>
<div class="section" id="mmap-of-0x0-0xfffff-legacy-mem-by-x">
<h3>mmap of 0x0-0xFFFFF legacy_mem by “X”<a class="headerlink" href="#mmap-of-0x0-0xfffff-legacy-mem-by-x" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>If the EFI memory map reports that the entire range supports the
same attributes, we can allow the mmap (and we will prefer WB if
supported, as is the case with HP sx[12]000 machines with VGA
disabled).</p>
<p>If EFI reports the range as partly WB and partly UC (as on sx[12]000
machines with VGA enabled), we must fail the mmap because there’s no
safe attribute to use.</p>
<p>If EFI reports some of the range but not all (as on Intel firmware
that doesn’t report the VGA frame buffer at all), we should fail the
mmap and force the user to map just the specific region of interest.</p>
</div></blockquote>
</div>
<div class="section" id="mmap-of-0xa0000-0xbffff-legacy-mem-by-x-on-hp-sx1000-with-vga-disabled">
<h3>mmap of 0xA0000-0xBFFFF legacy_mem by “X” on HP sx1000 with VGA disabled<a class="headerlink" href="#mmap-of-0xa0000-0xbffff-legacy-mem-by-x-on-hp-sx1000-with-vga-disabled" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>The EFI memory map reports the following attributes:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>0x00000-0xFFFFF WB only (no VGA MMIO hole)
</pre></div>
</div>
<p>This is a special case of the previous case, and the mmap should
fail for the same reason as above.</p>
</div></blockquote>
</div>
<div class="section" id="read-of-sys-devices-rom">
<h3>read of /sys/devices/…/rom<a class="headerlink" href="#read-of-sys-devices-rom" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>For VGA devices, this may cause an <a class="reference internal" href="../driver-api/device-io.html#c.ioremap" title="ioremap"><code class="xref c c-func docutils literal notranslate"><span class="pre">ioremap()</span></code></a> of 0xC0000.  This
used to be done with a UC mapping, because the VGA frame buffer
at 0xA0000 prevents use of a WB granule.  The UC mapping causes
an MCA on HP sx[12]000 chipsets.</p>
<p>We should use WB page table mappings to avoid covering the VGA
frame buffer.</p>
</div></blockquote>
</div>
</div>
<div class="section" id="notes">
<h2>Notes<a class="headerlink" href="#notes" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div>[1] SDM rev 2.2, vol 2, sec 4.4.1.
[2] SDM rev 2.2, vol 2, sec 4.4.6.</div></blockquote>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>