

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Memory hotplug &mdash; The Linux Kernel  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.6.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/mm/damon/index.html">DAMON: Data Access MONitor</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Memory hotplug</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/core-api/memory-hotplug.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="memory-hotplug">
<span id="id1"></span><h1>Memory hotplug<a class="headerlink" href="#memory-hotplug" title="Permalink to this headline">¶</a></h1>
<div class="section" id="memory-hotplug-event-notifier">
<h2>Memory hotplug event notifier<a class="headerlink" href="#memory-hotplug-event-notifier" title="Permalink to this headline">¶</a></h2>
<p>Hotplugging events are sent to a notification queue.</p>
<p>There are six types of notification defined in <code class="docutils literal notranslate"><span class="pre">include/linux/memory.h</span></code>:</p>
<dl class="docutils">
<dt>MEM_GOING_ONLINE</dt>
<dd>Generated before new memory becomes available in order to be able to
prepare subsystems to handle memory. The page allocator is still unable
to allocate from the new memory.</dd>
<dt>MEM_CANCEL_ONLINE</dt>
<dd>Generated if MEM_GOING_ONLINE fails.</dd>
<dt>MEM_ONLINE</dt>
<dd>Generated when memory has successfully brought online. The callback may
allocate pages from the new memory.</dd>
<dt>MEM_GOING_OFFLINE</dt>
<dd>Generated to begin the process of offlining memory. Allocations are no
longer possible from the memory but some of the memory to be offlined
is still in use. The callback can be used to free memory known to a
subsystem from the indicated memory block.</dd>
<dt>MEM_CANCEL_OFFLINE</dt>
<dd>Generated if MEM_GOING_OFFLINE fails. Memory is available again from
the memory block that we attempted to offline.</dd>
<dt>MEM_OFFLINE</dt>
<dd>Generated after offlining memory is complete.</dd>
</dl>
<p>A callback routine can be registered by calling:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>hotplug_memory_notifier(callback_func, priority)
</pre></div>
</div>
<p>Callback functions with higher values of priority are called before callback
functions with lower values.</p>
<p>A callback function must have the following prototype:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>int callback_func(
  struct notifier_block *self, unsigned long action, void *arg);
</pre></div>
</div>
<p>The first argument of the callback function (self) is a pointer to the block
of the notifier chain that points to the callback function itself.
The second argument (action) is one of the event types described above.
The third argument (arg) passes a pointer of struct memory_notify:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct memory_notify {
        unsigned long start_pfn;
        unsigned long nr_pages;
        int status_change_nid_normal;
        int status_change_nid_high;
        int status_change_nid;
}
</pre></div>
</div>
<ul>
<li><p class="first">start_pfn is start_pfn of online/offline memory.</p>
</li>
<li><p class="first">nr_pages is # of pages of online/offline memory.</p>
</li>
<li><p class="first">status_change_nid_normal is set node id when N_NORMAL_MEMORY of nodemask
is (will be) set/clear, if this is -1, then nodemask status is not changed.</p>
</li>
<li><p class="first">status_change_nid_high is set node id when N_HIGH_MEMORY of nodemask
is (will be) set/clear, if this is -1, then nodemask status is not changed.</p>
</li>
<li><p class="first">status_change_nid is set node id when N_MEMORY of nodemask is (will be)
set/clear. It means a new(memoryless) node gets new memory by online and a
node loses all memory. If this is -1, then nodemask status is not changed.</p>
<p>If status_changed_nid* &gt;= 0, callback should create/discard structures for the
node if necessary.</p>
</li>
</ul>
<p>The callback routine shall return one of the values
NOTIFY_DONE, NOTIFY_OK, NOTIFY_BAD, NOTIFY_STOP
defined in <code class="docutils literal notranslate"><span class="pre">include/linux/notifier.h</span></code></p>
<p>NOTIFY_DONE and NOTIFY_OK have no effect on the further processing.</p>
<p>NOTIFY_BAD is used as response to the MEM_GOING_ONLINE, MEM_GOING_OFFLINE,
MEM_ONLINE, or MEM_OFFLINE action to cancel hotplugging. It stops
further processing of the notification queue.</p>
<p>NOTIFY_STOP stops further processing of the notification queue.</p>
</div>
<div class="section" id="locking-internals">
<h2>Locking Internals<a class="headerlink" href="#locking-internals" title="Permalink to this headline">¶</a></h2>
<p>When adding/removing memory that uses memory block devices (i.e. ordinary RAM),
the device_hotplug_lock should be held to:</p>
<ul class="simple">
<li>synchronize against online/offline requests (e.g. via sysfs). This way, memory
block devices can only be accessed (.online/.state attributes) by user
space once memory has been fully added. And when removing memory, we
know nobody is in critical sections.</li>
<li>synchronize against CPU hotplug and similar (e.g. relevant for ACPI and PPC)</li>
</ul>
<p>Especially, there is a possible lock inversion that is avoided using
device_hotplug_lock when adding memory and user space tries to online that
memory faster than expected:</p>
<ul class="simple">
<li>device_online() will first take the device_lock(), followed by
mem_hotplug_lock</li>
<li>add_memory_resource() will first take the mem_hotplug_lock, followed by
the device_lock() (while creating the devices, during bus_add_device()).</li>
</ul>
<p>As the device is visible to user space before taking the device_lock(), this
can result in a lock inversion.</p>
<p>onlining/offlining of memory should be done via device_online()/
device_offline() - to make sure it is properly synchronized to actions
via sysfs. Holding device_hotplug_lock is advised (to e.g. protect online_type)</p>
<p>When adding/removing/onlining/offlining memory or adding/removing
heterogeneous/device memory, we should always hold the mem_hotplug_lock in
write mode to serialise memory hotplug (e.g. access to global/zone
variables).</p>
<p>In addition, mem_hotplug_lock (in contrast to device_hotplug_lock) in read
mode allows for a quite efficient get_online_mems/put_online_mems
implementation, so code accessing memory can protect from that memory
vanishing.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>