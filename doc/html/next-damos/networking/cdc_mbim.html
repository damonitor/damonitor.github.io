

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>cdc_mbim - Driver for CDC MBIM Mobile Broadband modems &mdash; The Linux Kernel  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.8.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/mm/damon/index.html">Monitoring Data Accesses</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../vm/damon/index.html">DAMON: Data Access MONitor</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>cdc_mbim - Driver for CDC MBIM Mobile Broadband modems</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/networking/cdc_mbim.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="cdc-mbim-driver-for-cdc-mbim-mobile-broadband-modems">
<h1>cdc_mbim - Driver for CDC MBIM Mobile Broadband modems<a class="headerlink" href="#cdc-mbim-driver-for-cdc-mbim-mobile-broadband-modems" title="Permalink to this headline">¶</a></h1>
<p>The cdc_mbim driver supports USB devices conforming to the “Universal
Serial Bus Communications Class Subclass Specification for Mobile
Broadband Interface Model” [1], which is a further development of
“Universal Serial Bus Communications Class Subclass Specifications for
Network Control Model Devices” [2] optimized for Mobile Broadband
devices, aka “3G/LTE modems”.</p>
<div class="section" id="command-line-parameters">
<h2>Command Line Parameters<a class="headerlink" href="#command-line-parameters" title="Permalink to this headline">¶</a></h2>
<p>The cdc_mbim driver has no parameters of its own.  But the probing
behaviour for NCM 1.0 backwards compatible MBIM functions (an
“NCM/MBIM function” as defined in section 3.2 of [1]) is affected
by a cdc_ncm driver parameter:</p>
<div class="section" id="prefer-mbim">
<h3>prefer_mbim<a class="headerlink" href="#prefer-mbim" title="Permalink to this headline">¶</a></h3>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Type:</th><td class="field-body">Boolean</td>
</tr>
<tr class="field-even field"><th class="field-name">Valid Range:</th><td class="field-body">N/Y (0-1)</td>
</tr>
<tr class="field-odd field"><th class="field-name">Default Value:</th><td class="field-body">Y (MBIM is preferred)</td>
</tr>
</tbody>
</table>
<p>This parameter sets the system policy for NCM/MBIM functions.  Such
functions will be handled by either the cdc_ncm driver or the cdc_mbim
driver depending on the prefer_mbim setting.  Setting prefer_mbim=N
makes the cdc_mbim driver ignore these functions and lets the cdc_ncm
driver handle them instead.</p>
<p>The parameter is writable, and can be changed at any time. A manual
unbind/bind is required to make the change effective for NCM/MBIM
functions bound to the “wrong” driver</p>
</div>
</div>
<div class="section" id="basic-usage">
<h2>Basic usage<a class="headerlink" href="#basic-usage" title="Permalink to this headline">¶</a></h2>
<p>MBIM functions are inactive when unmanaged. The cdc_mbim driver only
provides a userspace interface to the MBIM control channel, and will
not participate in the management of the function. This implies that a
userspace MBIM management application always is required to enable a
MBIM function.</p>
<p>Such userspace applications includes, but are not limited to:</p>
<blockquote>
<div><ul class="simple">
<li>mbimcli (included with the libmbim [3] library), and</li>
<li>ModemManager [4]</li>
</ul>
</div></blockquote>
<p>Establishing a MBIM IP session reequires at least these actions by the
management application:</p>
<blockquote>
<div><ul class="simple">
<li>open the control channel</li>
<li>configure network connection settings</li>
<li>connect to network</li>
<li>configure IP interface</li>
</ul>
</div></blockquote>
<div class="section" id="management-application-development">
<h3>Management application development<a class="headerlink" href="#management-application-development" title="Permalink to this headline">¶</a></h3>
<p>The driver &lt;-&gt; userspace interfaces are described below.  The MBIM
control channel protocol is described in [1].</p>
</div>
</div>
<div class="section" id="mbim-control-channel-userspace-abi">
<h2>MBIM control channel userspace ABI<a class="headerlink" href="#mbim-control-channel-userspace-abi" title="Permalink to this headline">¶</a></h2>
<div class="section" id="dev-cdc-wdmx-character-device">
<h3>/dev/cdc-wdmX character device<a class="headerlink" href="#dev-cdc-wdmx-character-device" title="Permalink to this headline">¶</a></h3>
<p>The driver creates a two-way pipe to the MBIM function control channel
using the cdc-wdm driver as a subdriver.  The userspace end of the
control channel pipe is a /dev/cdc-wdmX character device.</p>
<p>The cdc_mbim driver does not process or police messages on the control
channel.  The channel is fully delegated to the userspace management
application.  It is therefore up to this application to ensure that it
complies with all the control channel requirements in [1].</p>
<p>The cdc-wdmX device is created as a child of the MBIM control
interface USB device.  The character device associated with a specific
MBIM function can be looked up using sysfs.  For example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>bjorn@nemi:~$ ls /sys/bus/usb/drivers/cdc_mbim/2-4:2.12/usbmisc
cdc-wdm0

bjorn@nemi:~$ grep . /sys/bus/usb/drivers/cdc_mbim/2-4:2.12/usbmisc/cdc-wdm0/dev
180:0
</pre></div>
</div>
</div>
<div class="section" id="usb-configuration-descriptors">
<h3>USB configuration descriptors<a class="headerlink" href="#usb-configuration-descriptors" title="Permalink to this headline">¶</a></h3>
<p>The wMaxControlMessage field of the CDC MBIM functional descriptor
limits the maximum control message size. The managament application is
responsible for negotiating a control message size complying with the
requirements in section 9.3.1 of [1], taking this descriptor field
into consideration.</p>
<p>The userspace application can access the CDC MBIM functional
descriptor of a MBIM function using either of the two USB
configuration descriptor kernel interfaces described in [6] or [7].</p>
<p>See also the ioctl documentation below.</p>
</div>
<div class="section" id="fragmentation">
<h3>Fragmentation<a class="headerlink" href="#fragmentation" title="Permalink to this headline">¶</a></h3>
<p>The userspace application is responsible for all control message
fragmentation and defragmentaion, as described in section 9.5 of [1].</p>
</div>
<div class="section" id="dev-cdc-wdmx-write">
<h3>/dev/cdc-wdmX write()<a class="headerlink" href="#dev-cdc-wdmx-write" title="Permalink to this headline">¶</a></h3>
<p>The MBIM control messages from the management application <em>must not</em>
exceed the negotiated control message size.</p>
</div>
<div class="section" id="dev-cdc-wdmx-read">
<h3>/dev/cdc-wdmX read()<a class="headerlink" href="#dev-cdc-wdmx-read" title="Permalink to this headline">¶</a></h3>
<p>The management application <em>must</em> accept control messages of up the
negotiated control message size.</p>
</div>
<div class="section" id="dev-cdc-wdmx-ioctl">
<h3>/dev/cdc-wdmX ioctl()<a class="headerlink" href="#dev-cdc-wdmx-ioctl" title="Permalink to this headline">¶</a></h3>
<p>IOCTL_WDM_MAX_COMMAND: Get Maximum Command Size
This ioctl returns the wMaxControlMessage field of the CDC MBIM
functional descriptor for MBIM devices.  This is intended as a
convenience, eliminating the need to parse the USB descriptors from
userspace.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#include &lt;stdio.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;sys/ioctl.h&gt;
#include &lt;linux/types.h&gt;
#include &lt;linux/usb/cdc-wdm.h&gt;
int main()
{
        __u16 max;
        int fd = open(&quot;/dev/cdc-wdm0&quot;, O_RDWR);
        if (!ioctl(fd, IOCTL_WDM_MAX_COMMAND, &amp;max))
                printf(&quot;wMaxControlMessage is %d\n&quot;, max);
}
</pre></div>
</div>
</div>
<div class="section" id="custom-device-services">
<h3>Custom device services<a class="headerlink" href="#custom-device-services" title="Permalink to this headline">¶</a></h3>
<p>The MBIM specification allows vendors to freely define additional
services.  This is fully supported by the cdc_mbim driver.</p>
<p>Support for new MBIM services, including vendor specified services, is
implemented entirely in userspace, like the rest of the MBIM control
protocol</p>
<p>New services should be registered in the MBIM Registry [5].</p>
</div>
</div>
<div class="section" id="mbim-data-channel-userspace-abi">
<h2>MBIM data channel userspace ABI<a class="headerlink" href="#mbim-data-channel-userspace-abi" title="Permalink to this headline">¶</a></h2>
<div class="section" id="wwany-network-device">
<h3>wwanY network device<a class="headerlink" href="#wwany-network-device" title="Permalink to this headline">¶</a></h3>
<p>The cdc_mbim driver represents the MBIM data channel as a single
network device of the “wwan” type. This network device is initially
mapped to MBIM IP session 0.</p>
</div>
<div class="section" id="multiplexed-ip-sessions-ips">
<h3>Multiplexed IP sessions (IPS)<a class="headerlink" href="#multiplexed-ip-sessions-ips" title="Permalink to this headline">¶</a></h3>
<p>MBIM allows multiplexing up to 256 IP sessions over a single USB data
channel.  The cdc_mbim driver models such IP sessions as 802.1q VLAN
subdevices of the master wwanY device, mapping MBIM IP session Z to
VLAN ID Z for all values of Z greater than 0.</p>
<p>The device maximum Z is given in the MBIM_DEVICE_CAPS_INFO structure
described in section 10.5.1 of [1].</p>
<p>The userspace management application is responsible for adding new
VLAN links prior to establishing MBIM IP sessions where the SessionId
is greater than 0. These links can be added by using the normal VLAN
kernel interfaces, either ioctl or netlink.</p>
<p>For example, adding a link for a MBIM IP session with SessionId 3:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ip link add link wwan0 name wwan0.3 type vlan id 3
</pre></div>
</div>
<p>The driver will automatically map the “wwan0.3” network device to MBIM
IP session 3.</p>
</div>
<div class="section" id="device-service-streams-dss">
<h3>Device Service Streams (DSS)<a class="headerlink" href="#device-service-streams-dss" title="Permalink to this headline">¶</a></h3>
<p>MBIM also allows up to 256 non-IP data streams to be multiplexed over
the same shared USB data channel.  The cdc_mbim driver models these
sessions as another set of 802.1q VLAN subdevices of the master wwanY
device, mapping MBIM DSS session A to VLAN ID (256 + A) for all values
of A.</p>
<p>The device maximum A is given in the MBIM_DEVICE_SERVICES_INFO
structure described in section 10.5.29 of [1].</p>
<p>The DSS VLAN subdevices are used as a practical interface between the
shared MBIM data channel and a MBIM DSS aware userspace application.
It is not intended to be presented as-is to an end user. The
assumption is that a userspace application initiating a DSS session
also takes care of the necessary framing of the DSS data, presenting
the stream to the end user in an appropriate way for the stream type.</p>
<p>The network device ABI requires a dummy ethernet header for every DSS
data frame being transported.  The contents of this header is
arbitrary, with the following exceptions:</p>
<blockquote>
<div><ul class="simple">
<li>TX frames using an IP protocol (0x0800 or 0x86dd) will be dropped</li>
<li>RX frames will have the protocol field set to ETH_P_802_3 (but will
not be properly formatted 802.3 frames)</li>
<li>RX frames will have the destination address set to the hardware
address of the master device</li>
</ul>
</div></blockquote>
<p>The DSS supporting userspace management application is responsible for
adding the dummy ethernet header on TX and stripping it on RX.</p>
<p>This is a simple example using tools commonly available, exporting
DssSessionId 5 as a pty character device pointed to by a /dev/nmea
symlink:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ip link add link wwan0 name wwan0.dss5 type vlan id 261
ip link set dev wwan0.dss5 up
socat INTERFACE:wwan0.dss5,type=2 PTY:,echo=0,link=/dev/nmea
</pre></div>
</div>
<p>This is only an example, most suitable for testing out a DSS
service. Userspace applications supporting specific MBIM DSS services
are expected to use the tools and programming interfaces required by
that service.</p>
<p>Note that adding VLAN links for DSS sessions is entirely optional.  A
management application may instead choose to bind a packet socket
directly to the master network device, using the received VLAN tags to
map frames to the correct DSS session and adding 18 byte VLAN ethernet
headers with the appropriate tag on TX.  In this case using a socket
filter is recommended, matching only the DSS VLAN subset. This avoid
unnecessary copying of unrelated IP session data to userspace.  For
example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>static struct sock_filter dssfilter[] = {
      /* use special negative offsets to get VLAN tag */
      BPF_STMT(BPF_LD|BPF_B|BPF_ABS, SKF_AD_OFF + SKF_AD_VLAN_TAG_PRESENT),
      BPF_JUMP(BPF_JMP|BPF_JEQ|BPF_K, 1, 0, 6), /* true */

      /* verify DSS VLAN range */
      BPF_STMT(BPF_LD|BPF_H|BPF_ABS, SKF_AD_OFF + SKF_AD_VLAN_TAG),
      BPF_JUMP(BPF_JMP|BPF_JGE|BPF_K, 256, 0, 4),     /* 256 is first DSS VLAN */
      BPF_JUMP(BPF_JMP|BPF_JGE|BPF_K, 512, 3, 0),     /* 511 is last DSS VLAN */

      /* verify ethertype */
      BPF_STMT(BPF_LD|BPF_H|BPF_ABS, 2 * ETH_ALEN),
      BPF_JUMP(BPF_JMP|BPF_JEQ|BPF_K, ETH_P_802_3, 0, 1),

      BPF_STMT(BPF_RET|BPF_K, (u_int)-1),     /* accept */
      BPF_STMT(BPF_RET|BPF_K, 0),             /* ignore */
};
</pre></div>
</div>
</div>
<div class="section" id="tagged-ip-session-0-vlan">
<h3>Tagged IP session 0 VLAN<a class="headerlink" href="#tagged-ip-session-0-vlan" title="Permalink to this headline">¶</a></h3>
<p>As described above, MBIM IP session 0 is treated as special by the
driver.  It is initially mapped to untagged frames on the wwanY
network device.</p>
<p>This mapping implies a few restrictions on multiplexed IPS and DSS
sessions, which may not always be practical:</p>
<blockquote>
<div><ul class="simple">
<li>no IPS or DSS session can use a frame size greater than the MTU on
IP session 0</li>
<li>no IPS or DSS session can be in the up state unless the network
device representing IP session 0 also is up</li>
</ul>
</div></blockquote>
<p>These problems can be avoided by optionally making the driver map IP
session 0 to a VLAN subdevice, similar to all other IP sessions.  This
behaviour is triggered by adding a VLAN link for the magic VLAN ID
4094.  The driver will then immediately start mapping MBIM IP session
0 to this VLAN, and will drop untagged frames on the master wwanY
device.</p>
<p>Tip: It might be less confusing to the end user to name this VLAN
subdevice after the MBIM SessionID instead of the VLAN ID.  For
example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ip link add link wwan0 name wwan0.0 type vlan id 4094
</pre></div>
</div>
</div>
<div class="section" id="vlan-mapping">
<h3>VLAN mapping<a class="headerlink" href="#vlan-mapping" title="Permalink to this headline">¶</a></h3>
<p>Summarizing the cdc_mbim driver mapping described above, we have this
relationship between VLAN tags on the wwanY network device and MBIM
sessions on the shared USB data channel:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>VLAN ID       MBIM type   MBIM SessionID           Notes
---------------------------------------------------------
untagged      IPS         0                        a)
1 - 255       IPS         1 - 255 &lt;VLANID&gt;
256 - 511     DSS         0 - 255 &lt;VLANID - 256&gt;
512 - 4093                                         b)
4094          IPS         0                        c)

  a) if no VLAN ID 4094 link exists, else dropped
  b) unsupported VLAN range, unconditionally dropped
  c) if a VLAN ID 4094 link exists, else dropped
</pre></div>
</div>
</div>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ol class="arabic">
<li><p class="first">USB Implementers Forum, Inc. - “Universal Serial Bus
Communications Class Subclass Specification for Mobile Broadband
Interface Model”, Revision 1.0 (Errata 1), May 1, 2013</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference external" href="http://www.usb.org/developers/docs/devclass_docs/">http://www.usb.org/developers/docs/devclass_docs/</a></li>
</ul>
</div></blockquote>
</li>
<li><p class="first">USB Implementers Forum, Inc. - “Universal Serial Bus
Communications Class Subclass Specifications for Network Control
Model Devices”, Revision 1.0 (Errata 1), November 24, 2010</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference external" href="http://www.usb.org/developers/docs/devclass_docs/">http://www.usb.org/developers/docs/devclass_docs/</a></li>
</ul>
</div></blockquote>
</li>
<li><p class="first">libmbim - “a glib-based library for talking to WWAN modems and
devices which speak the Mobile Interface Broadband Model (MBIM)
protocol”</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference external" href="http://www.freedesktop.org/wiki/Software/libmbim/">http://www.freedesktop.org/wiki/Software/libmbim/</a></li>
</ul>
</div></blockquote>
</li>
<li><p class="first">ModemManager - “a DBus-activated daemon which controls mobile
broadband (2G/3G/4G) devices and connections”</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference external" href="http://www.freedesktop.org/wiki/Software/ModemManager/">http://www.freedesktop.org/wiki/Software/ModemManager/</a></li>
</ul>
</div></blockquote>
</li>
<li><p class="first">“MBIM (Mobile Broadband Interface Model) Registry”</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference external" href="http://compliance.usb.org/mbim/">http://compliance.usb.org/mbim/</a></li>
</ul>
</div></blockquote>
</li>
<li><p class="first">“/sys/kernel/debug/usb/devices output format”</p>
<blockquote>
<div><ul class="simple">
<li>Documentation/driver-api/usb/usb.rst</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">“/sys/bus/usb/devices/…/descriptors”</p>
<blockquote>
<div><ul class="simple">
<li>Documentation/ABI/stable/sysfs-bus-usb</li>
</ul>
</div></blockquote>
</li>
</ol>
</div></blockquote>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>