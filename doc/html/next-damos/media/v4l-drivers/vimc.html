

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>35. The Virtual Media Controller Driver (vimc) &mdash; The Linux Kernel  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.6.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/mm/damon/index.html">DAMON: Data Access MONitor</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>35. The Virtual Media Controller Driver (vimc)</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/media/v4l-drivers/vimc.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="the-virtual-media-controller-driver-vimc">
<h1>35. The Virtual Media Controller Driver (vimc)<a class="headerlink" href="#the-virtual-media-controller-driver-vimc" title="Permalink to this headline">¶</a></h1>
<p>The vimc driver emulates complex video hardware using the V4L2 API and the Media
API. It has a capture device and three subdevices: sensor, debayer and scaler.</p>
<div class="section" id="topology">
<h2>35.1. Topology<a class="headerlink" href="#topology" title="Permalink to this headline">¶</a></h2>
<p>The topology is hardcoded, although you could modify it in vimc-core and
recompile the driver to achieve your own topology. This is the default topology:</p>
<div class="figure align-center" id="id1">
<img alt="Diagram of the default media pipeline topology" src="../../_images/vimc.svg" /><p class="caption"><span class="caption-text">Media pipeline graph on vimc</span></p>
</div>
<div class="section" id="configuring-the-topology">
<h3>35.1.1. Configuring the topology<a class="headerlink" href="#configuring-the-topology" title="Permalink to this headline">¶</a></h3>
<p>Each subdevice will come with its default configuration (pixelformat, height,
width, …). One needs to configure the topology in order to match the
configuration on each linked subdevice to stream frames through the pipeline.
If the configuration doesn’t match, the stream will fail. The <code class="docutils literal notranslate"><span class="pre">v4l-utils</span></code>
package is a bundle of user-space applications, that comes with <code class="docutils literal notranslate"><span class="pre">media-ctl</span></code> and
<code class="docutils literal notranslate"><span class="pre">v4l2-ctl</span></code> that can be used to configure the vimc configuration. This sequence
of commands fits for the default topology:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>media-ctl -d platform:vimc -V <span class="s1">&#39;&quot;Sensor A&quot;:0[fmt:SBGGR8_1X8/640x480]&#39;</span>
media-ctl -d platform:vimc -V <span class="s1">&#39;&quot;Debayer A&quot;:0[fmt:SBGGR8_1X8/640x480]&#39;</span>
media-ctl -d platform:vimc -V <span class="s1">&#39;&quot;Sensor B&quot;:0[fmt:SBGGR8_1X8/640x480]&#39;</span>
media-ctl -d platform:vimc -V <span class="s1">&#39;&quot;Debayer B&quot;:0[fmt:SBGGR8_1X8/640x480]&#39;</span>
v4l2-ctl -z platform:vimc -d <span class="s2">&quot;RGB/YUV Capture&quot;</span> -v <span class="nv">width</span><span class="o">=</span><span class="m">1920</span>,height<span class="o">=</span><span class="m">1440</span>
v4l2-ctl -z platform:vimc -d <span class="s2">&quot;Raw Capture 0&quot;</span> -v <span class="nv">pixelformat</span><span class="o">=</span>BA81
v4l2-ctl -z platform:vimc -d <span class="s2">&quot;Raw Capture 1&quot;</span> -v <span class="nv">pixelformat</span><span class="o">=</span>BA81
</pre></div>
</div>
</div>
</div>
<div class="section" id="subdevices">
<h2>35.2. Subdevices<a class="headerlink" href="#subdevices" title="Permalink to this headline">¶</a></h2>
<p>Subdevices define the behavior of an entity in the topology. Depending on the
subdevice, the entity can have multiple pads of type source or sink.</p>
<dl class="docutils">
<dt>vimc-sensor:</dt>
<dd><p class="first">Generates images in several formats using video test pattern generator.
Exposes:</p>
<ul class="last simple">
<li>1 Pad source</li>
</ul>
</dd>
<dt>vimc-debayer:</dt>
<dd><p class="first">Transforms images in bayer format into a non-bayer format.
Exposes:</p>
<ul class="last simple">
<li>1 Pad sink</li>
<li>1 Pad source</li>
</ul>
</dd>
<dt>vimc-scaler:</dt>
<dd><p class="first">Scale up the image by a factor of 3. E.g.: a 640x480 image becomes a
1920x1440 image. (this value can be configured, see at
<a class="reference internal" href="#module-options">Module options</a>).
Exposes:</p>
<ul class="last simple">
<li>1 Pad sink</li>
<li>1 Pad source</li>
</ul>
</dd>
<dt>vimc-capture:</dt>
<dd><p class="first">Exposes node /dev/videoX to allow userspace to capture the stream.
Exposes:</p>
<ul class="last simple">
<li>1 Pad sink</li>
<li>1 Pad source</li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="module-options">
<h2>35.3. Module options<a class="headerlink" href="#module-options" title="Permalink to this headline">¶</a></h2>
<p>Vimc has a module parameter to configure the driver.</p>
<ul>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">sca_mult=&lt;unsigned</span> <span class="pre">int&gt;</span></code></p>
<blockquote>
<div><p>Image size multiplier factor to be used to multiply both width and
height, so the image size will be <code class="docutils literal notranslate"><span class="pre">sca_mult^2</span></code> bigger than the
original one. Currently, only supports scaling up (the default value
is 3).</p>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="source-code-documentation">
<h2>35.4. Source code documentation<a class="headerlink" href="#source-code-documentation" title="Permalink to this headline">¶</a></h2>
<div class="section" id="vimc-streamer">
<h3>35.4.1. vimc-streamer<a class="headerlink" href="#vimc-streamer" title="Permalink to this headline">¶</a></h3>
<dl class="type">
<dt id="c.vimc_stream">
struct <code class="descname">vimc_stream</code><a class="headerlink" href="#c.vimc_stream" title="Permalink to this definition">¶</a></dt>
<dd><p>struct that represents a stream in the pipeline</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct vimc_stream {
  struct media_pipeline pipe;
  struct vimc_ent_device *ved_pipeline[VIMC_STREAMER_PIPELINE_MAX_SIZE];
  unsigned int pipe_size;
  struct task_struct *kthread;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">pipe</span></code></dt>
<dd>the media pipeline object associated with this stream</dd>
<dt><code class="docutils literal notranslate"><span class="pre">ved_pipeline</span></code></dt>
<dd>array containing all the entities participating in the
stream. The order is from a video device (usually a capture device) where
stream_on was called, to the entity generating the first base image to be
processed in the pipeline.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">pipe_size</span></code></dt>
<dd>size of <strong>ved_pipeline</strong></dd>
<dt><code class="docutils literal notranslate"><span class="pre">kthread</span></code></dt>
<dd>thread that generates the frames of the stream.</dd>
</dl>
<p><strong>Description</strong></p>
<p>When the user call stream_on in a video device, struct vimc_stream is
used to keep track of all entities and subdevices that generates and
process frames for the stream.</p>
<dl class="function">
<dt id="c.vimc_get_source_entity">
struct <a class="reference internal" href="../kapi/mc-core.html#c.media_entity" title="media_entity">media_entity</a> * <code class="descname">vimc_get_source_entity</code><span class="sig-paren">(</span>struct <a class="reference internal" href="../kapi/mc-core.html#c.media_entity" title="media_entity">media_entity</a> *<em>&nbsp;ent</em><span class="sig-paren">)</span><a class="headerlink" href="#c.vimc_get_source_entity" title="Permalink to this definition">¶</a></dt>
<dd><p>get the entity connected with the first sink pad</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">media_entity</span> <span class="pre">*</span> <span class="pre">ent</span></code></dt>
<dd>reference media_entity</dd>
</dl>
<p><strong>Description</strong></p>
<p>Helper function that returns the media entity containing the source pad
linked with the first sink pad from the given media entity pad list.</p>
<p><strong>Return</strong></p>
<p>The source pad or NULL, if it wasn’t found.</p>
<dl class="function">
<dt id="c.vimc_streamer_pipeline_terminate">
void <code class="descname">vimc_streamer_pipeline_terminate</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.vimc_stream" title="vimc_stream">vimc_stream</a> *<em>&nbsp;stream</em><span class="sig-paren">)</span><a class="headerlink" href="#c.vimc_streamer_pipeline_terminate" title="Permalink to this definition">¶</a></dt>
<dd><p>Disable stream in all ved in stream</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">vimc_stream</span> <span class="pre">*</span> <span class="pre">stream</span></code></dt>
<dd>the pointer to the stream structure with the pipeline to be
disabled.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Calls s_stream to disable the stream in each entity of the pipeline</p>
<dl class="function">
<dt id="c.vimc_streamer_pipeline_init">
int <code class="descname">vimc_streamer_pipeline_init</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.vimc_stream" title="vimc_stream">vimc_stream</a> *<em>&nbsp;stream</em>, struct vimc_ent_device *<em>&nbsp;ved</em><span class="sig-paren">)</span><a class="headerlink" href="#c.vimc_streamer_pipeline_init" title="Permalink to this definition">¶</a></dt>
<dd><p>Initializes the stream structure</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">vimc_stream</span> <span class="pre">*</span> <span class="pre">stream</span></code></dt>
<dd>the pointer to the stream structure to be initialized</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">vimc_ent_device</span> <span class="pre">*</span> <span class="pre">ved</span></code></dt>
<dd>the pointer to the vimc entity initializing the stream</dd>
</dl>
<p><strong>Description</strong></p>
<p>Initializes the stream structure. Walks through the entity graph to
construct the pipeline used later on the streamer thread.
Calls <a class="reference internal" href="#c.vimc_streamer_s_stream" title="vimc_streamer_s_stream"><code class="xref c c-func docutils literal notranslate"><span class="pre">vimc_streamer_s_stream()</span></code></a> to enable stream in all entities of
the pipeline.</p>
<p><strong>Return</strong></p>
<p>0 if success, error code otherwise.</p>
<dl class="function">
<dt id="c.vimc_streamer_thread">
int <code class="descname">vimc_streamer_thread</code><span class="sig-paren">(</span>void *<em>&nbsp;data</em><span class="sig-paren">)</span><a class="headerlink" href="#c.vimc_streamer_thread" title="Permalink to this definition">¶</a></dt>
<dd><p>Process frames through the pipeline</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">*</span> <span class="pre">data</span></code></dt>
<dd>vimc_stream struct of the current stream</dd>
</dl>
<p><strong>Description</strong></p>
<p>From the source to the sink, gets a frame from each subdevice and send to
the next one of the pipeline at a fixed framerate.</p>
<p><strong>Return</strong></p>
<p>Always zero (created as <code class="docutils literal notranslate"><span class="pre">int</span></code> instead of <code class="docutils literal notranslate"><span class="pre">void</span></code> to comply with
kthread API).</p>
<dl class="function">
<dt id="c.vimc_streamer_s_stream">
int <code class="descname">vimc_streamer_s_stream</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.vimc_stream" title="vimc_stream">vimc_stream</a> *<em>&nbsp;stream</em>, struct vimc_ent_device *<em>&nbsp;ved</em>, int<em>&nbsp;enable</em><span class="sig-paren">)</span><a class="headerlink" href="#c.vimc_streamer_s_stream" title="Permalink to this definition">¶</a></dt>
<dd><p>Start/stop the streaming on the media pipeline</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">vimc_stream</span> <span class="pre">*</span> <span class="pre">stream</span></code></dt>
<dd>the pointer to the stream structure of the current stream</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">vimc_ent_device</span> <span class="pre">*</span> <span class="pre">ved</span></code></dt>
<dd>pointer to the vimc entity of the entity of the stream</dd>
<dt><code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">enable</span></code></dt>
<dd>flag to determine if stream should start/stop</dd>
</dl>
<p><strong>Description</strong></p>
<p>When starting, check if there is no <code class="docutils literal notranslate"><span class="pre">stream-&gt;kthread</span></code> allocated. This
should indicate that a stream is already running. Then, it initializes the
pipeline, creates and runs a kthread to consume buffers through the pipeline.
When stopping, analogously check if there is a stream running, stop the
thread and terminates the pipeline.</p>
<p><strong>Return</strong></p>
<p>0 if success, error code otherwise.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>