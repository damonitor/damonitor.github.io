

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>6.1. Introduction &mdash; The Linux Kernel  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../../../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.7.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../admin-guide/mm/damon/index.html">Monitoring Data Accesses</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../vm/damon/index.html">DAMON: Data Access MONitor</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
      <li>6.1. Introduction</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/media/uapi/rc/lirc-dev-intro.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="introduction">
<span id="lirc-dev-intro"></span><h1>6.1. Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h1>
<p>LIRC stands for Linux Infrared Remote Control. The LIRC device interface is
a bi-directional interface for transporting raw IR and decoded scancodes
data between userspace and kernelspace. Fundamentally, it is just a chardev
(/dev/lircX, for X = 0, 1, 2, …), with a number of standard struct
file_operations defined on it. With respect to transporting raw IR and
decoded scancodes to and fro, the essential fops are read, write and ioctl.</p>
<p>It is also possible to attach a BPF program to a LIRC device for decoding
raw IR into scancodes.</p>
<p>Example dmesg output upon a driver registering w/LIRC:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ dmesg |grep lirc_dev
rc rc0: lirc_dev: driver mceusb registered at minor = 0, raw IR receiver, raw IR transmitter
</pre></div>
</div>
<p>What you should see for a chardev:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ ls -l /dev/lirc*
crw-rw---- 1 root root 248, 0 Jul 2 22:20 /dev/lirc0
</pre></div>
</div>
<p>Note that the package <a class="reference external" href="https://git.linuxtv.org/v4l-utils.git/">v4l-utils</a>
contains tools for working with LIRC devices:</p>
<blockquote>
<div><ul class="simple">
<li>ir-ctl: can receive raw IR and transmit IR, as well as query LIRC
device features.</li>
<li>ir-keytable: can load keymaps; allows you to set IR kernel protocols; load
BPF IR decoders and test IR decoding. Some BPF IR decoders are also
provided.</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="lirc-modes">
<span id="id1"></span><h1>6.2. LIRC modes<a class="headerlink" href="#lirc-modes" title="Permalink to this headline">¶</a></h1>
<p>LIRC supports some modes of receiving and sending IR codes, as shown
on the following table.</p>
<p id="lirc-scancode-flag-repeat"><span id="lirc-scancode-flag-toggle"></span><span id="lirc-mode-scancode"></span><code class="docutils literal notranslate"><span class="pre">LIRC_MODE_SCANCODE</span></code></p>
<blockquote>
<div><p>This mode is for both sending and receiving IR.</p>
<p>For transmitting (aka sending), create a <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">lirc_scancode</span></code> with
the desired scancode set in the <code class="docutils literal notranslate"><span class="pre">scancode</span></code> member, <code class="xref c c-type docutils literal notranslate"><span class="pre">rc_proto</span></code>
set to the <a class="reference internal" href="rc-protos.html#remote-controllers-protocols"><span class="std std-ref">IR protocol</span></a>, and all other
members set to 0. Write this struct to the lirc device.</p>
<p>For receiving, you read <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">lirc_scancode</span></code> from the LIRC device.
The <code class="docutils literal notranslate"><span class="pre">scancode</span></code> field is set to the received scancode and the
<a class="reference internal" href="rc-protos.html#remote-controllers-protocols"><span class="std std-ref">IR protocol</span></a> is set in
<code class="xref c c-type docutils literal notranslate"><span class="pre">rc_proto</span></code>. If the scancode maps to a valid key code, this is set
in the <code class="docutils literal notranslate"><span class="pre">keycode</span></code> field, else it is set to <code class="docutils literal notranslate"><span class="pre">KEY_RESERVED</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">flags</span></code> can have <code class="docutils literal notranslate"><span class="pre">LIRC_SCANCODE_FLAG_TOGGLE</span></code> set if the toggle
bit is set in protocols that support it (e.g. rc-5 and rc-6), or
<code class="docutils literal notranslate"><span class="pre">LIRC_SCANCODE_FLAG_REPEAT</span></code> for when a repeat is received for protocols
that support it (e.g. nec).</p>
<p>In the Sanyo and NEC protocol, if you hold a button on remote, rather than
repeating the entire scancode, the remote sends a shorter message with
no scancode, which just means button is held, a “repeat”. When this is
received, the <code class="docutils literal notranslate"><span class="pre">LIRC_SCANCODE_FLAG_REPEAT</span></code> is set and the scancode and
keycode is repeated.</p>
<p>With nec, there is no way to distinguish “button hold” from “repeatedly
pressing the same button”. The rc-5 and rc-6 protocols have a toggle bit.
When a button is released and pressed again, the toggle bit is inverted.
If the toggle bit is set, the <code class="docutils literal notranslate"><span class="pre">LIRC_SCANCODE_FLAG_TOGGLE</span></code> is set.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">timestamp</span></code> field is filled with the time nanoseconds
(in <code class="docutils literal notranslate"><span class="pre">CLOCK_MONOTONIC</span></code>) when the scancode was decoded.</p>
</div></blockquote>
<p id="lirc-mode-mode2"><code class="docutils literal notranslate"><span class="pre">LIRC_MODE_MODE2</span></code></p>
<blockquote>
<div><p>The driver returns a sequence of pulse and space codes to userspace,
as a series of u32 values.</p>
<p>This mode is used only for IR receive.</p>
<p>The upper 8 bits determine the packet type, and the lower 24 bits
the payload. Use <code class="docutils literal notranslate"><span class="pre">LIRC_VALUE()</span></code> macro to get the payload, and
the macro <code class="docutils literal notranslate"><span class="pre">LIRC_MODE2()</span></code> will give you the type, which
is one of:</p>
<p><code class="docutils literal notranslate"><span class="pre">LIRC_MODE2_PULSE</span></code></p>
<blockquote>
<div>Signifies the presence of IR in microseconds.</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">LIRC_MODE2_SPACE</span></code></p>
<blockquote>
<div>Signifies absence of IR in microseconds.</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">LIRC_MODE2_FREQUENCY</span></code></p>
<blockquote>
<div>If measurement of the carrier frequency was enabled with
<a class="reference internal" href="lirc-set-measure-carrier-mode.html#lirc-set-measure-carrier-mode"><span class="std std-ref">ioctl LIRC_SET_MEASURE_CARRIER_MODE</span></a> then this packet gives you
the carrier frequency in Hertz.</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">LIRC_MODE2_TIMEOUT</span></code></p>
<blockquote>
<div>If timeout reports are enabled with
<a class="reference internal" href="lirc-set-rec-timeout-reports.html#lirc-set-rec-timeout-reports"><span class="std std-ref">ioctl LIRC_SET_REC_TIMEOUT_REPORTS</span></a>, when the timeout set with
<a class="reference internal" href="lirc-set-rec-timeout.html#lirc-set-rec-timeout"><span class="std std-ref">ioctl LIRC_GET_REC_TIMEOUT and LIRC_SET_REC_TIMEOUT</span></a> expires due to no IR being detected,
this packet will be sent, with the number of microseconds with
no IR.</div></blockquote>
</div></blockquote>
<p id="lirc-mode-pulse"><code class="docutils literal notranslate"><span class="pre">LIRC_MODE_PULSE</span></code></p>
<blockquote>
<div><p>In pulse mode, a sequence of pulse/space integer values are written to the
lirc device using <a class="reference internal" href="lirc-write.html#lirc-write"><span class="std std-ref">LIRC write()</span></a>.</p>
<p>The values are alternating pulse and space lengths, in microseconds. The
first and last entry must be a pulse, so there must be an odd number
of entries.</p>
<p>This mode is used only for IR send.</p>
</div></blockquote>
</div>
<div class="section" id="bpf-based-ir-decoder">
<h1>6.3. BPF based IR decoder<a class="headerlink" href="#bpf-based-ir-decoder" title="Permalink to this headline">¶</a></h1>
<p>The kernel has support for decoding the most common
<a class="reference internal" href="rc-protos.html#remote-controllers-protocols"><span class="std std-ref">IR protocols</span></a>, but there
are many protocols which are not supported. To support these, it is possible
to load an BPF program which does the decoding. This can only be done on
LIRC devices which support reading raw IR.</p>
<p>First, using the <a class="reference external" href="http://man7.org/linux/man-pages/man2/bpf.2.html">bpf(2)</a> syscall with the <code class="docutils literal notranslate"><span class="pre">BPF_LOAD_PROG</span></code> argument,
program must be loaded of type <code class="docutils literal notranslate"><span class="pre">BPF_PROG_TYPE_LIRC_MODE2</span></code>. Once attached
to the LIRC device, this program will be called for each pulse, space or
timeout event on the LIRC device. The context for the BPF program is a
pointer to a unsigned int, which is a <a class="reference internal" href="#lirc-mode-mode2"><span class="std std-ref">LIRC_MODE_MODE2</span></a>
value. When the program has decoded the scancode, it can be submitted using
the BPF functions <code class="docutils literal notranslate"><span class="pre">bpf_rc_keydown()</span></code> or <code class="docutils literal notranslate"><span class="pre">bpf_rc_repeat()</span></code>. Mouse or pointer
movements can be reported using <code class="docutils literal notranslate"><span class="pre">bpf_rc_pointer_rel()</span></code>.</p>
<p>Once you have the file descriptor for the <code class="docutils literal notranslate"><span class="pre">BPF_PROG_TYPE_LIRC_MODE2</span></code> BPF
program, it can be attached to the LIRC device using the <a class="reference external" href="http://man7.org/linux/man-pages/man2/bpf.2.html">bpf(2)</a> syscall.
The target must be the file descriptor for the LIRC device, and the
attach type must be <code class="docutils literal notranslate"><span class="pre">BPF_LIRC_MODE2</span></code>. No more than 64 BPF programs can be
attached to a single LIRC device at a time.</p>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>