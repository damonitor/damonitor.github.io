

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>LSM BPF Programs &mdash; The Linux Kernel  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.7.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/mm/damon/index.html">DAMON: Data Access MONitor</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>LSM BPF Programs</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/bpf/bpf_lsm.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="lsm-bpf-programs">
<h1>LSM BPF Programs<a class="headerlink" href="#lsm-bpf-programs" title="Permalink to this headline">¶</a></h1>
<p>These BPF programs allow runtime instrumentation of the LSM hooks by privileged
users to implement system-wide MAC (Mandatory Access Control) and Audit
policies using eBPF.</p>
<div class="section" id="structure">
<h2>Structure<a class="headerlink" href="#structure" title="Permalink to this headline">¶</a></h2>
<p>The example shows an eBPF program that can be attached to the <code class="docutils literal notranslate"><span class="pre">file_mprotect</span></code>
LSM hook:</p>
<dl class="function">
<dt>
<code class="descname">int file_mprotect(struct vm_area_struct *vma, unsigned long reqprot, unsigned long prot);</code></dt>
<dd></dd></dl>

<p>Other LSM hooks which can be instrumented can be found in
<code class="docutils literal notranslate"><span class="pre">include/linux/lsm_hooks.h</span></code>.</p>
<p>eBPF programs that use <a class="reference internal" href="btf.html"><span class="doc">BPF Type Format (BTF)</span></a> do not need to include kernel headers
for accessing information from the attached eBPF program’s context. They can
simply declare the structures in the eBPF program and only specify the fields
that need to be accessed.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">mm_struct</span> <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start_brk</span><span class="p">,</span> <span class="n">brk</span><span class="p">,</span> <span class="n">start_stack</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">preserve_access_index</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start_brk</span><span class="p">,</span> <span class="n">brk</span><span class="p">,</span> <span class="n">start_stack</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vm_start</span><span class="p">,</span> <span class="n">vm_end</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">vm_mm</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">preserve_access_index</span><span class="p">));</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The order of the fields is irrelevant.</p>
</div>
<p>This can be further simplified (if one has access to the BTF information at
build time) by generating the <code class="docutils literal notranslate"><span class="pre">vmlinux.h</span></code> with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> bpftool btf dump file &lt;path-to-btf-vmlinux&gt; format c &gt; vmlinux.h
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal notranslate"><span class="pre">path-to-btf-vmlinux</span></code> can be <code class="docutils literal notranslate"><span class="pre">/sys/kernel/btf/vmlinux</span></code> if the
build environment matches the environment the BPF programs are
deployed in.</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">vmlinux.h</span></code> can then simply be included in the BPF programs without
requiring the definition of the types.</p>
<p>The eBPF programs can be declared using the``BPF_PROG``
macros defined in <a class="reference external" href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tree/tools/lib/bpf/bpf_tracing.h">tools/lib/bpf/bpf_tracing.h</a>. In this
example:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">&quot;lsm/file_mprotect&quot;</span></code> indicates the LSM hook that the program must
be attached to</li>
<li><code class="docutils literal notranslate"><span class="pre">mprotect_audit</span></code> is the name of the eBPF program</li>
</ul>
</div></blockquote>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">SEC</span><span class="p">(</span><span class="s">&quot;lsm/file_mprotect&quot;</span><span class="p">)</span>
<span class="kt">int</span> <span class="n">BPF_PROG</span><span class="p">(</span><span class="n">mprotect_audit</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">,</span>
             <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reqprot</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">prot</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">)</span>
<span class="p">{</span>
        <span class="cm">/* ret is the return value from the previous BPF program</span>
<span class="cm">         * or 0 if it&#39;s the first hook.</span>
<span class="cm">         */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

        <span class="kt">int</span> <span class="n">is_heap</span><span class="p">;</span>

        <span class="n">is_heap</span> <span class="o">=</span> <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span> <span class="o">&gt;=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_mm</span><span class="o">-&gt;</span><span class="n">start_brk</span> <span class="o">&amp;&amp;</span>
                   <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">&lt;=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_mm</span><span class="o">-&gt;</span><span class="n">brk</span><span class="p">);</span>

        <span class="cm">/* Return an -EPERM or write information to the perf events buffer</span>
<span class="cm">         * for auditing</span>
<span class="cm">         */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">is_heap</span><span class="p">)</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">__attribute__((preserve_access_index))</span></code> is a clang feature that allows
the BPF verifier to update the offsets for the access at runtime using the
<a class="reference internal" href="btf.html"><span class="doc">BPF Type Format (BTF)</span></a> information. Since the BPF verifier is aware of the types, it
also validates all the accesses made to the various types in the eBPF program.</p>
</div>
<div class="section" id="loading">
<h2>Loading<a class="headerlink" href="#loading" title="Permalink to this headline">¶</a></h2>
<p>eBPF programs can be loaded with the <em class="manpage">bpf(2)</em> syscall’s
<code class="docutils literal notranslate"><span class="pre">BPF_PROG_LOAD</span></code> operation:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">bpf_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>

<span class="n">obj</span> <span class="o">=</span> <span class="n">bpf_object__open</span><span class="p">(</span><span class="s">&quot;./my_prog.o&quot;</span><span class="p">);</span>
<span class="n">bpf_object__load</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
</pre></div>
</div>
<p>This can be simplified by using a skeleton header generated by <code class="docutils literal notranslate"><span class="pre">bpftool</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> bpftool gen skeleton my_prog.o &gt; my_prog.skel.h
</pre></div>
</div>
<p>and the program can be loaded by including <code class="docutils literal notranslate"><span class="pre">my_prog.skel.h</span></code> and using
the generated helper, <code class="docutils literal notranslate"><span class="pre">my_prog__open_and_load</span></code>.</p>
</div>
<div class="section" id="attachment-to-lsm-hooks">
<h2>Attachment to LSM Hooks<a class="headerlink" href="#attachment-to-lsm-hooks" title="Permalink to this headline">¶</a></h2>
<p>The LSM allows attachment of eBPF programs as LSM hooks using <em class="manpage">bpf(2)</em>
syscall’s <code class="docutils literal notranslate"><span class="pre">BPF_RAW_TRACEPOINT_OPEN</span></code> operation or more simply by
using the libbpf helper <code class="docutils literal notranslate"><span class="pre">bpf_program__attach_lsm</span></code>.</p>
<p>The program can be detached from the LSM hook by <em>destroying</em> the <code class="docutils literal notranslate"><span class="pre">link</span></code>
link returned by <code class="docutils literal notranslate"><span class="pre">bpf_program__attach_lsm</span></code> using <code class="docutils literal notranslate"><span class="pre">bpf_link__destroy</span></code>.</p>
<p>One can also use the helpers generated in <code class="docutils literal notranslate"><span class="pre">my_prog.skel.h</span></code> i.e.
<code class="docutils literal notranslate"><span class="pre">my_prog__attach</span></code> for attachment and <code class="docutils literal notranslate"><span class="pre">my_prog__destroy</span></code> for cleaning up.</p>
</div>
<div class="section" id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<p>An example eBPF program can be found in
<a class="reference external" href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tree/tools/testing/selftests/bpf/progs/lsm.c">tools/testing/selftests/bpf/progs/lsm.c</a> and the corresponding
userspace code in <a class="reference external" href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tree/tools/testing/selftests/bpf/prog_tests/test_lsm.c">tools/testing/selftests/bpf/prog_tests/test_lsm.c</a></p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>