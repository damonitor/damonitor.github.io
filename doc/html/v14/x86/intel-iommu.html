

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>12. Linux IOMMU Support &mdash; The Linux Kernel  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.7.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/mm/damon/index.html">DAMON: Data Access MONitor</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>12. Linux IOMMU Support</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/x86/intel-iommu.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="linux-iommu-support">
<h1>12. Linux IOMMU Support<a class="headerlink" href="#linux-iommu-support" title="Permalink to this headline">¶</a></h1>
<p>The architecture spec can be obtained from the below location.</p>
<p><a class="reference external" href="http://www.intel.com/content/dam/www/public/us/en/documents/product-specifications/vt-directed-io-spec.pdf">http://www.intel.com/content/dam/www/public/us/en/documents/product-specifications/vt-directed-io-spec.pdf</a></p>
<p>This guide gives a quick cheat sheet for some basic understanding.</p>
<p>Some Keywords</p>
<ul class="simple">
<li>DMAR - DMA remapping</li>
<li>DRHD - DMA Remapping Hardware Unit Definition</li>
<li>RMRR - Reserved memory Region Reporting Structure</li>
<li>ZLR  - Zero length reads from PCI devices</li>
<li>IOVA - IO Virtual address.</li>
</ul>
<div class="section" id="basic-stuff">
<h2>12.1. Basic stuff<a class="headerlink" href="#basic-stuff" title="Permalink to this headline">¶</a></h2>
<p>ACPI enumerates and lists the different DMA engines in the platform, and
device scope relationships between PCI devices and which DMA engine  controls
them.</p>
</div>
<div class="section" id="what-is-rmrr">
<h2>12.2. What is RMRR?<a class="headerlink" href="#what-is-rmrr" title="Permalink to this headline">¶</a></h2>
<p>There are some devices the BIOS controls, for e.g USB devices to perform
PS2 emulation. The regions of memory used for these devices are marked
reserved in the e820 map. When we turn on DMA translation, DMA to those
regions will fail. Hence BIOS uses RMRR to specify these regions along with
devices that need to access these regions. OS is expected to setup
unity mappings for these regions for these devices to access these regions.</p>
</div>
<div class="section" id="how-is-iova-generated">
<h2>12.3. How is IOVA generated?<a class="headerlink" href="#how-is-iova-generated" title="Permalink to this headline">¶</a></h2>
<p>Well behaved drivers call pci_map_*() calls before sending command to device
that needs to perform DMA. Once DMA is completed and mapping is no longer
required, device performs a pci_unmap_*() calls to unmap the region.</p>
<p>The Intel IOMMU driver allocates a virtual address per domain. Each PCIE
device has its own domain (hence protection). Devices under p2p bridges
share the virtual address with all devices under the p2p bridge due to
transaction id aliasing for p2p bridges.</p>
<p>IOVA generation is pretty generic. We used the same technique as <a class="reference internal" href="../core-api/mm-api.html#c.vmalloc" title="vmalloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">vmalloc()</span></code></a>
but these are not global address spaces, but separate for each domain.
Different DMA engines may support different number of domains.</p>
<p>We also allocate guard pages with each mapping, so we can attempt to catch
any overflow that might happen.</p>
</div>
<div class="section" id="graphics-problems">
<h2>12.4. Graphics Problems?<a class="headerlink" href="#graphics-problems" title="Permalink to this headline">¶</a></h2>
<p>If you encounter issues with graphics devices, you can try adding
option intel_iommu=igfx_off to turn off the integrated graphics engine.
If this fixes anything, please ensure you file a bug reporting the problem.</p>
</div>
<div class="section" id="some-exceptions-to-iova">
<h2>12.5. Some exceptions to IOVA<a class="headerlink" href="#some-exceptions-to-iova" title="Permalink to this headline">¶</a></h2>
<p>Interrupt ranges are not address translated, (0xfee00000 - 0xfeefffff).
The same is true for peer to peer transactions. Hence we reserve the
address from PCI MMIO ranges so they are not allocated for IOVA addresses.</p>
</div>
<div class="section" id="fault-reporting">
<h2>12.6. Fault reporting<a class="headerlink" href="#fault-reporting" title="Permalink to this headline">¶</a></h2>
<p>When errors are reported, the DMA engine signals via an interrupt. The fault
reason and device that caused it with fault reason is printed on console.</p>
<p>See below for sample.</p>
</div>
<div class="section" id="boot-message-sample">
<h2>12.7. Boot Message Sample<a class="headerlink" href="#boot-message-sample" title="Permalink to this headline">¶</a></h2>
<p>Something like this gets printed indicating presence of DMAR tables
in ACPI.</p>
<p>ACPI: DMAR (v001 A M I  OEMDMAR  0x00000001 MSFT 0x00000097) &#64; 0x000000007f5b5ef0</p>
<p>When DMAR is being processed and initialized by ACPI, prints DMAR locations
and any RMRR’s processed:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ACPI DMAR:Host address width 36
ACPI DMAR:DRHD (flags: 0x00000000)base: 0x00000000fed90000
ACPI DMAR:DRHD (flags: 0x00000000)base: 0x00000000fed91000
ACPI DMAR:DRHD (flags: 0x00000001)base: 0x00000000fed93000
ACPI DMAR:RMRR base: 0x00000000000ed000 end: 0x00000000000effff
ACPI DMAR:RMRR base: 0x000000007f600000 end: 0x000000007fffffff
</pre></div>
</div>
<p>When DMAR is enabled for use, you will notice..</p>
</div>
<div class="section" id="pci-dma-using-dmar-iommu">
<h2>12.8. PCI-DMA: Using DMAR IOMMU<a class="headerlink" href="#pci-dma-using-dmar-iommu" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id1">
<h3>12.8.1. Fault reporting<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DMAR:[DMA Write] Request device [00:02.0] fault addr 6df084000
DMAR:[fault reason 05] PTE Write access is not set
DMAR:[DMA Write] Request device [00:02.0] fault addr 6df084000
DMAR:[fault reason 05] PTE Write access is not set
</pre></div>
</div>
</div>
</div>
<div class="section" id="tbd">
<h2>12.9. TBD<a class="headerlink" href="#tbd" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>For compatibility testing, could use unity map domain for all devices, just
provide a 1-1 for all useful memory under a single domain for all devices.</li>
<li>API for paravirt ops for abstracting functionality for VMM folks.</li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>